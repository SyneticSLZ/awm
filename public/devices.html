<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDA Device Intelligence Dashboard - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fda-blue': '#1e40af',
                        'fda-light': '#eff6ff',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .json-container {
            background: #1a1a1a;
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .json-key { color: #f92672; }
        .json-string { color: #a6e22e; }
        .json-number { color: #ae81ff; }
        .json-boolean { color: #66d9ef; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold">FDA Device Intelligence</h1>
                    <p class="text-xl opacity-90 mt-2">Comprehensive Medical Device Regulatory Analysis</p>
                </div>
                <div class="hidden md:block">
                    <div class="bg-white bg-opacity-20 rounded-lg p-4">
                        <p class="text-sm">Connected to:</p>
                        <p class="font-semibold">FDA openFDA API + eCFR Live Data</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Section -->
    <section id="dashboard-section" class="container mx-auto px-6 py-8">
        <!-- Search Interface -->
        <div class="bg-white rounded-xl card-shadow p-8 mb-8">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Search FDA Device Data</h2>
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-fda-light rounded-lg p-4">
                        <h3 class="font-semibold text-fda-blue mb-2">Device Intelligence</h3>
                        <p class="text-sm text-gray-600">Search any device name for complete regulatory profile</p>
                        <p class="text-xs text-gray-500 mt-1">e.g. "pacemaker", "mri scanner", "hearing aid"</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-semibold text-green-700 mb-2">eCFR Parts</h3>
                        <p class="text-sm text-gray-600">Browse specific regulatory parts (862-892)</p>
                        <p class="text-xs text-gray-500 mt-1">e.g. "part 870", "cardiovascular", "dental"</p>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h3 class="font-semibold text-yellow-700 mb-2">Advanced Search</h3>
                        <p class="text-sm text-gray-600">Product codes, K numbers, company names</p>
                        <p class="text-xs text-gray-500 mt-1">e.g. "K123456", "Medtronic", "FOZ"</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Enter device name, part number, or regulatory term..."
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-fda-blue focus:outline-none text-lg"
                    >
                </div>
                <div class="flex gap-2">
                    <button 
                        id="device-search-btn" 
                        class="bg-fda-blue text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                    >
                        Device Intelligence
                    </button>
                    <button 
                        id="part-search-btn" 
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold"
                    >
                        Browse eCFR Parts
                    </button>
                </div>
            </div>

            <!-- Quick Part Browser -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-semibold text-gray-700 mb-3">Quick eCFR Part Access:</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2">
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="862">862 - Clinical Chemistry</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="864">864 - Hematology</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="866">866 - Immunology</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="868">868 - Anesthesiology</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="870">870 - Cardiovascular</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="872">872 - Dental</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="874">874 - ENT</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="876">876 - Gastro-Urology</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="878">878 - Surgery</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="880">880 - Hospital</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="882">882 - Neurological</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="884">884 - OB/GYN</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="886">886 - Ophthalmic</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="888">888 - Orthopedic</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="890">890 - Physical Medicine</button>
                    <button class="part-btn bg-white hover:bg-fda-light border border-gray-200 rounded px-3 py-2 text-sm transition-colors" data-part="892">892 - Radiology</button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden bg-white rounded-xl card-shadow p-8 mb-8">
            <div class="flex items-center justify-center">
                <div class="loading-pulse bg-fda-blue rounded-full h-4 w-4 mr-2"></div>
                <div class="loading-pulse bg-fda-blue rounded-full h-4 w-4 mr-2" style="animation-delay: 0.1s;"></div>
                <div class="loading-pulse bg-fda-blue rounded-full h-4 w-4 mr-4" style="animation-delay: 0.2s;"></div>
                <span class="text-lg text-gray-600">Searching FDA databases and eCFR regulations...</span>
            </div>
        </div>

        <!-- Error Display -->
        <div id="error-display" class="hidden bg-red-50 border border-red-200 rounded-xl p-6 mb-8">
            <div class="flex items-start">
                <div class="bg-red-100 rounded-full p-2 mr-4">
                    <svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Search Error</h3>
                    <div id="error-content" class="text-red-700"></div>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results-container" class="hidden fade-in">
            <!-- Device Profile Overview -->
            <div id="device-profile" class="hidden bg-white rounded-xl card-shadow p-8 mb-8">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2" id="device-title"></h2>
                    <p class="text-gray-600" id="device-timestamp"></p>
                </div>

                <!-- Overview Cards -->
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-6">
                        <h3 class="text-sm font-medium opacity-90">Regulatory Complexity</h3>
                        <p class="text-2xl font-bold mt-2" id="complexity-level">-</p>
                        <p class="text-sm opacity-75 mt-1" id="complexity-desc">-</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg p-6">
                        <h3 class="text-sm font-medium opacity-90">Device Classification</h3>
                        <p class="text-2xl font-bold mt-2" id="device-class">-</p>
                        <p class="text-sm opacity-75 mt-1" id="class-desc">-</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-6">
                        <h3 class="text-sm font-medium opacity-90">Market Status</h3>
                        <p class="text-2xl font-bold mt-2" id="market-status">-</p>
                        <p class="text-sm opacity-75 mt-1" id="market-desc">-</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-lg p-6">
                        <h3 class="text-sm font-medium opacity-90">Safety Profile</h3>
                        <p class="text-2xl font-bold mt-2" id="safety-level">-</p>
                        <p class="text-sm opacity-75 mt-1" id="safety-desc">-</p>
                    </div>
                </div>

                <!-- Applicable Parts -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Applicable eCFR Parts</h3>
                    <div id="applicable-parts" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- Recommendations -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-4">Regulatory Recommendations</h3>
                    <ul id="recommendations-list" class="space-y-2"></ul>
                </div>
            </div>

            <!-- Detailed Data Sections -->
            <div id="detailed-data" class="space-y-6">
                <!-- FDA Data Section -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="bg-fda-blue text-white p-6">
                        <h2 class="text-2xl font-bold">FDA Database Results</h2>
                        <p class="opacity-90 mt-1">Data from openFDA APIs</p>
                    </div>
                    <div id="fda-data-content" class="p-6"></div>
                </div>

                <!-- eCFR Data Section -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="bg-green-600 text-white p-6">
                        <h2 class="text-2xl font-bold">eCFR Regulatory Text</h2>
                        <p class="opacity-90 mt-1">Live data from Electronic Code of Federal Regulations</p>
                    </div>
                    <div id="ecfr-data-content" class="p-6"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        class FDADeviceData {
            constructor() {
                this.baseUrl = '/api/fda'; // Adjust this to your backend URL
                this.currentData = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Search buttons
                document.getElementById('device-search-btn').addEventListener('click', () => {
                    this.performDeviceSearch();
                });

                document.getElementById('part-search-btn').addEventListener('click', () => {
                    this.performPartSearch();
                });

                // Enter key search
                document.getElementById('search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.performDeviceSearch();
                    }
                });

                // Part buttons
                document.querySelectorAll('.part-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const part = e.target.dataset.part;
                        this.searchSpecificPart(part);
                    });
                });
            }

            async performDeviceSearch() {
                const searchTerm = document.getElementById('search-input').value.trim();
                if (!searchTerm) {
                    this.showError('Please enter a search term');
                    return;
                }

                this.showLoading();
                this.hideError();

                try {
                    const response = await fetch(`${this.baseUrl}/device-intelligence?q=${encodeURIComponent(searchTerm)}`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Search failed');
                    }

                    this.currentData = data;
                    this.displayDeviceResults(data);
                } catch (error) {
                    this.showError(`Device search failed: ${error.message}`, error);
                } finally {
                    this.hideLoading();
                }
            }

            async performPartSearch() {
                const searchTerm = document.getElementById('search-input').value.trim();
                if (!searchTerm) {
                    this.showError('Please enter a part number or search term');
                    return;
                }

                // Try to extract part number
                const partMatch = searchTerm.match(/(\d{3})/);
                const partNumber = partMatch ? partMatch[1] : searchTerm;

                this.searchSpecificPart(partNumber);
            }

            async searchSpecificPart(partNumber) {
                this.showLoading();
                this.hideError();

                try {
                    const response = await fetch(`${this.baseUrl}/ecfr-part/${partNumber}`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Part search failed');
                    }

                    this.displayPartResults(data);
                } catch (error) {
                    this.showError(`eCFR Part search failed: ${error.message}`, error);
                } finally {
                    this.hideLoading();
                }
            }

            displayDeviceResults(data) {
                this.hideError();
                document.getElementById('results-container').classList.remove('hidden');
                document.getElementById('device-profile').classList.remove('hidden');

                // Update profile overview
                document.getElementById('device-title').textContent = `Device Intelligence: ${data.searchTerm}`;
                document.getElementById('device-timestamp').textContent = `Analysis generated: ${new Date(data.timestamp).toLocaleString()}`;

                // Update overview cards
                const profile = data.profile;
                document.getElementById('complexity-level').textContent = profile.overview.regulatoryComplexity;
                document.getElementById('device-class').textContent = profile.overview.primaryClassification;
                document.getElementById('market-status').textContent = profile.overview.marketStatus;
                document.getElementById('safety-level').textContent = profile.safety.riskLevel;

                // Update descriptions
                document.getElementById('complexity-desc').textContent = `${profile.regulatory.applicableParts} eCFR parts apply`;
                document.getElementById('class-desc').textContent = profile.regulatory.pathways.join(', ') || 'Pathway TBD';
                document.getElementById('market-desc').textContent = `${profile.overview.totalFDARecords} FDA records found`;
                document.getElementById('safety-desc').textContent = `${profile.safety.recallCount} recalls, ${profile.safety.adverseEventCount} adverse events`;

                // Display applicable parts
                this.displayApplicableParts(data.applicableParts);

                // Display recommendations
                this.displayRecommendations(profile.recommendations);

                // Display detailed data
                this.displayFDAData(data.data.fda);
                this.displayECFRData(data.data.ecfr);
            }

            displayPartResults(data) {
                this.hideError();
                document.getElementById('results-container').classList.remove('hidden');
                document.getElementById('device-profile').classList.add('hidden');

                // Display eCFR part data
                this.displayECFRPartData(data);
            }

            displayApplicableParts(parts) {
                const container = document.getElementById('applicable-parts');
                container.innerHTML = '';

                if (!parts || parts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No applicable eCFR parts identified</p>';
                    return;
                }

                parts.forEach(part => {
                    const partCard = document.createElement('div');
                    partCard.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer';
                    partCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-800">Part ${part.part}</h4>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${part.matchType}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${part.description}</p>
                        <div class="flex justify-between items-center">
                            <p class="text-xs text-gray-500">Relevance Score: ${part.relevanceScore}</p>
                            <a href="https://www.ecfr.gov/current/title-21/chapter-I/subchapter-H/part-${part.part}" 
                               target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-xs"
                               onclick="event.stopPropagation()">
                                View on eCFR ↗
                            </a>
                        </div>
                    `;
                    partCard.addEventListener('click', () => this.searchSpecificPart(part.part));
                    container.appendChild(partCard);
                });
            }

            displayRecommendations(recommendations) {
                const container = document.getElementById('recommendations-list');
                container.innerHTML = '';

                if (!recommendations || recommendations.length === 0) {
                    container.innerHTML = '<li class="text-gray-500">No specific recommendations available</li>';
                    return;
                }

                recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start';
                    li.innerHTML = `
                        <svg class="w-5 h-5 text-yellow-600 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-yellow-800">${rec}</span>
                    `;
                    container.appendChild(li);
                });
            }

            displayFDAData(fdaData) {
                const container = document.getElementById('fda-data-content');
                container.innerHTML = '';

                // Show metadata if available
                if (fdaData._metadata) {
                    const metadataDiv = document.createElement('div');
                    metadataDiv.className = 'bg-gray-50 rounded-lg p-4 mb-6';
                    metadataDiv.innerHTML = `
                        <h3 class="font-semibold text-gray-800 mb-2">API Status Summary</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-green-600 font-medium">✓ Successful Endpoints (${fdaData._metadata.successfulEndpoints.length}/${fdaData._metadata.totalEndpoints}):</p>
                                <p class="text-sm text-gray-600">${fdaData._metadata.successfulEndpoints.join(', ') || 'None'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-red-600 font-medium">✗ Failed Endpoints:</p>
                                <p class="text-sm text-gray-600">${fdaData._metadata.failedEndpoints.join(', ') || 'None'}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(metadataDiv);
                }

                const fdaEndpoints = [
                    { key: 'fiveOneOk', name: '510(k) Clearances', color: 'blue', url: 'https://api.fda.gov/device/510k.json' },
                    { key: 'pma', name: 'PMA Approvals', color: 'green', url: 'https://api.fda.gov/device/pma.json' },
                    { key: 'recalls', name: 'Device Recalls', color: 'red', url: 'https://api.fda.gov/device/recall.json' },
                    { key: 'adverseEvents', name: 'Adverse Events', color: 'orange', url: 'https://api.fda.gov/device/event.json' },
                    { key: 'classification', name: 'Device Classification', color: 'purple', url: 'https://api.fda.gov/device/classification.json' },
                    { key: 'registrations', name: 'Registrations', color: 'indigo', url: 'https://api.fda.gov/device/registrationlisting.json' },
                    { key: 'udi', name: 'UDI Database', color: 'pink', url: 'https://api.fda.gov/device/udi.json' },
                    { key: 'enforcement', name: 'Enforcement Reports', color: 'gray', url: 'https://api.fda.gov/device/enforcement.json' }
                ];

                fdaEndpoints.forEach(endpoint => {
                    const data = fdaData[endpoint.key];
                    if (!data) return;

                    const section = this.createExpandableSection(
                        endpoint.name,
                        data.results?.length || 0,
                        data.error,
                        endpoint.color,
                        endpoint.url
                    );

                    if (data.results?.length > 0) {
                        const content = this.createFDADataTable(data.results, endpoint.key);
                        section.appendChild(content);
                    } else if (data.error) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-4 text-red-700';
                        errorDiv.innerHTML = `
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-red-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <div>
                                    <strong>API Error:</strong> ${data.error}
                                    <br><span class="text-sm">This FDA endpoint may be temporarily unavailable or the query returned no results.</span>
                                </div>
                            </div>
                        `;
                        section.appendChild(errorDiv);
                    } else {
                        const noDataDiv = document.createElement('div');
                        noDataDiv.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 text-gray-600';
                        noDataDiv.innerHTML = `
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-gray-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                </svg>
                                No data found for this search term in the ${endpoint.name} database.
                            </div>
                        `;
                        section.appendChild(noDataDiv);
                    }

                    container.appendChild(section);
                });
            }

            displayECFRData(ecfrData) {
                const container = document.getElementById('ecfr-data-content');
                container.innerHTML = '';

                if (!ecfrData || Object.keys(ecfrData).length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No eCFR data available</p>';
                    return;
                }

                Object.entries(ecfrData).forEach(([partNumber, partData]) => {
                    const section = this.createECFRPartSection(partNumber, partData);
                    container.appendChild(section);
                });
            }

            displayECFRPartData(data) {
                const container = document.getElementById('ecfr-data-content');
                container.innerHTML = '';

                const partData = {
                    partInfo: { part: data.part, description: data.description },
                    document: data.data
                };

                const section = this.createECFRPartSection(data.part, partData);
                container.appendChild(section);

                // Show results container
                document.getElementById('results-container').classList.remove('hidden');
            }

            createExpandableSection(title, count, error, color, apiUrl = null) {
                const section = document.createElement('div');
                section.className = 'border border-gray-200 rounded-lg mb-4 overflow-hidden';

                const header = document.createElement('div');
                header.className = `bg-${color}-50 border-b border-gray-200 p-4 cursor-pointer hover:bg-${color}-100 transition-colors`;
                
                const statusClass = error ? 'text-red-600' : count > 0 ? 'text-green-600' : 'text-gray-500';
                const statusText = error ? 'Error' : count > 0 ? `${count} records` : 'No data';

                header.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <h3 class="text-lg font-semibold text-gray-800 mr-4">${title}</h3>
                            ${apiUrl ? `<a href="${apiUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm" onclick="event.stopPropagation()">API Docs ↗</a>` : ''}
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm ${statusClass} mr-4">${statusText}</span>
                            <svg class="w-5 h-5 text-gray-500 transform transition-transform expand-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                `;

                const content = document.createElement('div');
                content.className = 'hidden p-4 bg-white';

                header.addEventListener('click', () => {
                    const isHidden = content.classList.contains('hidden');
                    content.classList.toggle('hidden');
                    const icon = header.querySelector('.expand-icon');
                    icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                });

                section.appendChild(header);
                section.appendChild(content);

                return section;
            }

            createFDADataTable(results, endpoint) {
                const div = document.createElement('div');
                div.className = 'overflow-x-auto';

                if (results.length === 0) {
                    div.innerHTML = '<p class="text-gray-500 p-4">No records found</p>';
                    return div;
                }

                // Create table based on endpoint type
                const table = document.createElement('table');
                table.className = 'min-w-full bg-white border border-gray-200';

                const thead = document.createElement('thead');
                thead.className = 'bg-gray-50';

                const tbody = document.createElement('tbody');
                tbody.className = 'divide-y divide-gray-200';

                // Define columns based on endpoint
                let columns = [];
                switch (endpoint) {
                    case 'fiveOneOk':
                        columns = [
                            { key: 'k_number', label: 'K Number', link: true },
                            { key: 'device_name', label: 'Device Name' },
                            { key: 'applicant', label: 'Applicant' },
                            { key: 'decision_date', label: 'Decision Date' },
                            { key: 'decision_description', label: 'Decision' }
                        ];
                        break;
                    case 'pma':
                        columns = [
                            { key: 'pma_number', label: 'PMA Number', link: true },
                            { key: 'generic_name', label: 'Generic Name' },
                            { key: 'trade_name', label: 'Trade Name' },
                            { key: 'applicant', label: 'Applicant' },
                            { key: 'decision_date', label: 'Decision Date' }
                        ];
                        break;
                    case 'recalls':
                        columns = [
                            { key: 'res_event_number', label: 'Event Number', link: true },
                            { key: 'product_description', label: 'Product' },
                            { key: 'recalling_firm', label: 'Recalling Firm' },
                            { key: 'recall_status', label: 'Status' },
                            { key: 'event_date_initiated', label: 'Date Initiated' }
                        ];
                        break;
                    case 'adverseEvents':
                        columns = [
                            { key: 'mdr_report_key', label: 'Report Key', link: true },
                            { key: 'event_type', label: 'Event Type' },
                            { key: 'manufacturer_name', label: 'Manufacturer' },
                            { key: 'date_received', label: 'Date Received' },
                            { key: 'event_location', label: 'Location' }
                        ];
                        break;
                    case 'classification':
                        columns = [
                            { key: 'product_code', label: 'Product Code', link: true },
                            { key: 'device_name', label: 'Device Name' },
                            { key: 'device_class', label: 'Class' },
                            { key: 'medical_specialty_description', label: 'Medical Specialty' },
                            { key: 'regulation_number', label: 'Regulation' }
                        ];
                        break;
                    case 'registrations':
                        columns = [
                            { key: 'registration.registration_number', label: 'Registration #' },
                            { key: 'registration.owner_operator.firm_name', label: 'Firm Name' },
                            { key: 'registration.owner_operator.city', label: 'City' },
                            { key: 'registration.owner_operator.state_code', label: 'State' },
                            { key: 'establishment_type', label: 'Type' }
                        ];
                        break;
                    case 'udi':
                        columns = [
                            { key: 'device_description', label: 'Device Description' },
                            { key: 'brand_name', label: 'Brand Name' },
                            { key: 'company_name', label: 'Company' },
                            { key: 'device_count_in_base_package', label: 'Package Count' },
                            { key: 'publish_date', label: 'Publish Date' }
                        ];
                        break;
                    case 'enforcement':
                        columns = [
                            { key: 'recall_number', label: 'Recall Number', link: true },
                            { key: 'product_description', label: 'Product' },
                            { key: 'recalling_firm', label: 'Firm' },
                            { key: 'classification', label: 'Classification' },
                            { key: 'recall_initiation_date', label: 'Initiation Date' }
                        ];
                        break;
                    default:
                        // Generic columns for unknown endpoints
                        const firstItem = results[0];
                        columns = Object.keys(firstItem).slice(0, 5).map(key => ({
                            key,
                            label: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                        }));
                }

                // Create header
                const headerRow = document.createElement('tr');
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    th.textContent = col.label;
                    headerRow.appendChild(th);
                });
                // Add actions column
                const actionsHeader = document.createElement('th');
                actionsHeader.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                actionsHeader.textContent = 'Actions';
                headerRow.appendChild(actionsHeader);
                thead.appendChild(headerRow);

                // Create rows
                results.slice(0, 20).forEach((item, index) => { // Limit to 20 rows for performance
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                    columns.forEach(col => {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                        
                        const value = this.getNestedValue(item, col.key) || '-';
                        
                        if (col.link && value !== '-') {
                            // Create link to FDA database
                            const link = document.createElement('a');
                            link.href = this.generateFDALink(endpoint, col.key, value);
                            link.target = '_blank';
                            link.className = 'text-blue-600 hover:text-blue-800 underline';
                            link.textContent = value;
                            td.appendChild(link);
                        } else {
                            td.textContent = this.truncateText(value, 50);
                        }
                        
                        row.appendChild(td);
                    });

                    // Add actions column
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium';
                    
                    const viewButton = document.createElement('button');
                    viewButton.className = 'text-indigo-600 hover:text-indigo-900 mr-2';
                    viewButton.textContent = 'View Details';
                    viewButton.addEventListener('click', () => this.showItemDetails(item, endpoint));
                    
                    actionsCell.appendChild(viewButton);
                    row.appendChild(actionsCell);

                    tbody.appendChild(row);
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                div.appendChild(table);

                // Add show more button if there are more results
                if (results.length > 20) {
                    const moreButton = document.createElement('button');
                    moreButton.className = 'mt-4 bg-blue-50 text-blue-600 px-4 py-2 rounded hover:bg-blue-100 transition-colors';
                    moreButton.textContent = `Show ${results.length - 20} more records`;
                    moreButton.addEventListener('click', () => {
                        // TODO: Implement pagination or expand table
                        alert(`${results.length - 20} additional records available. Implement pagination for better performance.`);
                    });
                    div.appendChild(moreButton);
                }

                return div;
            }

            createECFRPartSection(partNumber, partData) {
                const section = document.createElement('div');
                section.className = 'border border-gray-200 rounded-lg mb-6 overflow-hidden';

                const header = document.createElement('div');
                header.className = 'bg-green-50 border-b border-gray-200 p-4 cursor-pointer hover:bg-green-100 transition-colors';
                
                const searchResultsCount = partData.searchResults?.length || 0;
                const totalSections = partData.document?.summary?.totalSections || partData.document?.sections?.length || 0;

                header.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <h3 class="text-lg font-semibold text-gray-800 mr-4">21 CFR Part ${partNumber}</h3>
                            <a href="https://www.ecfr.gov/current/title-21/chapter-I/subchapter-H/part-${partNumber}" 
                               target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-sm"
                               onclick="event.stopPropagation()">
                                View on eCFR ↗
                            </a>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm text-green-600 mr-4">${searchResultsCount} matches / ${totalSections} sections</span>
                            <svg class="w-5 h-5 text-gray-500 transform transition-transform expand-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">${partData.partInfo?.description || 'eCFR Part ' + partNumber}</p>
                `;

                const content = document.createElement('div');
                content.className = 'hidden p-4 bg-white';

                // Part summary
                if (partData.document?.summary) {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'bg-gray-50 rounded-lg p-4 mb-4';
                    summaryDiv.innerHTML = `
                        <h4 class="font-semibold text-gray-800 mb-2">Part Summary</h4>
                        <div class="grid md:grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-medium">Total Sections:</span> ${partData.document.summary.totalSections}
                            </div>
                            <div>
                                <span class="font-medium">Class Distribution:</span>
                                <div class="mt-1">
                                    Class I: ${partData.document.summary.classDistribution?.classI || 0}<br>
                                    Class II: ${partData.document.summary.classDistribution?.classII || 0}<br>
                                    Class III: ${partData.document.summary.classDistribution?.classIII || 0}
                                </div>
                            </div>
                            <div>
                                <span class="font-medium">Common Device Types:</span>
                                <div class="mt-1 text-xs">
                                    ${partData.document.summary.deviceTypes?.slice(0, 5).join(', ') || 'Various devices'}
                                </div>
                            </div>
                        </div>
                    `;
                    content.appendChild(summaryDiv);
                }

                // Search results or all sections
                const sectionsToShow = partData.searchResults?.length > 0 ? partData.searchResults : partData.document?.sections?.slice(0, 10) || [];
                
                if (sectionsToShow.length > 0) {
                    const sectionsDiv = document.createElement('div');
                    sectionsDiv.className = 'space-y-4';
                    
                    sectionsToShow.forEach(section => {
                        const sectionCard = this.createSectionCard(section, partNumber);
                        sectionsDiv.appendChild(sectionCard);
                    });
                    
                    content.appendChild(sectionsDiv);
                }

                header.addEventListener('click', () => {
                    const isHidden = content.classList.contains('hidden');
                    content.classList.toggle('hidden');
                    const icon = header.querySelector('.expand-icon');
                    icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                });

                section.appendChild(header);
                section.appendChild(content);

                return section;
            }

            createSectionCard(section, partNumber) {
                const card = document.createElement('div');
                card.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';

                const sectionUrl = section.url || `https://www.ecfr.gov/current/title-21/chapter-I/subchapter-H/part-${partNumber}/section-${section.sectionId || section.section}`;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-800">${section.title || section.sectionId}</h4>
                        <div class="flex items-center space-x-2">
                            ${section.deviceClass ? `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Class ${section.deviceClass}</span>` : ''}
                            <a href="${sectionUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">View Section ↗</a>
                        </div>
                    </div>
                    ${section.identification ? `
                        <div class="mb-2">
                            <span class="text-sm font-medium text-gray-700">Identification:</span>
                            <p class="text-sm text-gray-600 mt-1">${this.truncateText(section.identification, 200)}</p>
                        </div>
                    ` : ''}
                    ${section.classification ? `
                        <div class="mb-2">
                            <span class="text-sm font-medium text-gray-700">Classification:</span>
                            <p class="text-sm text-gray-600 mt-1">${this.truncateText(section.classification, 150)}</p>
                        </div>
                    ` : ''}
                    ${section.matches ? `
                        <div class="mt-2">
                            <span class="text-sm font-medium text-gray-700">Search Matches:</span>
                            <div class="mt-1 space-y-1">
                                ${section.matches.map(match => `
                                    <div class="text-xs bg-yellow-50 p-2 rounded">
                                        <span class="font-medium">${match.field}:</span> ${this.truncateText(match.context, 100)}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <button class="mt-2 text-indigo-600 hover:text-indigo-800 text-sm view-details-btn">View Full Section Details</button>
                `;

                // Add click handler for details
                card.querySelector('.view-details-btn').addEventListener('click', () => {
                    this.showSectionDetails(section, partNumber);
                });

                return card;
            }

            showItemDetails(item, endpoint) {
                // Create modal or detailed view
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                
                const modalContent = document.createElement('div');
                modalContent.className = 'bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-y-auto p-6';
                
                modalContent.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">FDA Record Details</h3>
                        <button class="close-modal text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="json-container p-4 rounded-lg overflow-x-auto">
                        <pre class="text-xs">${this.formatJSON(item)}</pre>
                    </div>
                `;
                
                modalContent.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            }

            showSectionDetails(section, partNumber) {
                // Similar modal for eCFR section details
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                
                const modalContent = document.createElement('div');
                modalContent.className = 'bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-y-auto p-6';
                
                const sectionUrl = section.url || `https://www.ecfr.gov/current/title-21/chapter-I/subchapter-H/part-${partNumber}/section-${section.sectionId || section.section}`;
                
                modalContent.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-bold">${section.title || section.sectionId}</h3>
                            <a href="${sectionUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">View on eCFR ↗</a>
                        </div>
                        <button class="close-modal text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        ${section.identification ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Identification:</h4>
                                <p class="text-gray-700 bg-gray-50 p-3 rounded">${section.identification}</p>
                            </div>
                        ` : ''}
                        ${section.classification ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Classification:</h4>
                                <p class="text-gray-700 bg-gray-50 p-3 rounded">${section.classification}</p>
                            </div>
                        ` : ''}
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Complete Section Data:</h4>
                            <div class="json-container p-4 rounded-lg overflow-x-auto">
                                <pre class="text-xs">${this.formatJSON(section)}</pre>
                            </div>
                        </div>
                    </div>
                `;
                
                modalContent.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            }

            // Utility functions
            getNestedValue(obj, path) {
                return path.split('.').reduce((current, key) => {
                    return current && current[key] !== undefined ? current[key] : null;
                }, obj);
            }

            truncateText(text, maxLength) {
                if (!text) return '-';
                const str = String(text);
                return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
            }

            generateFDALink(endpoint, field, value) {
                const baseUrls = {
                    'fiveOneOk': 'https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfpmn/pmn.cfm',
                    'pma': 'https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfpma/pma.cfm',
                    'recalls': 'https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfres/res.cfm',
                    'classification': 'https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfpcd/classification.cfm'
                };
                
                // Return appropriate FDA link based on endpoint and field
                if (endpoint === 'fiveOneOk' && field === 'k_number') {
                    return `${baseUrls.fiveOneOk}?id=${value}`;
                } else if (endpoint === 'pma' && field === 'pma_number') {
                    return `${baseUrls.pma}?id=${value}`;
                } else {
                    return baseUrls[endpoint] || '#';
                }
            }

            formatJSON(obj) {
                return JSON.stringify(obj, null, 2)
                    .replace(/("[\w\s_-]+")\s*:/g, '<span class="json-key">$1</span>:')
                    .replace(/:\s*(".*?")/g, ': <span class="json-string">$1</span>')
                    .replace(/:\s*(\d+)/g, ': <span class="json-number">$1</span>')
                    .replace(/:\s*(true|false)/g, ': <span class="json-boolean">$1</span>');
            }

            showLoading() {
                document.getElementById('loading-state').classList.remove('hidden');
                document.getElementById('results-container').classList.add('hidden');
            }

            hideLoading() {
                document.getElementById('loading-state').classList.add('hidden');
            }

            showError(message, error = null) {
                const errorDisplay = document.getElementById('error-display');
                const errorContent = document.getElementById('error-content');
                
                let errorHtml = `<p class="mb-2">${message}</p>`;
                
                if (error) {
                    errorHtml += `
                        <details class="mt-2">
                            <summary class="cursor-pointer text-sm font-medium">Technical Details</summary>
                            <div class="mt-2 p-2 bg-red-100 rounded text-sm">
                                <pre class="whitespace-pre-wrap">${error.stack || error.message || JSON.stringify(error, null, 2)}</pre>
                            </div>
                        </details>
                    `;
                }
                
                errorContent.innerHTML = errorHtml;
                errorDisplay.classList.remove('hidden');
                document.getElementById('results-container').classList.add('hidden');
            }

            hideError() {
                document.getElementById('error-display').classList.add('hidden');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            new FDADeviceData();
        });
    </script>
</body>
</html>