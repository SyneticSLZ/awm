<!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRD Clinical Trials Outcomes Research Tool</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Axios for API requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6',
                        'secondary': '#10b981',
                        'accent': '#8b5cf6',
                        'dark': '#1e293b',
                    }
                }
            }
        }
    </script>
    <style>
      /* Timeline Visualization Styles */
.timeline-chart {
    margin-bottom: 2rem;
    position: relative;
}

.year-markers {
    height: 20px;
    position: relative;
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 1.5rem;
}

.year-markers div {
    transform: translateX(-50%);
}

.condition-track {
    transition: all 0.2s ease;
}

.condition-track:hover {
    transform: translateX(4px);
}

/* Activity indicators hover effects */
.condition-track .relative div {
    transition: all 0.2s ease;
    z-index: 10;
}

.condition-track:hover .relative div {
    transform: scale(1.5);
}

/* Make the tooltips work with pure CSS */
.condition-track .relative div::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 0.25rem 0.5rem;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.condition-track .relative div:hover::after {
    opacity: 1;
}

/* Insight cards hover effects */
.insight-card {
    transition: all 0.2s ease;
}

.insight-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-2px);
}

/* Evolution patterns section */
.evolution-patterns {
    margin-top: 1rem;
}

/* Make the timeline responsive */
@media (max-width: 768px) {
    .year-markers div {
        font-size: 0.6rem;
    }
    
    .condition-track .absolute {
        transform: scale(0.8);
    }
    
    .condition-track:hover .absolute {
        transform: scale(1.2);
    }
}

/* Add some animation for loading and transitions */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#drug-usage-timeline {
    animation: fadeIn 0.5s ease;
}

.condition-track {
    animation: fadeIn 0.3s ease;
    animation-fill-mode: both;
}

/* Stagger the animations for each condition track */
.condition-track:nth-child(1) { animation-delay: 0.1s; }
.condition-track:nth-child(2) { animation-delay: 0.2s; }
.condition-track:nth-child(3) { animation-delay: 0.3s; }
.condition-track:nth-child(4) { animation-delay: 0.4s; }
.condition-track:nth-child(5) { animation-delay: 0.5s; }
.condition-track:nth-child(6) { animation-delay: 0.6s; }
.condition-track:nth-child(7) { animation-delay: 0.7s; }
.condition-track:nth-child(8) { animation-delay: 0.8s; }
.condition-track:nth-child(9) { animation-delay: 0.9s; }
.condition-track:nth-child(10) { animation-delay: 1s; }

/* Enhance the insight cards */
.insight-card {
    border-left: 4px solid #3b82f6;
    background-color: #f9fafb;
}

.insight-card:nth-child(2) {
    border-left-color: #10b981;
}

.insight-card:nth-child(3) {
    border-left-color: #f59e0b;
}

.insight-card:nth-child(4) {
    border-left-color: #ef4444;
}

.insight-card:nth-child(5) {
    border-left-color: #8b5cf6;
}
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
  <header class="bg-dark text-white shadow-md">
      <div class="container mx-auto p-4">
          <nav class="flex justify-between items-center">
              <div class="text-2xl font-bold">
                  <a href="#" class="hover:text-gray-300 transition-colors">Research Tool</a>
              </div>
              <ul class="flex space-x-6">
                  <li>
                      <a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Home</a>
                  </li>
                  <li>
                      <a href="./wl.html" class="text-gray-300 hover:text-white transition-colors duration-200">Warning Letters</a>
                  </li>
                  <li>
                      <a href="./post483.html" class="text-gray-300 hover:text-white transition-colors duration-200">483s</a>
                  </li>
              </ul>
          </nav>
          <!-- <div class="text-center mt-4">
              <h1 class="text-3xl font-bold">Treatment-Resistant Depression Clinical Trials Research Tool</h1>
              <p class="text-gray-300 mt-2">Analyze and compare clinical trial outcomes across studies and phases</p>
          </div> -->
      </div>
  </header>


    <main class="container mx-auto p-4">
        <!-- Search Section -->
        <section class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Search for Clinical Trials</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-grow">
                    <label for="drugSearch" class="block text-sm font-medium mb-1">Drug Name:</label>
                    <input type="text" id="drugSearch" placeholder="e.g., PCN-101, Ketamine, COMP360" 
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="flex-grow">
                    <label for="conditionSearch" class="block text-sm font-medium mb-1">Condition (Optional):</label>
                    <input type="text" id="conditionSearch" placeholder="Default: Treatment Resistant Depression" 
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="flex items-end">
                    <button id="searchButton" class="bg-primary hover:bg-blue-600 text-white py-2 px-6 rounded-lg transition duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Search
                    </button>
                </div>
            </div>
            <div class="mt-4 flex items-center gap-4" style="display: none;">
                <div>
                    <input type="checkbox" id="hasResultsOnly" class="mr-2" >
                    <label for="hasResultsOnly" class="text-sm">Show only studies with results</label>
                </div>
                <div >
                    <input type="checkbox" id="trdFocusOnly" class="mr-2" >
                    <label for="trdFocusOnly" class="text-sm">Focus on TRD-specific trials only</label>
                </div>
            </div>
        </section>

        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <div class="flex justify-center items-center p-10">
                <svg class="animate-spin h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-lg font-medium">Loading studies...</span>
            </div>
        </div>

        <!-- Placeholder Message -->
        <div id="placeholderMessage" class="bg-white rounded-lg shadow-md p-10 text-center text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <p class="text-lg">Enter a drug name and click "Search" to analyze clinical trials</p>
            <p class="mt-2 text-sm">Example searches: Ketamine, Psilocybin, Esketamine, PCN-101, COMP360</p>
        </div>
        <div id="trial-dashboard" class="max-w-6xl mx-auto p-4" style="display: none;">
            <!-- Content will be dynamically populated by JavaScript -->
            <div class="animate-pulse flex flex-col space-y-4">
                <div class="h-8 bg-gray-200 rounded w-3/4 mx-auto"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="h-64 bg-gray-200 rounded"></div>
                    <div class="h-64 bg-gray-200 rounded"></div>
                    <div class="h-64 bg-gray-200 rounded"></div>
                    <div class="h-64 bg-gray-200 rounded"></div>
                </div>
                <div class="h-32 bg-gray-200 rounded"></div>
            </div>
        </div>



        <!-- PubMed Section (Initially Hidden) -->
<section id="pubmedSection" class="hidden mt-8 bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-gray-800">PubMed Articles</h2>
      <div class="text-sm text-gray-500" id="pubmedResultCount"></div>
    </div>
    
    <!-- Loading State -->
    <div id="pubmedLoading" class="hidden">
      <div class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
      <p class="text-center text-gray-500">Searching PubMed database...</p>
    </div>
    
    <!-- Error State -->
    <div id="pubmedError" class="hidden">
      <div class="text-center py-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-lg">Error fetching PubMed articles</p>
        <p class="mt-2 text-sm" id="pubmedErrorMessage">Please try again later.</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="pubmedEmpty" class="hidden">
      <div class="text-center py-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <p class="text-lg">No PubMed articles found</p>
        <p class="mt-2 text-sm">Try a different search term or broaden your search criteria.</p>
      </div>
    </div>
    
    <!-- PubMed Summary Section (will appear at the top of results) -->
<div id="pubmedSummary" class="hidden mb-6 bg-white rounded-lg shadow-md p-4">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">Research Summary</h3>
    
    <!-- Loading State for Summary -->
    <div id="pubmedSummaryLoading" class="py-3">
      <div class="flex items-center space-x-2">
        <div class="animate-pulse rounded-full h-4 w-4 bg-primary"></div>
        <p class="text-sm text-gray-500">Analyzing research trends...</p>
      </div>
    </div>
    
    <!-- Summary Content -->
    <div id="pubmedSummaryContent" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Research Focus Areas -->
        <div class="bg-gray-50 p-3 rounded-md">
          <h4 class="font-medium text-gray-700 mb-2">Key Research Areas</h4>
          <div id="pubmedKeyAreas" class="text-sm"></div>
        </div>
        
        <!-- Publication Timeline -->
        <div class="bg-gray-50 p-3 rounded-md">
            <h4 class="font-medium text-gray-700 mb-2">Publication Timeline</h4>
            <div id="pubmedTimeline" class="text-sm">
              <table class="w-full text-xs">
                <tbody id="pubmedTimelineTable"></tbody>
              </table>
            </div>
          </div>

        <!-- Common Topics -->
        <div class="bg-gray-50 p-3 rounded-md">
          <h4 class="font-medium text-gray-700 mb-2">Common Topics</h4>
          <div id="pubmedTopics" class="text-sm">
            <div id="pubmedTopicsCloud" class="flex flex-wrap gap-1 mt-1"></div>
          </div>
        </div>
        
        <!-- Notable Findings -->
        <div class="bg-gray-50 p-3 rounded-md">
          <h4 class="font-medium text-gray-700 mb-2">Notable Journals</h4>
          <div id="pubmedJournals" class="text-sm"></div>
        </div>
      </div>
    </div>
  </div>
    <!-- Articles List -->
    <div id="pubmedArticles" class="hidden">
      <div class="mb-4 flex justify-between items-center">
        <div>
          <select id="pubmedSort" class="rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-sm">
            <option value="relevance">Sort by Relevance</option>
            <option value="date">Sort by Date (Newest)</option>
            <option value="citationCount">Sort by Citation Count</option>
          </select>
        </div>
        <div>
          <label class="inline-flex items-center text-sm">
            <input type="checkbox" id="pubmedFullTextOnly" class="rounded border-gray-300 text-primary focus:ring-primary">
            <span class="ml-2">Full text only</span>
          </label>
        </div>
      </div>
      
      <div id="pubmedArticlesList" class="space-y-4">
        <!-- Articles will be inserted here dynamically -->
      </div>
      
      <div class="mt-6 text-center" id="pubmedPagination">
        <button id="pubmedLoadMore" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">
          Load More Articles
        </button>
      </div>
    </div>
  </section>


<!-- EMA Data Section -->
<section id="emaDataSection" class=" hidden mb-6">
  <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">European Medicines Agency (EMA) Data</h2>
      <div class="flex items-center" style="display: none;">
        <span id="emaDataLastUpdated" class="text-xs text-gray-500 mr-2" >Last updated: Loading...</span>
        <button id="refreshEmaDataBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        </button>
      </div>
    </div>
    
    <!-- EMA Data Tabs -->
    <div class="mb-6 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
                  id="ema-approval-tab" 
                  data-tab="ema-approval-content"
                  aria-selected="true">
            EMA Approvals
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-orphan-tab" 
                  data-tab="ema-orphan-content"
                  aria-selected="false">
            Orphan Designations
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-safety-tab" 
                  data-tab="ema-safety-content"
                  aria-selected="false">
            Safety Communications
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-psusa-tab" 
                  data-tab="ema-psusa-content"
                  aria-selected="false">
            PSUSA
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-referrals-tab" 
                  data-tab="ema-referrals-content"
                  aria-selected="false">
            Referrals
          </button>
        </li>
        <li role="presentation">
          <button class="ema-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ema-shortages-tab" 
                  data-tab="ema-shortages-content"
                  aria-selected="false">
            Shortages
          </button>
        </li>
      </ul>
    </div>
    
    <!-- EMA Tab Content -->
    <div class="ema-tab-content">
      <!-- EMA Approvals Tab Content -->
      <div id="ema-approval-content" class="ema-tab-pane active">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Marketing Authorizations</h3>
          <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full" id="emaApprovalCount">0 approvals</span>
        </div>
        <div class="ema-data-container" id="emaApprovalData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>EMA approval data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- Orphan Designations Tab Content -->
      <div id="ema-orphan-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Orphan Drug Designations</h3>
          <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full" id="emaOrphanCount">0 designations</span>
        </div>
        <div class="ema-data-container" id="emaOrphanData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <span>Orphan designation data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- Safety Communications Tab Content -->
      <div id="ema-safety-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Safety Communications (DHPCs)</h3>
          <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full" id="emaSafetyCount">0 communications</span>
        </div>
        <div class="ema-data-container" id="emaSafetyData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>Safety communication data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- PSUSA Tab Content -->
      <div id="ema-psusa-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Periodic Safety Update Reports</h3>
          <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full" id="emaPsusaCount">0 reports</span>
        </div>
        <div class="ema-data-container" id="emaPsusaData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>PSUSA data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- Referrals Tab Content -->
      <div id="ema-referrals-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Referral Procedures</h3>
          <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full" id="emaReferralsCount">0 referrals</span>
        </div>
        <div class="ema-data-container" id="emaReferralsData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
            </svg>
            <span>Referral procedure data will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
      
      <!-- Shortages Tab Content -->
      <div id="ema-shortages-content" class="ema-tab-pane hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Medicine Shortages</h3>
          <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full" id="emaShortagesCount">0 shortages</span>
        </div>
        <div class="ema-data-container" id="emaShortagesData">
          <div class="flex justify-center items-center py-8 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span>Shortage information will be available here once you search for a drug</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- File Upload Section for Admin -->
    <div class="mt-8 pt-6 border-t border-gray-200" id="emaDataAdmin">
      <h3 class="text-lg font-medium mb-4">Data Management</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload DHPC Data</h4>
          <form id="dhpcUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="dhpcFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload DHPC File
            </button>
          </form>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload PSUSA Data</h4>
          <form id="psusaUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="psusaFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload PSUSA File
            </button>
          </form>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload Shortages Data</h4>
          <form id="shortagesUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="shortagesFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload Shortages File
            </button>
          </form>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload Medicines Data</h4>
          <form id="medicinesUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="medicinesFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload Medicines File
            </button>
          </form>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Upload Referrals Data</h4>
          <form id="referralsUploadForm" class="flex flex-col space-y-2">
            <input type="file" id="referralsFileInput" accept=".csv" class="text-sm">
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
              Upload Referrals File
            </button>
          </form>
        </div>
      </div>
      <div id="uploadStatus" class="mt-4 hidden"></div>
    </div>
    
    <div class="text-center mt-4">
      <p class="text-xs text-gray-500">
        Data sourced from the European Medicines Agency (EMA) public database.
      </p>
    </div>
  </div>
</section>

        <section id="fdaDataSection" class="hidden mb-6">
            <style>
                /* FDA Data Section Styles */
.fda-tab-button {
  transition: all 0.2s ease-in-out;
}

.fda-tab-button:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.fda-tab-pane {
  display: none;
}

.fda-tab-pane.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

/* FDA Card Styles */
.product-card {
  transition: all 0.2s ease-in-out;
}

.product-card:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Timeline Styling */
.timeline-dot {
  position: absolute;
  left: -6px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.timeline-line {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 2px;
  background-color: #e5e7eb;
}

/* Animation effects */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateY(10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.fade-in {
  animation: fadeIn 0.3s ease-out;
}

.slide-in {
  animation: slideIn 0.3s ease-out;
}

/* Card hover effects */
.hover-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.hover-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

/* Badge styles */
.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.badge-blue {
  background-color: #e0f2fe;
  color: #0369a1;
}

.badge-green {
  background-color: #dcfce7;
  color: #166534;
}

.badge-yellow {
  background-color: #fef9c3;
  color: #854d0e;
}

.badge-red {
  background-color: #fee2e2;
  color: #b91c1c;
}

.badge-purple {
  background-color: #f3e8ff;
  color: #7e22ce;
}

/* Custom scrollbar for overflow content */
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background-color: #f3f4f6;
  border-radius: 8px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: #d1d5db;
  border-radius: 8px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: #9ca3af;
}

/* Table styling */
.table-compact th,
.table-compact td {
  padding: 0.5rem 0.75rem;
}

.table-hover tr:hover {
  background-color: #f9fafb;
}

.table-striped tbody tr:nth-child(odd) {
  background-color: #f9fafb;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .responsive-table {
    display: block;
    width: 100%;
    overflow-x: auto;
  }
  
  .mobile-card {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    padding: 1rem;
  }
  
  .mobile-card-label {
    font-weight: 500;
    color: #6b7280;
    font-size: 0.75rem;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
  }
  
  .mobile-card-value {
    margin-bottom: 0.75rem;
  }
}

/* Chart container styles */
#adverse-events-chart {
  height: 300px; /* Fixed height to ensure chart is visible */
  position: relative;
  width: 100%;
  min-height: 300px;
  background-color: white;
  padding: 16px;
  border-radius: 8px;
}

/* Bar chart specific styles */
.chart-bar {
  transition: all 0.3s ease;
  background-color: #3b82f6;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  width: 100%;
  max-width: 30px;
  margin: 0 auto;
}

.chart-bar:hover {
  background-color: #2563eb;
  transform: scaleY(1.05);
  transform-origin: bottom;
}

.chart-bar-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: relative;
}

.chart-bar-value {
  font-size: 0.75rem;
  color: #4b5563;
  position: absolute;
  top: -20px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.chart-bar-container:hover .chart-bar-value {
  opacity: 1;
}

.chart-bar-label {
  font-size: 0.75rem;
  color: #4b5563;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 80px;
  text-align: center;
  transform: rotate(-45deg);
  transform-origin: right top;
  position: absolute;
  bottom: -24px;
  right: 50%;
}

/* Grid lines */
.chart-grid-line {
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
  background-color: #e5e7eb;
}

.chart-y-axis {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 40px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  padding: 8px 0;
}

.chart-y-label {
  font-size: 0.75rem;
  color: #6b7280;
  text-align: right;
  padding-right: 8px;
}

/* Make sure chart is responsive */
@media (max-width: 640px) {
  #adverse-events-chart {
    height: 240px;
    min-height: 240px;
    padding: 12px;
  }
  
  .chart-bar-label {
    max-width: 60px;
    font-size: 0.7rem;
  }
}

/* Animation for chart loading */
@keyframes barGrow {
  from { height: 0; }
  to { height: var(--bar-height); }
}

.animate-bar {
  animation: barGrow 1s ease-out forwards;
  height: 0;
}
            </style>
            <div class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-xl font-semibold mb-4">FDA Regulatory Information</h2>
              
              <div class="mb-6">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium">FDA Documents</h3>
                  <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full" id="fdaDocCount">0 documents</span>
                </div>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="fdaDocuments">
                  <div class="flex justify-center items-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>FDA document data will be available here</span>
                  </div>
                </div>
              </div>
              
              <div class="mb-6">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium">Orange Book Information</h3>
                  <span class="text-xs px-2 py-1 bg-orange-100 text-orange-800 rounded-full" id="orangeBookCount">0 entries</span>
                </div>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="orangeBookData">
                  <div class="flex justify-center items-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    <span>Orange Book listings will be available here</span>
                  </div>
                </div>
              </div>
              
              <div class="mb-6">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium">DailyMed Information</h3>
                  <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full" id="dailyMedCount">0 entries</span>
                </div>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="dailyMedData">
                  <div class="flex justify-center items-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>DailyMed information will be available here</span>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium">FDA Warning Letters</h3>
                  <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full" id="warningLettersCount">0 letters</span>
                </div>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg" id="warningLettersData">
                  <div class="flex justify-center items-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <span>Warning letters will be available here</span>
                  </div>
                </div>
              </div>
              
              <div class="text-center mt-6">
                <p class="text-sm text-gray-500">
                  Data sourced from FDA.gov, DailyMed, and FDA Orange Book. Last updated: March 2025
                </p>
              </div>
            </div>
          </section>



        <div class="bg-white p-4 rounded-lg shadow mb-6 hidden">
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-1">
                <label for="trial-selection" class="block text-sm font-medium text-gray-700 mb-1">Select a trial</label>
                <select id="trial-selection" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                  <option value="">-- Select a trial --</option>
                </select>
              </div>
              <div class="flex items-end">
                <button id="visualize-btn" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                  Visualize Trial
                </button>
              </div>
            </div>
            <div class="mt-4" id="loading-indicator" style="display: none;">
              <div class="flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 text-indigo-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Generating visualization...</span>
              </div>
            </div>
         
          
          <!-- Empty div that will be populated with visualization -->
          <div id="visualization-container" class="bg-white p-4 rounded-lg shadow min-h-[500px]"></div>
        </div>
      

<!-- Overall Drug Success Rate Section -->
<section id="drugSuccessSection" style="border: 1px solid blue;" class="hidden mb-6" style="display: none;">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold mb-4">Overall Drug Success Rates</h2>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Treatment Efficacy Comparison Across Trials</h3>
        <p class="text-sm text-gray-600 mb-4">This visualization combines data from all trials to show overall effectiveness of treatments. Higher values indicate better outcomes relative to placebo.</p>
        <div class="h-72">
          <canvas id="overallDrugSuccessChart"></canvas>
        </div>
      </div>
  
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <h3 class="text-lg font-medium mb-3">Response Rate Distribution</h3>
          <p class="text-sm text-gray-600 mb-2">Percentage of patients who responded to treatment</p>
          <div class="h-64">
            <canvas id="responseRateChart"></canvas>
          </div>
        </div>
        <div>
          <h3 class="text-lg font-medium mb-3">Remission Rate Distribution</h3>
          <p class="text-sm text-gray-600 mb-2">Percentage of patients who achieved remission</p>
          <div class="h-64">
            <canvas id="remissionRateChart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Statistical Summary by Drug</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white border border-gray-200">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b text-left">Drug</th>
                <th class="py-2 px-4 border-b text-left">Trials</th>
                <th class="py-2 px-4 border-b text-left">Total Patients</th>
                <th class="py-2 px-4 border-b text-left">Avg. Effect Size</th>
                <th class="py-2 px-4 border-b text-left">Response Rate</th>
                <th class="py-2 px-4 border-b text-left">Remission Rate</th>
              </tr>
            </thead>
            <tbody id="drugSuccessSummaryTable">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
        <!-- Results Overview -->
        <section id="resultsOverview" class="hidden mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Results Overview</h2>
                <div id="resultsSummary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Will be populated dynamically -->
                </div>
                <div class="flex flex-wrap gap-2 mb-4" id="phaseFilter">
                    <button class="phase-filter bg-primary text-white px-3 py-1 rounded-full text-sm" data-phase="all">All Phases</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PRE_PHASE">Pre-Phase</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE1">Phase 1</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE2">Phase 2</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE3">Phase 3</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE4">Phase 4</button>
                    <button class="phase-filter bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full text-sm" data-phase="PHASE1_PHASE2">Phase 1/2</button>
                </div>
            </div>
        </section>

        <!-- Collated Outcomes Section -->
<!-- Enhanced Collated Outcomes Section -->
<section id="collatedOutcomesSection" style="border: 1px solid red;" class="hidden mb-6" style="display: none;">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold mb-4">Collated Trial Outcomes</h2>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Overall Treatment Effect Distribution</h3>
        <div class="flex justify-between mb-4">
          <div>
            <select id="outcomeMetricSelector" class="p-2 border border-gray-300 rounded-lg">
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <div>
            <select id="outcomeTypeSelector" class="p-2 border border-gray-300 rounded-lg">
              <option value="all">All Outcomes</option>
              <option value="primary" selected>Primary Outcomes</option>
              <option value="secondary">Secondary Outcomes</option>
            </select>
          </div>
        </div>
        <div class="h-72">
          <canvas id="overallTreatmentEffectChart"></canvas>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Phase Comparison</h3>
        <p class="text-sm text-gray-600 mb-4">Compare effect sizes across different clinical trial phases. Higher values indicate better outcomes.</p>
        <div class="h-72">
          <canvas id="phaseComparisonChart"></canvas>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-lg font-medium mb-3">Comparative Phase Performance</h3>
        <p class="text-sm text-gray-600 mb-4">Direct comparison of phase-specific effect sizes with confidence intervals.</p>
        <div class="h-72">
          <canvas id="phasePerformanceChart"></canvas>
        </div>
      </div>
      
      <div class="mt-8">
        <h3 class="text-lg font-medium mb-3">Statistical Summary</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white border border-gray-200">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b text-left">Phase</th>
                <th class="py-2 px-4 border-b text-left">Trials</th>
                <th class="py-2 px-4 border-b text-left">Mean Effect</th>
                <th class="py-2 px-4 border-b text-left">Standard Deviation</th>
                <th class="py-2 px-4 border-b text-left">95% CI</th>
                <th class="py-2 px-4 border-b text-left">p-value</th>
              </tr>
            </thead>
            <tbody id="statisticalSummaryTable">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
  
  <!-- New FDA Data Section -->


        <!-- Studies List -->
        <section id="studiesSection" class="hidden mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Studies (<span id="studyCount">0</span>)</h2>
                <div id="studiesList" class="space-y-4">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Aggregate Outcomes Section -->
        <section id="aggregateOutcomesSection" class="hidden mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Aggregate Outcomes by Phase</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-3">Overall Effectiveness Distribution</h3>
                    <canvas id="overallDistributionChart" height="300"></canvas>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium mb-3">Phase 1-2 Outcomes</h3>
                        <canvas id="earlyPhasesChart" height="250"></canvas>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-3">Phase 3-4 Outcomes</h3>
                        <canvas id="latePhasesChart" height="250"></canvas>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-medium mb-3">Primary Outcome Measures Across Phases</h3>
                    <div id="outcomeMeasuresList" class="space-y-4">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Study Detail Section -->
        <section id="studyDetailSection" class="hidden mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Study Details</h2>
                    <button id="closeStudyDetail" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="studyDetailContent">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </section>
    </main>

    <script>
        // API Base URL - Use our local backend
        const API_BASE_URL = "https://sunday-fsfq.onrender.com/api";
        //  const API_BASE_URL = 'http://localhost:3000/api';

        // State management
        const appState = {
            studies: [],
            currentStudyId: null,
            currentPhaseFilter: 'all',
            allOutcomeMeasures: [],
            collatedOutcomes: [],
            hasResultsOnly: true,
            trdFocusOnly: true,
            studyDetails: {},
            outcomeMetrics: [],
            currentOutcomeMetric: '',
            currentOutcomeType: 'primary',
            failedStudyIds: new Set() // Track failed study ID requests to avoid repeated failures
        };
        appState.fdaData = {
    documents: [],
    orangeBook: [],
    dailyMed: [],
    warningLetters: []
};
appState.allTrialOutcomes = [];


        // DOM elements
        const elements = {
            drugSearch: document.getElementById('drugSearch'),
            conditionSearch: document.getElementById('conditionSearch'),
            hasResultsOnly: document.getElementById('hasResultsOnly'),
            trdFocusOnly: document.getElementById('trdFocusOnly'),
            searchButton: document.getElementById('searchButton'),
            loadingState: document.getElementById('loadingState'),
            placeholderMessage: document.getElementById('placeholderMessage'),
            resultsOverview: document.getElementById('resultsOverview'),
            resultsSummary: document.getElementById('resultsSummary'),
            studiesSection: document.getElementById('studiesSection'),
            studyCount: document.getElementById('studyCount'),
            studiesList: document.getElementById('studiesList'),
            aggregateOutcomesSection: document.getElementById('aggregateOutcomesSection'),
            collatedOutcomesSection: document.getElementById('collatedOutcomesSection'),
            studyDetailSection: document.getElementById('studyDetailSection'),
            closeStudyDetail: document.getElementById('closeStudyDetail'),
            studyDetailContent: document.getElementById('studyDetailContent'),
            phaseFilter: document.getElementById('phaseFilter'),
            outcomeMetricSelector: document.getElementById('outcomeMetricSelector'),
            outcomeTypeSelector: document.getElementById('outcomeTypeSelector'),
            statisticalSummaryTable: document.getElementById('statisticalSummaryTable')
        
        };
        elements.fdaDataSection = document.getElementById('fdaDataSection');
elements.fdaDocuments = document.getElementById('fdaDocuments');
elements.orangeBookData = document.getElementById('orangeBookData');
elements.dailyMedData = document.getElementById('dailyMedData');
elements.warningLettersData = document.getElementById('warningLettersData');
elements.fdaDocCount = document.getElementById('fdaDocCount');
elements.orangeBookCount = document.getElementById('orangeBookCount');
elements.dailyMedCount = document.getElementById('dailyMedCount');
elements.warningLettersCount = document.getElementById('warningLettersCount');
elements.phasePerformanceChart = document.getElementById('phasePerformanceChart');

        // Chart instances
        let charts = {
            overallDistribution: null,
            earlyPhases: null,
            latePhases: null,
            overallTreatmentEffect: null,
            phaseComparison: null,
            phasePerformance : null,
            studySpecific: {}
        };
// Add new elements to the DOM references
elements.drugSuccessSection = document.getElementById('drugSuccessSection');
elements.drugSuccessSummaryTable = document.getElementById('drugSuccessSummaryTable');

// Add new chart references
charts.overallDrugSuccess = null;
charts.responseRate = null;
charts.remissionRate = null;

// Function to analyze and display overall drug success rates
// Improved display function with error handling
function displayDrugSuccessRates() {
    console.log("Analyzing overall drug success rates...");
    
    try {
        // Only show if we have data
        if (appState.allTrialOutcomes.length === 0) {
            console.warn("No trial outcome data available for drug success visualization");
            return;
        }
        
        // Make sure the section is visible
        showSection(elements.drugSuccessSection, true);
        
        // Ensure chart canvases exist
        ensureDrugSuccessChartCanvasesExist();
        
        // Compute drug-specific data
        const drugData = analyzeDrugSuccessData();
        
        if (drugData.length === 0) {
            console.warn("No processed drug data available for visualization");
            elements.drugSuccessSection.querySelector('.bg-white').innerHTML = `
                <div class="text-center py-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <p class="text-lg text-gray-600">Insufficient outcome data for drug success visualization</p>
                    <p class="mt-2 text-sm text-gray-500">Try searching for more studies or including studies without TRD focus</p>
                </div>
            `;
            return;
        }
        
        // Create visualizations
        createOverallDrugSuccessChart(drugData);
        createResponseRateChart(drugData);
        createRemissionRateChart(drugData);
        createDrugSuccessSummaryTable(drugData);
        
        // Create additional visualizations
        createCombinedMeasuresChart();
        createTreatmentOutcomeCurve();
        
    } catch (error) {
        console.error("Error in displayDrugSuccessRates:", error);
        
        // Add error message to drug success section
        if (elements.drugSuccessSection) {
            elements.drugSuccessSection.querySelector('.bg-white').innerHTML += `
                <div class="bg-red-50 text-red-700 p-4 rounded-lg mt-4">
                    <p>Error analyzing drug success rates: ${error.message}</p>
                    <p class="text-sm mt-2">This is likely due to an issue with the outcome data format.</p>
                </div>
            `;
        }
    }
}

// Function to ensure drug success chart canvases exist
function ensureDrugSuccessChartCanvasesExist() {
    // Get the drug success section
    const section = document.getElementById('drugSuccessSection');
    if (!section) {
        console.error("Drug success section not found");
        return;
    }
    
    // Define the chart canvases we need to check/create
    const chartCanvases = [
        { id: 'overallDrugSuccessChart', containerSelector: '.h-72' },
        { id: 'responseRateChart', containerSelector: '.h-64:nth-of-type(1)' },
        { id: 'remissionRateChart', containerSelector: '.h-64:nth-of-type(2)' }
    ];
    
    // Check each canvas
    chartCanvases.forEach(({ id, containerSelector }) => {
        // First check if the canvas already exists
        if (!document.getElementById(id)) {
            console.log(`Canvas ${id} not found, attempting to create`);
            
            // Find the container using the selector within the drug success section
            const containers = section.querySelectorAll(containerSelector);
            let container = null;
            
            if (containers && containers.length > 0) {
                // Use the first matching container
                container = containers[0];
            }
            
            // If we found a container, create the canvas inside it
            if (container) {
                container.innerHTML = `<canvas id="${id}"></canvas>`;
                console.log(`Created canvas: ${id}`);
            } else {
                console.error(`Container not found for ${id} using selector ${containerSelector}`);
                
                // Alternative approach: find container based on nearby heading text
                const headings = section.querySelectorAll('h3');
                for (let i = 0; i < headings.length; i++) {
                    const heading = headings[i];
                    
                    // Determine which heading might correspond to which chart
                    let targetId = null;
                    if (heading.textContent.includes("Treatment Effect") || 
                        heading.textContent.includes("Efficacy")) {
                        targetId = 'overallDrugSuccessChart';
                    } else if (heading.textContent.includes("Response Rate")) {
                        targetId = 'responseRateChart';
                    } else if (heading.textContent.includes("Remission Rate")) {
                        targetId = 'remissionRateChart';
                    }
                    
                    // If this heading matches our target and it's followed by a container
                    if (targetId === id && heading.nextElementSibling) {
                        const possibleContainer = heading.nextElementSibling;
                        possibleContainer.innerHTML = `<canvas id="${id}"></canvas>`;
                        console.log(`Created canvas ${id} in container after heading: ${heading.textContent}`);
                        break;
                    }
                }
            }
        }
    });
}

function updateNavigationBar() {
    const navbar = document.querySelector('.fixed.bottom-4');
    if (!navbar) return;
    
    // Check if we already have the drug success button
    if (!document.getElementById('nav-drug-success')) {
        const newButton = document.createElement('button');
        newButton.id = 'nav-drug-success';
        newButton.className = 'text-primary hover:text-blue-700 text-sm font-medium';
        newButton.textContent = 'Success Rates';

        const emaButton = document.createElement('button');
    emaButton.id = 'nav-ema';
    emaButton.className = 'text-primary hover:text-blue-700 text-sm font-medium';
    emaButton.textContent = 'EMA Data';

    if (fdaButton) {
        navDiv.insertBefore(emaButton, fdaButton);
    } else {
        navDiv.appendChild(emaButton);
    }
        
        // Insert before the FDA data button
        const fdaButton = document.getElementById('nav-fda');
        if (fdaButton) {
            navbar.querySelector('div').insertBefore(newButton, fdaButton);
        } else {
            navbar.querySelector('div').appendChild(newButton);
        }
        
        // Add event listener
        newButton.addEventListener('click', () => {
            elements.drugSuccessSection.scrollIntoView({ behavior: 'smooth' });
        });

        emaButton.addEventListener('click', () => {
        elements.emaDataSection.scrollIntoView({ behavior: 'smooth' });
    });
    }
}

// Function to extract drug names from intervention data
function extractDrugName(studyTitle, measurements) {
    // Try to identify the drug from group titles first
    const experimentalGroups = measurements.filter(m => !m.isControlGroup);
    if (experimentalGroups.length > 0) {
        // Extract drug name from experimental group title
        const groupTitle = experimentalGroups[0].groupTitle.toLowerCase();
        
        // Look for common drug names
        const drugPatterns = [
            { pattern: /ketamine/i, name: "Ketamine" },
            { pattern: /esketamine/i, name: "Esketamine" },
            { pattern: /pcn-101/i, name: "PCN-101" },
            { pattern: /mij821/i, name: "MIJ821" },
            { pattern: /comp360/i, name: "COMP360" },
            { pattern: /psilocybin/i, name: "Psilocybin" },
            { pattern: /brexpiprazole/i, name: "Brexpiprazole" },
            { pattern: /quetiapine/i, name: "Quetiapine" }
        ];
        
        for (const { pattern, name } of drugPatterns) {
            if (pattern.test(groupTitle)) {
                return name;
            }
        }
    }
    
    // If not found in group titles, try to extract from study title
    const studyTitleLower = studyTitle.toLowerCase();
    for (const drugName of ["Ketamine", "Esketamine", "PCN-101", "MIJ821", "COMP360", "Psilocybin", "Brexpiprazole", "Quetiapine"]) {
        if (studyTitleLower.includes(drugName.toLowerCase())) {
            return drugName;
        }
    }
    
    // Default fallback
    return "Unknown";
}

// Function to analyze outcome data and calculate success metrics
function analyzeDrugSuccessData() {
    const drugData = {};
    
    // First group data by drug
    appState.allTrialOutcomes.forEach(study => {
        // Skip studies without outcomes
        if (!study.outcomes || study.outcomes.length === 0) return;
        
        // Process each outcome
        study.outcomes.forEach(outcome => {
            // Skip outcomes without measurement data
            if (!outcome.measurements || outcome.measurements.length === 0) return;
            
            // Extract drug name
            const drugName = extractDrugName(study.title, outcome.measurements);
            
            // Initialize drug data if needed
            if (!drugData[drugName]) {
                drugData[drugName] = {
                    name: drugName,
                    trials: new Set(),
                    totalPatients: 0,
                    effectSizes: [],
                    experimentalValues: [],
                    controlValues: [],
                    responseRates: [],
                    remissionRates: [],
                    outcomeMeasures: new Set()
                };
            }
            
            // Add this trial to the set
            drugData[drugName].trials.add(study.nctId);
            
            // Track outcome measure
            drugData[drugName].outcomeMeasures.add(outcome.title);
            
            // Add effect size if available
            if (outcome.effectSize !== null) {
                drugData[drugName].effectSizes.push(outcome.effectSize);
            }
            
            // Add experimental and control values
            if (outcome.experimentalValue !== null) {
                drugData[drugName].experimentalValues.push(outcome.experimentalValue);
                drugData[drugName].totalPatients += outcome.experimentalSampleSize || 0;
            }
            
            if (outcome.controlValue !== null) {
                drugData[drugName].controlValues.push(outcome.controlValue);
            }
            
            // Check for response and remission rates
            const titleLower = outcome.title.toLowerCase();
            const isResponseOutcome = titleLower.includes(">= 50% improvement") || 
                                     titleLower.includes("responders") || 
                                     titleLower.includes("response rate");
                                     
            const isRemissionOutcome = titleLower.includes("<= 10") || 
                                      titleLower.includes("remission") ||
                                      (titleLower.includes("madrs") && titleLower.includes("<=") && titleLower.includes("7"));
            
            // Extract the rates from measurements
            if (isResponseOutcome || isRemissionOutcome) {
                const experimentalMeasurements = outcome.measurements.filter(m => !m.isControlGroup);
                const controlMeasurements = outcome.measurements.filter(m => m.isControlGroup);
                
                if (experimentalMeasurements.length > 0) {
                    // For response/remission, measurements are usually percentages
                    const experimentalRate = experimentalMeasurements.reduce((sum, m) => sum + m.value, 0) / experimentalMeasurements.length;
                    
                    if (isResponseOutcome) {
                        drugData[drugName].responseRates.push(experimentalRate);
                    }
                    
                    if (isRemissionOutcome) {
                        drugData[drugName].remissionRates.push(experimentalRate);
                    }
                }
            }
        });
    });
    
    // Convert to array and calculate averages
    const result = Object.values(drugData).map(drug => {
        return {
            name: drug.name,
            trialCount: drug.trials.size,
            totalPatients: drug.totalPatients,
            avgEffectSize: drug.effectSizes.length > 0 ? calculateMean(drug.effectSizes) : null,
            stdDevEffectSize: drug.effectSizes.length > 0 ? calculateStandardDeviation(drug.effectSizes) : null,
            avgResponseRate: drug.responseRates.length > 0 ? calculateMean(drug.responseRates) : null,
            avgRemissionRate: drug.remissionRates.length > 0 ? calculateMean(drug.remissionRates) : null,
            outcomeMeasures: Array.from(drug.outcomeMeasures)
        };
    }).filter(drug => drug.trialCount > 0 && (drug.avgEffectSize !== null || drug.avgResponseRate !== null));
    
    // Sort by number of trials (descending)
    result.sort((a, b) => b.trialCount - a.trialCount);
    
    console.log("Analyzed drug success data:", result);
    
    return result;
}

// Function to create the overall drug success chart
function createOverallDrugSuccessChart(drugData) {
    const canvasId = 'overallDrugSuccessChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.error(`Canvas not found: ${canvasId}`);
        return;
    }
    
    // Clear previous chart
    if (charts.overallDrugSuccess) {
        charts.overallDrugSuccess.destroy();
    }
    
    // Filter data to drugs with effect sizes
    const drugsWithEffectSizes = drugData.filter(drug => drug.avgEffectSize !== null);
    
    if (drugsWithEffectSizes.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No effect size data available for comparison.</p>';
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Create bar chart for drug comparison
    charts.overallDrugSuccess = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: drugsWithEffectSizes.map(drug => drug.name),
            datasets: [{
                label: 'Average Effect Size',
                data: drugsWithEffectSizes.map(drug => drug.avgEffectSize),
                backgroundColor: drugsWithEffectSizes.map((_, i) => getColorByIndex(i, 0.7)),
                borderColor: drugsWithEffectSizes.map((_, i) => getColorByIndex(i)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // Horizontal bar chart
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Effect Size (standardized)'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Drug'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const index = context.dataIndex;
                            const drug = drugsWithEffectSizes[index];
                            return [
                                `Effect Size: ${drug.avgEffectSize.toFixed(2)}`,
                                `Trials: ${drug.trialCount}`,
                                `Patients: ${drug.totalPatients}`
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Function to create the response rate chart
function createResponseRateChart(drugData) {
    const canvasId = 'responseRateChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.error(`Canvas not found: ${canvasId}`);
        return;
    }
    
    // Clear previous chart
    if (charts.responseRate) {
        charts.responseRate.destroy();
    }
    
    // Filter data to drugs with response rates
    const drugsWithResponseRates = drugData.filter(drug => drug.avgResponseRate !== null);
    
    if (drugsWithResponseRates.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No response rate data available.</p>';
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Create pie chart for response rates
    charts.responseRate = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: drugsWithResponseRates.map(drug => drug.name),
            datasets: [{
                data: drugsWithResponseRates.map(drug => drug.avgResponseRate),
                backgroundColor: drugsWithResponseRates.map((_, i) => getColorByIndex(i, 0.7)),
                borderColor: drugsWithResponseRates.map((_, i) => getColorByIndex(i)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const index = context.dataIndex;
                            const drug = drugsWithResponseRates[index];
                            return [
                                `${drug.name}: ${drug.avgResponseRate.toFixed(1)}%`,
                                `Trials: ${drug.trialCount}`
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Function to create the remission rate chart
function createRemissionRateChart(drugData) {
    const canvasId = 'remissionRateChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.error(`Canvas not found: ${canvasId}`);
        return;
    }
    
    // Clear previous chart
    if (charts.remissionRate) {
        charts.remissionRate.destroy();
    }
    
    // Filter data to drugs with remission rates
    const drugsWithRemissionRates = drugData.filter(drug => drug.avgRemissionRate !== null);
    
    if (drugsWithRemissionRates.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No remission rate data available.</p>';
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Create pie chart for remission rates
    charts.remissionRate = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: drugsWithRemissionRates.map(drug => drug.name),
            datasets: [{
                data: drugsWithRemissionRates.map(drug => drug.avgRemissionRate),
                backgroundColor: drugsWithRemissionRates.map((_, i) => getColorByIndex(i, 0.7)),
                borderColor: drugsWithRemissionRates.map((_, i) => getColorByIndex(i)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const index = context.dataIndex;
                            const drug = drugsWithRemissionRates[index];
                            return [
                                `${drug.name}: ${drug.avgRemissionRate.toFixed(1)}%`,
                                `Trials: ${drug.trialCount}`
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Function to create the drug success summary table
function createDrugSuccessSummaryTable(drugData) {
    const table = elements.drugSuccessSummaryTable;
    if (!table) {
        console.error("Drug success summary table element not found");
        return;
    }
    
    table.innerHTML = '';
    
    if (drugData.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">No drug data available for summary.</td></tr>';
        return;
    }
    
    // Create a row for each drug
    drugData.forEach(drug => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="py-2 px-4 border-b">${drug.name}</td>
            <td class="py-2 px-4 border-b">${drug.trialCount}</td>
            <td class="py-2 px-4 border-b">${drug.totalPatients}</td>
            <td class="py-2 px-4 border-b">${drug.avgEffectSize !== null ? drug.avgEffectSize.toFixed(2) : 'N/A'}</td>
            <td class="py-2 px-4 border-b">${drug.avgResponseRate !== null ? drug.avgResponseRate.toFixed(1) + '%' : 'N/A'}</td>
            <td class="py-2 px-4 border-b">${drug.avgRemissionRate !== null ? drug.avgRemissionRate.toFixed(1) + '%' : 'N/A'}</td>
        `;
        table.appendChild(row);
    });
}

// Helper function to get a color by index
function getColorByIndex(index, alpha = 1) {
    const colors = [
        `rgba(59, 130, 246, ${alpha})`,   // blue
        `rgba(16, 185, 129, ${alpha})`,   // emerald
        `rgba(139, 92, 246, ${alpha})`,   // violet
        `rgba(249, 115, 22, ${alpha})`,   // orange
        `rgba(236, 72, 153, ${alpha})`,   // pink
        `rgba(14, 165, 233, ${alpha})`,   // sky
        `rgba(168, 85, 247, ${alpha})`,   // purple
        `rgba(234, 88, 12, ${alpha})`,    // amber
        `rgba(22, 163, 74, ${alpha})`,    // green
        `rgba(79, 70, 229, ${alpha})`     // indigo
    ];
    
    return colors[index % colors.length];
}
        // Helper functions
        function displayLoading(show) {
            elements.loadingState.classList.toggle('hidden', !show);
            elements.placeholderMessage.classList.toggle('hidden', show);
        }

        function showSection(section, show = true) {
            section.classList.toggle('hidden', !show);
        }

        function formatPhase(phase) {
            if (!phase) return 'N/A';
            return phase
                .replace('PHASE', 'Phase ')
                .replace('PRE_', 'Pre-')
                .replace('_', '/');
        }

        function getPhaseColor(phase) {
            const colors = {
                'PRE_PHASE': '#9ca3af', // gray-400
                'PHASE1': '#60a5fa', // blue-400
                'PHASE2': '#34d399', // emerald-400
                'PHASE3': '#a78bfa', // violet-400
                'PHASE4': '#f97316', // orange-500
                'PHASE1_PHASE2': '#38bdf8' // sky-400
            };
            return colors[phase] || '#9ca3af';
        }

        function getStatusBadge(status) {
            const statusClasses = {
                'COMPLETED': 'bg-green-100 text-green-800',
                'RECRUITING': 'bg-blue-100 text-blue-800',
                'NOT_YET_RECRUITING': 'bg-yellow-100 text-yellow-800',
                'ACTIVE_NOT_RECRUITING': 'bg-indigo-100 text-indigo-800',
                'TERMINATED': 'bg-red-100 text-red-800',
                'WITHDRAWN': 'bg-gray-100 text-gray-800',
                'SUSPENDED': 'bg-orange-100 text-orange-800',
                'ENROLLING_BY_INVITATION': 'bg-purple-100 text-purple-800',
                'AVAILABLE': 'bg-teal-100 text-teal-800',
                'NO_LONGER_AVAILABLE': 'bg-gray-100 text-gray-800',
                'APPROVED_FOR_MARKETING': 'bg-green-100 text-green-800',
                'WITHHELD': 'bg-gray-100 text-gray-800',
                'UNKNOWN': 'bg-gray-100 text-gray-800'
            };

            const className = statusClasses[status] || 'bg-gray-100 text-gray-800';
            const label = status.replace(/_/g, ' ').toLowerCase();
            
            return `<span class="px-2 py-1 text-xs font-medium rounded-full ${className} capitalize">${label}</span>`;
        }

        // API functions
        //  async function fetchStudies(drug, condition, hasResults) {
        //     try {
        //         condition = condition || "Treatment Resistant Depression";
                
        //         // Using our backend endpoint
        //         const params = {
        //             condition: condition,
        //             intervention: drug,
        //             hasResults: hasResults,
        //             fields: "protocolSection,resultsSection,hasResults",
        //             pageSize: 100
        //         };
                
        //         console.log("Fetching studies with params:", params);
        //         const response = await axios.get(`${API_BASE_URL}/studies/search`, { 
        //             params,
        //             headers: {
        //                 'Accept': 'application/json',
        //                 'Cache-Control': 'no-cache',
        //                 'Pragma': 'no-cache'
        //             }
        //         });
                
        //         console.log("Studies search response status:", response.status);
        //         let studies = response.data.data.studies || [];
                
        //         return studies;
        //     } catch (error) {
        //         console.error("Error fetching studies:", error);
        //         return [];
        //     }
        // }

        // async function fetchStudyDetails(nctId) {
        //     // Skip if we've already failed to fetch this study
        //     if (appState.failedStudyIds.has(nctId)) {
        //         console.log(`Skipping already failed study ID: ${nctId}`);
        //         return null;
        //     }
            
        //     try {
        //         console.log(`Fetching details for study: ${nctId}`);
        //         const response = await axios.get(`${API_BASE_URL}/studies/${nctId}`, {
        //             params: {
        //                 timestamp: new Date().getTime() // Add timestamp to prevent caching
        //             },
        //             headers: {
        //                 'Accept': 'application/json',
        //                 'Cache-Control': 'no-cache',
        //                 'Pragma': 'no-cache'
        //             }
        //         });
                
        //         console.log(`Study details response status for ${nctId}:`, response.status);
        //         return response.data.data;
        //     } catch (error) {
        //         console.error(`Error fetching details for ${nctId}:`, error);
        //         appState.failedStudyIds.add(nctId); // Track failed requests
        //         return null;
        //     }
        // }


//         async function fetchStudies(drug, condition, hasResults) {
// try {
//     condition = condition || "";
    
//     // Using our backend endpoint
//     const params = {
//         condition: condition,
//         intervention: drug,
//         hasResults: hasResults,
//         fields: "protocolSection,resultsSection,hasResults",
//         pageSize: 100
//     };
    
//     console.log("Fetching studies with params:", params);
//     const response = await axios.get(`${API_BASE_URL}/studies/search`, { 
//         params,
//         headers: {
//             'Accept': 'application/json',
//             'Cache-Control': 'no-cache',
//             'Pragma': 'no-cache'
//         }
//     });
    
//     console.log("Studies search response status:", response.status);
//     let studies = response.data.data.studies || [];
    
//     return studies;
// } catch (error) {
//     console.error("Error fetching studies:", error);
//     return [];
// }
// }


async function fetchStudies(drug, condition, hasResults) {
  try {
    condition = condition || "";
    const allStudies = [];
    let pageToken = null;
    let hasNextPage = true;
    
    // Continue fetching until there are no more pages
    while (hasNextPage) {
      const params = {
        condition: condition,
        intervention: drug,
        hasResults: hasResults,
        fields: "protocolSection,resultsSection,hasResults",
        pageSize: 100 // Keep page size at 100 for efficiency
      };
      
      // Add page token for pagination if we're not on the first page
      if (pageToken) {
        params.pageToken = pageToken;
      }
      
      console.log(`Fetching studies page with params:`, params);
      
      const response = await axios.get(`${API_BASE_URL}/studies/search`, {
        params,
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });
      
      console.log(`Studies search response status: ${response.status}, page size: ${response.data.data.studies?.length || 0}`);
      
      const studies = response.data.data.studies || [];
      allStudies.push(...studies);
      
      // Get next page token
      pageToken = response.data.pagination?.nextPageToken;
      hasNextPage = !!pageToken;
      
      // Optional: Add delay to avoid rate limiting
      if (hasNextPage) {
        await new Promise(resolve => setTimeout(resolve, 300));
      }
    }
    
    console.log(`Total studies fetched: ${allStudies.length}`);
    return allStudies;
  } catch (error) {
    console.error("Error fetching all studies:", error);
    return [];
  }
}

async function fetchStudyDetails(nctId) {
// Skip if we've already failed to fetch this study
if (appState.failedStudyIds.has(nctId)) {
    console.log(`Skipping already failed study ID: ${nctId}`);
    return null;
}

try {
    console.log(`Fetching details for study: ${nctId}`);
    const response = await axios.get(`${API_BASE_URL}/studies/${nctId}`, {
        params: {
            timestamp: new Date().getTime() // Add timestamp to prevent caching
        },
        headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
        }
    });
    
    console.log(`Study details response status for ${nctId}:`, response.status);
    return response.data.data;
} catch (error) {
    console.error(`Error fetching details for ${nctId}:`, error);
    appState.failedStudyIds.add(nctId); // Track failed requests
    return null;
}
}


        // Function to filter studies specific to TRD treatment
        function filterTRDSpecificStudies(studies) {
            if (!appState.trdFocusOnly) return studies;
            
            return studies.filter(study => {
                // Check if the study is specifically about TRD
                const title = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
                const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
                const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
                const detailedDescription = study.protocolSection?.descriptionModule?.detailedDescription?.toLowerCase() || '';
                
                // Check for TRD-specific terms
                const trdTerms = [
                    'treatment-resistant depression', 
                    'treatment resistant depression',
                    'trd',
                    'refractory depression',
                    'treatment-refractory depression'
                ];
                
                // Check if any TRD terms are in the study's text
                return trdTerms.some(term => 
                    title.includes(term) || 
                    officialTitle.includes(term) || 
                    briefSummary.includes(term) || 
                    detailedDescription.includes(term)
                );
            });
        }

        // // Function to generate bell curve data
        // function generateNormalDistribution(mean, stdDev, points = 100) {
        //     if (isNaN(mean) || isNaN(stdDev) || stdDev <= 0) {
        //         console.warn("Invalid parameters for normal distribution:", { mean, stdDev });
        //         return [];
        //     }
            
        //     const data = [];
        //     const min = mean - 3 * stdDev;
        //     const max = mean + 3 * stdDev;
        //     const step = (max - min) / points;
            
        //     for (let x = min; x <= max; x += step) {
        //         const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
        //                   Math.exp(-Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2)));
        //         data.push({ x, y });
        //     }
            
        //     return data;
        // }

// Helper function to generate normal distribution data points
function generateNormalDistribution(mean, stdDev, points = 100) {
    if (isNaN(mean) || isNaN(stdDev) || stdDev <= 0) {
        console.warn("Invalid parameters for normal distribution:", { mean, stdDev });
        return Array(points).fill({x: 0, y: 0});
    }
    
    const data = [];
    const min = mean - 3 * stdDev;
    const max = mean + 3 * stdDev;
    const step = (max - min) / points;
    
    for (let x = min; x <= max; x += step) {
        const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                  Math.exp(-Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2)));
        data.push({x, y});
    }
    
    return data;
}

// Helper function to update interpretation for distribution chart
function updateInterpretation(container, outcome, distributionData, pValueInfo) {
    // Determine if lower or higher values are better based on outcome title
    const lowerIsBetter = isLowerValueBetter(outcome.title);
    
    // Prepare interpretation message
    let interpretation = `<p class="font-semibold">Distribution Analysis:</p>
                         <p>${outcome.title}</p>
                         <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>`;
    
    // Add group summaries
    interpretation += `<p class="font-semibold mt-2">Group Comparisons:</p>
                      <ul class="list-disc ml-4">`;
    
    distributionData.forEach(data => {
        interpretation += `<li>${data.group}: Mean = ${data.mean.toFixed(2)}, SD = ${data.stdDev.toFixed(2)}</li>`;
    });
    
    interpretation += `</ul>`;
    
    // Add statistical significance if available
    if (pValueInfo) {
        interpretation += pValueInfo;
    }
    
// Find experimental and control groups
if (distributionData.length > 1) {
    // Find experimental and control groups
    let experimentalGroup, controlGroup;
    
    // Try to identify control/placebo group
    for (let i = 0; i < distributionData.length; i++) {
        const groupName = distributionData[i].group.toLowerCase();
        if (groupName.includes('placebo') || groupName.includes('control')) {
            controlGroup = distributionData[i];
        } else if (groupName.includes('experimental') || 
                 groupName.includes('treatment') || 
                 groupName.includes('intervention')) {
            experimentalGroup = distributionData[i];
        }
    }
    
    // If we couldn't clearly identify, assume first is control, second is experimental
    if (!controlGroup && distributionData.length >= 2) {
        controlGroup = distributionData[0];
        experimentalGroup = distributionData[1];
    }
    
    // If we have both groups, add comparison
    if (controlGroup && experimentalGroup) {
        const diff = experimentalGroup.mean - controlGroup.mean;
        const diffPercent = (diff / Math.abs(controlGroup.mean)) * 100;
        
        const betterWorse = lowerIsBetter ? 
            (diff < 0 ? 'better' : 'worse') : 
            (diff > 0 ? 'better' : 'worse');
        
        interpretation += `<p class="font-semibold mt-2">Clinical Interpretation:</p>
                         <p>The experimental group showed a ${Math.abs(diffPercent).toFixed(1)}% ${betterWorse} outcome compared to control.</p>`;
    }
}

container.innerHTML = interpretation;
}

// Helper function to update interpretation for categorical chart
function updateCategoricalInterpretation(container, outcome, groups, categories, groupValues) {
// Prepare interpretation message
let interpretation = `<p class="font-semibold">Categorical Analysis:</p>
                     <p>${outcome.title}</p>
                     <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>`;

// Add group comparisons
interpretation += `<p class="font-semibold mt-2">Category Values:</p>
                  <table class="border-collapse w-full text-sm">
                    <thead>
                      <tr>
                        <th class="border px-2 py-1">Category</th>
                        ${groups.map(g => `<th class="border px-2 py-1">${g.title}</th>`).join('')}
                      </tr>
                    </thead>
                    <tbody>`;

categories.forEach(cat => {
    interpretation += `<tr>
                       <td class="border px-2 py-1">${cat}</td>
                       ${groups.map(g => `<td class="border px-2 py-1">${groupValues[g.id][cat]?.toFixed(2) || 'N/A'}</td>`).join('')}
                     </tr>`;
});

interpretation += `</tbody></table>`;

// Add statistical significance if available
if (outcome.analyses && outcome.analyses.length > 0) {
    const analysis = outcome.analyses[0];
    if (analysis.pValue) {
        interpretation += `<p class="font-semibold mt-2">Statistical Analysis:</p>
                       <p>p-value: ${analysis.pValue}</p>`;
        
        if (analysis.statisticalMethod) {
            interpretation += `<p>Method: ${analysis.statisticalMethod}</p>`;
        }
        
        if (analysis.ciLowerLimit && analysis.ciUpperLimit) {
            interpretation += `<p>${analysis.ciPctValue || 95}% CI: [${analysis.ciLowerLimit}, ${analysis.ciUpperLimit}]</p>`;
        }
    }
}

container.innerHTML = interpretation;
}

// Helper function to update interpretation for time series chart
function updateTimeSeriesInterpretation(container, outcome, groups, timePoints, groupValues) {
// Determine if lower or higher values are better based on outcome title
const lowerIsBetter = isLowerValueBetter(outcome.title);

// Prepare interpretation message
let interpretation = `<p class="font-semibold">Time Series Analysis:</p>
                     <p>${outcome.title}</p>
                     <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>`;

// Try to identify baseline and final time points
const baselineIndex = timePoints.findIndex(t => 
    t.toLowerCase().includes('baseline') || 
    t.toLowerCase().includes('screening') || 
    t === timePoints[0]
);

const finalIndex = timePoints.length - 1;

// Add change over time analysis if we have baseline and final
if (baselineIndex !== -1 && finalIndex > baselineIndex) {
    const baselineTime = timePoints[baselineIndex];
    const finalTime = timePoints[finalIndex];
    
    interpretation += `<p class="font-semibold mt-2">Change from ${baselineTime} to ${finalTime}:</p>
                      <ul class="list-disc ml-4">`;
    
    groups.forEach(group => {
        const baseline = groupValues[group.id][baselineTime];
        const final = groupValues[group.id][finalTime];
        
        if (baseline !== undefined && final !== undefined) {
            const change = final - baseline;
            const percentChange = (change / Math.abs(baseline)) * 100;
            
            const direction = change > 0 ? 'increase' : (change < 0 ? 'decrease' : 'no change');
            const betterWorse = lowerIsBetter ?
                (change < 0 ? 'improvement' : (change > 0 ? 'worsening' : 'no change')) :
                (change > 0 ? 'improvement' : (change < 0 ? 'worsening' : 'no change'));
            
            interpretation += `<li>${group.title}: ${Math.abs(percentChange).toFixed(1)}% ${direction} (${betterWorse})</li>`;
        }
    });
    
    interpretation += `</ul>`;
}

// Add statistical significance if available
if (outcome.analyses && outcome.analyses.length > 0) {
    const analysis = outcome.analyses[0];
    if (analysis.pValue) {
        interpretation += `<p class="font-semibold mt-2">Statistical Analysis:</p>
                       <p>p-value: ${analysis.pValue}</p>`;
        
        if (analysis.statisticalMethod) {
            interpretation += `<p>Method: ${analysis.statisticalMethod}</p>`;
        }
    }
}

container.innerHTML = interpretation;
}

// Helper function to determine if lower values are better for outcomes like depression scales
function isLowerValueBetter(title) {
if (!title) return false;

const lowerIsBetterTerms = [
    'depression', 'anxiety', 'stress', 'pain', 'fatigue', 'symptom', 
    'adverse', 'negative', 'score', 'ham-d', 'hamd', 'madrs', 'phq',
    'hamilton', 'montgomery', 'qids', 'beck', 'bdi', 'gad', 'panss'
];

const titleLower = title.toLowerCase();
return lowerIsBetterTerms.some(term => titleLower.includes(term));
}

// Helper function to sanitize long titles for chart display
function sanitizeTitle(title) {
if (!title) return 'Outcome Measure';

// If title is too long, truncate and add ellipsis
return title.length > 60 ? title.substring(0, 57) + '...' : title;
}



        // Statistical utility functions
        function calculateMean(values) {
            if (!values || values.length === 0) return 0;
            return values.reduce((sum, val) => sum + val, 0) / values.length;
        }

        function calculateStandardDeviation(values, mean) {
            if (!values || values.length <= 1) return 0;
            mean = mean || calculateMean(values);
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            return Math.sqrt(variance);
        }

        function calculateConfidenceInterval(mean, stdDev, n, confidenceLevel = 0.95) {
            if (n <= 1 || stdDev <= 0) return { lower: mean, upper: mean };
            
            // For small sample sizes, use t-distribution
            // Approximate t-value for 95% confidence and various degrees of freedom
            const tValue = n < 30 ? 2.045 : 1.96; // t-value for n-1 degrees of freedom at 95% confidence
            
            const marginOfError = tValue * (stdDev / Math.sqrt(n));
            return {
                lower: mean - marginOfError,
                upper: mean + marginOfError
            };
        }

        function calculatePValue(treatmentMean, controlMean, treatmentStdDev, controlStdDev, treatmentN, controlN) {
            // This is a simplified p-value calculation for demonstration
            // Would need proper t-test or other statistical test implementation for real applications
            if (treatmentN < 2 || controlN < 2) return "N/A";
            
            // Calculate pooled standard deviation
            const pooledVariance = ((treatmentN - 1) * Math.pow(treatmentStdDev, 2) + (controlN - 1) * Math.pow(controlStdDev, 2)) / 
                                (treatmentN + controlN - 2);
            const pooledStdDev = Math.sqrt(pooledVariance);
            
            // Calculate standard error of difference between means
            const standardError = pooledStdDev * Math.sqrt(1/treatmentN + 1/controlN);
            
            // Calculate t-statistic
            const tStat = Math.abs(treatmentMean - controlMean) / standardError;
            
            // Approximate p-value from t-statistic (simplified)
            // In a real implementation, would use t-distribution function
            if (tStat > 2.58) return "< 0.01";
            if (tStat > 1.96) return "< 0.05";
            return "> 0.05";
        }

        // Function to standardize outcome values for comparison
        function standardizeOutcomeValue(value, metric) {
            // For metrics where lower is better (e.g., depression scales), 
            // we invert the value for consistent interpretation
            const lowerIsBetterMetrics = [
                'hamilton depression rating scale',
                'madrs',
                'montgomery-asberg depression rating scale',
                'phq-9',
                'qids',
                'depression'
            ];
            
            if (lowerIsBetterMetrics.some(term => metric.toLowerCase().includes(term))) {
                // For these metrics, lower scores are better, so we invert the direction
                return -value;
            }
            
            return value;
        }

        // Function to extract and collate outcome measures
        function extractOutcomeMeasures(studies) {
            const allOutcomes = [];
            const outcomeMetrics = new Set();
            
            studies.forEach(study => {
                const nctId = study.protocolSection?.identificationModule?.nctId;
                if (!study.hasResults || !appState.studyDetails[nctId]) return;
                
                const studyDetail = appState.studyDetails[nctId];
                const phase = study.protocolSection?.designModule?.phases?.[0] || 'N/A';
                
                // Get outcome measures from the study results
                const outcomes = studyDetail.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
                
                // Process each outcome measure
                outcomes.forEach(outcome => {
                    // Skip outcomes without data
                    if (!outcome.classes || !outcome.classes[0]?.categories) return;
                    
                    // Add to unique metrics
                    outcomeMetrics.add(outcome.title);
                    
                    // Determine if this is a primary or secondary outcome
                    const outcomeType = outcome.type?.toLowerCase() || 'other';
                    
                    // Process each measurement class and category
                    outcome.classes.forEach(cls => {
                        cls.categories.forEach(cat => {
                            // Find experimental and control groups
                            const experimentalMeasurements = [];
                            const controlMeasurements = [];
                            
                            cat.measurements.forEach(measurement => {
                                const value = parseFloat(measurement.value);
                                
                                // Skip invalid measurements
                                if (isNaN(value)) return;
                                
                                // Determine if this is experimental or control group
                                const group = outcome.groups.find(g => g.id === measurement.groupId);
                                if (!group) return;
                                
                                const groupTitle = group.title.toLowerCase();
                                const isControlGroup = 
                                    groupTitle.includes('placebo') || 
                                    groupTitle.includes('control') ||
                                    groupTitle.includes('sham');
                                
                                // Calculate standard error if available
                                let standardError = null;
                                
                                if (measurement.dispersion && measurement.dispersion !== 'null') {
                                    const dispersionValue = parseFloat(measurement.dispersion);
                                    const dispersionType = measurement.dispersionType?.toLowerCase() || '';
                                    
                                    if (!isNaN(dispersionValue)) {
                                        if (dispersionType === 'standard_error') {
                                            standardError = dispersionValue;
                                        } else if (dispersionType === 'standard_deviation') {
                                            // Convert SD to SE if sample size is available
                                            const sampleSize = group.participantsAnalyzedList?.[0]?.count;
                                            if (sampleSize && !isNaN(sampleSize) && sampleSize > 0) {
                                                standardError = dispersionValue / Math.sqrt(sampleSize);
                                            }
                                        }
                                    }
                                }
                                
                                // Prepare measurement data
                                const measurementData = {
                                    value: value,
                                    standardError: standardError,
                                    sampleSize: group.participantsAnalyzedList?.[0]?.count || 0
                                };
                                
                                // Add to appropriate group
                                if (isControlGroup) {
                                    controlMeasurements.push(measurementData);
                                } else {
                                    experimentalMeasurements.push(measurementData);
                                }
                            });
                            
                            // Calculate aggregated measurements
                            if (experimentalMeasurements.length > 0) {
                                // Calculate weighted average for experimental group
                                const expTotal = experimentalMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
                                const expSampleSize = experimentalMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
                                
                                let controlValue = null;
                                let controlSampleSize = 0;
                                
                                // Calculate weighted average for control group if available
                                if (controlMeasurements.length > 0) {
                                    const ctrlTotal = controlMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
                                    controlSampleSize = controlMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
                                    
                                    if (controlSampleSize > 0) {
                                        controlValue = ctrlTotal / controlSampleSize;
                                    }
                                }
                                
                                // Calculate standardized outcome value
                                const experimentalValue = expSampleSize > 0 ? expTotal / expSampleSize : null;
                                
                                // Calculate effect size if both experimental and control values exist
                                let effectSize = null;
                                if (experimentalValue !== null && controlValue !== null) {
                                    // Standardize the effect based on outcome metric
                                    effectSize = standardizeOutcomeValue(experimentalValue - controlValue, outcome.title);
                                }
                                
                                // Store the outcome data
                                allOutcomes.push({
                                    nctId: nctId,
                                    title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                                    phase: phase,
                                    outcomeType: outcomeType,
                                    outcomeTitle: outcome.title,
                                    category: cat.title,
                                    experimentalValue: experimentalValue,
                                    controlValue: controlValue,
                                    effectSize: effectSize,
                                    experimentalSampleSize: expSampleSize,
                                    controlSampleSize: controlSampleSize,
                                    timeFrame: outcome.timeFrame || 'Not specified'
                                });
                            }
                        });
                    });
                });
            });
            
            // Set the outcome metrics and measures
            appState.collatedOutcomes = allOutcomes;
            appState.outcomeMetrics = Array.from(outcomeMetrics);
            
            // If we have any outcomes, set the default metric
            if (appState.outcomeMetrics.length > 0) {
                appState.currentOutcomeMetric = appState.outcomeMetrics[0];
            }
            
            // Populate the outcome metric selector
            populateOutcomeMetricSelector();
            
            // Display aggregate outcome visualizations
            displayAggregateVisualizations();
            
            // Display collated outcomes visualizations
            displayCollatedOutcomes();
        }
        
        function populateOutcomeMetricSelector() {
    if (!elements.outcomeMetricSelector) {
        elements.outcomeMetricSelector = document.getElementById('outcomeMetricSelector');
        if (!elements.outcomeMetricSelector) {
            console.error('Outcome metric selector not found, cannot populate');
            return;
        }
        
        // Re-add event listener
        elements.outcomeMetricSelector.addEventListener('change', () => {
            appState.currentOutcomeMetric = elements.outcomeMetricSelector.value;
            displayCollatedOutcomes();
        });
    }
    
    elements.outcomeMetricSelector.innerHTML = '';
    
    appState.outcomeMetrics.forEach(metric => {
        const option = document.createElement('option');
        option.value = metric;
        option.textContent = metric;
        elements.outcomeMetricSelector.appendChild(option);
    });
    
    // Set the current metric
    if (appState.currentOutcomeMetric) {
        elements.outcomeMetricSelector.value = appState.currentOutcomeMetric;
    }
}


        function displayResultsSummary(studies) {
            elements.resultsSummary.innerHTML = '';
            
            // Count studies by phase
            const phaseCount = studies.reduce((acc, study) => {
                const phase = study.protocolSection?.designModule?.phases?.[0] || 'N/A';
                acc[phase] = (acc[phase] || 0) + 1;
                return acc;
            }, {});
            
            // Count studies by status
            const statusCount = studies.reduce((acc, study) => {
                const status = study.protocolSection?.statusModule?.overallStatus || 'UNKNOWN';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            
            // Count studies with results
            const withResults = studies.filter(study => study.hasResults).length;
            
            // Calculate success rate for completed studies with results
            let successRate = "N/A";
            const completedWithResults = studies.filter(study => 
                study.hasResults && 
                study.protocolSection?.statusModule?.overallStatus === "COMPLETED"
            ).length;
            
            if (completedWithResults > 0) {
                // For now, just estimate based on positive outcomes in collated data
                const positiveOutcomes = appState.collatedOutcomes.filter(outcome => outcome.effectSize > 0).length;
                const totalOutcomes = appState.collatedOutcomes.length;
                
                if (totalOutcomes > 0) {
                    successRate = `${Math.round(positiveOutcomes * 100 / totalOutcomes)}%`;
                }
            }
            
            // Create summary cards
            const summaryItems = [
                {
                    title: 'Total Studies',
                    value: studies.length,
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>'
                },
                {
                    title: 'With Results',
                    value: withResults,
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>'
                },
                {
                    title: 'Study Phases',
                    value: Object.keys(phaseCount).length,
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>'
                },
                {
                    title: 'Success Rate',
                    value: successRate,
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                }
            ];
            
            summaryItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 rounded-lg p-4 flex items-center';
                card.innerHTML = `
                    <div class="p-3 rounded-full bg-white shadow-sm mr-4">
                        ${item.icon}
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">${item.title}</p>
                        <p class="text-2xl font-semibold">${item.value}</p>
                    </div>
                `;
                elements.resultsSummary.appendChild(card);
            });
        }

        // function displayStudies(studies) {
        //     elements.studiesList.innerHTML = '';
        //     elements.studyCount.textContent = studies.length;
            
        //     if (studies.length === 0) {
        //         elements.studiesList.innerHTML = `
        //             <div class="text-center p-4 text-gray-500">
        //                 <p>No studies found matching the current filters.</p>
        //             </div>
        //         `;
        //         return;
        //     }
            
        //     // Sort studies by phase
        //     const phaseOrder = { 
        //         "PRE_PHASE": 0, 
        //         "PHASE1": 1, 
        //         "PHASE1_PHASE2": 1.5,
        //         "PHASE2": 2, 
        //         "PHASE3": 3, 
        //         "PHASE4": 4 
        //     };
            
        //     studies.sort((a, b) => {
        //         const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        //         const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        //         return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
        //     });
            
        //     studies.forEach(study => {
        //         const nctId = study.protocolSection?.identificationModule?.nctId;
        //         const title = study.protocolSection?.identificationModule?.briefTitle;
        //         const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
        //         const status = study.protocolSection?.statusModule?.overallStatus;
        //         const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
        //         const hasResults = study.hasResults;
                
        //         // Determine if this is a TRD-specific study
        //         const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
        //         const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
        //         const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
                
        //         const trdTerms = [
        //             'treatment-resistant depression', 
        //             'treatment resistant depression',
        //             'trd',
        //             'refractory depression'
        //         ];
                
        //         const isTRDSpecific = trdTerms.some(term => 
        //             briefTitle.includes(term) || 
        //             officialTitle.includes(term) || 
        //             briefSummary.includes(term)
        //         );
                
        //         const card = document.createElement('div');
        //         card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
        //         card.innerHTML = `
        //             <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
        //                 <div class="flex gap-2 items-center flex-wrap">
        //                     <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
        //                     <span class="text-sm font-medium">${formatPhase(phase)}</span>
        //                     ${getStatusBadge(status)}
        //                     ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
        //                 </div>
        //                 <div>
        //                     <span class="text-xs text-gray-500">${nctId}</span>
        //                     ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
        //                 </div>
        //             </div>
        //             <h3 class="text-lg font-medium mb-2">${title}</h3>
        //             <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
        //             <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
        //                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        //                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        //                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        //                 </svg>
        //                 View Study Details
        //             </button>
        //         `;
        //         elements.studiesList.appendChild(card);
                
        //         // Add event listener to the view button
        //         card.querySelector('.view-study-btn').addEventListener('click', () => {
        //             viewStudyDetails(nctId);
        //         });
        //     });
        // }
        function generateDrugUsageTimeline(studies, drugName) {
    // Create container for the timeline
    const timelineContainer = document.createElement('div');
    timelineContainer.className = 'mb-8 p-4 bg-white rounded-lg border border-gray-200 shadow-sm';
    timelineContainer.innerHTML = `
        <h2 class="text-xl font-bold mb-4">Historical Usage Timeline: ${drugName}</h2>
        <div id="usage-timeline" class="relative">
            <div class="timeline-loading text-center p-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-blue-500"></div>
                <p class="mt-2 text-gray-600">Analyzing usage patterns...</p>
            </div>
        </div>
    `;

    // Process the data after rendering the initial container
    setTimeout(() => {
        // Extract and organize timeline data
        const usageData = extractUsageData(studies);
        
        if (Object.keys(usageData.byCondition).length === 0) {
            // No meaningful data found
            document.getElementById('usage-timeline').innerHTML = `
                <div class="text-center p-4 text-gray-500">
                    <p>Insufficient data to generate a timeline for ${drugName}.</p>
                </div>
            `;
            return;
        }
        
        // Render the timeline visualization
        renderTimelineVisualization(usageData, drugName);
    }, 100);
    
    return timelineContainer;
}

// function extractUsageData(studies) {
//     // Initialize data structure
//     const result = {
//         earliestStudyYear: null,
//         latestStudyYear: null,
//         byCondition: {},
//         byPhase: {
//             "PRE_PHASE": [],
//             "PHASE1": [],
//             "PHASE1_PHASE2": [],
//             "PHASE2": [],
//             "PHASE3": [],
//             "PHASE4": []
//         },
//         totalStudies: studies.length
//     };
    
//     // Current year for comparison
//     const currentYear = new Date().getFullYear();
    
//     studies.forEach(study => {
//         // Extract key information
//         const startYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.startDateStruct?.date
//         );
        
//         const completionYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.completionDateStruct?.date
//         );
        
//         const primaryCompletionYear = extractYearFromDate(
//             study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
//         );
        
//         // Use the most appropriate year available
//         const studyYear = startYear || 
//                          (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
//                          (completionYear && completionYear <= currentYear ? completionYear : null) || 
//                          null;
        
//         if (!studyYear) return; // Skip if no valid year
        
//         // Update earliest/latest years
//         if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
//             result.earliestStudyYear = studyYear;
//         }
        
//         if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
//             result.latestStudyYear = studyYear;
//         }
        
//         // Extract conditions
//         const conditions = study.protocolSection?.conditionsModule?.conditions || [];
        
//         // If no specific conditions listed, use a placeholder
//         if (conditions.length === 0) {
//             const category = "Unspecified Condition";
            
//             if (!result.byCondition[category]) {
//                 result.byCondition[category] = {
//                     count: 0,
//                     years: {},
//                     earliestYear: null,
//                     latestYear: null
//                 };
//             }
            
//             result.byCondition[category].count++;
//             result.byCondition[category].years[studyYear] = (result.byCondition[category].years[studyYear] || 0) + 1;
            
//             // Update condition-specific earliest/latest years
//             if (result.byCondition[category].earliestYear === null || 
//                 studyYear < result.byCondition[category].earliestYear) {
//                 result.byCondition[category].earliestYear = studyYear;
//             }
            
//             if (result.byCondition[category].latestYear === null || 
//                 studyYear > result.byCondition[category].latestYear) {
//                 result.byCondition[category].latestYear = studyYear;
//             }
//         } else {
//             // Process each condition
//             conditions.forEach(condition => {
//                 // Normalize the condition name - capitalize first letter of each word
//                 const normalizedCondition = condition
//                     .split(' ')
//                     .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
//                     .join(' ');
                
//                 // Initialize condition data if it doesn't exist
//                 if (!result.byCondition[normalizedCondition]) {
//                     result.byCondition[normalizedCondition] = {
//                         count: 0,
//                         years: {},
//                         earliestYear: null,
//                         latestYear: null
//                     };
//                 }
                
//                 // Increment counts
//                 result.byCondition[normalizedCondition].count++;
//                 result.byCondition[normalizedCondition].years[studyYear] = 
//                     (result.byCondition[normalizedCondition].years[studyYear] || 0) + 1;
                
//                 // Update condition-specific earliest/latest years
//                 if (result.byCondition[normalizedCondition].earliestYear === null || 
//                     studyYear < result.byCondition[normalizedCondition].earliestYear) {
//                     result.byCondition[normalizedCondition].earliestYear = studyYear;
//                 }
                
//                 if (result.byCondition[normalizedCondition].latestYear === null || 
//                     studyYear > result.byCondition[normalizedCondition].latestYear) {
//                     result.byCondition[normalizedCondition].latestYear = studyYear;
//                 }
//             });
//         }
        
//         // Track phases
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         if (result.byPhase[phase]) {
//             result.byPhase[phase].push({
//                 nctId: study.protocolSection?.identificationModule?.nctId,
//                 year: studyYear,
//                 conditions: conditions.length > 0 ? conditions : ["Unspecified"]
//             });
//         }
//     });
    
//     // Filter out conditions with very few studies (< 2% of total)
//     const minStudiesThreshold = Math.max(1, Math.ceil(result.totalStudies * 0.02));
    
//     Object.keys(result.byCondition).forEach(condition => {
//         if (result.byCondition[condition].count < minStudiesThreshold) {
//             delete result.byCondition[condition];
//         }
//     });
    
//     // Group similar conditions
//     const groupedConditions = groupSimilarConditions(result.byCondition);
//     if (Object.keys(groupedConditions).length > 0) {
//         result.byCondition = groupedConditions;
//     }
    
//     return result;
// }
function extractUsageData(studies) {
    // Initialize data structure
    const result = {
        earliestStudyYear: null,
        latestStudyYear: null,
        byCondition: {},
        byPhase: {
            "PRE_PHASE": [],
            "PHASE1": [],
            "PHASE1_PHASE2": [],
            "PHASE2": [],
            "PHASE3": [],
            "PHASE4": []
        },
        totalStudies: studies.length
    };
    
    // Current year for comparison
    const currentYear = new Date().getFullYear();
    
    studies.forEach(study => {
        // Extract key information
        const startYear = extractYearFromDate(
            study.protocolSection?.statusModule?.startDateStruct?.date
        );
        
        const completionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.completionDateStruct?.date
        );
        
        const primaryCompletionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
        );
        
        // Use the most appropriate year available
        const studyYear = startYear || 
                         (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
                         (completionYear && completionYear <= currentYear ? completionYear : null) || 
                         null;
        
        if (!studyYear) return; // Skip if no valid year
        
        // Update earliest/latest years
        if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
            result.earliestStudyYear = studyYear;
        }
        
        if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
            result.latestStudyYear = studyYear;
        }
        
        // Extract conditions
        const conditions = study.protocolSection?.conditionsModule?.conditions || [];
        
        // If no specific conditions listed, use a placeholder
        if (conditions.length === 0) {
            const category = "Unspecified Condition";
            
            if (!result.byCondition[category]) {
                result.byCondition[category] = {
                    count: 0,
                    years: {},
                    earliestYear: null,
                    latestYear: null
                };
            }
            
            result.byCondition[category].count++;
            result.byCondition[category].years[studyYear] = (result.byCondition[category].years[studyYear] || 0) + 1;
            
            // Update condition-specific earliest/latest years
            if (result.byCondition[category].earliestYear === null || 
                studyYear < result.byCondition[category].earliestYear) {
                result.byCondition[category].earliestYear = studyYear;
            }
            
            if (result.byCondition[category].latestYear === null || 
                studyYear > result.byCondition[category].latestYear) {
                result.byCondition[category].latestYear = studyYear;
            }
        } else {
            // Process each condition
            conditions.forEach(condition => {
                // Keep the exact condition name as provided, only first letter capitalized for consistency
                const normalizedCondition = condition.charAt(0).toUpperCase() + condition.slice(1);
                
                // Initialize condition data if it doesn't exist
                if (!result.byCondition[normalizedCondition]) {
                    result.byCondition[normalizedCondition] = {
                        count: 0,
                        years: {},
                        earliestYear: null,
                        latestYear: null
                    };
                }
                
                // Increment counts
                result.byCondition[normalizedCondition].count++;
                result.byCondition[normalizedCondition].years[studyYear] = 
                    (result.byCondition[normalizedCondition].years[studyYear] || 0) + 1;
                
                // Update condition-specific earliest/latest years
                if (result.byCondition[normalizedCondition].earliestYear === null || 
                    studyYear < result.byCondition[normalizedCondition].earliestYear) {
                    result.byCondition[normalizedCondition].earliestYear = studyYear;
                }
                
                if (result.byCondition[normalizedCondition].latestYear === null || 
                    studyYear > result.byCondition[normalizedCondition].latestYear) {
                    result.byCondition[normalizedCondition].latestYear = studyYear;
                }
            });
        }
        
        // Track phases
        const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        if (result.byPhase[phase]) {
            result.byPhase[phase].push({
                nctId: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                conditions: conditions.length > 0 ? conditions : ["Unspecified"]
            });
        }
    });
    
    // We'll keep all conditions regardless of frequency to show complete data
    // But we can sort by count to display the most studied conditions prominently
    
    return result;
}
function groupSimilarConditions(conditionsData) {
    // // Define condition categories and their keywords
    // const categories = {
    //     "Depression": ["depression", "depressive", "mood disorder"],
    //     "Pain": ["pain", "analgesia", "analgesic"],
    //     "Anesthesia": ["anesthesia", "anaesthesia", "sedation"],
    //     "Anxiety": ["anxiety", "anxious", "panic"],
    //     "Addiction": ["addiction", "substance abuse", "dependence", "substance use disorder"],
    //     "Neurological": ["dementia", "alzheimer", "parkinson", "multiple sclerosis", "epilepsy", "seizure"],
    //     "Psychiatric": ["schizophrenia", "bipolar", "ptsd", "trauma", "ocd"]
    // };
    
    // const result = {};
    // const assignedConditions = new Set();
    
    // // First pass: assign conditions to predefined categories
    // Object.keys(categories).forEach(category => {
    //     const keywords = categories[category];
    //     let totalCount = 0;
    //     let earliestYear = null;
    //     let latestYear = null;
    //     const yearCounts = {};
        
    //     Object.keys(conditionsData).forEach(condition => {
    //         const conditionLower = condition.toLowerCase();
            
    //         if (keywords.some(keyword => conditionLower.includes(keyword))) {
    //             assignedConditions.add(condition);
    //             totalCount += conditionsData[condition].count;
                
    //             // Update years
    //             if (earliestYear === null || conditionsData[condition].earliestYear < earliestYear) {
    //                 earliestYear = conditionsData[condition].earliestYear;
    //             }
                
    //             if (latestYear === null || conditionsData[condition].latestYear > latestYear) {
    //                 latestYear = conditionsData[condition].latestYear;
    //             }
                
    //             // Merge year counts
    //             Object.keys(conditionsData[condition].years).forEach(year => {
    //                 yearCounts[year] = (yearCounts[year] || 0) + conditionsData[condition].years[year];
    //             });
    //         }
    //     });
        
    //     if (totalCount > 0) {
    //         result[category] = {
    //             count: totalCount,
    //             years: yearCounts,
    //             earliestYear: earliestYear,
    //             latestYear: latestYear
    //         };
    //     }
    // });
    
    // // Second pass: add remaining conditions
    // Object.keys(conditionsData).forEach(condition => {
    //     if (!assignedConditions.has(condition)) {
    //         result[condition] = conditionsData[condition];
    //     }
    // });
    // console.log(result)
    
    return conditionsData;
}

// function renderTimelineVisualization(data, drugName) {
//     const timelineElement = document.getElementById('usage-timeline');
    
//     // Create array of conditions sorted by earliest use
//     const sortedConditions = Object.keys(data.byCondition)
//         .map(condition => ({
//             name: condition,
//             ...data.byCondition[condition]
//         }))
//         .sort((a, b) => a.earliestYear - b.earliestYear);
    
//     // Calculate timeline dimensions
//     const startYear = data.earliestStudyYear;
//     const endYear = data.latestStudyYear;
//     const yearSpan = endYear - startYear + 1;
    
//     // Generate the timeline HTML
//     let timelineHTML = `
//         <div class="mb-6">
//             <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${startYear} to ${endYear}</p>
//         </div>
//         <div class="timeline-chart relative">
//             <!-- Year markers -->
//             <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
//     `;
    
//     // Add year markers (show at most 10 years to avoid overcrowding)
//     const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
//     for (let year = startYear; year <= endYear; year += yearStep) {
//         const position = ((year - startYear) / yearSpan) * 100;
//         timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
//     }
    
//     timelineHTML += `
//             </div>
            
//             <!-- Timeline tracks -->
//             <div class="timeline-tracks space-y-6">
//     `;
    
//     // Generate a track for each condition
//     sortedConditions.forEach((condition, index) => {
//         const startPosition = ((condition.earliestYear - startYear) / yearSpan) * 100;
//         const endPosition = 100 - ((endYear - condition.latestYear) / yearSpan) * 100;
//         const width = endPosition - startPosition;
        
//         // Generate a color based on the condition index
//         const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
//         const color = `hsl(${hue}, 70%, 60%)`;
//         const darkColor = `hsl(${hue}, 70%, 40%)`;
        
//         timelineHTML += `
//             <div class="condition-track">
//                 <div class="flex justify-between items-center mb-1">
//                     <span class="font-medium text-sm">${condition.name}</span>
//                     <span class="text-xs text-gray-500">${condition.count} studies</span>
//                 </div>
//                 <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
//                     <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${color};">
//                         <div class="h-full flex items-center justify-center text-xs font-bold text-white">
//                             ${condition.earliestYear} - ${condition.latestYear}
//                         </div>
//                     </div>
//                 </div>
                
//                 <!-- Activity indicators -->
//                 <div class="relative h-1 mt-1">
//         `;
        
//         // Add activity indicators (small circles indicating study frequency)
//         Object.keys(condition.years).forEach(year => {
//             const yearPosition = ((year - startYear) / yearSpan) * 100;
//             const size = Math.min(12, Math.max(4, condition.years[year] * 2)); // Scale based on study count
            
//             timelineHTML += `
//                 <div class="absolute rounded-full" 
//                      style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${darkColor};"
//                      title="${year}: ${condition.years[year]} studies">
//                 </div>
//             `;
//         });
        
//         timelineHTML += `
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
        
//         <!-- Evolution of usage patterns -->
//         <div class="mt-8">
//             <h3 class="text-lg font-medium mb-3">Key Evolution Patterns</h3>
//             <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
//     `;
    
//     // Generate insights based on the data
//     const insights = generateInsights(data, drugName, sortedConditions);
    
//     insights.forEach(insight => {
//         timelineHTML += `
//             <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
//                 <div class="flex items-start">
//                     <div class="insight-icon mr-3 text-blue-500">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//                             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
//                         </svg>
//                     </div>
//                     <p class="text-sm">${insight}</p>
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
//     `;
    
//     // Update the timeline element
//     timelineElement.innerHTML = timelineHTML;
// }

// function generateInsights(data, drugName, sortedConditions) {
//     const insights = [];
//     const currentYear = new Date().getFullYear();
    
//     // Insight 1: First studied indication
//     if (sortedConditions.length > 0) {
//         const firstCondition = sortedConditions[0];
//         insights.push(
//             `${drugName} was first studied for <strong>${firstCondition.name}</strong> in ${firstCondition.earliestYear}, ${currentYear - firstCondition.earliestYear} years ago.`
//         );
//     }
    
//     // Insight 2: Most studied indication
//     const mostStudiedCondition = sortedConditions.sort((a, b) => b.count - a.count)[0];
//     insights.push(
//         `The most researched application has been <strong>${mostStudiedCondition.name}</strong> with ${mostStudiedCondition.count} studies.`
//     );
    
//     // Insight 3: Recent expansion
//     const recentConditions = sortedConditions
//         .filter(c => c.earliestYear >= currentYear - 10)
//         .sort((a, b) => b.earliestYear - a.earliestYear);
    
//     if (recentConditions.length > 0) {
//         insights.push(
//             `In the past decade, research has expanded to include <strong>${recentConditions.map(c => c.name).join(', ')}</strong>.`
//         );
//     }
    
//     // Insight 4: Phase progression
//     const phaseData = data.byPhase;
//     const latePhaseCount = (phaseData.PHASE3 || []).length + (phaseData.PHASE4 || []).length;
//     const totalPhaseCount = Object.values(phaseData).flat().length;
    
//     if (totalPhaseCount > 0) {
//         const latePhasePercentage = Math.round((latePhaseCount / totalPhaseCount) * 100);
//         insights.push(
//             `${latePhasePercentage}% of studies have reached late-stage (Phase 3-4) clinical trials, indicating ${latePhasePercentage > 30 ? 'significant' : 'ongoing'} progress toward regulatory approval across various conditions.`
//         );
//     }
    
//     // Insight 5: Recent activity
//     const recentYears = currentYear - 5;
//     let recentActivityCount = 0;
    
//     sortedConditions.forEach(condition => {
//         Object.keys(condition.years).forEach(year => {
//             if (parseInt(year) >= recentYears) {
//                 recentActivityCount += condition.years[year];
//             }
//         });
//     });
    
//     if (data.totalStudies > 0) {
//         const recentPercentage = Math.round((recentActivityCount / data.totalStudies) * 100);
//         insights.push(
//             `${recentPercentage}% of all ${drugName} studies have been conducted in the last 5 years, showing ${recentPercentage > 50 ? 'accelerating' : 'continued'} research interest.`
//         );
//     }
    
//     return insights;
// }
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


// function renderTimelineVisualization(data, drugName) {
//     const timelineElement = document.getElementById('usage-timeline');
    
//     // Create array of conditions sorted by number of studies (most studied first)
//     const sortedConditions = Object.keys(data.byCondition)
//         .map(condition => ({
//             name: condition,
//             ...data.byCondition[condition]
//         }))
//         .sort((a, b) => b.count - a.count)
//         // Limit to top 20 conditions to avoid overcrowding
//         .slice(0, 20);
    
//     // Calculate timeline dimensions
//     const startYear = data.earliestStudyYear;
//     const endYear = data.latestStudyYear;
//     const yearSpan = endYear - startYear + 1;
    
//     // Generate the timeline HTML
//     let timelineHTML = `
//         <div class="mb-6">
//             <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${startYear} to ${endYear}</p>
//             <p class="text-sm text-gray-500 mt-1">Showing top ${sortedConditions.length} conditions out of ${Object.keys(data.byCondition).length} total</p>
//         </div>
//         <div class="timeline-chart relative">
//             <!-- Year markers -->
//             <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
//     `;
    
//     // Add year markers (show at most 10 years to avoid overcrowding)
//     const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
//     for (let year = startYear; year <= endYear; year += yearStep) {
//         const position = ((year - startYear) / yearSpan) * 100;
//         timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
//     }
    
//     timelineHTML += `
//             </div>
            
//             <!-- Timeline tracks -->
//             <div class="timeline-tracks space-y-6">
//     `;
    
//     // Generate a track for each condition
//     sortedConditions.forEach((condition, index) => {
//         const startPosition = ((condition.earliestYear - startYear) / yearSpan) * 100;
//         const endPosition = 100 - ((endYear - condition.latestYear) / yearSpan) * 100;
//         const width = endPosition - startPosition;
        
//         // Generate a color based on the condition index
//         const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
//         const color = `hsl(${hue}, 70%, 60%)`;
//         const darkColor = `hsl(${hue}, 70%, 40%)`;
        
//         timelineHTML += `
//             <div class="condition-track">
//                 <div class="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
//                     <span class="font-medium text-sm break-words">${condition.name}</span>
//                     <span class="text-xs text-gray-500">${condition.count} ${condition.count === 1 ? 'study' : 'studies'}</span>
//                 </div>
//                 <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
//                     <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${color};">
//                         <div class="h-full flex items-center justify-center text-xs font-bold text-white whitespace-nowrap px-2 overflow-hidden">
//                             ${condition.earliestYear} - ${condition.latestYear}
//                         </div>
//                     </div>
//                 </div>
                
//                 <!-- Activity indicators -->
//                 <div class="relative h-1 mt-1">
//         `;
        
//         // Add activity indicators (small circles indicating study frequency)
//         Object.keys(condition.years).forEach(year => {
//             const yearPosition = ((year - startYear) / yearSpan) * 100;
//             const size = Math.min(12, Math.max(4, condition.years[year] * 2)); // Scale based on study count
            
//             timelineHTML += `
//                 <div class="absolute rounded-full" 
//                      style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${darkColor};"
//                      title="${year}: ${condition.years[year]} ${condition.years[year] === 1 ? 'study' : 'studies'}">
//                 </div>
//             `;
//         });
        
//         timelineHTML += `
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
        
//         <!-- View all conditions button for when there are more than 20 -->
//         ${Object.keys(data.byCondition).length > 20 ? `
//         <div class="mt-4 text-center">
//             <button id="view-all-conditions" class="px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm">
//                 View All ${Object.keys(data.byCondition).length} Conditions
//             </button>
//         </div>
//         ` : ''}
        
//         <!-- Evolution of usage patterns -->
//         <div class="mt-8">
//             <h3 class="text-lg font-medium mb-3">Key Clinical Insights</h3>
//             <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
//     `;
    
//     // Generate insights based on the data
//     const insights = generateInsights(data, drugName, sortedConditions);
    
//     insights.forEach(insight => {
//         timelineHTML += `
//             <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
//                 <div class="flex items-start">
//                     <div class="insight-icon mr-3 text-blue-500">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//                             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
//                         </svg>
//                     </div>
//                     <p class="text-sm">${insight}</p>
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
//     `;
    
//     // Update the timeline element
//     timelineElement.innerHTML = timelineHTML;
    
//     // Add event listener for the "View All Conditions" button
//     const viewAllButton = document.getElementById('view-all-conditions');
//     if (viewAllButton) {
//         viewAllButton.addEventListener('click', () => {
//             // Show modal with all conditions
//             showAllConditionsModal(data, drugName);
//         });
//     }
// }

// function showAllConditionsModal(data, drugName) {
//     // Create a modal to display all conditions
//     const modal = document.createElement('div');
//     modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
//     // Sort all conditions by count
//     const allConditions = Object.keys(data.byCondition)
//         .map(condition => ({
//             name: condition,
//             count: data.byCondition[condition].count,
//             earliestYear: data.byCondition[condition].earliestYear,
//             latestYear: data.byCondition[condition].latestYear
//         }))
//         .sort((a, b) => b.count - a.count);
    
//     // Create the modal content
//     let modalContent = `
//         <div class="bg-white rounded-lg w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
//             <div class="p-4 border-b">
//                 <div class="flex justify-between items-center">
//                     <h3 class="text-xl font-bold">All Clinical Conditions for ${drugName}</h3>
//                     <button id="close-conditions-modal" class="text-gray-500 hover:text-gray-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <p class="text-sm text-gray-500">${allConditions.length} total conditions found in clinical trials</p>
//             </div>
//             <div class="overflow-y-auto p-4">
//                 <table class="w-full">
//                     <thead class="bg-gray-50">
//                         <tr>
//                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Condition</th>
//                             <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Studies</th>
//                             <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Year Range</th>
//                         </tr>
//                     </thead>
//                     <tbody class="divide-y divide-gray-200">
//     `;
    
//     allConditions.forEach((condition, index) => {
//         modalContent += `
//             <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
//                 <td class="px-4 py-2 text-sm">${condition.name}</td>
//                 <td class="px-4 py-2 text-sm text-center">${condition.count}</td>
//                 <td class="px-4 py-2 text-sm text-center">${condition.earliestYear} - ${condition.latestYear}</td>
//             </tr>
//         `;
//     });
    
//     modalContent += `
//                     </tbody>
//                 </table>
//             </div>
//         </div>
//     `;
    
//     modal.innerHTML = modalContent;
//     document.body.appendChild(modal);
    
//     // Add event listener to close the modal
//     document.getElementById('close-conditions-modal').addEventListener('click', () => {
//         document.body.removeChild(modal);
//     });
    
//     // Also close when clicking outside the modal content
//     modal.addEventListener('click', (e) => {
//         if (e.target === modal) {
//             document.body.removeChild(modal);
//         }
//     });
// }

// function generateInsights(data, drugName, sortedConditions) {
//     const insights = [];
//     const currentYear = new Date().getFullYear();
    
//     // Insight 1: First studied indication
//     if (sortedConditions.length > 0) {
//         const firstCondition = sortedConditions.sort((a, b) => a.earliestYear - b.earliestYear)[0];
//         insights.push(
//             `${drugName} was first studied for <strong>${firstCondition.name}</strong> in ${firstCondition.earliestYear}, ${currentYear - firstCondition.earliestYear} years ago.`
//         );
//     }
    
//     // Insight 2: Most studied indication
//     const mostStudiedCondition = sortedConditions.sort((a, b) => b.count - a.count)[0];
//     insights.push(
//         `The most researched application has been <strong>${mostStudiedCondition.name}</strong> with ${mostStudiedCondition.count} studies.`
//     );
    
//     // Insight 3: Count unique conditions
//     const uniqueConditionCount = Object.keys(data.byCondition).length;
//     insights.push(
//         `${drugName} has been investigated for ${uniqueConditionCount} distinct clinical conditions, showing its potential versatility across multiple medical applications.`
//     );
    
//     // Insight 4: Phase progression
//     const phaseData = data.byPhase;
//     const latePhaseCount = (phaseData.PHASE3 || []).length + (phaseData.PHASE4 || []).length;
//     const totalPhaseCount = Object.values(phaseData).flat().length;
    
//     if (totalPhaseCount > 0) {
//         const latePhasePercentage = Math.round((latePhaseCount / totalPhaseCount) * 100);
//         insights.push(
//             `${latePhasePercentage}% of studies have reached late-stage (Phase 3-4) clinical trials, indicating ${latePhasePercentage > 30 ? 'significant' : 'ongoing'} progress toward regulatory approval across various conditions.`
//         );
//     }
    
//     // Insight 5: Recent activity and trend
//     const recentYears = currentYear - 5;
//     let recentActivityCount = 0;
//     const recentConditions = new Set();
    
//     sortedConditions.forEach(condition => {
//         Object.keys(condition.years).forEach(year => {
//             if (parseInt(year) >= recentYears) {
//                 recentActivityCount += condition.years[year];
//                 recentConditions.add(condition.name);
//             }
//         });
//     });
    
//     if (recentConditions.size > 0) {
//         const topRecentConditions = Array.from(recentConditions).slice(0, 3);
//         if (topRecentConditions.length > 0) {
//             insights.push(
//                 `In the last 5 years, research has focused on ${recentConditions.size} conditions, with notable interest in <strong>${topRecentConditions.join('</strong>, <strong>')}</strong>.`
//             );
//         }
//     }
    
//     return insights;
// }


// function extractYearFromDate(dateString) {
//     if (!dateString) return null;
    
//     // Extract year from YYYY-MM-DD format
//     const match = dateString.match(/^(\d{4})-/);
//     if (match) {
//         return parseInt(match[1]);
//     }
    
//     // Try to extract any 4-digit year
//     const yearMatch = dateString.match(/\b(\d{4})\b/);
//     if (yearMatch) {
//         const year = parseInt(yearMatch[1]);
//         // Validate year is reasonable (between 1950 and current year + 5)
//         const currentYear = new Date().getFullYear();
//         if (year >= 1950 && year <= currentYear + 5) {
//             return year;
//         }
//     }
    
//     return null;
// }

// // Update the displayStudies function to include the timeline
// function displayStudiesWithTimeline(studies, drugName) {
//     // First, create and append the timeline
//     const timelineElement = generateDrugUsageTimeline(studies, drugName);
    
//     // Check if there's already a timeline
//     const existingTimeline = document.getElementById('drug-usage-timeline');
//     if (existingTimeline) {
//         existingTimeline.replaceWith(timelineElement);
//     } else {
//         // Insert the timeline before the studies list
//         const studiesContainer = elements.studiesList.parentElement;
//         timelineElement.id = 'drug-usage-timeline';
//         studiesContainer.insertBefore(timelineElement, elements.studiesList);
//     }
    
//     // Now continue with the original display logic
//     elements.studiesList.innerHTML = '';
//     elements.studyCount.textContent = studies.length;

//     if (studies.length === 0) {
//         elements.studiesList.innerHTML = `
//             <div class="text-center p-4 text-gray-500">
//                 <p>No studies found matching the current filters.</p>
//             </div>
//         `;
//         return;
//     }

//     // Sort studies by phase
//     const phaseOrder = { 
//         "PRE_PHASE": 0, 
//         "PHASE1": 1, 
//         "PHASE1_PHASE2": 1.5,
//         "PHASE2": 2, 
//         "PHASE3": 3, 
//         "PHASE4": 4 
//     };

//     studies.sort((a, b) => {
//         const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//         return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
//     });

//     studies.forEach(study => {
//         const nctId = study.protocolSection?.identificationModule?.nctId;
//         const title = study.protocolSection?.identificationModule?.briefTitle;
//         const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
//         const status = study.protocolSection?.statusModule?.overallStatus;
//         const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
//         const hasResults = study.hasResults;
        
//         // Determine if this is a TRD-specific study
//         const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
//         const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
//         const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
//         const trdTerms = [
//             'treatment-resistant depression', 
//             'treatment resistant depression',
//             'trd',
//             'refractory depression'
//         ];
        
//         const isTRDSpecific = trdTerms.some(term => 
//             briefTitle.includes(term) || 
//             officialTitle.includes(term) || 
//             briefSummary.includes(term)
//         );
        
//         const card = document.createElement('div');
//         card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
//         card.innerHTML = `
//             <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
//                 <div class="flex gap-2 items-center flex-wrap">
//                     <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
//                     <span class="text-sm font-medium">${formatPhase(phase)}</span>
//                     ${getStatusBadge(status)}
//                     ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
//                 </div>
//                 <div>
//                     <span class="text-xs text-gray-500">${nctId}</span>
//                     ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
//                 </div>
//             </div>
//             <h3 class="text-lg font-medium mb-2">${title}</h3>
//             <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
//             <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//                 </svg>
//                 View Study Details
//             </button>
//         `;
//         elements.studiesList.appendChild(card);
        
//         // Add event listener to the view button
//         card.querySelector('.view-study-btn').addEventListener('click', () => {
//             viewStudyDetails(nctId);
//         });
//     });
// }


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



/**
 * Extracts usage data for drug-centric timeline
 * @param {Array} studies - Array of study objects
 * @param {string} drugName - Name of the drug
 * @returns {Object} - Structured usage data
 */
function extractUsageData(studies, drugName) {
    // Initialize data structure
    const result = {
        earliestStudyYear: null,
        latestStudyYear: null,
        byCondition: {},
        byPhase: {
            "PRE_PHASE": [],
            "PHASE1": [],
            "PHASE1_PHASE2": [],
            "PHASE2": [],
            "PHASE3": [],
            "PHASE4": []
        },
        totalStudies: studies.length,
        entityType: 'drug',
        entityName: drugName
    };
    
    // Current year for comparison
    const currentYear = new Date().getFullYear();
    
    studies.forEach(study => {
        // Extract key information
        const startYear = extractYearFromDate(
            study.protocolSection?.statusModule?.startDateStruct?.date
        );
        
        const completionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.completionDateStruct?.date
        );
        
        const primaryCompletionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
        );
        
        // Use the most appropriate year available
        const studyYear = startYear || 
                         (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
                         (completionYear && completionYear <= currentYear ? completionYear : null) || 
                         null;
        
        if (!studyYear) return; // Skip if no valid year
        
        // Update earliest/latest years
        if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
            result.earliestStudyYear = studyYear;
        }
        
        if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
            result.latestStudyYear = studyYear;
        }
        
        // Extract conditions
        const conditions = study.protocolSection?.conditionsModule?.conditions || [];
        
        // If no specific conditions listed, use a placeholder
        if (conditions.length === 0) {
            const category = "Unspecified Condition";
            
            if (!result.byCondition[category]) {
                result.byCondition[category] = {
                    count: 0,
                    years: {},
                    earliestYear: null,
                    latestYear: null,
                    studies: [] // Store study IDs for linking
                };
            }
            
            result.byCondition[category].count++;
            result.byCondition[category].years[studyYear] = (result.byCondition[category].years[studyYear] || 0) + 1;
            
            // Store study ID for linking
            result.byCondition[category].studies.push({
                id: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study'
            });
            
            // Update condition-specific earliest/latest years
            if (result.byCondition[category].earliestYear === null || 
                studyYear < result.byCondition[category].earliestYear) {
                result.byCondition[category].earliestYear = studyYear;
            }
            
            if (result.byCondition[category].latestYear === null || 
                studyYear > result.byCondition[category].latestYear) {
                result.byCondition[category].latestYear = studyYear;
            }
        } else {
            // Process each condition
            conditions.forEach(condition => {
                // Keep the exact condition name as provided, only first letter capitalized for consistency
                const normalizedCondition = condition.charAt(0).toUpperCase() + condition.slice(1);
                
                // Initialize condition data if it doesn't exist
                if (!result.byCondition[normalizedCondition]) {
                    result.byCondition[normalizedCondition] = {
                        count: 0,
                        years: {},
                        earliestYear: null,
                        latestYear: null,
                        studies: [] // Store study IDs for linking
                    };
                }
                
                // Increment counts
                result.byCondition[normalizedCondition].count++;
                result.byCondition[normalizedCondition].years[studyYear] = 
                    (result.byCondition[normalizedCondition].years[studyYear] || 0) + 1;
                
                // Store study ID for linking
                result.byCondition[normalizedCondition].studies.push({
                    id: study.protocolSection?.identificationModule?.nctId,
                    year: studyYear,
                    title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                    phase: study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE"
                });
                
                // Update condition-specific earliest/latest years
                if (result.byCondition[normalizedCondition].earliestYear === null || 
                    studyYear < result.byCondition[normalizedCondition].earliestYear) {
                    result.byCondition[normalizedCondition].earliestYear = studyYear;
                }
                
                if (result.byCondition[normalizedCondition].latestYear === null || 
                    studyYear > result.byCondition[normalizedCondition].latestYear) {
                    result.byCondition[normalizedCondition].latestYear = studyYear;
                }
            });
        }
        
        // Track phases
        const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        if (result.byPhase[phase]) {
            result.byPhase[phase].push({
                nctId: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                conditions: conditions.length > 0 ? conditions : ["Unspecified"],
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study'
            });
        }
    });
    
    return result;
}

/**
 * Extracts data for condition-centric timeline
 * @param {Array} studies - Array of study objects
 * @param {string} conditionName - Name of the condition
 * @returns {Object} - Structured usage data
 */
function extractConditionData(studies, conditionName) {
    // Initialize data structure
    const result = {
        earliestStudyYear: null,
        latestStudyYear: null,
        byDrug: {}, // Instead of byCondition, we track by drug
        byPhase: {
            "PRE_PHASE": [],
            "PHASE1": [],
            "PHASE1_PHASE2": [],
            "PHASE2": [],
            "PHASE3": [],
            "PHASE4": []
        },
        totalStudies: studies.length,
        entityType: 'condition',
        entityName: conditionName
    };
    
    // Current year for comparison
    const currentYear = new Date().getFullYear();
    
    studies.forEach(study => {
        // Extract key information
        const startYear = extractYearFromDate(
            study.protocolSection?.statusModule?.startDateStruct?.date
        );
        
        const completionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.completionDateStruct?.date
        );
        
        const primaryCompletionYear = extractYearFromDate(
            study.protocolSection?.statusModule?.primaryCompletionDateStruct?.date
        );
        
        // Use the most appropriate year available
        const studyYear = startYear || 
                         (primaryCompletionYear && primaryCompletionYear <= currentYear ? primaryCompletionYear : null) || 
                         (completionYear && completionYear <= currentYear ? completionYear : null) || 
                         null;
        
        if (!studyYear) return; // Skip if no valid year
        
        // Update earliest/latest years
        if (result.earliestStudyYear === null || studyYear < result.earliestStudyYear) {
            result.earliestStudyYear = studyYear;
        }
        
        if (result.latestStudyYear === null || studyYear > result.latestStudyYear) {
            result.latestStudyYear = studyYear;
        }
        
        // Extract interventions (drugs or treatments)
        const interventions = study.protocolSection?.armsInterventionsModule?.interventions || [];
        
        // If no specific interventions listed, use a placeholder
        if (interventions.length === 0) {
            const category = "Unspecified Treatment";
            
            if (!result.byDrug[category]) {
                result.byDrug[category] = {
                    count: 0,
                    years: {},
                    earliestYear: null,
                    latestYear: null,
                    studies: [] // Store study IDs for linking
                };
            }
            
            result.byDrug[category].count++;
            result.byDrug[category].years[studyYear] = (result.byDrug[category].years[studyYear] || 0) + 1;
            
            // Store study ID for linking
            result.byDrug[category].studies.push({
                id: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                phase: study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE"
            });
            
            // Update drug-specific earliest/latest years
            if (result.byDrug[category].earliestYear === null || 
                studyYear < result.byDrug[category].earliestYear) {
                result.byDrug[category].earliestYear = studyYear;
            }
            
            if (result.byDrug[category].latestYear === null || 
                studyYear > result.byDrug[category].latestYear) {
                result.byDrug[category].latestYear = studyYear;
            }
        } else {
            // Process each intervention
            interventions.forEach(intervention => {
                // Only capture drug interventions
                if (intervention.type?.toLowerCase() !== 'drug' && 
                    intervention.type?.toLowerCase() !== 'biological' &&
                    intervention.type?.toLowerCase() !== 'combination product') {
                    return;
                }
                
                // Normalize drug name
                const drugName = intervention.name.charAt(0).toUpperCase() + intervention.name.slice(1);
                
                // Initialize drug data if it doesn't exist
                if (!result.byDrug[drugName]) {
                    result.byDrug[drugName] = {
                        count: 0,
                        years: {},
                        earliestYear: null,
                        latestYear: null,
                        studies: [] // Store study IDs for linking
                    };
                }
                
                // Increment counts
                result.byDrug[drugName].count++;
                result.byDrug[drugName].years[studyYear] = 
                    (result.byDrug[drugName].years[studyYear] || 0) + 1;
                
                // Store study ID for linking
                result.byDrug[drugName].studies.push({
                    id: study.protocolSection?.identificationModule?.nctId,
                    year: studyYear,
                    title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study',
                    phase: study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE"
                });
                
                // Update drug-specific earliest/latest years
                if (result.byDrug[drugName].earliestYear === null || 
                    studyYear < result.byDrug[drugName].earliestYear) {
                    result.byDrug[drugName].earliestYear = studyYear;
                }
                
                if (result.byDrug[drugName].latestYear === null || 
                    studyYear > result.byDrug[drugName].latestYear) {
                    result.byDrug[drugName].latestYear = studyYear;
                }
            });
        }
        
        // Track phases
        const phase = study.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        if (result.byPhase[phase]) {
            result.byPhase[phase].push({
                nctId: study.protocolSection?.identificationModule?.nctId,
                year: studyYear,
                title: study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study'
            });
        }
    });
    
    return result;
}

/**
 * Renders the timeline visualization
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */

 
// function renderTimelineVisualization(data, entityName, entityType = 'drug') {
//     const timelineElement = document.getElementById('usage-timeline');
    
//     // Determine which data field to use based on entity type
//     const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
//     const itemType = entityType === 'drug' ? 'conditions' : 'treatments';
    
//     // Create array of items sorted by number of studies (most studied first)
//     const sortedItems = Object.keys(data[dataField])
//         .map(item => ({
//             name: item,
//             ...data[dataField][item]
//         }))
//         .sort((a, b) => b.count - a.count)
//         // Limit to top 15 items to avoid overcrowding
//         .slice(0, 15);
    
//     // Calculate timeline dimensions
//     const startYear = data.earliestStudyYear;
//     const endYear = data.latestStudyYear;
//     const yearSpan = endYear - startYear + 1;
    
//     // Generate the timeline HTML
//     let timelineHTML = `
//         <div class="mb-6">
//             <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${startYear} to ${endYear}</p>
//             <p class="text-sm text-gray-500 mt-1">Showing top ${sortedItems.length} ${itemType} out of ${Object.keys(data[dataField]).length} total</p>
//         </div>
        
//         <div class="mb-4">
//             <input type="text" id="timeline-search" placeholder="Search ${itemType}..." 
//                    class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
//         </div>
        
//         <div class="timeline-chart relative">
//             <!-- Year markers -->
//             <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
//     `;
    
//     // Add year markers (show at most 10 years to avoid overcrowding)
//     const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
//     for (let year = startYear; year <= endYear; year += yearStep) {
//         const position = ((year - startYear) / yearSpan) * 100;
//         timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
//     }
    
//     timelineHTML += `
//             </div>
            
//             <!-- Timeline tracks -->
//             <div class="timeline-tracks space-y-6">
//     `;
    
//     // Generate a track for each item
//     sortedItems.forEach((item, index) => {
//         const startPosition = ((item.earliestYear - startYear) / yearSpan) * 100;
//         const endPosition = 100 - ((endYear - item.latestYear) / yearSpan) * 100;
//         const width = endPosition - startPosition;
        
//         // Generate a color based on the item index
//         const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
//         const color = `hsl(${hue}, 70%, 60%)`;
//         const darkColor = `hsl(${hue}, 70%, 40%)`;
        
//         timelineHTML += `
//             <div class="item-track" data-item="${item.name.toLowerCase()}">
//                 <div class="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
//                     <a href="#" class="item-link font-medium text-sm break-words text-blue-600 hover:text-blue-800 hover:underline" 
//                        data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
//                         ${item.name}
//                     </a>
//                     <span class="text-xs text-gray-500">${item.count} ${item.count === 1 ? 'study' : 'studies'}</span>
//                 </div>
//                 <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
//                     <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${color};">
//                         <div class="h-full flex items-center justify-center text-xs font-bold text-white whitespace-nowrap px-2 overflow-hidden">
//                             ${item.earliestYear} - ${item.latestYear}
//                         </div>
//                     </div>
//                 </div>
                
//                 <!-- Activity indicators -->
//                 <div class="relative h-1 mt-1">
//         `;
        
//         // Add activity indicators (small circles indicating study frequency)
//         Object.keys(item.years).forEach(year => {
//             const yearPosition = ((year - startYear) / yearSpan) * 100;
//             const studyCount = item.years[year];
//             const size = Math.min(12, Math.max(4, studyCount * 2)); // Scale based on study count
            
//             // Find studies for this year and item
//             const yearStudies = item.studies.filter(study => study.year == year);
//             const studyIds = yearStudies.map(study => study.id).join(',');
//             const studyTitles = yearStudies.map(study => study.title).join('||');
            
//             timelineHTML += `
//                 <div class="absolute rounded-full study-indicator cursor-pointer" 
//                      style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${darkColor};"
//                      data-year="${year}" 
//                      data-count="${studyCount}"
//                      data-item="${item.name}"
//                      data-studies="${studyIds}"
//                      data-titles="${encodeURIComponent(studyTitles)}"
//                      title="${year}: ${studyCount} ${studyCount === 1 ? 'study' : 'studies'} for ${item.name}">
//                 </div>
//             `;
//         });
        
//         timelineHTML += `
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
        
//         <!-- View all button for when there are more than shown -->
//         ${Object.keys(data[dataField]).length > sortedItems.length ? `
//         <div class="mt-4 text-center">
//             <button id="view-all-items" class="px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm">
//                 View All ${Object.keys(data[dataField]).length} ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}
//             </button>
//         </div>
//         ` : ''}
        
//         <!-- Study details popup -->
//         <div id="study-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
//             <div class="bg-white rounded-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
//                 <div class="p-4 border-b flex justify-between items-center">
//                     <h3 class="text-lg font-bold" id="popup-title">Studies</h3>
//                     <button id="close-popup" class="text-gray-500 hover:text-gray-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                         </svg>
//                     </button>
//                 </div>
//                 <div class="overflow-y-auto p-4" id="popup-content">
//                     <!-- Content will be dynamically inserted here -->
//                 </div>
//             </div>
//         </div>
        
//         <!-- Evolution insights -->
//         <div class="mt-8">
//             <h3 class="text-lg font-medium mb-3">Key Clinical Insights</h3>
//             <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
//     `;
    
//     // Generate insights based on the data
//     const insights = generateInsights(data, entityName, sortedItems, entityType);
    
//     insights.forEach(insight => {
//         timelineHTML += `
//             <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
//                 <div class="flex items-start">
//                     <div class="insight-icon mr-3 text-blue-500">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
//                             <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
//                         </svg>
//                     </div>
//                     <p class="text-sm">${insight}</p>
//                 </div>
//             </div>
//         `;
//     });
    
//     timelineHTML += `
//             </div>
//         </div>
//     `;
    
//     // Update the timeline element
//     timelineElement.innerHTML = timelineHTML;
    
//     // Add event listeners
    
//     // 1. Search functionality
//     const searchInput = document.getElementById('timeline-search');
//     if (searchInput) {
//         searchInput.addEventListener('input', (e) => {
//             const searchTerm = e.target.value.toLowerCase();
//             const tracks = document.querySelectorAll('.item-track');
            
//             tracks.forEach(track => {
//                 const itemName = track.dataset.item;
//                 if (!searchTerm || itemName.includes(searchTerm)) {
//                     track.style.display = '';
//                 } else {
//                     track.style.display = 'none';
//                 }
//             });
//         });
//     }
    
//     // 2. View all button
//     const viewAllButton = document.getElementById('view-all-items');
//     if (viewAllButton) {
//         viewAllButton.addEventListener('click', () => {
//             // Show modal with all items
//             showAllItemsModal(data, entityName, entityType);
//         });
//     }
    
//     // 3. Study indicators (dots)
//     const studyIndicators = document.querySelectorAll('.study-indicator');
//     studyIndicators.forEach(indicator => {
//         indicator.addEventListener('click', (e) => {
//             const year = e.target.dataset.year;
//             const item = e.target.dataset.item;
//             const count = e.target.dataset.count;
//             const studyIds = e.target.dataset.studies.split(',');
//             const studyTitles = decodeURIComponent(e.target.dataset.titles).split('||');
            
//             // Show popup with links to studies
//             const popup = document.getElementById('study-popup');
//             const popupTitle = document.getElementById('popup-title');
//             const popupContent = document.getElementById('popup-content');
            
//             popupTitle.textContent = `${count} Studies for ${item} (${year})`;
            
//             let studyListHTML = `<ul class="space-y-2">`;
            
//             for (let i = 0; i < studyIds.length; i++) {
//                 studyListHTML += `
//                     <li class="border-b border-gray-100 pb-2">
//                         <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link" data-nctid="${studyIds[i]}">
//                             ${studyTitles[i] || `Study ${i+1}`}
//                         </a>
//                     </li>
//                 `;
//             }
            
//             studyListHTML += `</ul>`;
//             popupContent.innerHTML = studyListHTML;
            
//             // Add event listeners to study links
//             const studyLinks = popupContent.querySelectorAll('.study-link');
//             studyLinks.forEach(link => {
//                 link.addEventListener('click', (e) => {
//                     e.preventDefault();
//                     const nctId = e.target.dataset.nctid;
//                     if (nctId) {
//                         // Close the popup
//                         popup.classList.add('hidden');
//                         // View study details (assuming viewStudyDetails function exists)
//                         viewStudyDetails(nctId);
//                     }
//                 });
//             });
            
//             // Show the popup
//             popup.classList.remove('hidden');
//         });
//     });
    
//     // 4. Close popup button
//     const closePopupButton = document.getElementById('close-popup');
//     if (closePopupButton) {
//         closePopupButton.addEventListener('click', () => {
//             document.getElementById('study-popup').classList.add('hidden');
//         });
//     }
//     // 5. Item links (condition/drug names)
//     const itemLinks = document.querySelectorAll('.item-link');
//     itemLinks.forEach(link => {
//         link.addEventListener('click', (e) => {
//             e.preventDefault();
//             const itemName = e.target.dataset.item;
//             const itemType = e.target.dataset.type;
            
//             // Trigger search for this item
//             // This would typically call your search function with the item as the search term
//             if (typeof searchForEntity === 'function') {
//                 searchForEntity(itemName, itemType);
//             } else {
//                 alert(`Search for ${itemType}: ${itemName} would be triggered here`);
//                 console.log(`Search for ${itemType}: ${itemName}`);
//             }
//         });
//     });
    
//     // 6. Close popup when clicking outside
//     const popup = document.getElementById('study-popup');
//     if (popup) {
//         popup.addEventListener('click', (e) => {
//             if (e.target === popup) {
//                 popup.classList.add('hidden');
//             }
//         });
//     }
// }
function renderTimelineVisualization(data, entityName, entityType = 'drug') {
    const timelineElement = document.getElementById('usage-timeline');
    
    // Determine which data field to use based on entity type
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'conditions' : 'treatments';
    
    // Create array of items sorted by number of studies (most studied first)
    const sortedItems = Object.keys(data[dataField])
        .map(item => ({
            name: item,
            ...data[dataField][item]
        }))
        .sort((a, b) => b.count - a.count)
        // Limit to top 15 items to avoid overcrowding
        .slice(0, 15);
    
    // Calculate timeline dimensions
    const startYear = data.earliestStudyYear;
    const endYear = data.latestStudyYear;
    const yearSpan = endYear - startYear + 1;
    
    // Generate the timeline HTML
    let timelineHTML = `
        <div class="mb-6">
            <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${startYear} to ${endYear}</p>
            <p class="text-sm text-gray-500 mt-1">Showing top ${sortedItems.length} ${itemType} out of ${Object.keys(data[dataField]).length} total</p>
        </div>
        
        <div class="mb-4">
            <input type="text" id="timeline-search" placeholder="Search ${itemType}..." 
                   class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
        </div>
        
        <div class="timeline-chart relative">
            <!-- Year markers -->
            <div class="year-markers flex justify-between text-xs text-gray-500 mb-2">
    `;
    
    // Add year markers (show at most 10 years to avoid overcrowding)
    const yearStep = Math.max(1, Math.ceil(yearSpan / 10));
    for (let year = startYear; year <= endYear; year += yearStep) {
        const position = ((year - startYear) / yearSpan) * 100;
        timelineHTML += `<div class="absolute" style="left: ${position}%">${year}</div>`;
    }
    
    timelineHTML += `
            </div>
            
            <!-- Timeline tracks -->
            <div class="timeline-tracks space-y-6">
    `;
    
    // Generate a track for each item
    sortedItems.forEach((item, index) => {
        const startPosition = ((item.earliestYear - startYear) / yearSpan) * 100;
        const endPosition = 100 - ((endYear - item.latestYear) / yearSpan) * 100;
        const width = endPosition - startPosition;
        
        // Generate a color based on the item index
        const hue = (index * 137.5) % 360; // Golden ratio to distribute colors
        const color = `hsl(${hue}, 70%, 60%)`;
        const darkColor = `hsl(${hue}, 70%, 40%)`;
        
        timelineHTML += `
            <div class="item-track" data-item="${item.name.toLowerCase()}">
                <div class="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
                    <a href="#" class="item-link font-medium text-sm break-words text-blue-600 hover:text-blue-800 hover:underline" 
                       data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
                        ${item.name}
                    </a>
                    <span class="text-xs text-gray-500">${item.count} ${item.count === 1 ? 'study' : 'studies'}</span>
                </div>
                <div class="relative h-8 bg-gray-100 rounded-full overflow-hidden">
                    <div class="absolute h-full rounded-full" style="left: ${startPosition}%; width: ${width}%; background-color: ${color};">
                        <div class="h-full flex items-center justify-center text-xs font-bold text-white whitespace-nowrap px-2 overflow-hidden">
                            ${item.earliestYear} - ${item.latestYear}
                        </div>
                    </div>
                </div>
                
                <!-- Activity indicators -->
                <div class="relative h-1 mt-1">
        `;
        
        // Add activity indicators (small circles indicating study frequency)
        Object.keys(item.years).forEach(year => {
            const yearPosition = ((year - startYear) / yearSpan) * 100;
            const studyCount = item.years[year];
            const size = Math.min(12, Math.max(4, studyCount * 2)); // Scale based on study count
            
            timelineHTML += `
                <div class="absolute rounded-full study-indicator cursor-pointer" 
                     style="left: ${yearPosition}%; top: -${size/4}px; width: ${size}px; height: ${size}px; background-color: ${darkColor};"
                     data-year="${year}" 
                     data-count="${studyCount}"
                     data-item="${item.name}"
                     title="${year}: ${studyCount} ${studyCount === 1 ? 'study' : 'studies'} for ${item.name}">
                </div>
            `;
        });
        
        timelineHTML += `
                </div>
            </div>
        `;
    });
    
    timelineHTML += `
            </div>
        </div>
        
        <!-- View all button for when there are more than shown -->
        ${Object.keys(data[dataField]).length > sortedItems.length ? `
        <div class="mt-4 text-center">
            <button id="view-all-items" class="px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm">
                View All ${Object.keys(data[dataField]).length} ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}
            </button>
        </div>
        ` : ''}
        
        <!-- Usage detail modal (will be created dynamically) -->
        <div id="usage-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>
        
        <!-- Evolution insights -->
        <div class="mt-8">
            <h3 class="text-lg font-medium mb-3">Key Clinical Insights</h3>
            <div class="evolution-patterns grid grid-cols-1 md:grid-cols-2 gap-4">
    `;
    
    // Generate insights based on the data
    const insights = generateInsights(data, entityName, sortedItems, entityType);
    
    insights.forEach(insight => {
        timelineHTML += `
            <div class="insight-card p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-start">
                    <div class="insight-icon mr-3 text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <p class="text-sm">${insight}</p>
                </div>
            </div>
        `;
    });
    
    timelineHTML += `
            </div>
        </div>
    `;
    
    // Update the timeline element
    timelineElement.innerHTML = timelineHTML;
    
    // Add event listeners
    
    // 1. Search functionality
    const searchInput = document.getElementById('timeline-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const tracks = document.querySelectorAll('.item-track');
            
            tracks.forEach(track => {
                const itemName = track.dataset.item;
                if (!searchTerm || itemName.includes(searchTerm)) {
                    track.style.display = '';
                } else {
                    track.style.display = 'none';
                }
            });
        });
    }
    
    // 2. View all button
    const viewAllButton = document.getElementById('view-all-items');
    if (viewAllButton) {
        viewAllButton.addEventListener('click', () => {
            // Show modal with all items
            showAllItemsModal(data, entityName, entityType);
        });
    }
    
    // 3. Item links (condition/drug names)
    const itemLinks = document.querySelectorAll('.item-link');
    itemLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const itemName = e.target.dataset.item;
            const itemType = e.target.dataset.type;
            
            // Get the data for this item
            const itemData = data[dataField][itemName];
            
            if (itemData) {
                // Show detailed modal
                showUsageDetailModal(itemData, itemName, entityType);
            } else {
                // Fallback to search
                if (typeof searchForEntity === 'function') {
                    searchForEntity(itemName, itemType);
                } else {
                    alert(`Search for ${itemType}: ${itemName}`);
                    console.log(`Search for ${itemType}: ${itemName}`);
                }
            }
        });
    });
    
    // 4. Study indicators (dots)
    const studyIndicators = document.querySelectorAll('.study-indicator');
    studyIndicators.forEach(indicator => {
        indicator.addEventListener('click', (e) => {
            const item = e.target.dataset.item;
            
            // Get the data for this item
            const itemData = data[dataField][item];
            
            if (itemData) {
                // Show detailed modal
                showUsageDetailModal(itemData, item, entityType);
            }
        });
    });
}

/**
 * Shows a detailed modal for a specific usage (condition or drug)
 * @param {Object} itemData - Data for the specific item
 * @param {string} itemName - Name of the item (condition or drug)
 * @param {string} entityType - Type of the parent entity ('drug' or 'condition')
 */
function showUsageDetailModal(itemData, itemName, entityType) {
    // Get or create modal container
    let modal = document.getElementById('usage-detail-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'usage-detail-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        document.body.appendChild(modal);
    }
    
    // Make sure modal is visible
    modal.classList.remove('hidden');
    
    // Determine relation type based on entity type
    const relationType = entityType === 'drug' ? 'condition' : 'drug';
    const relationTypeName = entityType === 'drug' ? 'Condition' : 'Treatment';
    
    // Sort studies by year (newest first)
    const sortedStudies = [...(itemData.studies || [])].sort((a, b) => b.year - a.year);
    
    // Group studies by phase
    const studiesByPhase = {};
    sortedStudies.forEach(study => {
        const phase = study.phase || 'Unknown';
        if (!studiesByPhase[phase]) {
            studiesByPhase[phase] = [];
        }
        studiesByPhase[phase].push(study);
    });
    
    // Get phase order for sorting
    const phaseOrder = {
        "PHASE4": 1,
        "PHASE3": 2,
        "PHASE2": 3,
        "PHASE1_PHASE2": 4,
        "PHASE1": 5,
        "PRE_PHASE": 6,
        "Unknown": 7
    };
    
    // Sort phases
    const sortedPhases = Object.keys(studiesByPhase).sort((a, b) => 
        (phaseOrder[a] || 999) - (phaseOrder[b] || 999)
    );
    
    // Create a heatmap data for years
    const yearData = [];
    const years = Object.keys(itemData.years || {}).map(Number).sort((a, b) => a - b);
    
    // Find max studies in a year for scaling
    const maxYearCount = Math.max(...Object.values(itemData.years || {}).map(count => Number(count)));
    
    years.forEach(year => {
        const count = itemData.years[year] || 0;
        // Calculate color intensity based on count relative to max
        const intensity = Math.floor((count / maxYearCount) * 100);
        yearData.push({
            year,
            count,
            intensity
        });
    });
    
    // Create modal content
    let modalContent = `
        <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b bg-gray-50">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">${itemName}</h3>
                    <button id="close-usage-detail-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-600">
                    ${relationTypeName} studied from ${itemData.earliestYear} to ${itemData.latestYear} 
                    (${itemData.count} total studies)
                </p>
            </div>
            
            <div class="overflow-y-auto">
                <!-- Quick stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border-b">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="text-sm text-blue-600 font-medium">First Studied</div>
                        <div class="text-2xl font-bold">${itemData.earliestYear}</div>
                        <div class="text-xs text-gray-500">${new Date().getFullYear() - itemData.earliestYear} years ago</div>
                    </div>
                    
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="text-sm text-green-600 font-medium">Total Studies</div>
                        <div class="text-2xl font-bold">${itemData.count}</div>
                        <div class="text-xs text-gray-500">Across ${years.length} years</div>
                    </div>
                    
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <div class="text-sm text-purple-600 font-medium">Latest Activity</div>
                        <div class="text-2xl font-bold">${itemData.latestYear}</div>
                        <div class="text-xs text-gray-500">${itemData.years[itemData.latestYear] || 0} studies in that year</div>
                    </div>
                </div>
                
                <!-- Year activity heatmap -->
                <div class="p-4 border-b">
                    <h4 class="text-lg font-medium mb-3">Research Activity by Year</h4>
                    <div class="flex flex-wrap gap-1 justify-center">
    `;
    
    // Generate year blocks for heatmap
    yearData.forEach(data => {
        const blueIntensity = Math.min(255, Math.max(100, 220 - data.intensity * 1.5));
        modalContent += `
            <div class="relative group">
                <div class="w-10 h-10 flex items-center justify-center text-xs font-medium 
                           ${data.intensity > 50 ? 'text-white' : 'text-gray-800'}" 
                     style="background-color: rgb(0, 0, ${blueIntensity})">
                    ${data.year}
                </div>
                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">
                    ${data.count} studies in ${data.year}
                </div>
            </div>
        `;
    });
    
    modalContent += `
                    </div>
                </div>
                
                <!-- Studies breakdown -->
                <div class="p-4">
                    <h4 class="text-lg font-medium mb-3">Studies by Phase</h4>
                    <div class="space-y-4">
    `;
    
    // Create phase sections
    sortedPhases.forEach(phase => {
        const phaseStudies = studiesByPhase[phase];
        const formattedPhase = formatPhase(phase);
        
        modalContent += `
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-gray-50 p-3 flex justify-between items-center">
                    <div class="flex items-center">
                        <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPhaseColor(phase)}"></span>
                        <h5 class="font-medium">${formattedPhase}</h5>
                    </div>
                    <span class="text-sm text-gray-500">${phaseStudies.length} studies</span>
                </div>
                
                <div class="divide-y divide-gray-100">
        `;
        
        // List studies in this phase
        phaseStudies.forEach(study => {
            modalContent += `
                <div class="p-3 hover:bg-gray-50">
                    <div class="flex justify-between items-start mb-1">
                        <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link" data-nctid="${study.id}">
                            ${study.title || 'Untitled Study'}
                        </a>
                        <span class="text-xs text-gray-500">${study.year}</span>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800 study-link" data-nctid="${study.id}">
                            View Details
                        </a>
                        <span class="text-gray-300">|</span>
                        <a href="https://clinicaltrials.gov/study/${study.id}" target="_blank" class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                            ClinicalTrials.gov
                        </a>
                    </div>
                </div>
            `;
        });
        
        modalContent += `
                </div>
            </div>
        `;
    });
    
    modalContent += `
                    </div>
                </div>
            </div>
            
            <!-- Footer with export options -->
            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                <button id="export-usage-data" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export Data
                </button>
                
                <a href="#" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors text-sm flex items-center" id="search-all-studies-link" data-item="${itemName}" data-type="${relationType}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    View All Studies
                </a>
            </div>
        </div>
    `;
    
    // Insert modal content
    modal.innerHTML = modalContent;
    
    // Add event listeners
    
    // 1. Close modal button
    document.getElementById('close-usage-detail-modal').addEventListener('click', () => {
        modal.classList.add('hidden');
    });
    
    // 2. Close when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.add('hidden');
        }
    });
    
    // 3. Study links
    const studyLinks = modal.querySelectorAll('.study-link');
    studyLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const nctId = e.target.dataset.nctid;
            if (nctId) {
                // Close the modal
                modal.classList.add('hidden');
                // View study details
                viewStudyDetails(nctId);
            }
        });
    });
    
    // 4. Export data button
    document.getElementById('export-usage-data').addEventListener('click', () => {
        exportUsageData(itemData, itemName);
    });
    
    // 5. Search all studies link
    document.getElementById('search-all-studies-link').addEventListener('click', (e) => {
        e.preventDefault();
        const searchItem = e.target.dataset.item;
        const searchType = e.target.dataset.type;
        
        // Close the modal
        modal.classList.add('hidden');
        
        // Trigger search for all studies
        if (typeof searchForEntity === 'function') {
            searchForEntity(searchItem, searchType);
        } else {
            alert(`Search for all studies with ${searchType}: ${searchItem}`);
            console.log(`Search for all studies with ${searchType}: ${searchItem}`);
        }
    });
}

/**
 * Exports data for a specific usage (condition or drug)
 * @param {Object} itemData - Data for the specific item
 * @param {string} itemName - Name of the item
 */
function exportUsageData(itemData, itemName) {
    // Prepare data for CSV export
    const csvRows = [];
    
    // Header row
    csvRows.push(['Study ID', 'Title', 'Year', 'Phase']);
    
    // Data rows
    (itemData.studies || []).forEach(study => {
        csvRows.push([
            study.id,
            study.title || 'Untitled Study',
            study.year,
            study.phase || 'Unknown'
        ]);
    });
    
    // Convert to CSV string
    let csvContent = csvRows.map(row => 
        row.map(cell => 
            typeof cell === 'string' && cell.includes(',') 
                ? `"${cell.replace(/"/g, '""')}"` 
                : String(cell)
        ).join(',')
    ).join('\n');
    
    // Create download link
    const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `${itemName.replace(/\s+/g, '_')}_studies.csv`);
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    document.body.removeChild(link);
}

/**
 * Helper function to format phase for display
 * @param {string} phase - Raw phase value
 * @returns {string} - Formatted phase string
 */
function formatPhase(phase) {
    switch(phase) {
        case "PRE_PHASE":
            return "Pre-Clinical";
        case "PHASE1":
            return "Phase 1";
        case "PHASE1_PHASE2":
            return "Phase 1/2";
        case "PHASE2":
            return "Phase 2";
        case "PHASE3":
            return "Phase 3";
        case "PHASE4":
            return "Phase 4";
        default:
            return phase || "Unknown";
    }
}

/**
 * Helper function to get color for phase
 * @param {string} phase - Raw phase value
 * @returns {string} - Color hex code
 */
function getPhaseColor(phase) {
    switch(phase) {
        case "PRE_PHASE":
            return "#9CA3AF"; // gray-400
        case "PHASE1":
            return "#60A5FA"; // blue-400
        case "PHASE1_PHASE2":
            return "#34D399"; // green-400
        case "PHASE2":
            return "#10B981"; // green-500
        case "PHASE3":
            return "#047857"; // green-700
        case "PHASE4":
            return "#064E3B"; // green-900
        default:
            return "#D1D5DB"; // gray-300
    }
}
/**
 * Renders the timeline data as a list
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */
function renderTimelineList(data, entityName, entityType = 'drug') {
    const timelineElement = document.getElementById('usage-timeline');
    
    // Determine which data field to use based on entity type
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'conditions' : 'treatments';
    
    // Create sorted array of all items
    const allItems = Object.keys(data[dataField])
        .map(item => ({
            name: item,
            ...data[dataField][item]
        }))
        .sort((a, b) => b.count - a.count);
    
    // Generate the list HTML
    let listHTML = `
        <div class="mb-6">
            <p class="text-sm text-gray-600">Based on analysis of ${data.totalStudies} clinical trials from ${data.earliestStudyYear} to ${data.latestStudyYear}</p>
        </div>
        
        <div class="mb-4">
            <input type="text" id="timeline-list-search" placeholder="Search ${itemType}..." 
                   class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${entityType === 'drug' ? 'Condition' : 'Treatment'}</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Studies</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Year Range</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Peak Activity</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="timeline-list-body">
    `;
    
    allItems.forEach((item, index) => {
        // Find peak year (year with most studies)
        let peakYear = null;
        let peakCount = 0;
        
        Object.keys(item.years).forEach(year => {
            if (item.years[year] > peakCount) {
                peakCount = item.years[year];
                peakYear = year;
            }
        });
        
        listHTML += `
            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}" data-item="${item.name.toLowerCase()}">
                <td class="px-4 py-2 text-sm font-medium">
                    <a href="#" class="item-link text-blue-600 hover:text-blue-800 hover:underline" 
                       data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
                        ${item.name}
                    </a>
                </td>
                <td class="px-4 py-2 text-sm text-center">${item.count}</td>
                <td class="px-4 py-2 text-sm text-center">${item.earliestYear} - ${item.latestYear}</td>
                <td class="px-4 py-2 text-sm text-center">
                    <span class="inline-flex items-center">
                        ${peakYear ? `${peakYear} (${peakCount} studies)` : 'N/A'}
                        <button class="ml-2 text-blue-500 hover:text-blue-700 view-year-studies"
                                data-year="${peakYear}" 
                                data-item="${item.name}"
                                data-count="${peakCount}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </span>
                </td>
            </tr>
        `;
    });
    
    listHTML += `
                </tbody>
            </table>
        </div>
        
        <!-- Study details popup -->
        <div id="list-study-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-bold" id="list-popup-title">Studies</h3>
                    <button id="close-list-popup" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="overflow-y-auto p-4" id="list-popup-content">
                    <!-- Content will be dynamically inserted here -->
                </div>
            </div>
        </div>
    `;
    
    // Update the timeline element
    timelineElement.innerHTML = listHTML;
    
    // Add event listeners
    
    // 1. Search functionality
    const searchInput = document.getElementById('timeline-list-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#timeline-list-body tr');
            
            rows.forEach(row => {
                const itemName = row.dataset.item;
                if (!searchTerm || itemName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // 2. Item links
    const itemLinks = document.querySelectorAll('.item-link');
    itemLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const itemName = e.target.dataset.item;
            const itemType = e.target.dataset.type;
            
            // Trigger search for this item
            if (typeof searchForEntity === 'function') {
                searchForEntity(itemName, itemType);
            } else {
                alert(`Search for ${itemType}: ${itemName} would be triggered here`);
                console.log(`Search for ${itemType}: ${itemName}`);
            }
        });
    });
    
    // 3. View year studies buttons
    const viewYearButtons = document.querySelectorAll('.view-year-studies');
    viewYearButtons.forEach(button => {
        button.addEventListener('click', () => {
            const year = button.dataset.year;
            const item = button.dataset.item;
            const count = button.dataset.count;
            
            // Find studies for this year and item
            const itemData = data[dataField][item];
            if (!itemData || !itemData.studies) return;
            
            const yearStudies = itemData.studies.filter(study => study.year == year);
            
            // Show popup with links to studies
            const popup = document.getElementById('list-study-popup');
            const popupTitle = document.getElementById('list-popup-title');
            const popupContent = document.getElementById('list-popup-content');
            
            popupTitle.textContent = `${count} Studies for ${item} (${year})`;
            
            let studyListHTML = `<ul class="space-y-2">`;
            
            yearStudies.forEach((study, i) => {
                studyListHTML += `
                    <li class="border-b border-gray-100 pb-2">
                        <a href="#" class="text-blue-600 hover:text-blue-800 font-medium study-link" data-nctid="${study.id}">
                            ${study.title || `Study ${i+1}`}
                        </a>
                    </li>
                `;
            });
            
            studyListHTML += `</ul>`;
            popupContent.innerHTML = studyListHTML;
            
            // Add event listeners to study links
            const studyLinks = popupContent.querySelectorAll('.study-link');
            studyLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const nctId = e.target.dataset.nctid;
                    if (nctId) {
                        // Close the popup
                        popup.classList.add('hidden');
                        // View study details
                        viewStudyDetails(nctId);
                    }
                });
            });
            
            // Show the popup
            popup.classList.remove('hidden');
        });
    });
    
    // 4. Close popup button
    const closePopupButton = document.getElementById('close-list-popup');
    if (closePopupButton) {
        closePopupButton.addEventListener('click', () => {
            document.getElementById('list-study-popup').classList.add('hidden');
        });
    }
    
    // 5. Close popup when clicking outside
    const popup = document.getElementById('list-study-popup');
    if (popup) {
        popup.addEventListener('click', (e) => {
            if (e.target === popup) {
                popup.classList.add('hidden');
            }
        });
    }
}

/**
 * Shows a modal with all items in the timeline
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */
function showAllItemsModal(data, entityName, entityType = 'drug') {
    // Create a modal to display all items
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    // Determine which data field to use based on entity type
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'Conditions' : 'Treatments';
    
    // Sort all items by count
    const allItems = Object.keys(data[dataField])
        .map(item => ({
            name: item,
            count: data[dataField][item].count,
            earliestYear: data[dataField][item].earliestYear,
            latestYear: data[dataField][item].latestYear
        }))
        .sort((a, b) => b.count - a.count);
    
    // Create the modal content
    let modalContent = `
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">All ${itemType} for ${entityName}</h3>
                    <button id="close-items-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500">${allItems.length} total ${itemType.toLowerCase()} found in clinical trials</p>
                
                <div class="mt-2">
                    <input type="text" id="modal-search" placeholder="Search ${itemType.toLowerCase()}..." 
                           class="w-full p-2 border border-gray-300 rounded shadow-sm text-sm">
                </div>
            </div>
            <div class="overflow-y-auto p-4">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${entityType === 'drug' ? 'Condition' : 'Treatment'}</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Studies</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Year Range</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="modal-items-list">
    `;
    
    allItems.forEach((item, index) => {
        modalContent += `
            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}" data-item="${item.name.toLowerCase()}">
                <td class="px-4 py-2 text-sm">${item.name}</td>
                <td class="px-4 py-2 text-sm text-center">${item.count}</td>
                <td class="px-4 py-2 text-sm text-center">${item.earliestYear} - ${item.latestYear}</td>
                <td class="px-4 py-2 text-sm text-center">
                    <button class="text-blue-600 hover:text-blue-800 view-item-studies"
                            data-item="${item.name}" data-type="${entityType === 'drug' ? 'condition' : 'drug'}">
                        View Studies
                    </button>
                </td>
            </tr>
        `;
    });
    
    modalContent += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
    
    // Add event listeners
    
    // 1. Close modal button
    document.getElementById('close-items-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    // 2. Close when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // 3. Search functionality
    const searchInput = document.getElementById('modal-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#modal-items-list tr');
            
            rows.forEach(row => {
                const itemName = row.dataset.item;
                if (!searchTerm || itemName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // 4. View item studies buttons
    const viewItemButtons = document.querySelectorAll('.view-item-studies');
    viewItemButtons.forEach(button => {
        button.addEventListener('click', () => {
            const itemName = button.dataset.item;
            const itemType = button.dataset.type;
            
            // Close the modal
            document.body.removeChild(modal);
            
            // Redirect to item-specific page or trigger search
            if (typeof searchForEntity === 'function') {
                searchForEntity(itemName, itemType);
            } else {
                alert(`Search for ${itemType}: ${itemName} would be triggered here`);
                console.log(`Search for ${itemType}: ${itemName}`);
            }
        });
    });
}

/**
 * Generates insights based on timeline data
 * @param {Object} data - Processed timeline data
 * @param {string} entityName - Name of the drug or condition
 * @param {Array} sortedItems - Array of sorted items (conditions or drugs)
 * @param {string} entityType - Either 'drug' or 'condition'
 * @returns {Array} - Array of insight strings
 */
function generateInsights(data, entityName, sortedItems, entityType = 'drug') {
    const insights = [];
    const currentYear = new Date().getFullYear();
    
    // Determine field and terminology based on entity type
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'condition' : 'treatment';
    
    // Insight 1: First studied indication/treatment
    if (sortedItems.length > 0) {
        const firstItem = [...sortedItems].sort((a, b) => a.earliestYear - b.earliestYear)[0];
        if (entityType === 'drug') {
            insights.push(
                `${entityName} was first studied for <strong>${firstItem.name}</strong> in ${firstItem.earliestYear}, ${currentYear - firstItem.earliestYear} years ago.`
            );
        } else {
            insights.push(
                `${entityName} was first treated with <strong>${firstItem.name}</strong> in clinical trials starting in ${firstItem.earliestYear}, ${currentYear - firstItem.earliestYear} years ago.`
            );
        }
    }
    
    // Insight 2: Most studied indication/treatment
    const mostStudiedItem = sortedItems.length > 0 ? sortedItems[0] : null;
    if (mostStudiedItem) {
        if (entityType === 'drug') {
            insights.push(
                `The most researched application has been <strong>${mostStudiedItem.name}</strong> with ${mostStudiedItem.count} studies.`
            );
        } else {
            insights.push(
                `The most commonly investigated treatment has been <strong>${mostStudiedItem.name}</strong> with ${mostStudiedItem.count} studies.`
            );
        }
    }
    
    // Insight 3: Count unique conditions/treatments
    const uniqueItemCount = Object.keys(data[dataField]).length;
    if (entityType === 'drug') {
        insights.push(
            `${entityName} has been investigated for ${uniqueItemCount} distinct clinical conditions, showing its potential versatility across multiple medical applications.`
        );
    } else {
        insights.push(
            `${entityName} has been studied with ${uniqueItemCount} different treatments in clinical trials, reflecting the diverse therapeutic approaches being explored.`
        );
    }
    
    // Insight 4: Phase progression
    const phaseData = data.byPhase;
    const latePhaseCount = (phaseData.PHASE3 || []).length + (phaseData.PHASE4 || []).length;
    const totalPhaseCount = Object.values(phaseData).flat().length;
    
    if (totalPhaseCount > 0) {
        const latePhasePercentage = Math.round((latePhaseCount / totalPhaseCount) * 100);
        insights.push(
            `${latePhasePercentage}% of studies have reached late-stage (Phase 3-4) clinical trials, indicating ${latePhasePercentage > 30 ? 'significant' : 'ongoing'} progress toward regulatory approval.`
        );
    }
    
    // Insight 5: Recent activity and trend
    const recentYears = currentYear - 5;
    let recentActivityCount = 0;
    const recentItems = new Set();
    
    sortedItems.forEach(item => {
        Object.keys(item.years).forEach(year => {
            if (parseInt(year) >= recentYears) {
                recentActivityCount += item.years[year];
                recentItems.add(item.name);
            }
        });
    });
    
    if (recentItems.size > 0) {
        const topRecentItems = Array.from(recentItems).slice(0, 3);
        if (topRecentItems.length > 0) {
            if (entityType === 'drug') {
                insights.push(
                    `In the last 5 years, research has focused on ${recentItems.size} conditions, with notable interest in <strong>${topRecentItems.join('</strong>, <strong>')}</strong>.`
                );
            } else {
                insights.push(
                    `In the last 5 years, clinical research has explored ${recentItems.size} treatments, with significant focus on <strong>${topRecentItems.join('</strong>, <strong>')}</strong>.`
                );
            }
        }
    }
    
    // Insight 6: Historical perspective
    const yearSpan = data.latestStudyYear - data.earliestStudyYear;
    if (yearSpan >= 10) {
        insights.push(
            `Clinical investigation of ${entityName} spans ${yearSpan} years, demonstrating sustained scientific interest and evolving research approaches over time.`
        );
    }
    
    return insights;
}

/**
 * Extracts year from date string
 * @param {string} dateString - Date string in various formats
 * @returns {number|null} - Extracted year or null if not found
 */
function extractYearFromDate(dateString) {
    if (!dateString) return null;
    
    // Extract year from YYYY-MM-DD format
    const match = dateString.match(/^(\d{4})-/);
    if (match) {
        return parseInt(match[1]);
    }
    
    // Try to extract any 4-digit year
    const yearMatch = dateString.match(/\b(\d{4})\b/);
    if (yearMatch) {
        const year = parseInt(yearMatch[1]);
        // Validate year is reasonable (between 1950 and current year + 5)
        const currentYear = new Date().getFullYear();
        if (year >= 1950 && year <= currentYear + 5) {
            return year;
        }
    }
    
    return null;
}

/**
 * Displays studies with timeline visualization
 * @param {Array} studies - Array of study objects
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 */
function displayStudiesWithTimeline(studies, entityName, entityType) {

    // Create and append the timeline
    const timelineElement = generateUsageTimeline(studies, entityName, entityType);
    
    // Check if there's already a timeline
    const existingTimeline = document.getElementById('entity-usage-timeline');
    if (existingTimeline) {
        existingTimeline.replaceWith(timelineElement);
    } else {
        // Insert the timeline before the studies list
        const studiesContainer = elements.studiesList.parentElement;
        timelineElement.id = 'entity-usage-timeline';
        studiesContainer.insertBefore(timelineElement, elements.studiesList);
    }
    
    // Now continue with the original display logic
    elements.studiesList.innerHTML = '';
    elements.studyCount.textContent = studies.length;

    if (studies.length === 0) {
        elements.studiesList.innerHTML = `
            <div class="text-center p-4 text-gray-500">
                <p>No studies found matching the current filters.</p>
            </div>
        `;
        return;
    }

    // Sort studies by phase
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4 
    };

    studies.sort((a, b) => {
        const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        return (phaseOrder[phaseB] || 0) - (phaseOrder[phaseA] || 0);  // Reversed order - latest phases first
    });

    studies.forEach(study => {
        const nctId = study.protocolSection?.identificationModule?.nctId;
        const title = study.protocolSection?.identificationModule?.briefTitle;
        const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
        const status = study.protocolSection?.statusModule?.overallStatus;
        const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
        const hasResults = study.hasResults;
        
        // Determine if this is a TRD-specific study
        const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
        const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
        const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
        const trdTerms = [
            'treatment-resistant depression', 
            'treatment resistant depression',
            'trd',
            'refractory depression'
        ];
        
        const isTRDSpecific = trdTerms.some(term => 
            briefTitle.includes(term) || 
            officialTitle.includes(term) || 
            briefSummary.includes(term)
        );
        
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200 mb-4';
        card.innerHTML = `
            <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
                <div class="flex gap-2 items-center flex-wrap">
                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
                    <span class="text-sm font-medium">${formatPhase(phase)}</span>
                    ${getStatusBadge(status)}
                    ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
                </div>
                <div>
                    <span class="text-xs text-gray-500">${nctId}</span>
                    ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
                </div>
            </div>
            <h3 class="text-lg font-medium mb-2">${title}</h3>
            <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
            <div class="flex flex-wrap gap-2">
                <button data-nctid="${nctId}" class="view-study-btn text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    View Details
                </button>
                <a href="https://clinicaltrials.gov/study/${nctId}" target="_blank" class="text-gray-600 hover:text-gray-800 text-sm font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    ClinicalTrials.gov
                </a>
            </div>
        `;
        elements.studiesList.appendChild(card);
        
        // Add event listener to the view button
        card.querySelector('.view-study-btn').addEventListener('click', () => {
            viewStudyDetails(nctId);
        });
    });
}




/**
 * Generates a timeline visualization for either drug usage or condition treatments
 * @param {Array} studies - Array of study objects
 * @param {string} entityName - Name of the drug or condition
 * @param {string} entityType - Either 'drug' or 'condition'
 * @returns {HTMLElement} - The timeline container element
 */
 function generateUsageTimeline(studies, entityName, entityType) {
    // Create container for the timeline
    const timelineContainer = document.createElement('div');
    timelineContainer.className = 'mb-8 p-4 bg-white rounded-lg border border-gray-200 shadow-sm';
    
    const titleText = entityType === 'drug' 
        ? `Historical Usage Timeline: ${entityName}`
        : `Treatment Timeline: ${entityName}`;
    
    timelineContainer.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
            <h2 class="text-xl font-bold">${titleText}</h2>
            
            <div class="flex items-center mt-2 md:mt-0">
                <div class="text-xs text-gray-500 mr-4">
                    <span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span> Clinical trials
                </div>
                <select id="timeline-view-toggle" class="text-sm border border-gray-300 rounded p-1">
                    <option value="chart" selected>Chart View</option>
                    <option value="list">List View</option>
                </select>
            </div>
        </div>
        <div id="usage-timeline" class="relative">
            <div class="timeline-loading text-center p-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-blue-500"></div>
                <p class="mt-2 text-gray-600">Analyzing ${entityType === 'drug' ? 'usage patterns' : 'treatment approaches'}...</p>
            </div>
        </div>
    `;

    // Process the data after rendering the initial container
    setTimeout(() => {
        // Extract and organize timeline data
        const usageData = entityType === 'drug' 
            ? extractUsageData(studies, entityName) 
            : extractConditionData(studies, entityName);
        
        if ((!usageData.byCondition || Object.keys(usageData.byCondition).length === 0) && 
            (!usageData.byDrug || Object.keys(usageData.byDrug).length === 0)) {
            // No meaningful data found
            document.getElementById('usage-timeline').innerHTML = `
                <div class="text-center p-4 text-gray-500">
                    <p>Insufficient data to generate a timeline for ${entityName}.</p>
                </div>
            `;
            return;
        }
        
        // Render the timeline visualization
        renderTimelineVisualization(usageData, entityName, entityType);
        
        // Add event listener for the view toggle
        const viewToggle = timelineContainer.querySelector('#timeline-view-toggle');
        if (viewToggle) {
            viewToggle.addEventListener('change', (e) => {
                const view = e.target.value;
                if (view === 'chart') {
                    renderTimelineVisualization(usageData, entityName, entityType);
                } else if (view === 'list') {
                    renderTimelineList(usageData, entityName, entityType);
                }
            });
        }
    }, 100);
    
    return timelineContainer;
}

/**
 * Wrapper function to maintain backward compatibility
 */
function generateDrugUsageTimeline(studies, drugName) {
    return generateUsageTimeline(studies, drugName, 'drug');
}

/**
 * Wrapper function for condition-based timeline
 */
function generateConditionTimeline(studies, conditionName) {
    return generateUsageTimeline(studies, conditionName, 'condition');
}
/**
 * Helper function to format phase for display
 * @param {string} phase - Raw phase value
 * @returns {string} - Formatted phase string
 */
function formatPhase(phase) {
    switch(phase) {
        case "PRE_PHASE":
            return "Pre-Clinical";
        case "PHASE1":
            return "Phase 1";
        case "PHASE1_PHASE2":
            return "Phase 1/2";
        case "PHASE2":
            return "Phase 2";
        case "PHASE3":
            return "Phase 3";
        case "PHASE4":
            return "Phase 4";
        default:
            return phase || "Unknown";
    }
}

/**
 * Helper function to get color for phase
 * @param {string} phase - Raw phase value
 * @returns {string} - Color hex code
 */
function getPhaseColor(phase) {
    switch(phase) {
        case "PRE_PHASE":
            return "#9CA3AF"; // gray-400
        case "PHASE1":
            return "#60A5FA"; // blue-400
        case "PHASE1_PHASE2":
            return "#34D399"; // green-400
        case "PHASE2":
            return "#10B981"; // green-500
        case "PHASE3":
            return "#047857"; // green-700
        case "PHASE4":
            return "#064E3B"; // green-900
        default:
            return "#D1D5DB"; // gray-300
    }
}

/**
 * Helper function to generate status badge HTML
 * @param {string} status - Study status
 * @returns {string} - Badge HTML
 */
function getStatusBadge(status) {
    if (!status) return '';
    
    const statusMap = {
        'Completed': { color: 'bg-green-100 text-green-800', priority: 3 },
        'Active': { color: 'bg-blue-100 text-blue-800', priority: 1 },
        'Recruiting': { color: 'bg-blue-100 text-blue-800', priority: 1 },
        'Not yet recruiting': { color: 'bg-yellow-100 text-yellow-800', priority: 2 },
        'Enrolling by invitation': { color: 'bg-blue-100 text-blue-800', priority: 1 },
        'Suspended': { color: 'bg-red-100 text-red-800', priority: 0 },
        'Terminated': { color: 'bg-red-100 text-red-800', priority: 0 },
        'Withdrawn': { color: 'bg-red-100 text-red-800', priority: 0 },
        'Unknown status': { color: 'bg-gray-100 text-gray-800', priority: 4 }
    };
    
    const statusInfo = statusMap[status] || { color: 'bg-gray-100 text-gray-800', priority: 4 };
    
    return `<span class="text-xs ${statusInfo.color} px-2 py-0.5 rounded-full">${status}</span>`;
}

/**
 * Search for a specific entity (drug or condition)
 * This is a placeholder function that should be implemented based on your application
 * @param {string} entityName - Name of the entity to search for
 * @param {string} entityType - Type of entity ('drug' or 'condition')
 */
function searchForEntity(entityName, entityType) {
    console.log(`Searching for ${entityType}: ${entityName}`);
    
    // This function should be implemented by the application
    // For example, it might:
    // 1. Set the search input field value
    // 2. Trigger the search
    // 3. Update the UI state
    
    // Example implementation:
    if (typeof elements !== 'undefined' && elements.searchInput) {
        elements.searchInput.value = entityName;
        
        // Trigger search
        if (typeof searchStudies === 'function') {
            // Set the entity type in your search parameters
            const searchParams = {
                term: entityName,
                type: entityType
            };
            
            searchStudies(searchParams);
        }
    } else {
        // Fallback if elements object is not available
        alert(`Search for ${entityType}: ${entityName}`);
    }
}

/**
 * Helper function to handle downloading timeline data
 * @param {Object} data - Timeline data
 * @param {string} entityName - Name of entity
 * @param {string} entityType - Type of entity ('drug' or 'condition')
 */
function downloadTimelineData(data, entityName, entityType) {
    // Prepare data for download
    const dataField = entityType === 'drug' ? 'byCondition' : 'byDrug';
    const itemType = entityType === 'drug' ? 'Condition' : 'Treatment';
    
    // Create CSV content
    let csvContent = `${itemType},Studies,First Year,Last Year,Peak Year\n`;
    
    Object.keys(data[dataField]).forEach(item => {
        const itemData = data[dataField][item];
        
        // Find peak year
        let peakYear = null;
        let peakCount = 0;
        
        Object.keys(itemData.years).forEach(year => {
            if (itemData.years[year] > peakCount) {
                peakCount = itemData.years[year];
                peakYear = year;
            }
        });
        
        // Add row to CSV
        csvContent += `"${item}",${itemData.count},${itemData.earliestYear},${itemData.latestYear},${peakYear || 'N/A'}\n`;
    });
    
    // Create download link
    const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `${entityName.replace(/\s+/g, '_')}_timeline_data.csv`);
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    document.body.removeChild(link);
}

// Add an "Export Data" button to the timeline header
function addExportButton(timelineElement, data, entityName, entityType) {
    const headerDiv = timelineElement.querySelector('div.flex.flex-col.md\\:flex-row');
    
    if (headerDiv) {
        const exportButton = document.createElement('button');
        exportButton.className = 'mt-2 md:mt-0 ml-0 md:ml-2 px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors text-sm flex items-center';
        exportButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export Data
        `;
        
        exportButton.addEventListener('click', () => {
            downloadTimelineData(data, entityName, entityType);
        });
        
        headerDiv.appendChild(exportButton);
    }
}

// Add a "Compare" button for drug vs condition comparison
function addCompareButton(timelineElement, entityName, entityType) {
    const headerDiv = timelineElement.querySelector('div.flex.flex-col.md\\:flex-row');
    
    if (headerDiv) {
        const compareButton = document.createElement('button');
        compareButton.className = 'mt-2 md:mt-0 ml-0 md:ml-2 px-3 py-1 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 transition-colors text-sm flex items-center';
        compareButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Compare
        `;
        
        compareButton.addEventListener('click', () => {
            // Show a modal with comparison options
            showComparisonModal(entityName, entityType);
        });
        
        headerDiv.appendChild(compareButton);
    }
}

/**
 * Shows a modal for choosing comparison options
 * @param {string} entityName - Current entity name
 * @param {string} entityType - Current entity type
 */
function showComparisonModal(entityName, entityType) {
    // Create a modal
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    // Opposite entity type
    const oppositeType = entityType === 'drug' ? 'condition' : 'drug';
    const oppositeTypeName = entityType === 'drug' ? 'Condition' : 'Drug';
    
    // Create modal content
    modal.innerHTML = `
        <div class="bg-white rounded-lg w-full max-w-md overflow-hidden flex flex-col">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold">Compare ${entityName}</h3>
                    <button id="close-compare-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <p class="mb-4">Compare this ${entityType} with another ${entityType} or a specific ${oppositeType}:</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Compare with another ${entityType}:</label>
                    <div class="flex">
                        <input type="text" id="compare-entity" placeholder="Enter ${entityType} name..." 
                               class="flex-grow p-2 border border-gray-300 rounded-l shadow-sm text-sm">
                        <button id="compare-same-type" class="px-4 py-2 bg-blue-500 text-white rounded-r hover:bg-blue-600 transition-colors">
                            Compare
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Compare with a ${oppositeType}:</label>
                    <div class="flex">
                        <input type="text" id="compare-opposite" placeholder="Enter ${oppositeTypeName} name..." 
                               class="flex-grow p-2 border border-gray-300 rounded-l shadow-sm text-sm">
                        <button id="compare-opposite-type" class="px-4 py-2 bg-purple-500 text-white rounded-r hover:bg-purple-600 transition-colors">
                            Compare
                        </button>
                    </div>
                </div>
                
                <div class="mt-6">
                    <p class="text-sm text-gray-500">
                        Comparing will show both timelines side-by-side to help identify patterns and relationships.
                    </p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add event listeners
    
    // 1. Close modal button
    document.getElementById('close-compare-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    // 2. Close when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // 3. Compare with same entity type
    document.getElementById('compare-same-type').addEventListener('click', () => {
        const compareEntity = document.getElementById('compare-entity').value.trim();
        if (compareEntity) {
            // Close modal
            document.body.removeChild(modal);
            
            // Initialize comparison
            if (typeof compareEntities === 'function') {
                compareEntities(entityName, compareEntity, entityType, entityType);
            } else {
                alert(`Compare ${entityName} (${entityType}) with ${compareEntity} (${entityType})`);
                console.log(`Compare ${entityName} (${entityType}) with ${compareEntity} (${entityType})`);
            }
        }
    });
    
    // 4. Compare with opposite entity type
    document.getElementById('compare-opposite-type').addEventListener('click', () => {
        const compareEntity = document.getElementById('compare-opposite').value.trim();
        if (compareEntity) {
            // Close modal
            document.body.removeChild(modal);
            
            // Initialize comparison
            if (typeof compareEntities === 'function') {
                compareEntities(entityName, compareEntity, entityType, oppositeType);
            } else {
                alert(`Compare ${entityName} (${entityType}) with ${compareEntity} (${oppositeType})`);
                console.log(`Compare ${entityName} (${entityType}) with ${compareEntity} (${oppositeType})`);
            }
        }
    });
}

/**
 * Compares two entities by showing their timelines side by side
 * This is a placeholder that should be implemented based on your application
 * @param {string} entity1 - First entity name
 * @param {string} entity2 - Second entity name
 * @param {string} type1 - First entity type
 * @param {string} type2 - Second entity type
 */
function compareEntities(entity1, entity2, type1, type2) {
    console.log(`Comparing ${entity1} (${type1}) with ${entity2} (${type2})`);
    
    // This function should be implemented based on your application logic
    // It would typically:
    // 1. Fetch data for both entities
    // 2. Create a comparison view
    // 3. Display the comparison
    
    alert(`Comparison feature would be implemented here for ${entity1} vs ${entity2}`);
}

// Add these functions to maintain backward compatibility with existing code
function groupSimilarConditions(conditionsData) {
    // This function is kept for backward compatibility
    return conditionsData;
}

/**
 * Main rendering function for display studies with timeline
 * @param {Array} studies - Array of study objects 
 * @param {string} entityName - Name of drug or condition
 * @param {string} entityType - Type of entity ('drug' or 'condition')
 */
function displayStudiesWithEntityTimeline(studies, entityName, entityType) {
    // Create a wrapper for both drug and condition views
    displayStudiesWithTimeline(studies, entityName, entityType);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Add these to your state management
const ITEMS_PER_PAGE = 20; // Adjust as needed

// Modify your displayStudies function to handle pagination
function displayStudies(studies, drug, condition) {
    // Store all studies in an app state variable for pagination
    appState.allStudies = studies;
    appState.currentPage = 1;
    
    elements.studyCount.textContent = studies.length;

    if (studies.length === 0) {
        elements.studiesList.innerHTML = `
            <div class="text-center p-4 text-gray-500">
                <p>No studies found matching the current filters.</p>
            </div>
        `;
        // Hide pagination controls when no results
        if (elements.paginationControls) {
            elements.paginationControls.classList.add('hidden');
        }
        return;
    }

    // Sort studies by phase (keep your existing sorting logic)
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4 
    };

    studies.sort((a, b) => {
        const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
        return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
    });

    // Timeline visualization logic remains the same
    const existingTimeline = document.getElementById('drug-usage-timeline');
    if (existingTimeline) {
        existingTimeline.remove();
    }
    
    if (!drug){
        displayStudiesWithTimeline(studies, condition, 'condition');
    }
    displayStudiesWithTimeline(studies, drug, 'drug');

    // Display the first page of studies
    displayStudiesPage(1);
    
    // Set up pagination controls
    setupPaginationControls(studies.length);
}

// New function to display a specific page of studies
function displayStudiesPage(page) {
    const studies = appState.allStudies;
    elements.studiesList.innerHTML = '';
    
    // Calculate start and end index for current page
    const startIndex = (page - 1) * ITEMS_PER_PAGE;
    const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, studies.length);
    
    // Display only the current page of studies
    for (let i = startIndex; i < endIndex; i++) {
        const study = studies[i];
        
        const nctId = study.protocolSection?.identificationModule?.nctId;
        const title = study.protocolSection?.identificationModule?.briefTitle;
        const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
        const status = study.protocolSection?.statusModule?.overallStatus;
        const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
        const hasResults = study.hasResults;
        
        // Determine if this is a TRD-specific study
        const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
        const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
        const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
        const trdTerms = [
            'treatment-resistant depression', 
            'treatment resistant depression',
            'trd',
            'refractory depression'
        ];
        
        const isTRDSpecific = trdTerms.some(term => 
            briefTitle.includes(term) || 
            officialTitle.includes(term) || 
            briefSummary.includes(term)
        );
        
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
        card.innerHTML = `
            <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
                <div class="flex gap-2 items-center flex-wrap">
                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
                    <span class="text-sm font-medium">${formatPhase(phase)}</span>
                    ${getStatusBadge(status)}
                    ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
                </div>
                <div>
                    <span class="text-xs text-gray-500">${nctId}</span>
                    ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
                </div>
            </div>
            <h3 class="text-lg font-medium mb-2">${title}</h3>
            <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
            <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                View Study Details
            </button>
        `;
        elements.studiesList.appendChild(card);
        
        // Add event listener to the view button
        card.querySelector('.view-study-btn').addEventListener('click', () => {
            viewStudyDetails(nctId);
        });
    }
    
    // Update current page in app state
    appState.currentPage = page;
    
    // Update active pagination button
    updateActivePaginationButton(page);
}

// Function to set up pagination controls
function setupPaginationControls(totalItems) {
    // First ensure we have a container for pagination controls
    if (!elements.paginationControls) {
        elements.paginationControls = document.createElement('div');
        elements.paginationControls.className = 'flex justify-center items-center mt-6 space-x-2';
        elements.studiesList.parentNode.appendChild(elements.paginationControls);
    } else {
        elements.paginationControls.innerHTML = '';
        elements.paginationControls.classList.remove('hidden');
    }
    
    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    
    // Don't show pagination for a single page
    if (totalPages <= 1) {
        elements.paginationControls.classList.add('hidden');
        return;
    }
    
    // Previous button
    const prevButton = document.createElement('button');
    prevButton.className = 'px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed';
    prevButton.innerHTML = '&laquo; Prev';
    prevButton.disabled = true; // Disabled initially on page 1
    prevButton.addEventListener('click', () => {
        if (appState.currentPage > 1) {
            displayStudiesPage(appState.currentPage - 1);
        }
    });
    elements.paginationControls.appendChild(prevButton);
    
    // Page number buttons
    // For simplicity, show max 7 page buttons with ellipsis for large number of pages
    const maxVisibleButtons = 7;
    const pages = [];
    
    if (totalPages <= maxVisibleButtons) {
        // Show all pages
        for (let i = 1; i <= totalPages; i++) {
            pages.push(i);
        }
    } else {
        // Complex pagination with ellipsis
        if (appState.currentPage <= 3) {
            // Near start
            for (let i = 1; i <= 5; i++) {
                pages.push(i);
            }
            pages.push('...');
            pages.push(totalPages);
        } else if (appState.currentPage >= totalPages - 2) {
            // Near end
            pages.push(1);
            pages.push('...');
            for (let i = totalPages - 4; i <= totalPages; i++) {
                pages.push(i);
            }
        } else {
            // Middle
            pages.push(1);
            pages.push('...');
            for (let i = appState.currentPage - 1; i <= appState.currentPage + 1; i++) {
                pages.push(i);
            }
            pages.push('...');
            pages.push(totalPages);
        }
    }
    
    // Add page buttons to DOM
    pages.forEach(page => {
        if (page === '...') {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-3 py-1';
            ellipsis.textContent = '...';
            elements.paginationControls.appendChild(ellipsis);
        } else {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'px-3 py-1 rounded border border-gray-300 hover:bg-gray-100';
            pageBtn.textContent = page;
            if (page === 1) {
                pageBtn.classList.add('bg-blue-100', 'border-blue-300');
            }
            pageBtn.addEventListener('click', () => {
                displayStudiesPage(page);
            });
            elements.paginationControls.appendChild(pageBtn);
        }
    });
    
    // Next button
    const nextButton = document.createElement('button');
    nextButton.className = 'px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed';
    nextButton.innerHTML = 'Next &raquo;';
    nextButton.addEventListener('click', () => {
        if (appState.currentPage < totalPages) {
            displayStudiesPage(appState.currentPage + 1);
        }
    });
    elements.paginationControls.appendChild(nextButton);
    
    // Store references to prev/next buttons in app state for easier access
    appState.prevButton = prevButton;
    appState.nextButton = nextButton;
}

// Function to update active pagination button
function updateActivePaginationButton(currentPage) {
    if (!elements.paginationControls) return;
    
    // Update prev/next button disabled states
    const totalPages = Math.ceil(appState.allStudies.length / ITEMS_PER_PAGE);
    appState.prevButton.disabled = currentPage === 1;
    appState.nextButton.disabled = currentPage === totalPages;
    
    // Update active page button
    const pageButtons = elements.paginationControls.querySelectorAll('button:not(:first-child):not(:last-child)');
    pageButtons.forEach(button => {
        if (button.textContent === currentPage.toString()) {
            button.classList.add('bg-blue-100', 'border-blue-300');
        } else {
            button.classList.remove('bg-blue-100', 'border-blue-300');
        }
    });
}

// Add search functionality to search within results
function addStudySearch() {
    // Create search input if it doesn't exist
    if (!elements.studySearch) {
        const searchContainer = document.createElement('div');
        searchContainer.className = 'mb-4';
        searchContainer.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 mb-1">Search within results</label>
            <div class="relative">
                <input id="study-search" type="text" placeholder="Search by title, NCT ID, or sponsor..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <button id="clear-search" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        `;
        
        // Insert search before the studies list
        elements.studiesList.parentNode.insertBefore(searchContainer, elements.studiesList);
        
        // Store reference to the search input
        elements.studySearch = document.getElementById('study-search');
        elements.clearSearch = document.getElementById('clear-search');
        
        // Add event listeners
        elements.studySearch.addEventListener('input', debounce(handleStudySearch, 300));
        elements.clearSearch.addEventListener('click', clearStudySearch);
    }
}

// Debounce function to prevent too many search operations
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Handle study search
function handleStudySearch() {
    const searchTerm = elements.studySearch.value.toLowerCase().trim();
    
    // Show/hide clear button
    elements.clearSearch.classList.toggle('hidden', !searchTerm);
    
    // If search term is empty, show all studies (paginated)
    if (!searchTerm) {
        appState.filteredStudies = null;
        displayStudiesPage(1);
        setupPaginationControls(appState.allStudies.length);
        return;
    }
    
    // Filter studies based on search term
    const filteredStudies = appState.allStudies.filter(study => {
        const nctId = study.protocolSection?.identificationModule?.nctId?.toLowerCase() || '';
        const title = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
        const sponsor = study.protocolSection?.identificationModule?.organization?.fullName?.toLowerCase() || '';
        
        return nctId.includes(searchTerm) || 
               title.includes(searchTerm) || 
               sponsor.includes(searchTerm);
    });
    
    // Store filtered studies in app state
    appState.filteredStudies = filteredStudies;
    
    // Update display with filtered studies
    elements.studyCount.textContent = `${filteredStudies.length} (filtered from ${appState.allStudies.length})`;
    
    // If no results after filtering
    if (filteredStudies.length === 0) {
        elements.studiesList.innerHTML = `
            <div class="text-center p-4 text-gray-500">
                <p>No studies found matching "${searchTerm}".</p>
                <button id="reset-search" class="mt-2 text-blue-600 hover:underline">Reset search</button>
            </div>
        `;
        elements.paginationControls.classList.add('hidden');
        
        // Add event listener to reset button
        document.getElementById('reset-search').addEventListener('click', clearStudySearch);
        return;
    }
    
    // Display first page of filtered results
    displayFilteredStudiesPage(1);
    setupPaginationControls(filteredStudies.length);
}

// Clear study search
function clearStudySearch() {
    elements.studySearch.value = '';
    elements.clearSearch.classList.add('hidden');
    appState.filteredStudies = null;
    
    // Reset to show all studies
    elements.studyCount.textContent = appState.allStudies.length;
    displayStudiesPage(1);
    setupPaginationControls(appState.allStudies.length);
}

// Display page of filtered studies
// Function to display a specific page of filtered studies
function displayFilteredStudiesPage(page) {
    const studies = appState.filteredStudies || appState.allStudies;
    elements.studiesList.innerHTML = '';
    
    // Calculate start and end index for current page
    const startIndex = (page - 1) * ITEMS_PER_PAGE;
    const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, studies.length);
    
    // Display the studies for this page
    for (let i = startIndex; i < endIndex; i++) {
        const study = studies[i];
        
        const nctId = study.protocolSection?.identificationModule?.nctId;
        const title = study.protocolSection?.identificationModule?.briefTitle;
        const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
        const status = study.protocolSection?.statusModule?.overallStatus;
        const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
        const hasResults = study.hasResults;
        
        // Determine if this is a TRD-specific study
        const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
        const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
        const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
        
        const trdTerms = [
            'treatment-resistant depression', 
            'treatment resistant depression',
            'trd',
            'refractory depression'
        ];
        
        const isTRDSpecific = trdTerms.some(term => 
            briefTitle.includes(term) || 
            officialTitle.includes(term) || 
            briefSummary.includes(term)
        );
        
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
        card.innerHTML = `
            <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
                <div class="flex gap-2 items-center flex-wrap">
                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
                    <span class="text-sm font-medium">${formatPhase(phase)}</span>
                    ${getStatusBadge(status)}
                    ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
                </div>
                <div>
                    <span class="text-xs text-gray-500">${nctId}</span>
                    ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
                </div>
            </div>
            <h3 class="text-lg font-medium mb-2">${title}</h3>
            <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
            <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                View Study Details
            </button>
        `;
        elements.studiesList.appendChild(card);
        
        // Add event listener to the view button
        card.querySelector('.view-study-btn').addEventListener('click', () => {
            viewStudyDetails(nctId);
        });
    }
    
    // Update current page in app state
    appState.currentPage = page;
    
    // Update active pagination button
    updateActivePaginationButton(page);
    
    // Update the results info message
    const resultsInfo = document.createElement('div');
    resultsInfo.className = 'text-sm text-gray-600 mt-2';
    
    if (studies.length > 0) {
        resultsInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${studies.length} results`;
    } else {
        resultsInfo.textContent = 'No results found';
    }
    
    // Replace any existing results info
    const existingInfo = document.querySelector('.results-info');
    if (existingInfo) {
        existingInfo.replaceWith(resultsInfo);
    } else {
        // Insert before the studies list
        elements.studiesList.parentNode.insertBefore(resultsInfo, elements.studiesList);
    }
    resultsInfo.classList.add('results-info');
    
    // Check if there's any data to show page controls
    if (studies.length <= ITEMS_PER_PAGE) {
        // If we have 1 page or less, hide pagination controls
        if (elements.paginationControls) {
            elements.paginationControls.classList.add('hidden');
        }
    } else {
        // Make sure pagination controls are visible
        if (elements.paginationControls) {
            elements.paginationControls.classList.remove('hidden');
        }
    }
}

// Initialize new features when page loads
function initPaginationAndSearch() {
    // Add these to your init function or document ready callback
    addStudySearch();
    
    // Make sure appState has required properties
    if (!appState) {
        appState = {};
    }
    
    appState.allStudies = [];
    appState.currentPage = 1;
    appState.filteredStudies = null;
}

// Call this when your app initializes
document.addEventListener('DOMContentLoaded', initPaginationAndSearch);

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


// // Function to display studies in the UI
// function displayStudies(studies, drug, condition) {
// elements.studiesList.innerHTML = '';
// elements.studyCount.textContent = studies.length;

// if (studies.length === 0) {
//     elements.studiesList.innerHTML = `
//         <div class="text-center p-4 text-gray-500">
//             <p>No studies found matching the current filters.</p>
//         </div>
//     `;
//     return;
// }


// const existingTimeline = document.getElementById('drug-usage-timeline');
//     if (existingTimeline) {
//         existingTimeline.remove();
//     }
    
// if (!drug){
//   displayStudiesWithTimeline(studies, condition , 'condition');
// }
//     displayStudiesWithTimeline(studies, drug, 'drug' );
        
//         // Update browser history and URL parameters
//         // updateUrlParameters(drug, condition, hasResultsOnly, trdFocusOnly);

// // Sort studies by phase
// const phaseOrder = { 
//     "PRE_PHASE": 0, 
//     "PHASE1": 1, 
//     "PHASE1_PHASE2": 1.5,
//     "PHASE2": 2, 
//     "PHASE3": 3, 
//     "PHASE4": 4 
// };

// studies.sort((a, b) => {
//     const phaseA = a.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//     const phaseB = b.protocolSection?.designModule?.phases?.[0] || "PRE_PHASE";
//     return (phaseOrder[phaseA] || 0) - (phaseOrder[phaseB] || 0);
// });

// studies.forEach(study => {
//     const nctId = study.protocolSection?.identificationModule?.nctId;
//     const title = study.protocolSection?.identificationModule?.briefTitle;
//     const phase = study.protocolSection?.designModule?.phases?.[0] || "N/A";
//     const status = study.protocolSection?.statusModule?.overallStatus;
//     const sponsor = study.protocolSection?.identificationModule?.organization?.fullName;
//     const hasResults = study.hasResults;
    
//     // Determine if this is a TRD-specific study
//     const briefTitle = study.protocolSection?.identificationModule?.briefTitle?.toLowerCase() || '';
//     const officialTitle = study.protocolSection?.identificationModule?.officialTitle?.toLowerCase() || '';
//     const briefSummary = study.protocolSection?.descriptionModule?.briefSummary?.toLowerCase() || '';
    
//     const trdTerms = [
//         'treatment-resistant depression', 
//         'treatment resistant depression',
//         'trd',
//         'refractory depression'
//     ];
    
//     const isTRDSpecific = trdTerms.some(term => 
//         briefTitle.includes(term) || 
//         officialTitle.includes(term) || 
//         briefSummary.includes(term)
//     );
    
//     const card = document.createElement('div');
//     card.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200';
//     card.innerHTML = `
//         <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
//             <div class="flex gap-2 items-center flex-wrap">
//                 <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
//                 <span class="text-sm font-medium">${formatPhase(phase)}</span>
//                 ${getStatusBadge(status)}
//                 ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
//             </div>
//             <div>
//                 <span class="text-xs text-gray-500">${nctId}</span>
//                 ${hasResults ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
//             </div>
//         </div>
//         <h3 class="text-lg font-medium mb-2">${title}</h3>
//         <p class="text-sm text-gray-600 mb-3">Sponsor: ${sponsor || 'Unknown'}</p>
//         <button data-nctid="${nctId}" class="view-study-btn text-primary hover:text-blue-700 text-sm font-medium flex items-center">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
//             </svg>
//             View Study Details
//         </button>
//     `;
//     elements.studiesList.appendChild(card);
    
//     // Add event listener to the view button
//     card.querySelector('.view-study-btn').addEventListener('click', () => {
//         viewStudyDetails(nctId);
//     });
// });
// }

        

async function viewStudyDetails(nctId) {
            appState.currentStudyId = nctId;
            displayLoading(true);
            
            // Check if we already have the study details cached
            let studyDetails = appState.studyDetails[nctId];
            
            // If not cached, fetch from API
            if (!studyDetails) {
                studyDetails = await fetchStudyDetails(nctId);
                
                if (studyDetails) {
                    // Cache the study details
                    appState.studyDetails[nctId] = studyDetails;
                }
            }
            
            if (!studyDetails) {
                displayLoading(false);
                alert('Error loading study details. Please try again.');
                return;
            }
            
            // Display study details
            displayStudyDetail(studyDetails);
            
            // Show the detail section
            showSection(elements.studyDetailSection, true);
            elements.studyDetailSection.scrollIntoView({ behavior: 'smooth' });
            displayLoading(false);
        }

//         function displayStudyDetail(study) {
// console.log(study);
// const identification = study.protocolSection?.identificationModule || {};
// const design = study.protocolSection?.designModule || {};
// const description = study.protocolSection?.descriptionModule || {};
// const arms = study.protocolSection?.armsInterventionsModule?.armGroups || [];
// const eligibility = study.protocolSection?.eligibilityModule || {};
// const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];

// const primaryOutcomes = outcomes.filter(outcome => outcome.type === "PRIMARY");
// const secondaryOutcomes = outcomes.filter(outcome => outcome.type === "SECONDARY");

// // Determine if this is a TRD-specific study
// const title = identification.briefTitle?.toLowerCase() || '';
// const officialTitle = identification.officialTitle?.toLowerCase() || '';
// const briefSummary = description.briefSummary?.toLowerCase() || '';
// const detailedDescription = description.detailedDescription?.toLowerCase() || '';

// const trdTerms = [
//     'treatment-resistant depression', 
//     'treatment resistant depression',
//     'trd',
//     'refractory depression',
//     'treatment-refractory depression'
// ];

// const isTRDSpecific = trdTerms.some(term => 
//     title.includes(term) || 
//     officialTitle.includes(term) || 
//     briefSummary.includes(term) || 
//     detailedDescription.includes(term)
// );

// elements.studyDetailContent.innerHTML = `
//     <div class="border-b pb-4 mb-4">
//         <div class="flex justify-between items-start">
//             <h2 class="text-2xl font-semibold mb-2">${identification.briefTitle || 'Untitled Study'}</h2>
//             <button id="copyStudyData" class="text-primary hover:text-blue-700 flex items-center text-sm">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4M16 5h2a2 2 0 012 2v4M21 14H11" />
//                 </svg>
//                 Copy Data
//             </button>
//         </div>
//         <div class="flex flex-wrap gap-2 mb-2">
//             <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">NCT ID: ${identification.nctId || 'N/A'}</span>
//             <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">Phase: ${formatPhase(design.phases?.[0] || 'N/A')}</span>
//             <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">Status: ${study.protocolSection?.statusModule?.overallStatus || 'N/A'}</span>
//             ${isTRDSpecific ? '<span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full">TRD-Specific</span>' : ''}
//         </div>
//         <p class="text-sm text-gray-600">Sponsor: ${identification.organization?.fullName || 'N/A'}</p>
//     </div>
            
//     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
//         <div>
//             <h3 class="text-lg font-medium mb-2">Study Design</h3>
//             <div class="bg-gray-50 p-3 rounded-lg">
//                 <p><strong>Study Type:</strong> ${design.studyType || 'N/A'}</p>
//                 <p><strong>Allocation:</strong> ${design.designInfo?.allocation || 'N/A'}</p>
//                 <p><strong>Intervention Model:</strong> ${design.designInfo?.interventionModel || 'N/A'}</p>
//                 <p><strong>Masking:</strong> ${design.designInfo?.maskingInfo?.masking || 'N/A'}</p>
//                 <p><strong>Primary Purpose:</strong> ${design.designInfo?.primaryPurpose || 'N/A'}</p>
//             </div>
//         </div>
        
//         <div>
//             <h3 class="text-lg font-medium mb-2">Enrollment</h3>
//             <div class="bg-gray-50 p-3 rounded-lg">
//                 <p><strong>Enrollment:</strong> ${design.enrollmentInfo?.count || 'N/A'}</p>
//                 <p><strong>Sex:</strong> ${eligibility.sex || 'N/A'}</p>
//                 <p><strong>Minimum Age:</strong> ${eligibility.minimumAge || 'N/A'}</p>
//                 <p><strong>Maximum Age:</strong> ${eligibility.maximumAge || 'N/A'}</p>
//                 <p><strong>Healthy Volunteers:</strong> ${eligibility.healthyVolunteers || 'N/A'}</p>
//             </div>
//         </div>
//     </div>
            
//     <div class="mb-6">
//         <h3 class="text-lg font-medium mb-2">Brief Summary</h3>
//         <div class="bg-gray-50 p-3 rounded-lg">
//             <p>${description.briefSummary || 'No summary available.'}</p>
//         </div>
//     </div>
            
//     <div class="mb-6">
//         <h3 class="text-lg font-medium mb-2">Arms and Interventions</h3>
//         <div class="bg-gray-50 p-3 rounded-lg">
//             ${arms.length > 0 ? 
//                 `<div class="grid grid-cols-1 gap-3">
//                     ${arms.map(arm => `
//                         <div class="border-b border-gray-200 pb-3 last:border-b-0 last:pb-0">
//                             <p class="font-medium">${arm.label} (${arm.type})</p>
//                             <p class="text-sm">${arm.description || 'No description available.'}</p>
//                         </div>
//                     `).join('')}
//                 </div>` : 
//                 '<p class="italic text-gray-500">No arms or interventions information available.</p>'
//             }
//         </div>
//     </div>
            
//     <div id="outcomeVisuals" class="mb-6">
//         <h3 class="text-lg font-medium mb-2">Outcome Measurements</h3>
//         ${outcomes.length > 0 ? 
//             `<div class="space-y-6">
//                 ${primaryOutcomes.length > 0 ? 
//                     `<div>
//                         <h4 class="text-md font-medium mb-2">Primary Outcomes</h4>
//                         <div class="space-y-4">
//                             ${primaryOutcomes.map((outcome, idx) => `
//                                 <div class="bg-gray-50 p-3 rounded-lg">
//                                     <p class="font-medium">${outcome.title}</p>
//                                     <p class="text-sm mb-2">${outcome.description || 'No description available.'}</p>
//                                     <p class="text-sm text-gray-600">Time Frame: ${outcome.timeFrame || 'Not specified'}</p>
//                                     <div class="relative h-64 mt-3">
//                                         <canvas id="outcome_${identification.nctId}_${idx}"></canvas>
//                                     </div>
//                                 </div>
//                             `).join('')}
//                         </div>
//                     </div>` : 
//                     ''}
                
//                 ${secondaryOutcomes.length > 0 ? 
//                     `<div>
//                         <h4 class="text-md font-medium mb-2">Secondary Outcomes</h4>
//                         <div class="space-y-4">
//                             ${secondaryOutcomes.map((outcome, idx) => `
//                                 <div class="bg-gray-50 p-3 rounded-lg">
//                                     <p class="font-medium">${outcome.title}</p>
//                                     <p class="text-sm mb-2">${outcome.description || 'No description available.'}</p>
//                                     <p class="text-sm text-gray-600">Time Frame: ${outcome.timeFrame || 'Not specified'}</p>
//                                     <div class="relative h-64 mt-3">
//                                         <canvas id="outcome_secondary_${identification.nctId}_${idx}"></canvas>
//                                     </div>
//                                 </div>
//                             `).join('')}
//                         </div>
//                     </div>` : 
//                     ''}
//             </div>` : 
//             '<p class="italic text-gray-500">No outcome measurements available.</p>'
//         }
//     </div>
            
//     <div class="mt-6 text-center">
//         <a href="https://clinicaltrials.gov/study/${identification.nctId}" target="_blank" class="inline-flex items-center text-primary hover:text-blue-700">
//             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//             </svg>
//             View full study on ClinicalTrials.gov
//         </a>
//     </div>
// `;

// // Create outcome charts after content is added to DOM
// setTimeout(() => {
//     createOutcomeCharts(study);
    
//     // Add event listener for copy button
//     const copyButton = document.getElementById('copyStudyData');
//     if (copyButton) {
//         copyButton.addEventListener('click', () => {
//             copyTrialDataToClipboard(identification.nctId);
//         });
//     }
// }, 100);
// }




//         function displayStudyDetail(study) {
//             console.log(study)
//             const identification = study.protocolSection?.identificationModule || {};
//             const design = study.protocolSection?.designModule || {};
//             const description = study.protocolSection?.descriptionModule || {};
//             const arms = study.protocolSection?.armsInterventionsModule?.armGroups || [];
//             const eligibility = study.protocolSection?.eligibilityModule || {};
//             const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
            
//             const primaryOutcomes = outcomes.filter(outcome => outcome.type === "PRIMARY");
//             const secondaryOutcomes = outcomes.filter(outcome => outcome.type === "SECONDARY");
            
//             // Determine if this is a TRD-specific study
//             const title = identification.briefTitle?.toLowerCase() || '';
//             const officialTitle = identification.officialTitle?.toLowerCase() || '';
//             const briefSummary = description.briefSummary?.toLowerCase() || '';
//             const detailedDescription = description.detailedDescription?.toLowerCase() || '';
            
//             const trdTerms = [
//                 'treatment-resistant depression', 
//                 'treatment resistant depression',
//                 'trd',
//                 'refractory depression',
//                 'treatment-refractory depression'
//             ];
            
//             const isTRDSpecific = trdTerms.some(term => 
//                 title.includes(term) || 
//                 officialTitle.includes(term) || 
//                 briefSummary.includes(term) || 
//                 detailedDescription.includes(term)
//             );
            
//             elements.studyDetailContent.innerHTML = `
//         <div class="border-b pb-4 mb-4">
//             <div class="flex justify-between items-start">
//                 <h2 class="text-2xl font-semibold mb-2">${identification.briefTitle || 'Untitled Study'}</h2>
//                 <button id="copyStudyData" class="text-primary hover:text-blue-700 flex items-center text-sm">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4M16 5h2a2 2 0 012 2v4M21 14H11" />
//                     </svg>
//                     Copy Data
//                 </button>
//             </div>
//             <div class="flex flex-wrap gap-2 mb-2">
//                 <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">NCT ID: ${identification.nctId || 'N/A'}</span>
//                 <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">Phase: ${formatPhase(design.phases?.[0] || 'N/A')}</span>
//                 <span class="bg-gray-100 text-sm px-3 py-1 rounded-full">Status: ${study.protocolSection?.statusModule?.overallStatus || 'N/A'}</span>
//                 ${isTRDSpecific ? '<span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full">TRD-Specific</span>' : ''}
//             </div>
//             <p class="text-sm text-gray-600">Sponsor: ${identification.organization?.fullName || 'N/A'}</p>
//         </div>
                
//                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
//                     <div>
//                         <h3 class="text-lg font-medium mb-2">Study Design</h3>
//                         <div class="bg-gray-50 p-3 rounded-lg">
//                             <p><strong>Study Type:</strong> ${design.studyType || 'N/A'}</p>
//                             <p><strong>Allocation:</strong> ${design.designInfo?.allocation || 'N/A'}</p>
//                             <p><strong>Intervention Model:</strong> ${design.designInfo?.interventionModel || 'N/A'}</p>
//                             <p><strong>Masking:</strong> ${design.designInfo?.maskingInfo?.masking || 'N/A'}</p>
//                             <p><strong>Primary Purpose:</strong> ${design.designInfo?.primaryPurpose || 'N/A'}</p>
//                         </div>
//                     </div>
                    
//                     <div>
//                         <h3 class="text-lg font-medium mb-2">Enrollment</h3>
//                         <div class="bg-gray-50 p-3 rounded-lg">
//                             <p><strong>Enrollment:</strong> ${design.enrollmentInfo.count || 'N/A'}</p>
//                             <p><strong>Sex:</strong> ${eligibility.sex || 'N/A'}</p>
//                             <p><strong>Minimum Age:</strong> ${eligibility.minimumAge || 'N/A'}</p>
//                             <p><strong>Maximum Age:</strong> ${eligibility.maximumAge || 'N/A'}</p>
//                             <p><strong>Healthy Volunteers:</strong> ${eligibility.healthyVolunteers || 'N/A'}</p>
//                         </div>
//                     </div>
//                 </div>
                
//                 <div class="mb-6">
//                     <h3 class="text-lg font-medium mb-2">Brief Summary</h3>
//                     <div class="bg-gray-50 p-3 rounded-lg">
//                         <p>${description.briefSummary || 'No summary available.'}</p>
//                     </div>
//                 </div>
                
//                 <div class="mb-6">
//                     <h3 class="text-lg font-medium mb-2">Arms and Interventions</h3>
//                     <div class="bg-gray-50 p-3 rounded-lg">
//                         ${arms.length > 0 ? 
//                             `<div class="grid grid-cols-1 gap-3">
//                                 ${arms.map(arm => `
//                                     <div class="border-b border-gray-200 pb-3 last:border-b-0 last:pb-0">
//                                         <p class="font-medium">${arm.label} (${arm.type})</p>
//                                         <p class="text-sm">${arm.description || 'No description available.'}</p>
//                                     </div>
//                                 `).join('')}
//                             </div>` : 
//                             '<p class="italic text-gray-500">No arms or interventions information available.</p>'
//                         }
//                     </div>
//                 </div>
                
//                 <div id="outcomeVisuals" class="mb-6">
//                     <h3 class="text-lg font-medium mb-2">Outcome Measurements</h3>
//                     ${outcomes.length > 0 ? 
//                         `<div class="space-y-6">
//                             ${primaryOutcomes.length > 0 ? 
//                                 `<div>
//                                     <h4 class="text-md font-medium mb-2">Primary Outcomes</h4>
//                                     <div class="space-y-4">
//                                         ${primaryOutcomes.map((outcome, idx) => `
//                                             <div class="bg-gray-50 p-3 rounded-lg">
//                                                 <p class="font-medium">${outcome.title}</p>
//                                                 <p class="text-sm mb-2">${outcome.description || 'No description available.'}</p>
//                                                 <p class="text-sm text-gray-600">Time Frame: ${outcome.timeFrame || 'Not specified'}</p>
//                                                 <div class="h-48 mt-3">
//                                                     <canvas id="outcome_${identification.nctId}_${idx}"></canvas>
//                                                 </div>
//                                             </div>
//                                         `).join('')}
//                                     </div>
//                                 </div>` : 
//                                 ''}
                            
//                             ${secondaryOutcomes.length > 0 ? 
//                                 `<div>
//                                     <h4 class="text-md font-medium mb-2">Secondary Outcomes</h4>
//                                     <div class="space-y-4">
//                                         ${secondaryOutcomes.map((outcome, idx) => `
//                                             <div class="bg-gray-50 p-3 rounded-lg">
//                                                 <p class="font-medium">${outcome.title}</p>
//                                                 <p class="text-sm mb-2">${outcome.description || 'No description available.'}</p>
//                                                 <p class="text-sm text-gray-600">Time Frame: ${outcome.timeFrame || 'Not specified'}</p>
//                                                 <div class="h-48 mt-3">
//                                                     <canvas id="outcome_secondary_${identification.nctId}_${idx}"></canvas>
//                                                 </div>
//                                             </div>
//                                         `).join('')}
//                                     </div>
//                                 </div>` : 
//                                 ''}
//                         </div>` : 
//                         '<p class="italic text-gray-500">No outcome measurements available.</p>'
//                     }
//                 </div>
                
//                 <div class="mt-6 text-center">
//                     <a href="https://clinicaltrials.gov/study/${identification.nctId}" target="_blank" class="inline-flex items-center text-primary hover:text-blue-700">
//                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
//                         </svg>
//                         View full study on ClinicalTrials.gov
//                     </a>
//                             <button id="viewFdaData" class="text-primary hover:text-blue-700 flex items-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
//                 </svg>
//                 View FDA Data
//             </button>
//         </div>
//             `;
            
//             // Create outcome charts after content is added to DOM
//             setTimeout(() => {
//         createOutcomeCharts(study);
        
//         // Add event listener for copy button
//         const copyButton = document.getElementById('copyStudyData');
//         if (copyButton) {
//             copyButton.addEventListener('click', () => {
//                 copyTrialDataToClipboard(identification.nctId);
//             });
//         }
        
//         // Add event listener for view FDA data button
//         const viewFdaButton = document.getElementById('viewFdaData');
//         if (viewFdaButton) {
//             viewFdaButton.addEventListener('click', () => {
//                 // Scroll to FDA data section
//                 elements.fdaDataSection.scrollIntoView({ behavior: 'smooth' });
//             });
//         }
//     }, 100);
// }


/**
 * Enhanced function to display study details with improved UI and data extraction
 */
 function displayStudyDetail(study) {
    if (!study) {
        console.error("No study data provided to displayStudyDetail");
        return;
    }
    
    console.log("Displaying study detail:", study);
    
    // Safely extract study data with fallbacks
    const identification = study.protocolSection?.identificationModule || {};
    const design = study.protocolSection?.designModule || {};
    const status = study.protocolSection?.statusModule || {};
    const description = study.protocolSection?.descriptionModule || {};
    const arms = study.protocolSection?.armsInterventionsModule?.armGroups || [];
    const eligibility = study.protocolSection?.eligibilityModule || {};
    const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
    const sponsor = study.protocolSection?.sponsorCollaboratorsModule?.leadSponsor || {};
    
    // Categorize outcomes
    const primaryOutcomes = outcomes.filter(outcome => outcome.type === "PRIMARY");
    const secondaryOutcomes = outcomes.filter(outcome => outcome.type === "SECONDARY");
    
    // Format dates
    const formatDate = (dateStruct) => {
        if (!dateStruct || !dateStruct.date) return 'Not specified';
        return new Date(dateStruct.date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    };
    
    // Get enrollment count
    const enrollmentCount = design.enrollmentInfo?.count || 'Not specified';
    
    // Determine study phase display
    const phaseDisplay = formatPhase(design.phases?.[0] || 'N/A');
    
    // Get study duration
    const startDate = formatDate(status.startDateStruct);
    const completionDate = formatDate(status.completionDateStruct);
    
    // Study duration calculation
    let durationDisplay = 'Not available';
    if (status.startDateStruct?.date && status.completionDateStruct?.date) {
        const start = new Date(status.startDateStruct.date);
        const end = new Date(status.completionDateStruct.date);
        const durationMs = end - start;
        const durationDays = Math.floor(durationMs / (1000 * 60 * 60 * 24));
        const durationMonths = Math.floor(durationDays / 30);
        const durationYears = Math.floor(durationMonths / 12);
        
        if (durationYears > 0) {
            durationDisplay = `${durationYears} year${durationYears !== 1 ? 's' : ''}`;
            if (durationMonths % 12 > 0) {
                durationDisplay += `, ${durationMonths % 12} month${durationMonths % 12 !== 1 ? 's' : ''}`;
            }
        } else if (durationMonths > 0) {
            durationDisplay = `${durationMonths} month${durationMonths !== 1 ? 's' : ''}`;
        } else {
            durationDisplay = `${durationDays} day${durationDays !== 1 ? 's' : ''}`;
        }
    }
    
    // Determine if this is a TRD-specific study
    const title = identification.briefTitle?.toLowerCase() || '';
    const officialTitle = identification.officialTitle?.toLowerCase() || '';
    const briefSummary = description.briefSummary?.toLowerCase() || '';
    const detailedDescription = description.detailedDescription?.toLowerCase() || '';
    
    const trdTerms = [
        'treatment-resistant depression', 
        'treatment resistant depression',
        'trd',
        'refractory depression',
        'treatment-refractory depression'
    ];
    
    const isTRDSpecific = trdTerms.some(term => 
        title.includes(term) || 
        officialTitle.includes(term) || 
        briefSummary.includes(term) || 
        detailedDescription.includes(term)
    );
    
    // Get masking information
    const maskingInfo = design.designInfo?.maskingInfo || {};
    const masking = maskingInfo.masking || 'Not specified';
    const maskingDesc = maskingInfo.maskingDescription || '';
    const whoMasked = maskingInfo.whoMasked || [];
    
    // Format masked parties
    let maskingParties = '';
    if (whoMasked && whoMasked.length > 0) {
        maskingParties = whoMasked.map(party => {
            return party
                .replace('_', ' ')
                .toLowerCase()
                .replace(/\b\w/g, c => c.toUpperCase());
        }).join(', ');
    }
    
    // Build HTML for study detail
    elements.studyDetailContent.innerHTML = `
        <!-- Study Header with Key Info -->
        <div class="border-b pb-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-gray-900">${identification.briefTitle || 'Untitled Study'}</h2>
                <div class="flex gap-2">
                    <button id="copyStudyData" class="text-blue-600 hover:text-blue-800 flex items-center text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4M16 5h2a2 2 0 012 2v4M21 14H11" />
                        </svg>
                        Copy Data
                    </button>
                    <a href="https://clinicaltrials.gov/study/${identification.nctId}" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        View on ClinicalTrials.gov
                    </a>
                </div>
            </div>
            
            <!-- Key Identifiers Row -->
            <div class="flex flex-wrap gap-2 mb-4">
                <span class="bg-gray-100 text-sm px-3 py-1 rounded-full font-medium">NCT ID: ${identification.nctId || 'N/A'}</span>
                <span class="bg-gray-100 text-sm px-3 py-1 rounded-full font-medium">Phase: ${phaseDisplay}</span>
                <span class="bg-${getStatusColor(status.overallStatus)} text-white text-sm px-3 py-1 rounded-full font-medium">${formatStatus(status.overallStatus)}</span>
                ${isTRDSpecific ? '<span class="bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full font-medium">TRD-Specific</span>' : ''}
                ${study.hasResults ? '<span class="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full font-medium">Has Results</span>' : ''}
            </div>
            
            <!-- Study Metadata -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                <div>
                    <p class="text-sm text-gray-500">Sponsor</p>
                    <p class="font-medium">${sponsor.name || 'Unknown'}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Study Start</p>
                    <p class="font-medium">${startDate}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Completion</p>
                    <p class="font-medium">${completionDate}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Duration</p>
                    <p class="font-medium">${durationDisplay}</p>
                </div>
            </div>
        </div>
        
        <!-- Two-Column Layout for Details -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Left Column: Study Design & Enrollment -->
            <div class="lg:col-span-1">
                <!-- Study Design Card -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Study Design
                    </h3>
                    <div class="space-y-2">
                        <div>
                            <p class="text-sm text-gray-500">Study Type</p>
                            <p class="font-medium">${design.studyType || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Allocation</p>
                            <p class="font-medium">${formatDesignInfo(design.designInfo?.allocation)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Intervention Model</p>
                            <p class="font-medium">${formatDesignInfo(design.designInfo?.interventionModel)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Primary Purpose</p>
                            <p class="font-medium">${formatDesignInfo(design.designInfo?.primaryPurpose)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Masking</p>
                            <p class="font-medium">${formatDesignInfo(masking)}</p>
                            ${maskingParties ? `<p class="text-sm text-gray-600">Who masked: ${maskingParties}</p>` : ''}
                            ${maskingDesc ? `<p class="text-sm italic text-gray-600 mt-1">${maskingDesc}</p>` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Enrollment Card -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Enrollment
                    </h3>
                    <div class="space-y-2">
                        <div>
                            <p class="text-sm text-gray-500">Total Enrollment</p>
                            <p class="font-medium">${enrollmentCount}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Sex/Gender</p>
                            <p class="font-medium">${formatGender(eligibility.sex)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Age Range</p>
                            <p class="font-medium">${eligibility.minimumAge || 'N/A'} to ${eligibility.maximumAge || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Healthy Volunteers</p>
                            <p class="font-medium">${eligibility.healthyVolunteers === true ? 'Accepted' : eligibility.healthyVolunteers === false ? 'Not Accepted' : 'Not Specified'}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Summary & Arms -->
            <div class="lg:col-span-2">
                <!-- Brief Summary -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Study Summary
                    </h3>
                    <div class="prose prose-sm max-w-none">
                        <p>${description.briefSummary || 'No summary available.'}</p>
                        ${description.detailedDescription ? `
                            <div class="mt-4 pt-4 border-t border-gray-100">
                                <p class="font-medium mb-2">Detailed Description:</p>
                                <p>${description.detailedDescription}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Arms and Interventions -->
                <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Arms and Interventions
                    </h3>
                    ${arms.length > 0 ? 
                        `<div class="space-y-4">
                            ${arms.map(arm => {
                                // Determine arm color based on type
                                let typeColor = 'bg-gray-100 text-gray-800';
                                if (arm.type === 'EXPERIMENTAL') typeColor = 'bg-blue-100 text-blue-800';
                                if (arm.type === 'ACTIVE_COMPARATOR') typeColor = 'bg-green-100 text-green-800';
                                if (arm.type === 'PLACEBO_COMPARATOR') typeColor = 'bg-purple-100 text-purple-800';
                                if (arm.type === 'SHAM_COMPARATOR') typeColor = 'bg-yellow-100 text-yellow-800';
                                if (arm.type === 'NO_INTERVENTION') typeColor = 'bg-gray-100 text-gray-800';
                                
                                return `
                                <div class="border-b border-gray-100 pb-4 last:border-b-0 last:pb-0">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium text-gray-900">${arm.label || 'Unnamed Arm'}</h4>
                                            <span class="inline-block ${typeColor} text-xs px-2 py-1 rounded-full mt-1">
                                                ${formatArmType(arm.type)}
                                            </span>
                                        </div>
                                    </div>
                                    <p class="text-sm mt-2">${arm.description || 'No description available.'}</p>
                                    ${arm.interventionNames && arm.interventionNames.length > 0 ? 
                                        `<div class="mt-2">
                                            <p class="text-xs text-gray-500">Interventions:</p>
                                            <div class="flex flex-wrap gap-1 mt-1">
                                                ${arm.interventionNames.map(intervention => 
                                                    `<span class="bg-gray-100 text-xs px-2 py-1 rounded-full">${intervention}</span>`
                                                ).join('')}
                                            </div>
                                        </div>` : ''
                                    }
                                </div>`;
                            }).join('')}
                        </div>` : 
                        '<p class="italic text-gray-500">No arms or interventions information available.</p>'
                    }
                </div>
            </div>
        </div>
        
        <!-- Outcome Measurements -->
        <div id="outcomeVisuals" class="mb-8">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Outcome Measurements
            </h3>
            ${outcomes.length > 0 ? 
                `<div class="space-y-8">
                    ${primaryOutcomes.length > 0 ? 
                        `<div>
                            <h4 class="text-lg font-medium mb-3 flex items-center">
                                <span class="inline-block w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                                Primary Outcomes
                            </h4>
                            <div class="space-y-6">
                                ${primaryOutcomes.map((outcome, idx) => `
                                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                                        <div class="p-4 border-b border-gray-100">
                                            <h5 class="font-medium text-lg text-gray-900">${outcome.title}</h5>
                                            <p class="text-sm mt-1">${outcome.description || 'No description available.'}</p>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Time Frame: ${outcome.timeFrame || 'Not specified'}</span>
                                                ${outcome.unitOfMeasure ? `<span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Unit: ${outcome.unitOfMeasure}</span>` : ''}
                                                ${outcome.paramType ? `<span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Type: ${formatParamType(outcome.paramType)}</span>` : ''}
                                            </div>
                                        </div>
                                        <div class="relative h-80 p-4">
                                            <canvas id="outcome_${identification.nctId}_${idx}"></canvas>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : 
                        ''}
                    
                    ${secondaryOutcomes.length > 0 ? 
                        `<div>
                            <h4 class="text-lg font-medium mb-3 flex items-center">
                                <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                                Secondary Outcomes
                            </h4>
                            <div class="space-y-6">
                                ${secondaryOutcomes.map((outcome, idx) => `
                                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                                        <div class="p-4 border-b border-gray-100">
                                            <h5 class="font-medium text-lg text-gray-900">${outcome.title}</h5>
                                            <p class="text-sm mt-1">${outcome.description || 'No description available.'}</p>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Time Frame: ${outcome.timeFrame || 'Not specified'}</span>
                                                ${outcome.unitOfMeasure ? `<span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Unit: ${outcome.unitOfMeasure}</span>` : ''}
                                                ${outcome.paramType ? `<span class="text-xs bg-gray-100 px-2 py-1 rounded-full">Type: ${formatParamType(outcome.paramType)}</span>` : ''}
                                            </div>
                                        </div>
                                        <div class="relative h-80 p-4">
                                            <canvas id="outcome_secondary_${identification.nctId}_${idx}"></canvas>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : 
                        ''}
                </div>` : 
                '<div class="bg-gray-50 rounded-lg p-6 text-center"><p class="italic text-gray-500">No outcome measurements available for this study.</p></div>'
            }
        </div>
    `;
    
    // Create outcome charts after content is added to DOM
    setTimeout(() => {
        createOutcomeCharts(study);
        
        // Add event listener for copy button
        const copyButton = document.getElementById('copyStudyData');
        if (copyButton) {
            copyButton.addEventListener('click', () => {
                copyTrialDataToClipboard(identification.nctId);
            });
        }
    }, 100);
}

/**
 * Helper functions for formatting study data
 */

// Format phase text
function formatPhase(phase) {
    if (!phase) return 'N/A';
    return phase
        .replace('PHASE', 'Phase ')
        .replace('PRE_', 'Pre-')
        .replace('_', '/');
}

// Format study status
function formatStatus(status) {
    if (!status) return 'Unknown';
    return status
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}

// Get color for status
function getStatusColor(status) {
    if (!status) return 'gray-500';
    
    const statusColors = {
        'COMPLETED': 'green-500',
        'RECRUITING': 'blue-500',
        'NOT_YET_RECRUITING': 'yellow-500',
        'ACTIVE_NOT_RECRUITING': 'indigo-500',
        'TERMINATED': 'red-500',
        'WITHDRAWN': 'gray-500',
        'SUSPENDED': 'orange-500',
        'ENROLLING_BY_INVITATION': 'purple-500',
        'AVAILABLE': 'teal-500',
        'NO_LONGER_AVAILABLE': 'gray-500',
        'APPROVED_FOR_MARKETING': 'green-500',
        'WITHHELD': 'gray-500',
        'UNKNOWN': 'gray-500'
    };
    
    return statusColors[status] || 'gray-500';
}

// Format design info fields
function formatDesignInfo(value) {
    if (!value) return 'Not specified';
    return value
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}

// Format gender display
function formatGender(sex) {
    if (!sex) return 'Not specified';
    
    if (sex === 'ALL') return 'All Genders';
    if (sex === 'FEMALE') return 'Female';
    if (sex === 'MALE') return 'Male';
    
    return sex
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}

// Format arm type for display
function formatArmType(type) {
    if (!type) return 'Unknown';
    
    const typeNames = {
        'EXPERIMENTAL': 'Experimental',
        'ACTIVE_COMPARATOR': 'Active Comparator',
        'PLACEBO_COMPARATOR': 'Placebo',
        'SHAM_COMPARATOR': 'Sham',
        'NO_INTERVENTION': 'No Intervention',
        'OTHER': 'Other'
    };
    
    return typeNames[type] || type
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}

// Format parameter type
function formatParamType(paramType) {
    if (!paramType) return 'Not specified';
    
    const paramTypeNames = {
        'MEAN': 'Mean',
        'MEDIAN': 'Median',
        'LEAST_SQUARES_MEAN': 'Least Squares Mean',
        'GEOMETRIC_MEAN': 'Geometric Mean',
        'NUMBER': 'Number',
        'COUNT_OF_PARTICIPANTS': 'Count of Participants',
        'COUNT_OF_UNITS': 'Count of Units'
    };
    
    return paramTypeNames[paramType] || paramType
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\b\w/g, c => c.toUpperCase());
}



// function collectAllTrialOutcomes() {
//     console.log("Collecting all trial outcomes data...");
//     appState.allTrialOutcomes = [];
    
//     // Get all studies with results
//     const studiesWithResults = appState.studies.filter(study => study.hasResults);
//     console.log(`Found ${studiesWithResults.length} studies with results`);
    
//     // For each study, collect the outcome measures
//     studiesWithResults.forEach(study => {
//         const nctId = study.protocolSection?.identificationModule?.nctId;
//         const studyDetails = appState.studyDetails[nctId];
        
//         if (!studyDetails || !studyDetails.resultsSection?.outcomeMeasuresModule?.outcomeMeasures) {
//             console.warn(`No outcome measures found for study ${nctId}`);
//             return;
//         }
        
//         const phase = study.protocolSection?.designModule?.phases?.[0] || 'N/A';
//         const studyTitle = study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study';
//         const outcomes = studyDetails.resultsSection.outcomeMeasuresModule.outcomeMeasures;
        
//         console.log(`Processing ${outcomes.length} outcomes for study ${nctId} (${studyTitle})`);
        
//         // Store basic study info
//         const studyInfo = {
//             nctId,
//             title: studyTitle,
//             phase,
//             sponsor: study.protocolSection?.identificationModule?.organization?.fullName || 'Unknown',
//             status: study.protocolSection?.statusModule?.overallStatus || 'Unknown',
//             outcomes: []
//         };
        
//         // Process each outcome measure
//         outcomes.forEach(outcome => {
//             if (!outcome.classes || !outcome.classes[0]?.categories) {
//                 console.warn(`Skipping outcome with no categories: ${outcome.title}`);
//                 return;
//             }
            
//             const outcomeType = outcome.type?.toLowerCase() || 'other';
//             const outcomeTitle = outcome.title || 'Unknown Outcome';
//             const timeFrame = outcome.timeFrame || 'Not specified';
            
//             // Process each measurement class and category
//             outcome.classes.forEach(cls => {
//                 cls.categories.forEach(cat => {
//                     const categoryData = {
//                         title: cat.title || '',
//                         measurements: []
//                     };
                    
//                     // Extract all measurements
//                     cat.measurements.forEach(measurement => {
//                         const value = parseFloat(measurement.value);
//                         if (isNaN(value)) return;
                        
//                         const group = outcome.groups.find(g => g.id === measurement.groupId);
//                         if (!group) return;
                        
//                         const groupTitle = group.title || 'Unknown Group';
//                         const isControlGroup = 
//                             groupTitle.toLowerCase().includes('placebo') || 
//                             groupTitle.toLowerCase().includes('control') ||
//                             groupTitle.toLowerCase().includes('sham');
                        
//                         // Calculate standard error or other statistics if available
//                         let standardError = null;
//                         let dispersion = null;
//                         let dispersionType = null;
                        
//                         if (measurement.dispersion && measurement.dispersion !== 'null') {
//                             dispersion = parseFloat(measurement.dispersion);
//                             dispersionType = measurement.dispersionType?.toLowerCase() || '';
                            
//                             if (!isNaN(dispersion)) {
//                                 if (dispersionType === 'standard_error') {
//                                     standardError = dispersion;
//                                 } else if (dispersionType === 'standard_deviation') {
//                                     // Convert SD to SE if sample size is available
//                                     const sampleSize = group.participantsAnalyzedList?.[0]?.count;
//                                     if (sampleSize && !isNaN(sampleSize) && sampleSize > 0) {
//                                         standardError = dispersion / Math.sqrt(sampleSize);
//                                     }
//                                 }
//                             }
//                         }
                        
//                         // Add measurement data
//                         categoryData.measurements.push({
//                             value,
//                             groupId: measurement.groupId,
//                             groupTitle,
//                             isControlGroup,
//                             sampleSize: group.participantsAnalyzedList?.[0]?.count || 0,
//                             standardError,
//                             dispersion,
//                             dispersionType
//                         });
//                     });
                    
//                     // Only add categories with measurements
//                     if (categoryData.measurements.length > 0) {
//                         // Calculate effect size if we have both experimental and control groups
//                         const experimentalMeasurements = categoryData.measurements.filter(m => !m.isControlGroup);
//                         const controlMeasurements = categoryData.measurements.filter(m => m.isControlGroup);
                        
//                         let effectSize = null;
//                         let experimentalValue = null;
//                         let controlValue = null;
//                         let experimentalSampleSize = 0;
//                         let controlSampleSize = 0;
                        
//                         if (experimentalMeasurements.length > 0) {
//                             // Calculate weighted average for experimental group
//                             const expTotal = experimentalMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
//                             experimentalSampleSize = experimentalMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
//                             experimentalValue = experimentalSampleSize > 0 ? expTotal / experimentalSampleSize : null;
//                         }
                        
//                         if (controlMeasurements.length > 0) {
//                             // Calculate weighted average for control group
//                             const ctrlTotal = controlMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
//                             controlSampleSize = controlMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
//                             controlValue = controlSampleSize > 0 ? ctrlTotal / controlSampleSize : null;
//                         }
                        
//                         // Calculate effect size if both values exist
//                         if (experimentalValue !== null && controlValue !== null) {
//                             // Standardize the effect based on outcome metric
//                             effectSize = standardizeOutcomeValue(experimentalValue - controlValue, outcomeTitle);
//                         }
                        
//                         // Add the processed outcome data
//                         studyInfo.outcomes.push({
//                             title: outcomeTitle,
//                             type: outcomeType,
//                             timeFrame,
//                             category: categoryData.title,
//                             measurements: categoryData.measurements,
//                             experimentalValue,
//                             controlValue,
//                             effectSize,
//                             experimentalSampleSize,
//                             controlSampleSize
//                         });
//                     }
//                 });
//             });
//         });
        
//         // Add this study's info to the collection if it has outcomes
//         if (studyInfo.outcomes.length > 0) {
//             appState.allTrialOutcomes.push(studyInfo);
//         }
//     });
    
//     console.log(`Collected outcome data from ${appState.allTrialOutcomes.length} studies`);
//     console.log("All outcomes data:", appState.allTrialOutcomes);
//     TrialDashboard.loadData(appState.allTrialOutcomes);

//     console.log( "td" , appState.allTrialOutcomes)
//     a =  appState.allTrialOutcomes
//     TrialDashboard.loadData(a);
    
//     // Now that we have all the data, create the visualizations
//     // createAggregateVisualizations();
// }



// Function to create all visualizations from the collected data

function collectAllTrialOutcomes() {
    console.log("Collecting all trial outcomes data...");
    appState.allTrialOutcomes = [];
    
    // Ensure studies property exists and has valid data
    if (!appState.studies || !Array.isArray(appState.studies) || appState.studies.length === 0) {
        console.log("No studies to collect outcomes from");
        return;
    }
    
    // Get all studies with results
    const studiesWithResults = appState.studies.filter(study => study && study.hasResults);
    console.log(`Found ${studiesWithResults.length} studies with results`);
    
    // For each study, collect the outcome measures
    studiesWithResults.forEach(study => {
        // First make sure the basic study properties exist
        if (!study || !study.protocolSection || !study.protocolSection.identificationModule) {
            console.warn("Study missing required properties - skipping");
            return;
        }
        
        const nctId = study.protocolSection.identificationModule.nctId;
        if (!nctId) {
            console.warn("Study missing NCT ID - skipping");
            return;
        }
        
        // Check if we have study details with outcome data
        if (!appState.studyDetails || !appState.studyDetails[nctId]) {
            console.warn(`No study details found for ${nctId} - skipping`);
            return;
        }
        
        const studyDetails = appState.studyDetails[nctId];
        
        // Make sure we have valid outcome measures data
        if (!studyDetails.resultsSection || 
            !studyDetails.resultsSection.outcomeMeasuresModule || 
            !studyDetails.resultsSection.outcomeMeasuresModule.outcomeMeasures) {
            console.warn(`No outcome measures found for study ${nctId}`);
            return;
        }
        
        const phase = study.protocolSection?.designModule?.phases?.[0] || 'N/A';
        const studyTitle = study.protocolSection?.identificationModule?.briefTitle || 'Untitled Study';
        const outcomes = studyDetails.resultsSection.outcomeMeasuresModule.outcomeMeasures;
        
        console.log(`Processing ${outcomes.length} outcomes for study ${nctId} (${studyTitle})`);
        
        // Store basic study info
        const studyInfo = {
            nctId,
            title: studyTitle,
            phase,
            sponsor: study.protocolSection?.identificationModule?.organization?.fullName || 'Unknown',
            status: study.protocolSection?.statusModule?.overallStatus || 'Unknown',
            outcomes: []
        };
        
        // Process each outcome measure
        outcomes.forEach(outcome => {
            // Make sure outcome has classes with categories
            if (!outcome.classes || !outcome.classes[0] || !outcome.classes[0].categories) {
                console.warn(`Skipping outcome with no categories: ${outcome.title || 'unknown'}`);
                return;
            }
            
            const outcomeType = outcome.type?.toLowerCase() || 'other';
            const outcomeTitle = outcome.title || 'Unknown Outcome';
            const timeFrame = outcome.timeFrame || 'Not specified';
            
            // Process each measurement class and category
            outcome.classes.forEach(cls => {
                if (!cls.categories || !Array.isArray(cls.categories)) {
                    console.warn(`Invalid categories in outcome class for ${nctId} - skipping`);
                    return;
                }
                
                cls.categories.forEach(cat => {
                    if (!cat.measurements || !Array.isArray(cat.measurements)) {
                        console.warn(`Invalid measurements in category for ${nctId} - skipping`);
                        return;
                    }
                    
                    const categoryData = {
                        title: cat.title || '',
                        measurements: []
                    };
                    
                    // Extract all measurements
                    cat.measurements.forEach(measurement => {
                        // Validate measurement data
                        if (!measurement || !measurement.value || !measurement.groupId) {
                            return;
                        }
                        
                        // Try to parse the value
                        const value = parseFloat(measurement.value);
                        if (isNaN(value)) return;
                        
                        // Validate that the group exists
                        if (!outcome.groups || !Array.isArray(outcome.groups)) {
                            return;
                        }
                        
                        const group = outcome.groups.find(g => g.id === measurement.groupId);
                        if (!group) return;
                        
                        const groupTitle = group.title || 'Unknown Group';
                        const isControlGroup = 
                            groupTitle.toLowerCase().includes('placebo') || 
                            groupTitle.toLowerCase().includes('control') ||
                            groupTitle.toLowerCase().includes('sham');
                        
                        // Calculate standard error or other statistics if available
                        let standardError = null;
                        let dispersion = null;
                        let dispersionType = null;
                        
                        if (measurement.dispersion && measurement.dispersion !== 'null') {
                            dispersion = parseFloat(measurement.dispersion);
                            dispersionType = measurement.dispersionType?.toLowerCase() || '';
                            
                            if (!isNaN(dispersion)) {
                                if (dispersionType === 'standard_error') {
                                    standardError = dispersion;
                                } else if (dispersionType === 'standard_deviation') {
                                    // Convert SD to SE if sample size is available
                                    const sampleSize = group.participantsAnalyzedList?.[0]?.count;
                                    if (sampleSize && !isNaN(sampleSize) && sampleSize > 0) {
                                        standardError = dispersion / Math.sqrt(sampleSize);
                                    }
                                }
                            }
                        }
                        
                        // Add measurement data
                        categoryData.measurements.push({
                            value,
                            groupId: measurement.groupId,
                            groupTitle,
                            isControlGroup,
                            sampleSize: group.participantsAnalyzedList?.[0]?.count || 0,
                            standardError,
                            dispersion,
                            dispersionType
                        });
                    });
                    
                    // Only add categories with measurements
                    if (categoryData.measurements.length > 0) {
                        // Calculate effect size if we have both experimental and control groups
                        const experimentalMeasurements = categoryData.measurements.filter(m => !m.isControlGroup);
                        const controlMeasurements = categoryData.measurements.filter(m => m.isControlGroup);
                        
                        let effectSize = null;
                        let experimentalValue = null;
                        let controlValue = null;
                        let experimentalSampleSize = 0;
                        let controlSampleSize = 0;
                        
                        if (experimentalMeasurements.length > 0) {
                            // Calculate weighted average for experimental group
                            const expTotal = experimentalMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
                            experimentalSampleSize = experimentalMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
                            experimentalValue = experimentalSampleSize > 0 ? expTotal / experimentalSampleSize : null;
                        }
                        
                        if (controlMeasurements.length > 0) {
                            // Calculate weighted average for control group
                            const ctrlTotal = controlMeasurements.reduce((sum, m) => sum + (m.value * m.sampleSize), 0);
                            controlSampleSize = controlMeasurements.reduce((sum, m) => sum + m.sampleSize, 0);
                            controlValue = controlSampleSize > 0 ? ctrlTotal / controlSampleSize : null;
                        }
                        
                        // Calculate effect size if both values exist
                        if (experimentalValue !== null && controlValue !== null) {
                            // Standardize the effect based on outcome metric
                            try {
                                effectSize = standardizeOutcomeValue(experimentalValue - controlValue, outcomeTitle);
                            } catch (error) {
                                console.warn(`Error calculating effect size for ${nctId}:`, error);
                                effectSize = experimentalValue - controlValue; // Fallback to raw difference
                            }
                        }
                        
                        // Add the processed outcome data
                        studyInfo.outcomes.push({
                            title: outcomeTitle,
                            type: outcomeType,
                            timeFrame,
                            category: categoryData.title,
                            measurements: categoryData.measurements,
                            experimentalValue,
                            controlValue,
                            effectSize,
                            experimentalSampleSize,
                            controlSampleSize
                        });
                    }
                });
            });
        });
        
        // Add this study's info to the collection if it has outcomes
        if (studyInfo.outcomes.length > 0) {
            appState.allTrialOutcomes.push(studyInfo);
        }
    });
    
    console.log(`Collected outcome data from ${appState.allTrialOutcomes.length} studies`);
    console.log("All outcomes data:", appState.allTrialOutcomes);
    
    // Try to initialize the TrialDashboard if it exists
    if (typeof TrialDashboard !== 'undefined' && appState.allTrialOutcomes) {
        try {
            console.log("Loading data into TrialDashboard");
            TrialDashboard.loadData(appState.allTrialOutcomes);
        } catch (error) {
            console.error("Error loading data into TrialDashboard:", error);
        }
    }
    
    // Now that we have all the data, create the visualizations
    try {
        createAggregateVisualizations();
    } catch (error) {
        console.error("Error creating aggregate visualizations:", error);
    }
}

// Fallback function for standardizeOutcomeValue in case it's not defined
function standardizeOutcomeValue(value, outcomeTitle) {
    if (typeof window.standardizeOutcomeValue === 'function') {
        return window.standardizeOutcomeValue(value, outcomeTitle);
    }
    
    // Simple fallback - higher positive values are better unless the title suggests otherwise
    const lowerIsBetter = 
        outcomeTitle.toLowerCase().includes('score') || 
        outcomeTitle.toLowerCase().includes('scale') ||
        outcomeTitle.toLowerCase().includes('severity') ||
        outcomeTitle.toLowerCase().includes('pain') ||
        outcomeTitle.toLowerCase().includes('depression') ||
        outcomeTitle.toLowerCase().includes('anxiety') ||
        outcomeTitle.toLowerCase().includes('symptom');
    
    return lowerIsBetter ? -value : value;
}


function createAggregateVisualizations() {
    // Skip if we don't have data
    if (appState.allTrialOutcomes.length === 0) {
        console.warn("No trial outcome data available for visualization");
        return;
    }
    
    // Extract all outcome metrics for the selector
    const outcomeMetrics = new Set();
    appState.allTrialOutcomes.forEach(study => {
        study.outcomes.forEach(outcome => {
            outcomeMetrics.add(outcome.title);
        });
    });
    
    // Update the metrics array and selector
    appState.outcomeMetrics = Array.from(outcomeMetrics);
    
    if (appState.outcomeMetrics.length > 0) {
        // Set default metric if not already set
        if (!appState.currentOutcomeMetric || !appState.outcomeMetrics.includes(appState.currentOutcomeMetric)) {
            appState.currentOutcomeMetric = appState.outcomeMetrics[0];
        }
        
        // Populate the selector
        populateOutcomeMetricSelector();
        
        // Show the collated outcomes section
        // showSection(elements.collatedOutcomesSection, true);
        
        // Create the visualizations
        // displayCollatedOutcomes();
    }
}

// Modified function to handle missing chart elements more gracefully
function createOverallTreatmentEffectChart(outcomes) {
    const canvasId = 'overallTreatmentEffectChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.warn(`Canvas not found: ${canvasId}`);
        // Try to create the canvas if its container exists
        const container = document.querySelector('#collatedOutcomesSection .h-72');
        if (container) {
            container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            console.log(`Created canvas: ${canvasId}`);
            // Try again with the new canvas
            const newCanvas = document.getElementById(canvasId);
            if (!newCanvas) {
                console.error(`Failed to create canvas: ${canvasId}`);
                return;
            }
            createOverallTreatmentEffectChart(outcomes);
            return;
        }
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Clear previous chart
    if (charts.overallTreatmentEffect) {
        charts.overallTreatmentEffect.destroy();
    }
    
    // Filter only outcomes with effect sizes
    const validOutcomes = outcomes.filter(o => o.effectSize !== null);
    
    if (validOutcomes.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No treatment effect data available for the selected metric.</p>';
        return;
    }
    
    // Calculate mean and standard deviation of effect sizes
    const effectSizes = validOutcomes.map(o => o.effectSize);
    const mean = calculateMean(effectSizes);
    const stdDev = calculateStandardDeviation(effectSizes, mean);
    
    // Generate normal distribution data
    const bellCurveData = generateNormalDistribution(mean, stdDev);
    
    // Generate scatter plot data for individual studies
    const scatterData = validOutcomes.map(o => ({
        x: o.effectSize,
        y: 0.05, // Small fixed value for visibility
        nctId: o.nctId,
        title: o.title,
        phase: o.phase
    }));
    
    // Create the chart
    charts.overallTreatmentEffect = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    type: 'line',
                    label: 'Overall Distribution',
                    data: bellCurveData,
                    borderColor: '#8b5cf6', // Violet
                    backgroundColor: 'rgba(139, 92, 246, 0.2)', // Transparent violet
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                },
                {
                    type: 'scatter',
                    label: 'Individual Studies',
                    data: scatterData,
                    backgroundColor: ctx => {
                        // Color points by phase
                        const phase = scatterData[ctx.dataIndex]?.phase;
                        return getPhaseColor(phase);
                    },
                    pointRadius: 6,
                    pointHoverRadius: 8
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: 'Effect Size'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Probability Density'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const datasetIndex = context[0].datasetIndex;
                            
                            if (datasetIndex === 1) { // Scatter plot
                                return scatterData[dataIndex].title || 'Study';
                            }
                            return 'Effect Size Distribution';
                        },
                        label: function(context) {
                            const dataIndex = context.dataIndex;
                            const datasetIndex = context.datasetIndex;
                            
                            if (datasetIndex === 1) { // Scatter plot
                                return [
                                    `NCT ID: ${scatterData[dataIndex].nctId || 'Unknown'}`,
                                    `Phase: ${formatPhase(scatterData[dataIndex].phase)}`,
                                    `Effect Size: ${scatterData[dataIndex].x.toFixed(2)}`
                                ];
                            }
                            return `Value: ${context.parsed.x.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
}
        // function createOutcomeCharts(study) {
        //     const nctId = study.protocolSection?.identificationModule?.nctId;
        //     const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
        //     const primaryOutcomes = outcomes.filter(outcome => outcome.type === "PRIMARY");
        //     const secondaryOutcomes = outcomes.filter(outcome => outcome.type === "SECONDARY");
            
        //     // Clean up any existing chart instances
        //     Object.keys(charts.studySpecific).forEach(chartId => {
        //         if (chartId.includes(nctId)) {
        //             if (charts.studySpecific[chartId]) {
        //                 charts.studySpecific[chartId].destroy();
        //                 delete charts.studySpecific[chartId];
        //             }
        //         }
        //     });
            
        //     // Create charts for primary outcomes
        //     primaryOutcomes.forEach((outcome, idx) => {
        //         createSingleOutcomeChart(nctId, outcome, idx, false);
        //     });
            
        //     // Create charts for secondary outcomes
        //     secondaryOutcomes.forEach((outcome, idx) => {
        //         createSingleOutcomeChart(nctId, outcome, idx, true);
        //     });
        // }
        
   /**
 * Enhanced Clinical Trial Outcome Visualization
 * This utility creates dynamic visualizations for clinical trial outcome data,
 * handling various data structures and presentation formats.
 */

// Function to create outcome charts based on study data
function createOutcomeCharts(study) {
    const outcomes = study.resultsSection?.outcomeMeasuresModule?.outcomeMeasures || [];
    const nctId = study.protocolSection?.identificationModule?.nctId || 'unknown';
    
    if (!outcomes.length) {
        console.log('No outcome measures available for visualization');
        return;
    }
    
    // Create charts for primary outcomes
    const primaryOutcomes = outcomes.filter(outcome => outcome.type === 'PRIMARY');
    primaryOutcomes.forEach((outcome, idx) => {
        const canvasId = `outcome_${nctId}_${idx}`;
        const canvas = document.getElementById(canvasId);
        
        if (!canvas) {
            console.warn(`Canvas element not found for ${canvasId}`);
            return;
        }
        
        createOutcomeVisualization(outcome, canvas);
    });
    
    // Create charts for secondary outcomes
    const secondaryOutcomes = outcomes.filter(outcome => outcome.type === 'SECONDARY');
    secondaryOutcomes.forEach((outcome, idx) => {
        const canvasId = `outcome_secondary_${nctId}_${idx}`;
        const canvas = document.getElementById(canvasId);
        
        if (!canvas) {
            console.warn(`Canvas element not found for ${canvasId}`);
            return;
        }
        
        createOutcomeVisualization(outcome, canvas);
    });
}

// Main function to create appropriate outcome visualization based on data type
function createOutcomeVisualization(outcome, canvas) {
    // Check if outcome has required data
    if (!outcome || !canvas) return;
    
    // Extract relevant data
    const title = outcome.title || 'Outcome Measure';
    const timeFrame = outcome.timeFrame || 'Not specified';
    const paramType = outcome.paramType || '';
    const groups = outcome.groups || [];
    const classes = outcome.classes || [];
    
    // Create container div for enhanced UI
    const container = document.createElement('div');
    container.className = 'outcome-chart-container relative';
    container.style.width = '100%';
    container.style.height = '100%';
    canvas.parentNode.insertBefore(container, canvas);
    container.appendChild(canvas);
    
    // Add full screen button
    const fullScreenBtn = document.createElement('button');
    fullScreenBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg>';
    fullScreenBtn.className = 'absolute top-2 right-2 bg-white p-1 rounded-md shadow hover:bg-gray-100 z-10';
    fullScreenBtn.title = 'Full Screen';
    container.appendChild(fullScreenBtn);
    
    // Add interpretation container
    const interpretationContainer = document.createElement('div');
    interpretationContainer.className = 'outcome-interpretation mt-3 p-2 bg-gray-50 rounded text-sm hidden';
    container.appendChild(interpretationContainer);
    
    // Attempt to detect outcome data structure and create appropriate visualization
    if (hasDistributionData(outcome)) {
        createDistributionChart(outcome, canvas, interpretationContainer);
    } else if (hasCategoricalData(outcome)) {
        createCategoricalChart(outcome, canvas, interpretationContainer);
    } else if (hasTimePointData(outcome)) {
        createTimeSeriesChart(outcome, canvas, interpretationContainer);
    } else {
        // Fallback to simple bar chart if no specific structure detected
        createSimpleBarChart(outcome, canvas, interpretationContainer);
    }
    
    // Set up full screen functionality
    fullScreenBtn.addEventListener('click', () => {
        toggleFullScreen(container);
        
        // Show interpretation when in full screen
        interpretationContainer.classList.toggle('hidden');
    });
}

// Helper function to toggle full screen for chart
function toggleFullScreen(container) {
    if (!document.fullscreenElement) {
        // Create modal for fullscreen view
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'bg-white rounded-lg p-4 max-w-4xl w-full max-h-90vh overflow-auto';
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'absolute top-4 right-4 text-white hover:text-gray-200';
        closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>';
        
        modal.appendChild(closeBtn);
        modal.appendChild(modalContent);
        
        // Clone the container content for the modal
        const clone = container.cloneNode(true);
        clone.style.height = '500px';
        clone.querySelector('.outcome-interpretation').classList.remove('hidden');
        
        modalContent.appendChild(clone);
        document.body.appendChild(modal);
        
        // Set up chart recreation in modal
        const originalCanvas = container.querySelector('canvas');
        const clonedCanvas = clone.querySelector('canvas');
        
        // Transfer chart to cloned canvas
        if (originalCanvas._chart) {
            const config = originalCanvas._chart.config;
            new Chart(clonedCanvas, config);
        }
        
        // Close modal on button click
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    }
}

// Check if outcome has distribution-like data suitable for bell curve
function hasDistributionData(outcome) {
    if (!outcome.groups || !outcome.classes) return false;
    
    // Check for mean and standard deviation/error in measurements
    let hasMeanAndVariance = false;
    
    // Look for paramType indicating mean/average
    const isMeanParam = outcome.paramType === 'MEAN' || 
                       outcome.paramType === 'LEAST_SQUARES_MEAN' || 
                       outcome.paramType === 'GEOMETRIC_MEAN';
    
    // Look for dispersion type indicating variance
    const hasVariance = outcome.dispersionType === 'Standard Deviation' || 
                       outcome.dispersionType === 'Standard Error' || 
                       outcome.dispersionType === 'STANDARD_DEVIATION' || 
                       outcome.dispersionType === 'STANDARD_ERROR';
    
    // If class measurements have spread/dispersion values
    if (outcome.classes && outcome.classes.length > 0) {
        for (const cls of outcome.classes) {
            if (cls.categories && cls.categories.length > 0) {
                for (const cat of cls.categories) {
                    if (cat.measurements && cat.measurements.length > 0) {
                        for (const measurement of cat.measurements) {
                            if (measurement.value && (measurement.spread || measurement.dispersion)) {
                                hasMeanAndVariance = true;
                                break;
                            }
                        }
                    }
                }
            }
        }
    }
    
    return (isMeanParam && hasVariance) || hasMeanAndVariance;
}

// Check if outcome has categorical data
function hasCategoricalData(outcome) {
    if (!outcome.classes || outcome.classes.length === 0) return false;
    
    // Check for multiple categories or single category with multiple measurements
    for (const cls of outcome.classes) {
        if (cls.categories && cls.categories.length > 1) {
            return true;
        } else if (cls.categories && cls.categories.length === 1) {
            const cat = cls.categories[0];
            if (cat.measurements && cat.measurements.length > 1) {
                return true;
            }
        }
    }
    
    return false;
}

// Check if outcome has time-based data points
function hasTimePointData(outcome) {
    if (!outcome.classes || outcome.classes.length === 0) return false;
    
    // Check for class titles that indicate time points
    const timeRegex = /^(baseline|week|month|day|hour|minute|year|follow.?up|visit)/i;
    
    for (const cls of outcome.classes) {
        if (cls.title && timeRegex.test(cls.title)) {
            return true;
        }
    }
    
    return false;
}

// Create bell curve distribution chart (similar to your example image)
function createDistributionChart(outcome, canvas, interpretationContainer) {
    const groups = outcome.groups || [];
    const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
    if (!groups.length) return;
    
    // Extract means and standard deviations for each group
    const distributionData = [];
    
    // Determine which outcome classes to use
    let classesToUse = outcome.classes;
    if (outcome.classes.length > 1) {
        // For multiple classes, try to find the most relevant ones (like final timepoint)
        const finalTimepoint = outcome.classes.find(c => 
            (c.title && /final|end|last|completion/i.test(c.title)) || 
            outcome.classes[outcome.classes.length - 1]
        );
        
        if (finalTimepoint) {
            classesToUse = [finalTimepoint];
        }
    }
    
    // Extract measurement data
    classesToUse.forEach(cls => {
        if (cls.categories && cls.categories.length > 0) {
            cls.categories.forEach(cat => {
                if (cat.measurements && cat.measurements.length > 0) {
                    cat.measurements.forEach(measurement => {
                        const groupId = measurement.groupId;
                        const group = groups.find(g => g.id === groupId);
                        if (!group) return;
                        
                        const value = parseFloat(measurement.value);
                        
                        // Get standard deviation or error
                        let spreadValue = 0;
                        if (measurement.spread) {
                            spreadValue = parseFloat(measurement.spread);
                        } else if (measurement.dispersion) {
                            spreadValue = parseFloat(measurement.dispersion);
                        }
                        
                        if (!isNaN(value) && !isNaN(spreadValue)) {
                            distributionData.push({
                                group: group.title,
                                mean: value,
                                stdDev: spreadValue,
                                isError: outcome.dispersionType === 'Standard Error' || 
                                         outcome.dispersionType === 'STANDARD_ERROR'
                            });
                        }
                    });
                }
            });
        }
    });
    
    // If we have analysis data with p-values, add that information
    let pValueInfo = "";
    if (outcome.analyses && outcome.analyses.length > 0) {
        const analysis = outcome.analyses[0];
        if (analysis.pValue) {
            pValueInfo = `<p class="font-semibold mt-2">Statistical Analysis:</p>
                         <p>p-value: ${analysis.pValue}</p>`;
            
            if (analysis.statisticalMethod) {
                pValueInfo += `<p>Method: ${analysis.statisticalMethod}</p>`;
            }
            
            if (analysis.ciLowerLimit && analysis.ciUpperLimit) {
                pValueInfo += `<p>${analysis.ciPctValue || 95}% CI: [${analysis.ciLowerLimit}, ${analysis.ciUpperLimit}]</p>`;
            }
        }
    }
    
    // Generate bell curve data for visualization
    const chartData = {
        datasets: distributionData.map((data, index) => {
            const color = colors[index % colors.length];
            const points = 100;
            
            // For standard error, convert to standard deviation
            let stdDev = data.stdDev;
            if (data.isError && outcome.denoms) {
                // Try to find sample size to convert SE to SD
                const groupDenom = outcome.denoms[0]?.counts.find(c => 
                    groups.find(g => g.id === c.groupId)?.title === data.group
                );
                
                if (groupDenom) {
                    const n = parseInt(groupDenom.value);
                    if (!isNaN(n) && n > 0) {
                        stdDev = data.stdDev * Math.sqrt(n);
                    }
                }
            }
            
            // Generate normal distribution curve points
            const distributionPoints = generateNormalDistribution(data.mean, stdDev, points);
            
            return {
                label: `${data.group} (=${data.mean.toFixed(1)}, =${stdDev.toFixed(1)})`,
                data: distributionPoints,
                borderColor: color,
                backgroundColor: color + '20', // Add transparency
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                tension: 0.4
            };
        })
    };
    
    // Set up chart configuration
    const config = {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: sanitizeTitle(outcome.title),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                subtitle: {
                    display: true,
                    text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
                    font: {
                        size: 12,
                        style: 'italic'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: `${outcome.title} (${outcome.unitOfMeasure || 'Value'})`,
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        display: true,
                        drawBorder: true
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Probability Density',
                        font: {
                            weight: 'bold'
                        }
                    },
                    beginAtZero: true
                }
            }
        }
    };
    
    // Add indicator lines for means
    const meanLines = distributionData.map((data, index) => {
        return {
            type: 'line',
            id: `mean-line-${index}`,
            mode: 'vertical',
            scaleID: 'x',
            value: data.mean,
            borderColor: colors[index % colors.length],
            borderWidth: 2,
            borderDash: [6, 4],
            label: {
                enabled: true,
                content: `=${data.mean.toFixed(1)}`,
                position: 'top'
            }
        };
    });
    
    config.options.plugins.annotation = {
        annotations: meanLines
    };
    
    // Add interpretation
    updateInterpretation(interpretationContainer, outcome, distributionData, pValueInfo);
    
    // Create the chart
    const chart = new Chart(canvas, config);
    canvas._chart = chart;
}

// Create categorical chart for outcome data
function createCategoricalChart(outcome, canvas, interpretationContainer) {
    const groups = outcome.groups || [];
    const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
    if (!groups.length) return;
    
    // Extract category data
    const categories = [];
    const groupValues = {};
    
    // Initialize group values
    groups.forEach(group => {
        groupValues[group.id] = {};
    });
    
    // Process all classes and categories
    outcome.classes.forEach(cls => {
        if (cls.categories && cls.categories.length > 0) {
            cls.categories.forEach(cat => {
                const categoryName = cat.title || 'Category';
                if (!categories.includes(categoryName)) {
                    categories.push(categoryName);
                }
                
                if (cat.measurements && cat.measurements.length > 0) {
                    cat.measurements.forEach(measurement => {
                        const value = parseFloat(measurement.value);
                        if (!isNaN(value)) {
                            groupValues[measurement.groupId][categoryName] = value;
                        }
                    });
                }
            });
        }
    });
    
    // Prepare data for Chart.js
    const datasets = groups.map((group, index) => {
        const color = colors[index % colors.length];
        return {
            label: group.title,
            data: categories.map(cat => groupValues[group.id][cat] || 0),
            backgroundColor: color,
            borderColor: color,
            borderWidth: 1
        };
    });
    
    // Set up chart configuration
    const config = {
        type: 'bar',
        data: {
            labels: categories,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: sanitizeTitle(outcome.title),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                subtitle: {
                    display: true,
                    text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
                    font: {
                        size: 12,
                        style: 'italic'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: outcome.unitOfMeasure || 'Value',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    };
    
    // Add interpretation
    updateCategoricalInterpretation(interpretationContainer, outcome, groups, categories, groupValues);
    
    // Create the chart
    const chart = new Chart(canvas, config);
    canvas._chart = chart;
}

// Create time series chart for longitudinal data
function createTimeSeriesChart(outcome, canvas, interpretationContainer) {
    const groups = outcome.groups || [];
    const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
    if (!groups.length) return;
    
    // Extract time points and values
    const timePoints = [];
    const groupValues = {};
    
    // Initialize group values
    groups.forEach(group => {
        groupValues[group.id] = {};
    });
    
    // Process classes as time points
    outcome.classes.forEach(cls => {
        const timePoint = cls.title || 'Time Point';
        if (!timePoints.includes(timePoint)) {
            timePoints.push(timePoint);
        }
        
        if (cls.categories && cls.categories.length > 0) {
            cls.categories.forEach(cat => {
                if (cat.measurements && cat.measurements.length > 0) {
                    cat.measurements.forEach(measurement => {
                        const value = parseFloat(measurement.value);
                        if (!isNaN(value)) {
                            groupValues[measurement.groupId][timePoint] = value;
                        }
                    });
                }
            });
        }
    });
    
    // Sort time points chronologically if possible
    const timeOrder = {
        'baseline': 0,
        'screening': 1
    };
    
    timePoints.sort((a, b) => {
        // Check for special time points first
        if (a.toLowerCase() in timeOrder && b.toLowerCase() in timeOrder) {
            return timeOrder[a.toLowerCase()] - timeOrder[b.toLowerCase()];
        } else if (a.toLowerCase() in timeOrder) {
            return -1;
        } else if (b.toLowerCase() in timeOrder) {
            return 1;
        }
        
        // Try to extract numeric values for comparison
        const aMatch = a.match(/(\d+)\s*(day|week|month|year|hr|min|hour|minute|second)/i);
        const bMatch = b.match(/(\d+)\s*(day|week|month|year|hr|min|hour|minute|second)/i);
        
        if (aMatch && bMatch) {
            const aValue = parseInt(aMatch[1]);
            const bValue = parseInt(bMatch[1]);
            
            if (!isNaN(aValue) && !isNaN(bValue)) {
                if (aMatch[2].toLowerCase() === bMatch[2].toLowerCase()) {
                    return aValue - bValue;
                }
            }
        }
        
        // Default alphabetical sort
        return a.localeCompare(b);
    });
    
    // Prepare data for Chart.js
    const datasets = groups.map((group, index) => {
        const color = colors[index % colors.length];
        return {
            label: group.title,
            data: timePoints.map(time => groupValues[group.id][time] || null),
            borderColor: color,
            backgroundColor: color + '20',
            tension: 0.3,
            fill: false
        };
    });
    
    // Set up chart configuration
    const config = {
        type: 'line',
        data: {
            labels: timePoints,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: sanitizeTitle(outcome.title),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                subtitle: {
                    display: true,
                    text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
                    font: {
                        size: 12,
                        style: 'italic'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: outcome.unitOfMeasure || 'Value',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    };
    
    // Add interpretation
    updateTimeSeriesInterpretation(interpretationContainer, outcome, groups, timePoints, groupValues);
    
    // Create the chart
    const chart = new Chart(canvas, config);
    canvas._chart = chart;
}

// Simple fallback bar chart for any outcome data
// function createSimpleBarChart(outcome, canvas, interpretationContainer) {
//     const groups = outcome.groups || [];
//     const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
//     if (!groups.length) return;
    
//     // Get values for each group
//     const groupData = [];
    
//     // Try to find values from any structure
//     if (outcome.classes && outcome.classes.length > 0) {
//         for (const cls of outcome.classes) {
//             if (cls.categories && cls.categories.length > 0) {
//                 for (const cat of cls.categories) {
//                     if (cat.measurements && cat.measurements.length > 0) {
//                         for (const measurement of cat.measurements) {
//                             const value = parseFloat(measurement.value);
//                             if (!isNaN(value)) {
//                                 const group = groups.find(g => g.id === measurement.groupId);
//                                 if (group) {
//                                     groupData.push({
//                                         group: group.title,
//                                         value: value
//                                     });
//                                 }
//                             }
//                         }
//                     }
//                 }
//             }
//         }
//     }
    
//     // Set up chart configuration
//     const config = {
//         type: 'bar',
//         data: {
//             labels: groupData.map(d => d.group),
//             datasets: [{
//                 label: outcome.title,
//                 data: groupData.map(d => d.value),
//                 backgroundColor: groupData.map((_, i) => colors[i % colors.length]),
//                 borderColor: groupData.map((_, i) => colors[i % colors.length]),
//                 borderWidth: 1
//             }]
//         },
//         options: {
//             responsive: true,
//             maintainAspectRatio: false,
//             plugins: {
//                 title: {
//                     display: true,
//                     text: sanitizeTitle(outcome.title),
//                     font: {
//                         size: 14,
//                         weight: 'bold'
//                     }
//                 },
//                 subtitle: {
//                     display: true,
//                     text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
//                     font: {
//                         size: 12,
//                         style: 'italic'
//                     }
//                 },
//                 legend: {
//                     display: false
//                 }
//             },
//             scales: {
//                 y: {
//                     beginAtZero: true,
//                     title: {
//                         display: true,
//                         text: outcome.unitOfMeasure || 'Value',
//                         font: {
//                             weight: 'bold'
//                         }
//                     }
//                 }
//             }
//         }
//     };
    
//     // Add interpretation
//     const message = `<p class="font-semibold">Outcome Summary:</p>
//                     <p>${outcome.title}</p>
//                     <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>
//                     <ul class="mt-2">
//                         ${groupData.map(d => `<li>${d.group}: ${d.value} ${outcome.unitOfMeasure || ''}</li>`).join('')}
//                     </ul>`;
    
//     interpretationContainer.innerHTML = message;
    
//     // Create the chart
//     const chart = new Chart(canvas, config);
//     canvas._chart = chart;
// }   
      
      
        function createSingleOutcomeChart(nctId, outcome, idx, isSecondary) {
            const prefix = isSecondary ? 'outcome_secondary_' : 'outcome_';
            const canvasId = `${prefix}${nctId}_${idx}`;
            const canvas = document.getElementById(canvasId);
            
            if (!canvas) {
                console.warn(`Canvas not found for ${canvasId}`);
                return;
            }
            
            // Check if outcome has classes and measurements
            if (!outcome.classes || !outcome.classes[0] || !outcome.classes[0].categories) {
                console.warn(`No valid measurements for ${outcome.title}`);
                return;
            }
            
            const measurements = [];
            outcome.classes.forEach(cls => {
                cls.categories.forEach(cat => {
                    cat.measurements.forEach(measurement => {
                        if (measurement && measurement.value !== undefined && measurement.groupId) {
                            const group = outcome.groups.find(g => g.id === measurement.groupId);
                            if (group) {
                                // Use parseFloat but provide a default for empty values
                                const value = measurement.value === '' ? null : parseFloat(measurement.value);
                                let dispersion = null;
                                let dispersionType = null;
                                let spread = null;
                                
                                // Extract dispersion information if available
                                if (measurement.dispersion !== undefined && measurement.dispersion !== '') {
                                    dispersion = parseFloat(measurement.dispersion);
                                    dispersionType = measurement.dispersionType;
                                }
                                
                                // Calculate spread (standard deviation) if needed
                                if (dispersionType === 'standard_error') {
                                    const sampleSize = group.participantsAnalyzedList?.[0]?.count;
                                    if (sampleSize && !isNaN(sampleSize) && sampleSize > 0) {
                                        spread = dispersion * Math.sqrt(sampleSize);
                                    }
                                } else if (dispersionType === 'standard_deviation') {
                                    spread = dispersion;
                                } else {
                                    spread = parseFloat(measurement.spread || 0);
                                }
                                
                                measurements.push({
                                    groupId: measurement.groupId,
                                    groupTitle: group.title || 'Unknown Group',
                                    value: value,
                                    dispersion: dispersion,
                                    dispersionType: dispersionType,
                                    spread: spread,
                                    category: cat.title || '',
                                    sampleSize: group.participantsAnalyzedList?.[0]?.count || 0
                                });
                            }
                        }
                    });
                });
            });
            
            if (measurements.length === 0) {
                console.warn(`No valid measurements for ${outcome.title}`);
                return;
            }
            
            // Clean up any existing chart on this canvas
            if (charts.studySpecific[canvasId]) {
                charts.studySpecific[canvasId].destroy();
            }
            
            // Create the chart
            const ctx = canvas.getContext('2d');
            
            // Determine if values are numerical or categorical
            const isNumerical = measurements.every(m => m.value !== null && !isNaN(m.value));
            
            if (isNumerical) {
                // Bell curve or bar chart for numerical data
                const datasets = [];
                const uniqueGroups = [...new Set(measurements.map(m => m.groupId))];
                
                uniqueGroups.forEach((groupId, index) => {
                    const groupMeasurements = measurements.filter(m => m.groupId === groupId);
                    if (groupMeasurements.length > 0) {
                        const groupTitle = groupMeasurements[0].groupTitle || `Group ${index + 1}`;
                        
                        // Check if we have dispersion/spread data for bell curves
                        const hasBellCurveData = groupMeasurements.some(m => m.spread > 0);
                        
                        if (hasBellCurveData) {
                            // Generate bell curve data for measurements with spread
                            groupMeasurements.forEach(m => {
                                if (m.value !== null && !isNaN(m.value) && m.spread > 0) {
                                    const mean = m.value;
                                    const stdDev = m.spread;
                                    const bellCurveData = generateNormalDistribution(mean, stdDev);
                                    
                                    datasets.push({
                                        label: `${groupTitle} - ${m.category}`,
                                        data: bellCurveData,
                                        borderColor: getRandomColor(index),
                                        backgroundColor: getRandomColor(index, 0.2),
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 0
                                    });
                                }
                            });
                        } else {
                            // Bar chart data for means without standard deviations
                            const barData = groupMeasurements
                                .filter(m => m.value !== null && !isNaN(m.value))
                                .map(m => ({
                                    x: m.category,
                                    y: m.value
                                }));
                            
                            if (barData.length > 0) {
                                datasets.push({
                                    type: 'bar',
                                    label: groupTitle,
                                    data: barData,
                                    backgroundColor: getRandomColor(index, 0.6),
                                    borderColor: getRandomColor(index),
                                    borderWidth: 1
                                });
                            }
                        }
                    }
                });
                
                if (datasets.length > 0) {
                    // Determine chart type based on data
                    const isBarChart = datasets.some(d => d.type === 'bar');
                    
                    const chartConfig = {
                        type: isBarChart ? 'bar' : 'line',
                        data: {
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: isBarChart ? 'category' : 'linear',
                                    title: {
                                        display: true,
                                        text: outcome.title || 'Value'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            // For dense values, truncate or format labels
                                            if (typeof value === 'string' && value.length > 15) {
                                                return value.substring(0, 15) + '...';
                                            }
                                            return value;
                                        }
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: isBarChart ? 'Value' : 'Probability Density'
                                    },
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].dataset.label || 'Value';
                                        },
                                        label: function(context) {
                                            if (isBarChart) {
                                                return `Value: ${context.parsed.y !== undefined ? context.parsed.y.toFixed(2) : 'N/A'}`;
                                            }
                                            return `Value: ${context.parsed.x !== undefined ? context.parsed.x.toFixed(2) : 'N/A'}`;
                                        }
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        // Limit legend label lengths
                                        generateLabels: function(chart) {
                                            const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                            return originalLabels.map(label => {
                                                if (label.text && label.text.length > 30) {
                                                    label.text = label.text.substring(0, 30) + '...';
                                                }
                                                return label;
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    };
                    
                    try {
                        charts.studySpecific[canvasId] = new Chart(ctx, chartConfig);
                    } catch (error) {
                        console.error(`Error creating chart for ${canvasId}:`, error);
                    }
                } else {
                    // No valid datasets
                    canvas.parentElement.innerHTML = '<p class="text-center text-gray-500">Insufficient data for visualization</p>';
                }
            } else {
                // Bar chart for categorical data
                const labels = [...new Set(measurements.map(m => m.category))].filter(label => label !== undefined);
                const datasets = [];
                const groupMap = {};
                
                measurements.forEach(m => {
                    if (!groupMap[m.groupId]) {
                        groupMap[m.groupId] = {
                            label: m.groupTitle || 'Unknown Group',
                            data: Array(labels.length).fill(null),
                            backgroundColor: getRandomColor(Object.keys(groupMap).length, 0.6),
                            borderColor: getRandomColor(Object.keys(groupMap).length),
                            borderWidth: 1
                        };
                    }
                    
                    const categoryIndex = labels.indexOf(m.category);
                    if (categoryIndex !== -1 && m.value !== null) {
                        groupMap[m.groupId].data[categoryIndex] = m.value;
                    }
                });
                
                const finalDatasets = [];
                Object.values(groupMap).forEach(group => {
                    // Only add groups that have at least one non-null value
                    if (group.data.some(val => val !== null)) {
                        finalDatasets.push(group);
                    }
                });
                
                if (finalDatasets.length > 0 && labels.length > 0) {
                    const chartConfig = {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: finalDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    ticks: {
                                        callback: function(value, index) {
                                            // For dense values, truncate or format labels
                                            const label = labels[index];
                                            if (typeof label === 'string' && label.length > 15) {
                                                return label.substring(0, 15) + '...';
                                            }
                                            return label;
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: outcome.title || 'Value'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        // Limit legend label lengths
                                        generateLabels: function(chart) {
                                            const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                            return originalLabels.map(label => {
                                                if (label.text && label.text.length > 30) {
                                                    label.text = label.text.substring(0, 30) + '...';
                                                }
                                                return label;
                                            });
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            const index = context[0].dataIndex;
                                            return labels[index] || 'Unknown';
                                        }
                                    }
                                }
                            }
                        }
                    };
                    
                    try {
                        charts.studySpecific[canvasId] = new Chart(ctx, chartConfig);
                    } catch (error) {
                        console.error(`Error creating categorical chart for ${canvasId}:`, error);
                    }
                } else {
                    // No valid datasets or labels
                    canvas.parentElement.innerHTML = '<p class="text-center text-gray-500">Insufficient data for visualization</p>';
                }
            }
        }

        // Function to process and display aggregate outcome data
        function processAggregateOutcomes(studies) {
    // First collect all outcome data
    collectAllTrialOutcomes();
    
    // Then populate the legacy data structure for backward compatibility
    appState.allOutcomeMeasures = [];
    
    // Process studies to extract outcome measures for the original visualization
    studies.forEach(study => {
        const nctId = study.protocolSection?.identificationModule?.nctId;
        const studyDetails = appState.studyDetails[nctId];
        if (!studyDetails || !studyDetails.resultsSection?.outcomeMeasuresModule?.outcomeMeasures) return;
        
        const phase = study.protocolSection?.designModule?.phases?.[0] || 'PRE_PHASE';
        const outcomes = studyDetails.resultsSection.outcomeMeasuresModule.outcomeMeasures;
        
        outcomes.forEach(outcome => {
            if (outcome.type !== "PRIMARY") return;
            
            if (!outcome.classes || !outcome.classes[0]?.categories) return;
            
            outcome.classes.forEach(cls => {
                cls.categories.forEach(cat => {
                    cat.measurements.forEach(measurement => {
                        const value = parseFloat(measurement.value);
                        const spread = parseFloat(measurement.spread || 0);
                        
                        if (!isNaN(value)) {
                            const group = outcome.groups.find(g => g.id === measurement.groupId);
                            const isExperimental = group?.title.toLowerCase().includes('experimental') || 
                                                 group?.title.toLowerCase().includes('treatment') ||
                                                 group?.title.toLowerCase().includes('intervention');
                            
                            // Skip placebo/control groups for aggregate analysis
                            if (!isExperimental) return;
                            
                            appState.allOutcomeMeasures.push({
                                nctId: nctId,
                                phase: phase,
                                outcomeTitle: outcome.title || 'Unknown Outcome',
                                groupTitle: group?.title || 'Unknown Group',
                                value: value,
                                spread: spread,
                                lowerIsBetter: outcome.title?.toLowerCase().includes('score') || 
                                              outcome.title?.toLowerCase().includes('scale')
                            });
                        }
                    });
                });
            });
        });
    });
    
    // Display drug success rates visualization
    displayDrugSuccessRates();
}

// Update the displayCollatedOutcomes function to first create the charts if needed
function displayCollatedOutcomes() {
    console.log("Displaying collated outcomes...");
    
    // Check if the chart canvases exist, if not create them
    ['overallTreatmentEffectChart', 'phaseComparisonChart', 'phasePerformanceChart'].forEach(canvasId => {
        if (!document.getElementById(canvasId)) {
            console.log(`Canvas ${canvasId} not found, attempting to create`);
            let container;
            switch (canvasId) {
                case 'overallTreatmentEffectChart':
                    container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(1)');
                    break;
                case 'phaseComparisonChart':
                    container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(2)');
                    break;
                case 'phasePerformanceChart':
                    container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(3)');
                    break;
            }
            
            if (container) {
                container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                console.log(`Created canvas: ${canvasId}`);
            }
        }
    });
    
    // Only show if we have data
    if (appState.allTrialOutcomes.length === 0 && appState.collatedOutcomes.length === 0) {
        showSection(elements.collatedOutcomesSection, false);
        return;
    }
    
    showSection(elements.collatedOutcomesSection, true);
    
    // Get the current metric and type selection
    const currentMetric = appState.currentOutcomeMetric;
    const currentType = appState.currentOutcomeType;
    
    console.log(`Filtering outcomes by metric: ${currentMetric}, type: ${currentType}`);
    
    // First try to use the collatedOutcomes array which might already have processed data
    let filteredOutcomes = [];
    
    if (appState.collatedOutcomes.length > 0) {
        filteredOutcomes = appState.collatedOutcomes;
    } else {
        // Otherwise, compile outcomes from the allTrialOutcomes array
        appState.allTrialOutcomes.forEach(study => {
            study.outcomes.forEach(outcome => {
                if (outcome.effectSize !== null) {
                    filteredOutcomes.push({
                        nctId: study.nctId,
                        title: study.title,
                        phase: study.phase,
                        outcomeTitle: outcome.title,
                        outcomeType: outcome.type,
                        category: outcome.category,
                        experimentalValue: outcome.experimentalValue,
                        controlValue: outcome.controlValue,
                        effectSize: outcome.effectSize,
                        experimentalSampleSize: outcome.experimentalSampleSize,
                        controlSampleSize: outcome.controlSampleSize,
                        timeFrame: outcome.timeFrame
                    });
                }
            });
        });
    }
    
    // Apply filters
    if (currentMetric) {
        filteredOutcomes = filteredOutcomes.filter(outcome => 
            outcome.outcomeTitle === currentMetric
        );
    }
    
    if (currentType !== 'all') {
        filteredOutcomes = filteredOutcomes.filter(outcome => 
            outcome.outcomeType === currentType
        );
    }
    
    console.log(`Filtered to ${filteredOutcomes.length} outcomes for visualization`);
    
    // Create the charts
    createOverallTreatmentEffectChart(filteredOutcomes);
    createEnhancedPhaseComparisonChart(filteredOutcomes);
    createPhasePerformanceChart(filteredOutcomes);
    createStatisticalSummaryTable(filteredOutcomes);
}


        function displayAggregateVisualizations() {
            if (appState.allOutcomeMeasures.length === 0) {
                elements.aggregateOutcomesSection.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-6 text-center">
                        <p class="text-gray-500">No outcome measures with results available for the selected studies.</p>
                    </div>
                `;
                return;
            }
            
            showSection(elements.aggregateOutcomesSection, true);
            
            // Create overall distribution chart
            createOverallDistributionChart();
            
            // Create phase-specific charts
            createPhaseSpecificCharts();
            
            // Display outcome measures list
            displayOutcomeMeasuresList();
        }

        function createOverallDistributionChart() {
            const canvas = document.getElementById('overallDistributionChart');
            if (!canvas) {
                console.warn("Overall distribution chart canvas not found");
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Clear previous chart instance if it exists
            if (charts.overallDistribution) {
                charts.overallDistribution.destroy();
            }
            
            // Standardize values (convert to z-scores)
            const outcomes = appState.allOutcomeMeasures;
            
            // Calculate mean and std dev across all measures
            const validOutcomes = outcomes.filter(o => !isNaN(o.value) && !isNaN(o.spread) && o.spread > 0);
            
            if (validOutcomes.length === 0) return;
            
            const values = validOutcomes.map(o => o.value);
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const stdDev = Math.sqrt(
                values.map(v => Math.pow(v - mean, 2)).reduce((sum, val) => sum + val, 0) / values.length
            );
            
            // Generate normal distribution data
            const bellCurveData = generateNormalDistribution(mean, stdDev);
            
            // Create chart
            charts.overallDistribution = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Overall Distribution',
                        data: bellCurveData,
                        borderColor: '#8b5cf6', // Violet
                        backgroundColor: 'rgba(139, 92, 246, 0.2)', // Transparent violet
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Standardized Outcome Value'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Probability Density'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return 'Overall Distribution';
                                },
                                label: function(context) {
                                    return `Value: ${context.parsed.x.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createPhaseSpecificCharts() {
            const earlyPhasesCanvas = document.getElementById('earlyPhasesChart');
            const latePhasesCanvas = document.getElementById('latePhasesChart');
            
            if (!earlyPhasesCanvas || !latePhasesCanvas) {
                console.warn("Phase-specific chart canvases not found");
                return;
            }
            
            const earlyPhasesCtx = earlyPhasesCanvas.getContext('2d');
            const latePhasesCtx = latePhasesCanvas.getContext('2d');
            
            // Clear previous chart instances if they exist
            if (charts.earlyPhases) {
                charts.earlyPhases.destroy();
            }
            if (charts.latePhases) {
                charts.latePhases.destroy();
            }
            
            // Group outcomes by phase
            const outcomes = appState.allOutcomeMeasures;
            const earlyPhaseOutcomes = outcomes.filter(o => 
                o.phase === 'PHASE1' || o.phase === 'PHASE2' || o.phase === 'PHASE1_PHASE2' || o.phase === 'PRE_PHASE'
            );
            const latePhaseOutcomes = outcomes.filter(o => 
                o.phase === 'PHASE3' || o.phase === 'PHASE4'
            );
            
            // Process early phase data
            if (earlyPhaseOutcomes.length > 0) {
                // Group by specific phase
                const phase1Data = earlyPhaseOutcomes.filter(o => o.phase === 'PHASE1');
                const phase2Data = earlyPhaseOutcomes.filter(o => o.phase === 'PHASE2');
                const phase12Data = earlyPhaseOutcomes.filter(o => o.phase === 'PHASE1_PHASE2');
                const prePhaseData = earlyPhaseOutcomes.filter(o => o.phase === 'PRE_PHASE');
                
                const datasets = [];
                
                if (phase1Data.length > 0) {
                    datasets.push(createPhaseDataset(phase1Data, 'Phase 1', '#60a5fa'));
                }
                if (phase2Data.length > 0) {
                    datasets.push(createPhaseDataset(phase2Data, 'Phase 2', '#34d399'));
                }
                if (phase12Data.length > 0) {
                    datasets.push(createPhaseDataset(phase12Data, 'Phase 1/2', '#38bdf8'));
                }
                if (prePhaseData.length > 0) {
                    datasets.push(createPhaseDataset(prePhaseData, 'Pre-Phase', '#9ca3af'));
                }
                
                // Create chart
                charts.earlyPhases = new Chart(earlyPhasesCtx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Standardized Outcome Value'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Probability Density'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
            
            // Process late phase data
            if (latePhaseOutcomes.length > 0) {
                // Group by specific phase
                const phase3Data = latePhaseOutcomes.filter(o => o.phase === 'PHASE3');
                const phase4Data = latePhaseOutcomes.filter(o => o.phase === 'PHASE4');
                
                const datasets = [];
                
                if (phase3Data.length > 0) {
                    datasets.push(createPhaseDataset(phase3Data, 'Phase 3', '#a78bfa'));
                }
                if (phase4Data.length > 0) {
                    datasets.push(createPhaseDataset(phase4Data, 'Phase 4', '#f97316'));
                }
                
                // Create chart
                charts.latePhases = new Chart(latePhasesCtx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Standardized Outcome Value'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Probability Density'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
        }

        function createPhaseDataset(phaseData, label, color) {
            const validData = phaseData.filter(o => !isNaN(o.value) && !isNaN(o.spread) && o.spread > 0);
            
            if (validData.length === 0) {
                return {
                    label: label,
                    data: [],
                    borderColor: color,
                    backgroundColor: hexToRgba(color, 0.2),
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                };
            }
            
            const values = validData.map(o => o.value);
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const stdDev = Math.sqrt(
                values.map(v => Math.pow(v - mean, 2)).reduce((sum, val) => sum + val, 0) / values.length
            ) || 1; // Default to 1 if stdDev is 0 to avoid division by zero
            
            // Generate normal distribution data
            const bellCurveData = generateNormalDistribution(mean, stdDev);
            
            return {
                label: label,
                data: bellCurveData,
                borderColor: color,
                backgroundColor: hexToRgba(color, 0.2),
                fill: true,
                tension: 0.4,
                pointRadius: 0
            };
        }

        function displayOutcomeMeasuresList() {
            const outcomeMeasuresList = document.getElementById('outcomeMeasuresList');
            if (!outcomeMeasuresList) {
                console.warn("Outcome measures list element not found");
                return;
            }
            
            outcomeMeasuresList.innerHTML = '';
            
            // Group outcomes by measure title
            const outcomes = appState.allOutcomeMeasures;
            const outcomesByTitle = {};
            
            outcomes.forEach(outcome => {
                const title = outcome.outcomeTitle || 'Unknown Outcome';
                if (!outcomesByTitle[title]) {
                    outcomesByTitle[title] = [];
                }
                outcomesByTitle[title].push(outcome);
            });
            
            // Sort outcome titles by frequency (most common first)
            const sortedTitles = Object.keys(outcomesByTitle).sort((a, b) => 
                outcomesByTitle[b].length - outcomesByTitle[a].length
            );
            
            if (sortedTitles.length === 0) {
                outcomeMeasuresList.innerHTML = '<p class="text-center text-gray-500">No outcome measures available</p>';
                return;
            }
            
            sortedTitles.forEach(title => {
                const outcomesByPhase = {};
                
                // Group by phase
                outcomesByTitle[title].forEach(outcome => {
                    const phase = outcome.phase;
                    if (!outcomesByPhase[phase]) {
                        outcomesByPhase[phase] = [];
                    }
                    outcomesByPhase[phase].push(outcome);
                });
                
                // Create outcome card
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg border border-gray-200';
                
                // Calculate average value across all phases
                const allValues = outcomesByTitle[title].map(o => o.value);
                const avgValue = allValues.reduce((sum, val) => sum + val, 0) / allValues.length;
                
                // Construct phase data HTML
                const phaseDataHtml = Object.keys(outcomesByPhase)
                    .map(phase => {
                        const phaseOutcomes = outcomesByPhase[phase];
                        const phaseValues = phaseOutcomes.map(o => o.value);
                        const avgPhaseValue = phaseValues.reduce((sum, val) => sum + val, 0) / phaseValues.length;
                        
                        return `
                            <div class="flex items-center mb-1">
                                <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${getPhaseColor(phase)}"></span>
                                <span class="text-sm">${formatPhase(phase)}: ${avgPhaseValue.toFixed(2)}</span>
                            </div>
                        `;
                    })
                    .join('');
                
                card.innerHTML = `
                    <h4 class="text-md font-medium mb-2">${title}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Studies: ${outcomesByTitle[title].length}</p>
                            <p class="text-sm text-gray-600 mb-2">Average value: ${avgValue.toFixed(2)}</p>
                            <div class="mt-2">
                                ${phaseDataHtml}
                            </div>
                        </div>
                        <div>
                            <div class="h-32">
                                <canvas id="outcome_summary_${title.replace(/\s+/g, '_').substring(0, 30)}"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                outcomeMeasuresList.appendChild(card);
                
                // Create summary chart
                const canvasId = `outcome_summary_${title.replace(/\s+/g, '_').substring(0, 30)}`;
                const canvas = document.getElementById(canvasId);
                
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const datasets = [];
                    
                    Object.keys(outcomesByPhase).forEach((phase, index) => {
                        const phaseOutcomes = outcomesByPhase[phase];
                        const phaseValues = phaseOutcomes.map(o => o.value);
                        const avgPhaseValue = phaseValues.reduce((sum, val) => sum + val, 0) / phaseValues.length;
                        
                        datasets.push({
                            label: formatPhase(phase),
                            data: [{x: formatPhase(phase), y: avgPhaseValue}],
                            backgroundColor: getPhaseColor(phase),
                            borderColor: getPhaseColor(phase),
                            borderWidth: 1
                        });
                    });
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Average Value'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            });
        }

        // New function to display collated outcomes
        function displayCollatedOutcomes() {
    // Only show if we have data
    if (appState.collatedOutcomes.length === 0) {
        showSection(elements.collatedOutcomesSection, false);
        return;
    }
    
    showSection(elements.collatedOutcomesSection, true);
    
    // Get the current metric and type selection
    const currentMetric = appState.currentOutcomeMetric;
    const currentType = appState.currentOutcomeType;
    
    // Filter outcomes by metric and type
    let filteredOutcomes = appState.collatedOutcomes;
    
    if (currentMetric) {
        filteredOutcomes = filteredOutcomes.filter(outcome => 
            outcome.outcomeTitle === currentMetric
        );
    }
    
    if (currentType !== 'all') {
        filteredOutcomes = filteredOutcomes.filter(outcome => 
            outcome.outcomeType === currentType
        );
    }
    
    // Create the overall treatment effect chart
    createOverallTreatmentEffectChart(filteredOutcomes);
    
    // Create the enhanced phase comparison chart
    createEnhancedPhaseComparisonChart(filteredOutcomes);
    
    // Create the new phase performance chart
    createPhasePerformanceChart(filteredOutcomes);
    
    // Create the statistical summary table
    createStatisticalSummaryTable(filteredOutcomes);
}

        function createOverallTreatmentEffectChart(outcomes) {
            const canvas = document.getElementById('overallTreatmentEffectChart');
            if (!canvas) {
                console.warn("Overall treatment effect chart canvas not found");
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Clear previous chart
            if (charts.overallTreatmentEffect) {
                charts.overallTreatmentEffect.destroy();
            }
            
            // Filter only outcomes with effect sizes
            const validOutcomes = outcomes.filter(o => o.effectSize !== null);
            
            if (validOutcomes.length === 0) {
                canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No treatment effect data available for the selected metric.</p>';
                return;
            }
            
            // Calculate mean and standard deviation of effect sizes
            const effectSizes = validOutcomes.map(o => o.effectSize);
            const mean = calculateMean(effectSizes);
            const stdDev = calculateStandardDeviation(effectSizes, mean);
            
            // Generate normal distribution data
            const bellCurveData = generateNormalDistribution(mean, stdDev);
            
            // Generate scatter plot data for individual studies
            const scatterData = validOutcomes.map(o => ({
                x: o.effectSize,
                y: 0.05, // Small fixed value for visibility
                nctId: o.nctId,
                title: o.title,
                phase: o.phase
            }));
            
            // Create the chart
            charts.overallTreatmentEffect = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            type: 'line',
                            label: 'Overall Distribution',
                            data: bellCurveData,
                            borderColor: '#8b5cf6', // Violet
                            backgroundColor: 'rgba(139, 92, 246, 0.2)', // Transparent violet
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            type: 'scatter',
                            label: 'Individual Studies',
                            data: scatterData,
                            backgroundColor: ctx => {
                                // Color points by phase
                                const phase = scatterData[ctx.dataIndex]?.phase;
                                return getPhaseColor(phase);
                            },
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Effect Size'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Probability Density'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const datasetIndex = context[0].datasetIndex;
                                    
                                    if (datasetIndex === 1) { // Scatter plot
                                        return scatterData[dataIndex].title || 'Study';
                                    }
                                    return 'Effect Size Distribution';
                                },
                                label: function(context) {
                                    const dataIndex = context.dataIndex;
                                    const datasetIndex = context.datasetIndex;
                                    
                                    if (datasetIndex === 1) { // Scatter plot
                                        return [
                                            `NCT ID: ${scatterData[dataIndex].nctId || 'Unknown'}`,
                                            `Phase: ${formatPhase(scatterData[dataIndex].phase)}`,
                                            `Effect Size: ${scatterData[dataIndex].x.toFixed(2)}`
                                        ];
                                    }
                                    return `Value: ${context.parsed.x.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createEnhancedPhaseComparisonChart(outcomes) {
    const canvasId = 'phaseComparisonChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.warn(`Canvas not found: ${canvasId}`);
        // Try to create the canvas if its container exists
        const container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(2)');
        if (container) {
            container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            console.log(`Created canvas: ${canvasId}`);
            // Try again with the new canvas
            const newCanvas = document.getElementById(canvasId);
            if (!newCanvas) {
                console.error(`Failed to create canvas: ${canvasId}`);
                return;
            }
            createEnhancedPhaseComparisonChart(outcomes);
            return;
        }
        return;
    }
    
    // Rest of the function implementation...
    const ctx = canvas.getContext('2d');
    
    // Clear previous chart
    if (charts.phaseComparison) {
        charts.phaseComparison.destroy();
    }
    
    // Filter only outcomes with effect sizes
    const validOutcomes = outcomes.filter(o => o.effectSize !== null);
    
    if (validOutcomes.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No phase-specific data available for the selected metric.</p>';
        return;
    }
    
    // Group outcomes by phase
    const phaseGroups = {};
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4,
        "N/A": 5
    };
    
    validOutcomes.forEach(o => {
        const phase = o.phase || 'N/A';
        if (!phaseGroups[phase]) {
            phaseGroups[phase] = [];
        }
        phaseGroups[phase].push(o.effectSize);
    });
    
    // Calculate phase statistics and prepare datasets
    const phases = Object.keys(phaseGroups)
        .filter(phase => phaseGroups[phase].length >= 2) // Only include phases with enough data
        .sort((a, b) => phaseOrder[a] - phaseOrder[b]);
    
    if (phases.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">Insufficient data for phase comparison visualization.</p>';
        return;
    }
    
    const datasets = [];
    const allEffectSizes = validOutcomes.map(o => o.effectSize);
    
    // Find global min and max for consistent scaling
    const globalMin = Math.min(...allEffectSizes);
    const globalMax = Math.max(...allEffectSizes);
    const range = globalMax - globalMin;
    const paddedMin = globalMin - (range * 0.1);
    const paddedMax = globalMax + (range * 0.1);
    
    phases.forEach((phase) => {
        const effectSizes = phaseGroups[phase];
        const mean = calculateMean(effectSizes);
        const stdDev = calculateStandardDeviation(effectSizes, mean) || 1; // Default to 1 if stdDev is 0
        
        // Generate normal distribution data with consistent x-scale
        const points = 100;
        const step = (paddedMax - paddedMin) / points;
        const bellCurveData = [];
        
        for (let x = paddedMin; x <= paddedMax; x += step) {
            const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                      Math.exp(-Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2)));
            bellCurveData.push({ x, y });
        }
        
        datasets.push({
            label: formatPhase(phase),
            data: bellCurveData,
            borderColor: getPhaseColor(phase),
            backgroundColor: hexToRgba(getPhaseColor(phase), 0.1),
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0
        });
    });
    
    // Create the chart with proper scaling
    charts.phaseComparison = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    title: {
                        display: true,
                        text: 'Effect Size'
                    },
                    min: paddedMin,
                    max: paddedMax,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Probability Density'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].dataset.label;
                        },
                        label: function(context) {
                            const phaseLabel = context.dataset.label;
                            const effectSize = context.parsed.x.toFixed(2);
                            
                            // Get the phase from the label
                            const phase = Object.keys(phaseOrder).find(p => 
                                formatPhase(p) === phaseLabel
                            );
                            
                            if (phase) {
                                const effectSizes = phaseGroups[phase];
                                const mean = calculateMean(effectSizes);
                                const count = effectSizes.length;
                                
                                return [
                                    `Effect Size: ${effectSize}`,
                                    `Mean Effect: ${mean.toFixed(2)}`,
                                    `Studies: ${count}`
                                ];
                            }
                            
                            return `Effect Size: ${effectSize}`;
                        }
                    }
                }
            }
        }
    });
}

// And for the phase performance chart
function createPhasePerformanceChart(outcomes) {
    const canvasId = 'phasePerformanceChart';
    const canvas = document.getElementById(canvasId);
    
    if (!canvas) {
        console.warn(`Canvas not found: ${canvasId}`);
        // Try to create the canvas if its container exists
        const container = document.querySelector('#collatedOutcomesSection .h-72:nth-of-type(3)');
        if (container) {
            container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            console.log(`Created canvas: ${canvasId}`);
            // Try again with the new canvas
            const newCanvas = document.getElementById(canvasId);
            if (!newCanvas) {
                console.error(`Failed to create canvas: ${canvasId}`);
                return;
            }
            createPhasePerformanceChart(outcomes);
            return;
        }
        return;
    }
    
    // Rest of the function implementation...
    const ctx = canvas.getContext('2d');
    
    // Clear previous chart
    if (charts.phasePerformance) {
        charts.phasePerformance.destroy();
    }
    
    // Filter only outcomes with effect sizes
    const validOutcomes = outcomes.filter(o => o.effectSize !== null);
    
    if (validOutcomes.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No phase-specific data available for the selected metric.</p>';
        return;
    }
    
    // Group outcomes by phase
    const phaseGroups = {};
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4,
        "N/A": 5
    };
    
    validOutcomes.forEach(o => {
        const phase = o.phase || 'N/A';
        if (!phaseGroups[phase]) {
            phaseGroups[phase] = [];
        }
        phaseGroups[phase].push(o.effectSize);
    });
    
    // Calculate phase statistics for the bar chart
    const phases = Object.keys(phaseGroups)
        .filter(phase => phaseGroups[phase].length >= 2) // Only include phases with enough data
        .sort((a, b) => phaseOrder[a] - phaseOrder[b]);
    
    if (phases.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">Insufficient data for phase performance visualization.</p>';
        return;
    }
    
    const labels = phases.map(phase => formatPhase(phase));
    const meanValues = [];
    const errorBars = {
        plus: [],
        minus: []
    };
    
    phases.forEach(phase => {
        const effectSizes = phaseGroups[phase];
        const mean = calculateMean(effectSizes);
        const stdDev = calculateStandardDeviation(effectSizes, mean);
        const n = effectSizes.length;
        const ci = calculateConfidenceInterval(mean, stdDev, n);
        
        meanValues.push(mean);
        errorBars.plus.push(ci.upper - mean);
        errorBars.minus.push(mean - ci.lower);
    });
    
    // Create the chart
    charts.phasePerformance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Mean Effect Size',
                data: meanValues,
                backgroundColor: phases.map(phase => hexToRgba(getPhaseColor(phase), 0.7)),
                borderColor: phases.map(phase => getPhaseColor(phase)),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Effect Size'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Trial Phase'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const index = context.dataIndex;
                            const phase = phases[index];
                            const effectSizes = phaseGroups[phase];
                            const mean = meanValues[index];
                            const stdDev = calculateStandardDeviation(effectSizes);
                            const n = effectSizes.length;
                            const ci = calculateConfidenceInterval(mean, stdDev, n);
                            
                            return [
                                `Mean Effect: ${mean.toFixed(2)}`,
                                `95% CI: [${ci.lower.toFixed(2)}, ${ci.upper.toFixed(2)}]`,
                                `Studies: ${n}`
                            ];
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'errorBars',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    
                    if (!meta.hidden) {
                        meta.data.forEach((element, index) => {
                            // Draw error bars
                            const plus = errorBars.plus[index];
                            const minus = errorBars.minus[index];
                            const x = element.x;
                            const y = element.y;
                            
                            const barWidth = 3;
                            
                            // Save state
                            ctx.save();
                            
                            // Line style
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = dataset.borderColor[index] || dataset.borderColor;
                            
                            // Draw the line
                            ctx.beginPath();
                            ctx.moveTo(x, y - plus);
                            ctx.lineTo(x, y + minus);
                            ctx.stroke();
                            
                            // Draw the top cap
                            ctx.beginPath();
                            ctx.moveTo(x - barWidth, y - plus);
                            ctx.lineTo(x + barWidth, y - plus);
                            ctx.stroke();
                            
                            // Draw the bottom cap
                            ctx.beginPath();
                            ctx.moveTo(x - barWidth, y + minus);
                            ctx.lineTo(x + barWidth, y + minus);
                            ctx.stroke();
                            
                            // Restore state
                            ctx.restore();
                        });
                    }
                });
            }
        }]
    });
}

    
// Function to initialize FDA data section
// Function to initialize FDA data section
// function initFdaDataSection() {
//   // Show the section
//   showSection(elements.fdaDataSection, true);
  
//   // Initialize counters
//   elements.fdaDocCount.textContent = "0 documents";
//   elements.orangeBookCount.textContent = "0 entries";
//   elements.dailyMedCount.textContent = "0 entries";
//   elements.warningLettersCount.textContent = "0 letters";
// }

// // Function to display FDA data when available
// async function displayFdaData(drugName) {
//   // Initialize the FDA data section
//   initFdaDataSection();
  
//   // Show loading state
//   const loadingTemplate = `
//     <div class="flex justify-center items-center py-8">
//       <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Loading FDA data...</span>
//     </div>
//   `;
  
//   elements.fdaDocuments.innerHTML = loadingTemplate;
//   elements.orangeBookData.innerHTML = loadingTemplate;
//   elements.dailyMedData.innerHTML = loadingTemplate;
  
//   try {
//     // Fetch FDA drug data
//     const fdaResponse = await fetch(`/api/fda/drug/${encodeURIComponent(drugName)}`);
//     const fdaData = await fdaResponse.json();
    
//     if (fdaResponse.ok && !fdaData.error) {
//       await displayFdaSubmissions(fdaData, drugName);
//     } else {
//       elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA submissions data");
//     }
    
//     // Fetch Orange Book data
//     const orangeBookResponse = await fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(drugName)}`);
//     const orangeBookData = await orangeBookResponse.json();
    
//     if (orangeBookResponse.ok && !orangeBookData.error) {
//       displayOrangeBookData(orangeBookData);
//     } else {
//       elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
//     }
    
//     // Fetch DailyMed data
//     const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(drugName)}`);
//     const dailyMedData = await dailyMedResponse.json();
    
//     if (dailyMedResponse.ok && !dailyMedData.error) {
//       displayDailyMedData(dailyMedData);
//     } else {
//       elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
//     }
    
//   } catch (error) {
//     console.error("Error fetching FDA data:", error);
//     elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
//     elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
//   }
// }

// // Helper function to create error messages
// function createErrorMessage(message) {
//   return `
//     <div class="flex justify-center items-center py-8 text-red-500">
//       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//       </svg>
//       <span>${message}</span>
//     </div>
//   `;
// }

// // Function to display FDA submissions
// async function displayFdaSubmissions(fdaData, drugName) {
//   // Check if FDA data is empty
//   if (Object.keys(fdaData).length === 0) {
//     elements.fdaDocuments.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">No FDA submissions found for "${drugName}"</p>
//       </div>
//     `;
//     elements.fdaDocCount.textContent = "0 documents";
//     return;
//   }
  
//   // Collect all products into a flat array for easier pagination
//   let allProducts = [];
//   Object.entries(fdaData).forEach(([brandName, strengths]) => {
//     Object.entries(strengths).forEach(([strength, products]) => {
//       products.forEach(product => {
//         allProducts.push({
//           ...product,
//           strength
//         });
//       });
//     });
//   });
  
//   // Count total entries for the counter
//   const totalEntries = allProducts.length;
  
//   // Update the counter
//   elements.fdaDocCount.textContent = `${totalEntries} submissions`;
  
//   // Pagination settings
//   const itemsPerPage = 10;
//   const totalPages = Math.ceil(totalEntries / itemsPerPage);
//   let currentPage = 1;
  
//   // Function to render products for the current page
//   function renderCurrentPage() {
//     const startIndex = (currentPage - 1) * itemsPerPage;
//     const endIndex = Math.min(startIndex + itemsPerPage, totalEntries);
//     const productsToShow = allProducts.slice(startIndex, endIndex);
    
//     // Create HTML for FDA submissions
//     let html = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">`;
    
//     // Iterate through each product for the current page
//     for (const product of productsToShow) {
//       // Create a card for each product
//       html += `
//         <div class="bg-white border border-gray-200 rounded-md shadow-sm hover:shadow-md transition-shadow">
//           <div class="p-3">
//             <div class="flex justify-between items-start">
//               <div class="truncate pr-2">
//                 <h4 class="text-sm font-semibold truncate">${product.brandName}</h4>
//                 <p class="text-xs text-gray-600">${product.strength}</p>
//               </div>
//               <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full whitespace-nowrap">
//                 ${product.applicationNumber}
//               </span>
//             </div>
            
//             <div class="mt-2 text-xs">
//               <p><span class="font-medium">Approved:</span> ${product.approvalDate}</p>
//               <p class="truncate"><span class="font-medium">Manufacturer:</span> ${product.manufacturerName || product.sponsorName}</p>
//               <p class="truncate"><span class="font-medium">Form:</span> ${product.dosageForm}</p>
//             </div>
            
//             <div class="mt-2 flex justify-end">
//               <button
//                 class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors view-details-btn"
//                 data-application="${product.applicationNumber}"
//                 data-brand="${product.brandName}"
//                 data-ingredient="${product.activeIngredients?.[0]?.name || drugName}"
//               >
//                 Details
//               </button>
//             </div>
//           </div>
//         </div>
//       `;
//     }
    
//     html += `</div>`;
    
//     // Add pagination controls
//     if (totalPages > 1) {
//       html += `
//         <div class="mt-6 flex justify-center">
//           <nav class="flex items-center">
//             <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-l ${currentPage === 1 ? 'bg-gray-100 cursor-not-allowed text-gray-400' : 'bg-white hover:bg-gray-50 text-gray-700'}" ${currentPage === 1 ? 'disabled' : ''}>
//               Previous
//             </button>
            
//             <div class="px-4 py-1 border-t border-b border-gray-300 bg-white text-sm">
//               Page ${currentPage} of ${totalPages}
//             </div>
            
//             <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-r ${currentPage === totalPages ? 'bg-gray-100 cursor-not-allowed text-gray-400' : 'bg-white hover:bg-gray-50 text-gray-700'}" ${currentPage === totalPages ? 'disabled' : ''}>
//               Next
//             </button>
//           </nav>
//         </div>
//       `;
//     }
    
//     elements.fdaDocuments.innerHTML = html;
    
//     // Add event listeners to the "View Details" buttons
//     document.querySelectorAll('.view-details-btn').forEach(button => {
//       button.addEventListener('click', function() {
//         const applicationNumber = this.getAttribute('data-application');
//         const brandName = this.getAttribute('data-brand');
//         const ingredient = this.getAttribute('data-ingredient');
//         openDetailsModal(applicationNumber, brandName, ingredient);
//       });
//     });
    
//     // Add event listeners to pagination buttons
//     if (totalPages > 1) {
//       document.getElementById('prev-page')?.addEventListener('click', function() {
//         if (currentPage > 1) {
//           currentPage--;
//           renderCurrentPage();
//           // Scroll to top of results
//           elements.fdaDocuments.scrollIntoView({ behavior: 'smooth' });
//         }
//       });
      
//       document.getElementById('next-page')?.addEventListener('click', function() {
//         if (currentPage < totalPages) {
//           currentPage++;
//           renderCurrentPage();
//           // Scroll to top of results
//           elements.fdaDocuments.scrollIntoView({ behavior: 'smooth' });
//         }
//       });
//     }
//   }
  
//   // Initial render
//   renderCurrentPage();
// }

//////////////////////////////////////////////////WARNING LETTERS ///////////////////////////////////////////////////////////
// New function to fetch warning letters
async function fetchWarningLetters(searchTerm, filters = {}) {
  try {
    // Build query parameters
    const queryParams = new URLSearchParams();
    queryParams.append('term', searchTerm);
    queryParams.append('field', 'all');


    
    // Add filters if they exist
    if (filters.type) queryParams.append('type', filters.type); // human or veterinary
    if (filters.issueDate) queryParams.append('issueDate', filters.issueDate);
    if (filters.issuingOffice) queryParams.append('issuingOffice', filters.issuingOffice);
    
    // Show loading state
    elements.warningLettersData.innerHTML = `
      <div class="flex justify-center items-center py-8">
        <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="ml-2 text-gray-600">Searching warning letters...</span>
      </div>
    `;
    
    // Make request to the API
    const response = await fetch(`${API_BASE_URL}/wl/search?${queryParams.toString()}`);
    
    if (!response.ok) {
      throw new Error(`Error fetching warning letters: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Display the warning letters
    displayWarningLetters(data, searchTerm);
  } catch (error) {
    console.error("Error fetching warning letters:", error);
    elements.warningLettersData.innerHTML = createErrorMessage("Error fetching warning letters");
    elements.warningLettersCount.textContent = "0 letters";
  }
}

// New function to display warning letters
function displayWarningLetters(data, searchTerm) {
  const letters = data.results || [];
  const totalCount = data.total || 0;
  
  // Update counter
  elements.warningLettersCount.textContent = `${totalCount} letters`;
  
  if (letters.length === 0) {
    elements.warningLettersData.innerHTML = `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No warning letters found containing "${searchTerm}"</p>
      </div>
    `;
    return;
  }
  
  // Get unique issuing offices for filter
  const issuingOffices = [...new Set(letters.map(letter => letter.issuingOffice))].filter(Boolean);
  
  // Determine which letters are veterinary vs human
  const isVeterinary = letter => {
    const vetKeywords = ['animal', 'vet', 'veterinary', 'livestock', 'pet', 'cattle', 'poultry', 'swine', 'equine', 'fish', 'aquatic', 'cow', 'horse', 'dog', 'cat'];
    const title = (letter.companyName || '').toLowerCase();
    const subject = (letter.subject || '').toLowerCase();
    const content = (letter.fullContent || '').toLowerCase();
    
    return vetKeywords.some(keyword => 
      title.includes(keyword) || 
      subject.includes(keyword) || 
      content.includes(keyword)
    );
  };
  
  // Create HTML for warning letters section
  let html = `
    <div>
      <!-- Filter controls -->
      <div class="mb-4">
        <div class="flex flex-wrap items-center justify-between">
          <div class="flex-1 min-w-0 mb-2 sm:mb-0">
            <h4 class="text-sm font-medium text-gray-700">Found ${totalCount} warning letters related to "${searchTerm}"</h4>
          </div>
          <div class="flex space-x-2">
            <div>
              <select id="warning-letters-type-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="all">All Types</option>
                <option value="human">Human</option>
                <option value="veterinary">Veterinary</option>
              </select>
            </div>
            <div>
              <select id="warning-letters-office-filter" class="text-xs rounded border border-gray-300 py-1 px-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="all">All Offices</option>
                ${issuingOffices.map(office => `<option value="${office}">${office}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Warning letters list -->
      <div id="warning-letters-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
  `;
  
  // Add each warning letter
  letters.forEach(letter => {
    // Determine if veterinary or human
    const letterType = isVeterinary(letter) ? 'veterinary' : 'human';
    
    html += `
      <div class="warning-letter-item hover-card bg-white border border-gray-200 rounded p-4 transition-all" 
           data-id="${letter.id || letter.letterId}" 
           data-type="${letterType}" 
           data-office="${letter.issuingOffice || ''}">
        <div class="flex justify-between items-start">
          <h5 class="text-sm font-medium">${letter.companyName}</h5>
          <div class="flex space-x-2">
            <span class="text-xs px-2 py-1 rounded-full ${letterType === 'veterinary' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
              ${letterType === 'veterinary' ? 'Veterinary' : 'Human'}
            </span>
            <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">
              ${formatDate(letter.letterIssueDate)}
            </span>
          </div>
        </div>
        
        <p class="mt-1 text-xs text-gray-500">${letter.issuingOffice || 'Unknown Office'}</p>
        <p class="mt-1 text-xs text-gray-700">${letter.subject || 'No subject provided'}</p>
        
        <div class="mt-2 text-xs text-gray-600 line-clamp-2">
          ${highlightSearchTerm(letter.excerpt || '', searchTerm)}
        </div>
        
        <div class="mt-3 flex justify-between items-center">
          <button class="text-xs text-blue-600 hover:text-blue-800 view-warning-letter" data-id="${letter.id || letter.letterId}">
            View Details
          </button>
          ${letter.companyUrl ? `
            <a href="${letter.companyUrl}" target="_blank" class="text-xs text-gray-600 hover:text-gray-800">
              View on FDA Website
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  // Close container divs
  html += `
      </div>
      
      <div class="mt-4 text-center">
        <button id="load-more-letters" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded transition-colors">
          Load More Letters
        </button>
      </div>
    </div>
  `;
  
  // Update the warning letters section
  elements.warningLettersData.innerHTML = html;
  
  // Add event listeners for warning letter detail view
  document.querySelectorAll('.view-warning-letter').forEach(button => {
    button.addEventListener('click', function() {
      const letterId = this.getAttribute('data-id');
      viewWarningLetterDetails(letterId, searchTerm);
    });
  });
  
  // Add event listeners for filters
  document.getElementById('warning-letters-type-filter').addEventListener('change', applyWarningLetterFilters);
  document.getElementById('warning-letters-office-filter').addEventListener('change', applyWarningLetterFilters);
  
  // Add event listener for load more button
  document.getElementById('load-more-letters').addEventListener('click', function() {
    loadMoreWarningLetters(searchTerm);
  });
}

// Function to apply warning letter filters
function applyWarningLetterFilters() {
  const typeFilter = document.getElementById('warning-letters-type-filter').value;
  const officeFilter = document.getElementById('warning-letters-office-filter').value;
  
  // Get all letter items
  const letterItems = document.querySelectorAll('.warning-letter-item');
  let visibleCount = 0;
  
  // Apply filters
  letterItems.forEach(item => {
    const itemType = item.getAttribute('data-type');
    const itemOffice = item.getAttribute('data-office');
    
    const typeMatch = typeFilter === 'all' || itemType === typeFilter;
    const officeMatch = officeFilter === 'all' || itemOffice === officeFilter;
    
    // Show/hide based on filter matching
    if (typeMatch && officeMatch) {
      item.classList.remove('hidden');
      visibleCount++;
    } else {
      item.classList.add('hidden');
    }
  });
  
  // Update the visible count
  const countEl = document.querySelector('#warning-letters-list').previousElementSibling.querySelector('h4');
  if (countEl) {
    const totalCount = letterItems.length;
    const searchTerm = countEl.textContent.match(/related to "([^"]+)"/)?.[1] || '';
    
    if (visibleCount < totalCount) {
      countEl.textContent = `Showing ${visibleCount} of ${totalCount} warning letters related to "${searchTerm}"`;
    } else {
      countEl.textContent = `Found ${totalCount} warning letters related to "${searchTerm}"`;
    }
  }
  
  // Show/hide load more button based on filters
  const loadMoreBtn = document.getElementById('load-more-letters');
  if (visibleCount === 0) {
    loadMoreBtn.classList.add('hidden');
    
    // Display a message if no results match the filters
    const noResultsEl = document.getElementById('no-filter-results');
    if (!noResultsEl) {
      const messageEl = document.createElement('div');
      messageEl.id = 'no-filter-results';
      messageEl.className = 'text-center p-4 text-sm text-gray-500';
      messageEl.textContent = 'No warning letters match the selected filters.';
      
      document.getElementById('warning-letters-list').appendChild(messageEl);
    }
  } else {
    loadMoreBtn.classList.remove('hidden');
    
    // Remove no results message if it exists
    const noResultsEl = document.getElementById('no-filter-results');
    if (noResultsEl) noResultsEl.remove();
  }
}

// Function to load more warning letters
async function loadMoreWarningLetters(searchTerm) {
  const loadMoreBtn = document.getElementById('load-more-letters');
  const currentCount = document.querySelectorAll('.warning-letter-item').length;
  
  // Show loading state
  loadMoreBtn.innerHTML = `
    <svg class="animate-spin h-4 w-4 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    Loading...
  `;
  loadMoreBtn.disabled = true;
  
  try {
    // Get the current filter values
    const typeFilter = document.getElementById('warning-letters-type-filter').value;
    const officeFilter = document.getElementById('warning-letters-office-filter').value;
    
    // Build query parameters
    const queryParams = new URLSearchParams();
    queryParams.append('term', searchTerm);
    queryParams.append('field', 'all');
    queryParams.append('offset', currentCount);
    queryParams.append('limit', 10); // Load 10 more letters
    
    // Add filters if they're not "all"
    if (typeFilter !== 'all') queryParams.append('type', typeFilter);
    if (officeFilter !== 'all') queryParams.append('issuingOffice', officeFilter);
    
    // Make request to the API
    const response = await fetch(`${API_BASE_URL}/wl/search?${queryParams.toString()}`);
    
    if (!response.ok) {
      throw new Error(`Error fetching more warning letters: ${response.status}`);
    }
    
    const data = await response.json();
    const letters = data.results || [];
    
    if (letters.length === 0) {
      // No more letters to load
      loadMoreBtn.innerHTML = 'No more letters to load';
      loadMoreBtn.disabled = true;
      return;
    }
    
    // Function to check if letter is veterinary
    const isVeterinary = letter => {
      const vetKeywords = ['animal', 'vet', 'veterinary', 'livestock', 'pet', 'cattle', 'poultry', 'swine', 'equine', 'fish', 'aquatic', 'cow', 'horse', 'dog', 'cat'];
      const title = (letter.companyName || '').toLowerCase();
      const subject = (letter.subject || '').toLowerCase();
      const content = (letter.fullContent || '').toLowerCase();
      
      return vetKeywords.some(keyword => 
        title.includes(keyword) || 
        subject.includes(keyword) || 
        content.includes(keyword)
      );
    };
    
    // Create HTML for new letters
    let html = '';
    
    letters.forEach(letter => {
      // Determine if veterinary or human
      const letterType = isVeterinary(letter) ? 'veterinary' : 'human';
      
      html += `
        <div class="warning-letter-item hover-card bg-white border border-gray-200 rounded p-4 transition-all" 
             data-id="${letter.id || letter.letterId}" 
             data-type="${letterType}" 
             data-office="${letter.issuingOffice || ''}">
          <div class="flex justify-between items-start">
            <h5 class="text-sm font-medium">${letter.companyName}</h5>
            <div class="flex space-x-2">
              <span class="text-xs px-2 py-1 rounded-full ${letterType === 'veterinary' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                ${letterType === 'veterinary' ? 'Veterinary' : 'Human'}
              </span>
              <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">
                ${formatDate(letter.letterIssueDate)}
              </span>
            </div>
          </div>
          
          <p class="mt-1 text-xs text-gray-500">${letter.issuingOffice || 'Unknown Office'}</p>
          <p class="mt-1 text-xs text-gray-700">${letter.subject || 'No subject provided'}</p>
          
          <div class="mt-2 text-xs text-gray-600 line-clamp-2">
            ${highlightSearchTerm(letter.excerpt || '', searchTerm)}
          </div>
          
          <div class="mt-3 flex justify-between items-center">
            <button class="text-xs text-blue-600 hover:text-blue-800 view-warning-letter" data-id="${letter.id || letter.letterId}">
              View Details
            </button>
            ${letter.companyUrl ? `
              <a href="${letter.companyUrl}" target="_blank" class="text-xs text-gray-600 hover:text-gray-800">
                View on FDA Website
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </a>
            ` : ''}
          </div>
        </div>
      `;
    });
    
    // Append new letters to the list
    document.getElementById('warning-letters-list').insertAdjacentHTML('beforeend', html);
    
    // Add event listeners for new warning letter detail view buttons
    document.querySelectorAll('.view-warning-letter:not([data-initialized])').forEach(button => {
      button.setAttribute('data-initialized', 'true');
      button.addEventListener('click', function() {
        const letterId = this.getAttribute('data-id');
        viewWarningLetterDetails(letterId, searchTerm);
      });
    });
    
    // Update button state
    loadMoreBtn.innerHTML = 'Load More Letters';
    loadMoreBtn.disabled = false;
    
    // Apply current filters to the new items
    applyWarningLetterFilters();
  } catch (error) {
    console.error('Error loading more warning letters:', error);
    loadMoreBtn.innerHTML = 'Error Loading More';
    
    // Auto-reset after a delay
    setTimeout(() => {
      loadMoreBtn.innerHTML = 'Load More Letters';
      loadMoreBtn.disabled = false;
    }, 3000);
  }
}

// Function to view warning letter details
async function viewWarningLetterDetails(letterId, searchTerm) {
  try {
    // Show loading modal
    showWarningLetterModal(`
      <div class="flex justify-center items-center py-12">
        <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="ml-2">Loading warning letter details...</span>
      </div>
    `);
    
    // Fetch the warning letter details
    const response = await fetch(`${API_BASE_URL}/wl/letter/${letterId}`);
    
    if (!response.ok) {
      throw new Error(`Error fetching warning letter details: ${response.status}`);
    }
    
    const letter = await response.json();
    
    // Format the letter content
    let contentHtml = '';
    
    if (letter.fullContent) {
      // If we have a search term, highlight it
      contentHtml = searchTerm 
        ? highlightSearchTerm(letter.fullContent, searchTerm)
        : letter.fullContent;
    } else {
      contentHtml = '<p class="text-gray-500">No letter content available.</p>';
    }
    
    // Show warning letter details in modal
    showWarningLetterModal(`
      <div>
        <div class="border-b pb-4 mb-4">
          <div class="flex justify-between items-start">
            <h3 class="text-xl font-semibold">${letter.companyName}</h3>
            <div class="flex space-x-2">
              ${letter.companyUrl ? `
                <a href="${letter.companyUrl}" target="_blank" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded transition-colors">
                  View on FDA Website
                </a>
              ` : ''}
            </div>
          </div>
          
          <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div>
              <p class="text-gray-500">Letter ID:</p>
              <p>${letter.letterId || 'N/A'}</p>
            </div>
            <div>
              <p class="text-gray-500">Issue Date:</p>
              <p>${formatDate(letter.letterIssueDate)}</p>
            </div>
            <div>
              <p class="text-gray-500">Issuing Office:</p>
              <p>${letter.issuingOffice || 'N/A'}</p>
            </div>
          </div>
          
          <div class="mt-4">
            <p class="text-gray-500">Subject:</p>
            <p>${letter.subject || 'No subject provided'}</p>
          </div>
        </div>
        
        <div class="mb-4">
          <h4 class="text-lg font-medium mb-2">Letter Content</h4>
          <div class="bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto custom-scrollbar text-sm whitespace-pre-line">
            ${contentHtml}
          </div>
        </div>
        
        ${letter.companyUrl ? `
          <div class="flex justify-center">
            <a href="${letter.companyUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              View complete warning letter on FDA website
            </a>
          </div>
        ` : ''}
      </div>
    `, letter.companyName);
    
    // If we have a search term, scroll to the first occurrence and highlight it specially
    if (searchTerm && letter.fullContent) {
      setTimeout(() => {
        // Find the first highlighted element
        const firstHighlight = document.querySelector('.highlight');
        if (firstHighlight) {
          // Scroll the element into view within the scrollable container
          firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Add a special animation to draw attention
          firstHighlight.classList.add('animate-pulse');
          setTimeout(() => {
            firstHighlight.classList.remove('animate-pulse');
          }, 2000);
        }
      }, 500);
    }
  } catch (error) {
    console.error('Error fetching warning letter details:', error);
    showWarningLetterModal(`
      <div class="text-center text-red-500 p-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-lg font-medium mb-2">Error Loading Warning Letter</h3>
        <p class="text-sm text-gray-600">We couldn't load the warning letter details. Please try again later.</p>
      </div>
    `, 'Error');
  }
}

// Function to show warning letter modal
function showWarningLetterModal(content, title = 'Warning Letter Details') {
  // Check if modal already exists
  let modal = document.getElementById('warning-letter-modal');
  
  if (!modal) {
    // Create modal if it doesn't exist
    modal = document.createElement('div');
    modal.id = 'warning-letter-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    
    // Build modal HTML
    modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
          <h2 class="text-xl font-semibold" id="warning-letter-modal-title">${title}</h2>
          <button id="close-warning-letter-modal" class="text-gray-400 hover:text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <div class="overflow-y-auto p-6" id="warning-letter-modal-content">
          ${content}
        </div>
      </div>
    `;
    
    // Add to document
    document.body.appendChild(modal);
    
    // Add event listener to close button
    document.getElementById('close-warning-letter-modal').addEventListener('click', closeWarningLetterModal);
    
    // Close on click outside content
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeWarningLetterModal();
      }
    });
    
    // Close on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.classList.contains('flex')) {
        closeWarningLetterModal();
      }
    });
  } else {
    // Update modal content
    document.getElementById('warning-letter-modal-title').textContent = title;
    document.getElementById('warning-letter-modal-content').innerHTML = content;
    
    // Show the modal
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
  
  // Prevent body scrolling
  document.body.style.overflow = 'hidden';
}

// Function to close warning letter modal
function closeWarningLetterModal() {
  const modal = document.getElementById('warning-letter-modal');
  if (modal) {
    modal.classList.remove('flex');
    modal.classList.add('hidden');
    
    // Allow body scrolling again
    document.body.style.overflow = '';
  }
}

// Helper function to highlight search terms in text
function highlightSearchTerm(text, searchTerm) {
  if (!text || !searchTerm) return text;
  
  // Escape special characters in the search term
  const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  
  // Create a regular expression to find the search term
  const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
  
  // Replace matches with highlighted spans
  return text.replace(regex, '<span class="highlight bg-yellow-200 px-0.5 rounded">$1</span>');
}

// Helper function to format date
function formatDate(dateString) {
  if (!dateString) return 'Unknown Date';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  } catch (e) {
    return dateString;
  }
}

// Helper function to create error message
function createErrorMessage(message) {
  return `
    <div class="text-center p-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-sm text-red-600">${message}</p>
    </div>
  `;
}

// Helper function to show/hide a section
function showSection(element, show) {
  if (show) {
    element.classList.remove('hidden');
  } else {
    element.classList.add('hidden');
  }
}

// Function to search warning letters directly
async function searchWarningLetters(searchTerm, type = null, issuingOffice = null) {
  // Display the FDA data section if it's hidden
  showSection(elements.fdaDataSection, true);
  
  // Show loading state only for warning letters
  elements.warningLettersData.innerHTML = `
    <div class="flex justify-center items-center py-8">
      <svg class="animate-spin h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-2 text-gray-600">Searching warning letters...</span>
    </div>
  `;
  
  try {
    // Create filters object
    const filters = {};
    if (type) filters.type = type;
    if (issuingOffice) filters.issuingOffice = issuingOffice;
    
    // Fetch warning letters
    await fetchWarningLetters(searchTerm, filters);
  } catch (error) {
    console.error('Error searching warning letters:', error);
    elements.warningLettersData.innerHTML = createErrorMessage('Error searching warning letters');
  }
}


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function initFdaDataSection() {
  // Show the section
  showSection(elements.fdaDataSection, true);
  
  // Initialize counters
  elements.fdaDocCount.textContent = "0 documents";
  elements.orangeBookCount.textContent = "0 entries";
  elements.dailyMedCount.textContent = "0 entries";
  elements.warningLettersCount.textContent = "0 letters";
}

// Function to display FDA data when available
async function displayFdaData(drugName,condition) {
  // Initialize the FDA data section
  initFdaDataSection();
  
  // Show loading state
  const loadingTemplate = `
    <div class="flex justify-center items-center py-8">
      <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-2 text-gray-600">Loading FDA data...</span>
    </div>
  `;
  
  elements.fdaDocuments.innerHTML = loadingTemplate;
  elements.orangeBookData.innerHTML = loadingTemplate;
  elements.dailyMedData.innerHTML = loadingTemplate;
  elements.warningLettersData.innerHTML = loadingTemplate;
  
  try {
        // if (!drug) {
    //     alert('Please enter a drug name to search.');
    //     return;
    // }
    // Fetch comprehensive FDA drug data
    const fdaResponse = await fetch(`${API_BASE_URL}/fda/drug/${encodeURIComponent(drugName)}`);
    const fdaData = await fdaResponse.json();
    
    if (fdaResponse.ok && !fdaData.error) {
      // Display the comprehensive FDA data
      displayComprehensiveFdaData(fdaData, drugName);
    } else {
      elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA data");
    }
    
    // Continue with existing Orange Book and DailyMed fetches
    const orangeBookResponse = await fetch(`${API_BASE_URL}/fda/orangebook/search?q=${encodeURIComponent(drugName)}`);
    const orangeBookData = await orangeBookResponse.json();
    
    if (orangeBookResponse.ok && !orangeBookData.error) {
      displayOrangeBookData(orangeBookData);
    } else {
      elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
    }
    
    const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(drugName)}`);
    const dailyMedData = await dailyMedResponse.json();
    
    if (dailyMedResponse.ok && !dailyMedData.error) {
      displayDailyMedData(dailyMedData);
    } else {
      elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
    }
    
    // Fetch warning letters
    await fetchWarningLetters(drugName);
    
  } catch (error) {
    console.error("Error fetching FDA data:", error);
    elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.warningLettersData.innerHTML = createErrorMessage("Error fetching FDA data");
  }
}



async function displayFdaClinicalData(condition) {
  // Initialize the FDA data section
  initFdaDataSection();
  
  // Show loading state
  const loadingTemplate = `
    <div class="flex justify-center items-center py-8">
      <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-2 text-gray-600">Loading clinical FDA data for ${condition}...</span>
    </div>
  `;
  
  elements.fdaDocuments.innerHTML = loadingTemplate;
  elements.orangeBookData.innerHTML = loadingTemplate;
  elements.dailyMedData.innerHTML = loadingTemplate;
  elements.warningLettersData.innerHTML = loadingTemplate;
  try {
    // if (!condition) {
    //   alert('Please enter a clinical condition to search.');
    //   return;
    // }

    // Fetch FDA data by condition
    const fdaResponse = await fetch(`/api/fda/condition/${encodeURIComponent(condition)}`);
    const fdaData = await fdaResponse.json();
    
    if (fdaResponse.ok && !fdaData.error) {
      // Display the comprehensive FDA data for the condition
      displayComprehensiveFdaData(fdaData, condition);
    } else {
      elements.fdaDocuments.innerHTML = createErrorMessage("Could not retrieve FDA data");
    }
    
    // Continue with existing Orange Book and DailyMed fetches
    const orangeBookResponse = await fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(condition)}`);
    const orangeBookData = await orangeBookResponse.json();
    
    if (orangeBookResponse.ok && !orangeBookData.error) {
      displayOrangeBookData(orangeBookData);
    } else {
      elements.orangeBookData.innerHTML = createErrorMessage("Could not retrieve Orange Book data");
    }
    
    const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(condition)}`);
    const dailyMedData = await dailyMedResponse.json();
    
    if (dailyMedResponse.ok && !dailyMedData.error) {
      displayDailyMedData(dailyMedData);
    } else {
      elements.dailyMedData.innerHTML = createErrorMessage("Could not retrieve DailyMed data");
    }
    
    // Fetch warning letters
    await fetchWarningLetters(condition);
    
  } catch (error) {
    console.error("Error fetching FDA data:", error);
    elements.fdaDocuments.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.orangeBookData.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.dailyMedData.innerHTML = createErrorMessage("Error fetching FDA data");
    elements.warningLettersData.innerHTML = createErrorMessage("Error fetching FDA data");
  }
}



// New function to display comprehensive FDA data
function displayComprehensiveFdaData(fdaData, drugName) {
  // Check if we have valid data
  if (!fdaData || (!fdaData.raw && !fdaData.categorized) || (Object.keys(fdaData.categorized).length === 0 && (!fdaData.raw.combinedResults || fdaData.raw.combinedResults.length === 0))) {
    elements.fdaDocuments.innerHTML = `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No FDA data found for "${drugName}"</p>
      </div>
    `;
    elements.fdaDocCount.textContent = "0 documents";
    return;
  }
  
  // Extract endpoint data
  const endpointsData = fdaData.raw?.endpoints || {};
  
  // Count total entries for the counter
  const totalDocuments = 
    (endpointsData.drugsFda?.count || 0) + 
    (endpointsData.label?.count || 0) + 
    (endpointsData.ndc?.count || 0) + 
    (endpointsData.enforcement?.count || 0) + 
    (endpointsData.event?.count || 0);
  
  // Update the counter
  elements.fdaDocCount.textContent = `${totalDocuments} documents`;
  
  // Create HTML for the FDA data
  let html = `
    <div class="mb-4 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
        <li class="mr-2" role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
                  id="applications-tab" 
                  data-tab="applications-content"
                  aria-selected="true">
            Drug Applications (${endpointsData.drugsFda?.count || 0})
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="label-tab" 
                  data-tab="label-content"
                  aria-selected="false">
            Labeling (${endpointsData.label?.count || 0})
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="ndc-tab" 
                  data-tab="ndc-content"
                  aria-selected="false">
            NDC (${endpointsData.ndc?.count || 0})
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="events-tab" 
                  data-tab="events-content"
                  aria-selected="false">
            Adverse Events (${endpointsData.event?.count || 0})
          </button>
        </li>
        <li role="presentation">
          <button class="fda-tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="enforcement-tab" 
                  data-tab="enforcement-content"
                  aria-selected="false">
            Enforcement (${endpointsData.enforcement?.count || 0})
          </button>
        </li>
      </ul>
    </div>
    
    <div class="tab-content">
  `;
  
  // Add Applications Tab Content
  html += `
    <div id="applications-content" class="fda-tab-pane active">
  `;
  
  // Process categorized drug application data
  if (Object.keys(fdaData.categorized).length > 0) {
    // Collect all products into a flat array for easier pagination
    let allProducts = [];
    Object.entries(fdaData.categorized).forEach(([brandName, strengths]) => {
      Object.entries(strengths).forEach(([strength, products]) => {
        products.forEach(product => {
          allProducts.push({
            ...product,
            strength
          });
        });
      });
    });
    
    // Add products grid
    html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">`;
    
    for (const product of allProducts.slice(0, 9)) { // Show top 9 products
      html += `
        <div class="bg-white border border-gray-200 rounded-md shadow-sm hover:shadow-md transition-shadow">
          <div class="p-3">
            <div class="flex justify-between items-start">
              <div class="truncate pr-2">
                <h4 class="text-sm font-semibold truncate">${product.brandName}</h4>
                <p class="text-xs text-gray-600">${product.strength}</p>
              </div>
              <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full whitespace-nowrap">
                ${product.applicationNumber}
              </span>
            </div>
            
            <div class="mt-2 text-xs">
              <p><span class="font-medium">Approved:</span> ${product.approvalDate}</p>
              <p class="truncate"><span class="font-medium">Manufacturer:</span> ${product.manufacturerName || product.sponsorName}</p>
              <p class="truncate"><span class="font-medium">Form:</span> ${product.dosageForm}</p>
            </div>
            
            <div class="mt-2 flex justify-end">
              <button
                class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors view-details-btn"
                data-application="${product.applicationNumber}"
                data-brand="${product.brandName}"
                data-ingredient="${product.activeIngredients?.[0]?.name || drugName}"
              >
                Details
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    html += `</div>`;
    
    // Add "Show All" button if there are more than 9 products
    if (allProducts.length > 9) {
      html += `
        <div class="mt-4 text-center">
          <button id="view-all-applications" class="px-4 py-2 bg-gray-100 text-gray-800 border border-gray-300 rounded hover:bg-gray-200 transition-colors text-sm">
            View All ${allProducts.length} Applications
          </button>
        </div>
      `;
    }
  } else {
    html += `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No drug application data found for "${drugName}"</p>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // Add Labeling Tab Content
  html += `
    <div id="label-content" class="fda-tab-pane hidden">
  `;
  
  const labelData = endpointsData.label?.data || [];
  if (labelData.length > 0) {
    html += `<div class="space-y-4">`;
    
    labelData.slice(0, 3).forEach(label => {
      const brandName = label.openfda?.brand_name?.[0] || 'Unknown Brand';
      const genericName = label.openfda?.generic_name?.[0] || 'Unknown Generic';
      const manufacturerName = label.openfda?.manufacturer_name?.[0] || 'Unknown Manufacturer';
      
      html += `
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
          <div class="p-4 border-b border-gray-200 bg-gray-50">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-medium text-gray-900">${brandName}</h3>
              <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                ${genericName}
              </span>
            </div>
            <p class="mt-1 text-sm text-gray-600">Manufacturer: ${manufacturerName}</p>
          </div>
          
          <div class="p-4">
            <div class="mb-4">
              <h4 class="text-sm font-medium text-gray-700 mb-1">Indications and Usage:</h4>
              <div class="text-sm text-gray-600 max-h-24 overflow-y-auto p-2 bg-gray-50 rounded">
                ${label.indications_and_usage?.[0] || 'Not provided'}
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 class="text-sm font-medium text-gray-700 mb-1">Dosage Forms and Strengths:</h4>
                <div class="text-sm text-gray-600 max-h-20 overflow-y-auto p-2 bg-gray-50 rounded">
                  ${label.dosage_forms_and_strengths?.[0] || 'Not provided'}
                </div>
              </div>
              
              <div>
                <h4 class="text-sm font-medium text-gray-700 mb-1">Route of Administration:</h4>
                <div class="text-sm text-gray-600 max-h-20 overflow-y-auto p-2 bg-gray-50 rounded">
                  ${label.openfda?.route?.[0] || 'Not provided'}
                </div>
              </div>
            </div>
            
            <button 
              class="mt-4 px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded text-sm hover:bg-blue-100 transition view-label-btn" 
              data-index="${labelData.indexOf(label)}">
              View Full Label Details
            </button>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
    
    // Add "Show All" button if there are more than 3 labels
    if (labelData.length > 3) {
      html += `
        <div class="mt-4 text-center">
          <button id="view-all-labels" class="px-4 py-2 bg-gray-100 text-gray-800 border border-gray-300 rounded hover:bg-gray-200 transition-colors text-sm">
            View All ${labelData.length} Labels
          </button>
        </div>
      `;
    }
  } else {
    html += `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No labeling information found for "${drugName}"</p>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // Add NDC Tab Content
  html += `
    <div id="ndc-content" class="fda-tab-pane hidden">
  `;
  
  const ndcData = endpointsData.ndc?.data || [];
  if (ndcData.length > 0) {
    html += `
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NDC</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Labeler</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
    `;
    
    ndcData.forEach(ndc => {
      html += `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div>
                <div class="text-sm font-medium text-gray-900">${ndc.brand_name || ndc.generic_name || 'Unknown'}</div>
                <div class="text-sm text-gray-500">${ndc.generic_name || ''}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ndc.product_ndc || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ndc.dosage_form || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ndc.route?.[0] || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ndc.labeler_name || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button class="text-blue-600 hover:text-blue-900 view-ndc-btn" data-index="${ndcData.indexOf(ndc)}">Details</button>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
  } else {
    html += `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No NDC information found for "${drugName}"</p>
      </div>
    `;
  }
  
  html += `</div>`;

  // Add Adverse Events Tab Content
  html += `
  <div id="events-content" class="fda-tab-pane hidden">
`;

const eventData = endpointsData.event?.data || [];
if (eventData.length > 0) {
  // Create a summary chart of adverse event types with fixed height
  html += `
    <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
      <div id="adverse-events-chart" style="height: 300px; min-height: 300px;"></div>
    </div>
  `;
  
  // Add a list of recent adverse events
  html += `
    <h3 class="text-lg font-medium text-gray-900 mb-2">Recent Reports</h3>
    <div class="space-y-3">
  `;
  
  eventData.slice(0, 5).forEach(event => {
    const reportDate = event.receiptdate || 'Unknown Date';
    const seriousness = event.serious ? 'Serious' : 'Non-serious';
    
    // Find the relevant drug in the report
    const drugReports = event.patient?.drug || [];
    const drugInfo = drugReports.find(drug => 
      drug.openfda?.brand_name?.[0]?.toLowerCase().includes(drugName.toLowerCase()) ||
      drug.openfda?.generic_name?.[0]?.toLowerCase().includes(drugName.toLowerCase()) ||
      (drug.medicinalproduct || '').toLowerCase().includes(drugName.toLowerCase())
    ) || drugReports[0] || {};
    
    // Get reactions
    const reactions = event.patient?.reaction || [];
    const reactionsList = reactions.map(r => r.reactionmeddrapt || 'Unknown reaction').join(', ');
    
    html += `
      <div class="bg-white border border-gray-200 rounded-md p-3 hover:shadow-sm transition">
        <div class="flex justify-between items-start">
          <div>
            <h4 class="text-sm font-medium text-gray-900">
              ${drugInfo.medicinalproduct || drugInfo.openfda?.brand_name?.[0] || 'Unknown Drug'}
            </h4>
            <p class="text-xs text-gray-500">Report Date: ${formatDate(reportDate)}</p>
          </div>
          <span class="px-2 py-0.5 text-xs rounded-full ${event.serious ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
            ${seriousness}
          </span>
        </div>
        
        <div class="mt-2">
          <h5 class="text-xs font-medium text-gray-700">Reported Reactions:</h5>
          <p class="text-xs text-gray-600 mt-1">${reactionsList || 'None reported'}</p>
        </div>
        
        <button 
          class="mt-2 text-xs text-blue-600 hover:text-blue-800 view-event-btn" 
          data-index="${eventData.indexOf(event)}">
          View Full Report
        </button>
      </div>
    `;
  });
  
  html += `</div>`;
  
  // Add "Show All" button if there are more than 5 events
  if (eventData.length > 5) {
    html += `
      <div class="mt-4 text-center">
        <button id="view-all-events" class="px-4 py-2 bg-gray-100 text-gray-800 border border-gray-300 rounded hover:bg-gray-200 transition-colors text-sm">
          View All ${eventData.length} Adverse Event Reports
        </button>
      </div>
    `;
  }
} else {
  html += `
    <div class="text-center p-4">
      <p class="text-sm text-gray-700">No adverse event information found for "${drugName}"</p>
    </div>
  `;
}

html += `</div>`;

  
  // Add Enforcement Tab Content
  html += `
    <div id="enforcement-content" class="fda-tab-pane hidden">
  `;
  
  const enforcementData = endpointsData.enforcement?.data || [];
  if (enforcementData.length > 0) {
    // Create a timeline of enforcement actions
    html += `
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900 mb-2">Enforcement Timeline</h3>
        <div class="relative">
          <div class="absolute h-full w-0.5 bg-gray-200 left-6 top-0"></div>
          <div class="space-y-6 relative">
    `;
    
    enforcementData.forEach(report => {
      const date = report.recall_initiation_date || 'Unknown Date';
      const reason = report.reason_for_recall || 'Not specified';
      const status = report.status || 'Unknown Status';
      const classification = report.classification || 'Unknown Classification';
      
      // Determine the severity badge color based on classification
      let classificationColor = 'bg-gray-100 text-gray-800';
      if (classification.includes('Class I')) {
        classificationColor = 'bg-red-100 text-red-800';
      } else if (classification.includes('Class II')) {
        classificationColor = 'bg-yellow-100 text-yellow-800';
      } else if (classification.includes('Class III')) {
        classificationColor = 'bg-green-100 text-green-800';
      }
      
      html += `
        <div class="pl-12 relative">
          <div class="absolute rounded-full w-6 h-6 flex items-center justify-center bg-blue-500 text-white left-3 top-0 -ml-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
          </div>
          
          <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
            <div class="flex justify-between items-start">
              <div>
                <span class="text-xs text-gray-500">${formatDate(date)}</span>
                <h4 class="text-sm font-medium text-gray-900 mt-0.5">${report.product_description || 'Unknown Product'}</h4>
              </div>
              <span class="px-2 py-0.5 text-xs rounded-full ${classificationColor}">
                ${classification}
              </span>
            </div>
            
            <div class="mt-2">
              <div class="text-xs">
                <span class="font-medium">Reason:</span> ${truncateText(reason, 100)}
              </div>
              <div class="text-xs mt-1">
                <span class="font-medium">Status:</span> ${status}
              </div>
              <div class="text-xs mt-1">
                <span class="font-medium">Recall Number:</span> ${report.recall_number || 'N/A'}
              </div>
            </div>
            
            <button 
              class="mt-2 text-xs text-blue-600 hover:text-blue-800 view-enforcement-btn" 
              data-index="${enforcementData.indexOf(report)}">
              View Details
            </button>
          </div>
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
      </div>
    `;
  } else {
    html += `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No enforcement actions found for "${drugName}"</p>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // Close main tab content div
  html += `</div>`;
  
  // Add the HTML to the page
  elements.fdaDocuments.innerHTML = html;
  
  // Initialize tab switching
  document.querySelectorAll('.fda-tab-button').forEach(button => {
    button.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Hide all tab panes
      document.querySelectorAll('.fda-tab-pane').forEach(pane => {
        pane.classList.add('hidden');
        pane.classList.remove('active');
      });
      
      // Deactivate all tab buttons
      document.querySelectorAll('.fda-tab-button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        btn.setAttribute('aria-selected', 'false');
      });
      
      // Activate the clicked tab
      document.getElementById(tabId).classList.remove('hidden');
      document.getElementById(tabId).classList.add('active');
      
      // Activate the clicked tab button
      this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
      this.classList.add('border-blue-500', 'text-blue-600');
      this.setAttribute('aria-selected', 'true');
      
// If it's the adverse events tab, initialize the chart with the updated function
    if (tabId === 'events-content' && document.getElementById('adverse-events-chart')) {
      // Use the fixed chart implementation
      initializeAdverseEventsChart(endpointsData.event?.data || []);
    }
  });
});
  
  // Add event listeners for "View Details" buttons
  document.querySelectorAll('.view-details-btn').forEach(button => {
    button.addEventListener('click', function() {
      const applicationNumber = this.getAttribute('data-application');
      const brandName = this.getAttribute('data-brand');
      const ingredient = this.getAttribute('data-ingredient');
      openDetailsModal(applicationNumber, brandName, ingredient);
    });
  });
  
  // Add event listeners for "View Label Details" buttons
  document.querySelectorAll('.view-label-btn').forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const labelData = endpointsData.label?.data || [];
      if (labelData[index]) {
        openLabelModal(labelData[index]);
      }
    });
  });
  
  // Add event listeners for NDC details buttons
// Add event listeners for NDC details buttons (continued)
document.querySelectorAll('.view-ndc-btn').forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const ndcData = endpointsData.ndc?.data || [];
      if (ndcData[index]) {
        openNdcModal(ndcData[index]);
      }
    });
  });
  
  // Add event listeners for adverse event details buttons
  document.querySelectorAll('.view-event-btn').forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const eventData = endpointsData.event?.data || [];
      if (eventData[index]) {
        openAdverseEventModal(eventData[index]);
      }
    });
  });
  
  // Add event listeners for enforcement details buttons
  document.querySelectorAll('.view-enforcement-btn').forEach(button => {
    button.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const enforcementData = endpointsData.enforcement?.data || [];
      if (enforcementData[index]) {
        openEnforcementModal(enforcementData[index]);
      }
    });
  });
  
  // Add event listeners for "View All" buttons
  document.getElementById('view-all-applications')?.addEventListener('click', function() {
    openAllApplicationsModal(fdaData.categorized, drugName);
  });
  
  document.getElementById('view-all-labels')?.addEventListener('click', function() {
    openAllLabelsModal(endpointsData.label?.data || []);
  });
  
  document.getElementById('view-all-events')?.addEventListener('click', function() {
    openAllEventsModal(endpointsData.event?.data || [], drugName);
  });
  
  // Initialize adverse events chart if data exists
  if (endpointsData.event?.data && endpointsData.event.data.length > 0 && document.getElementById('adverse-events-chart')) {
    // We'll initialize the chart when the tab is clicked
  }
}

// Function to initialize adverse events chart
// Function to initialize adverse events chart with proper heights
function initializeAdverseEventsChart(eventData) {
  if (!eventData || eventData.length === 0 || !document.getElementById('adverse-events-chart')) {
    return;
  }
  
  // Count the types of reactions
  const reactionCounts = {};
  
  eventData.forEach(event => {
    const reactions = event.patient?.reaction || [];
    
    reactions.forEach(reaction => {
      const reactionName = reaction.reactionmeddrapt || 'Unknown';
      if (!reactionCounts[reactionName]) {
        reactionCounts[reactionName] = 0;
      }
      reactionCounts[reactionName]++;
    });
  });
  
  // Sort and take top 10 reactions
  const sortedReactions = Object.entries(reactionCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  
  // Prepare chart data
  const labels = sortedReactions.map(([name]) => name);
  const counts = sortedReactions.map(([, count]) => count);
  
  // Calculate the maximum count for scaling
  const maxCount = Math.max(...counts);
  
  // Create a proper bar chart with specific heights
  let chartHtml = `
    <div class="flex flex-col h-full">
      <h4 class="text-sm font-medium text-gray-700 mb-4">Top 10 Reported Reactions</h4>
      <div class="flex-1 flex flex-col">
  `;
  
  // Create chart container with grid for bars
  chartHtml += `
    <div class="flex-1 relative">
      <!-- Y-axis labels -->
      <div class="absolute left-0 top-0 bottom-0 w-10 flex flex-col justify-between text-xs text-gray-500 pr-2">
        <div>${maxCount}</div>
        <div>${Math.round(maxCount * 0.75)}</div>
        <div>${Math.round(maxCount * 0.5)}</div>
        <div>${Math.round(maxCount * 0.25)}</div>
        <div>0</div>
      </div>
      
      <!-- Grid lines -->
      <div class="absolute left-10 right-0 top-0 bottom-0">
        <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 0%"></div>
        <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 25%"></div>
        <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 50%"></div>
        <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 75%"></div>
        <div class="absolute left-0 right-0 h-px bg-gray-200" style="top: 100%"></div>
      </div>
      
      <!-- Bars -->
      <div class="absolute left-12 right-2 top-0 bottom-8 flex items-end justify-around">
  `;
  
  // Add each bar
  for (let i = 0; i < labels.length; i++) {
    const percentage = (counts[i] / maxCount) * 100;
    
    chartHtml += `
      <div class="flex flex-col items-center group" style="height: 100%;">
        <div class="text-xs text-gray-600 mb-1 opacity-0 group-hover:opacity-100 transition-opacity">
          ${counts[i]}
        </div>
        <div class="w-12 bg-blue-500 rounded-t transition-all hover:bg-blue-600" 
             style="height: ${percentage}%; min-height: 4px;"></div>
      </div>
    `;
  }
  
  // Close bars container
  chartHtml += `
      </div>
      
      <!-- X-axis labels -->
      <div class="absolute left-12 right-2 bottom-0 h-8 flex justify-around">
  `;
  
  // Add X-axis labels
  for (let i = 0; i < labels.length; i++) {
    chartHtml += `
      <div class="text-xs text-gray-600 transform -rotate-45 origin-top-left overflow-hidden whitespace-nowrap w-12 truncate" 
           title="${labels[i]}">
        ${truncateText(labels[i], 15)}
      </div>
    `;
  }
  
  // Close X-axis container and rest of the chart
  chartHtml += `
      </div>
    </div>
  </div>
</div>
  `;
  
  document.getElementById('adverse-events-chart').innerHTML = chartHtml;
}

// Alternative implementation using HTML Canvas for more precise control
function initializeAdverseEventsCanvasChart(eventData) {
  if (!eventData || eventData.length === 0) {
    return;
  }
  
  const chartContainer = document.getElementById('adverse-events-chart');
  if (!chartContainer) return;
  
  // Clear previous content
  chartContainer.innerHTML = '';
  
  // Create canvas element
  const canvas = document.createElement('canvas');
  canvas.id = 'adverse-events-canvas';
  canvas.style.width = '100%';
  canvas.style.height = '100%';
  chartContainer.appendChild(canvas);
  
  // Add title above the chart
  const titleDiv = document.createElement('div');
  titleDiv.className = 'text-sm font-medium text-gray-700 mb-2';
  titleDiv.textContent = 'Top 10 Reported Reactions';
  chartContainer.insertBefore(titleDiv, canvas);
  
  // Count reactions
  const reactionCounts = {};
  eventData.forEach(event => {
    const reactions = event.patient?.reaction || [];
    reactions.forEach(reaction => {
      const name = reaction.reactionmeddrapt || 'Unknown';
      reactionCounts[name] = (reactionCounts[name] || 0) + 1;
    });
  });
  
  // Sort and get top 10
  const sortedReactions = Object.entries(reactionCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  
  // Prepare data for chart
  const labels = sortedReactions.map(([name]) => name);
  const data = sortedReactions.map(([, count]) => count);
  
  // Check if Chart.js is available - if not, load it
  if (typeof Chart === 'undefined') {
    // If Chart.js isn't available, create a simple visual instead
    createSimpleBarChart(chartContainer, labels, data);
    return;
  }
  
  // Create Chart.js chart
  new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Reported Reactions',
        data: data,
        backgroundColor: 'rgba(59, 130, 246, 0.8)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Count'
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            title: function(tooltipItems) {
              return tooltipItems[0].label;
            }
          }
        },
        legend: {
          display: false
        }
      }
    }
  });
}


function createSimpleBarChart(outcome, canvas, interpretationContainer) {
    const groups = outcome.groups || [];
    const colors = ['#3B82F6', '#10B981', '#F05252', '#8B5CF6', '#F59E0B', '#EC4899'];
    
    if (!groups.length) return;
    
    // Get values for each group
    const groupData = [];
    
    // Try to find values from any structure
    if (outcome.classes && outcome.classes.length > 0) {
        for (const cls of outcome.classes) {
            if (cls.categories && cls.categories.length > 0) {
                for (const cat of cls.categories) {
                    if (cat.measurements && cat.measurements.length > 0) {
                        for (const measurement of cat.measurements) {
                            const value = parseFloat(measurement.value);
                            if (!isNaN(value)) {
                                const group = groups.find(g => g.id === measurement.groupId);
                                if (group) {
                                    groupData.push({
                                        group: group.title,
                                        value: value
                                    });
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    // Check if we have data to display
    if (groupData.length === 0) {
        // Handle empty data case
        interpretationContainer.innerHTML = `
            <p class="font-semibold">No outcome data available</p>
            <p class="text-xs text-gray-500">${outcome.title || 'Outcome measure'}</p>
        `;
        return;
    }
    
    // Set up chart configuration
    const config = {
        type: 'bar',
        data: {
            labels: groupData.map(d => d.group),
            datasets: [{
                label: outcome.title,
                data: groupData.map(d => d.value),
                backgroundColor: groupData.map((_, i) => colors[i % colors.length]),
                borderColor: groupData.map((_, i) => colors[i % colors.length]),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: sanitizeTitle(outcome.title),
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                subtitle: {
                    display: true,
                    text: `Time Frame: ${outcome.timeFrame || 'Not specified'}`,
                    font: {
                        size: 12,
                        style: 'italic'
                    }
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: outcome.unitOfMeasure || 'Value',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    };
    
    // Add interpretation
    const message = `<p class="font-semibold">Outcome Summary:</p>
                    <p>${outcome.title}</p>
                    <p class="text-xs text-gray-500 mt-1">${outcome.description || ''}</p>
                    <ul class="mt-2">
                        ${groupData.map(d => `<li>${d.group}: ${d.value} ${outcome.unitOfMeasure || ''}</li>`).join('')}
                    </ul>`;
    
    interpretationContainer.innerHTML = message;
    
    // Create the chart
    const chart = new Chart(canvas, config);
    canvas._chart = chart;
}


// Fallback simple bar chart if Chart.js is not available
// function createSimpleBarChart(container, labels, data) {
//   const maxValue = Math.max(...data);
  
//   // Add chart container
//   const chartDiv = document.createElement('div');
//   chartDiv.className = 'flex h-64 items-end space-x-2 pt-5 mt-2';
  
//   // Create bars
//   labels.forEach((label, i) => {
//     const height = (data[i] / maxValue) * 100;
    
//     const barContainer = document.createElement('div');
//     barContainer.className = 'flex flex-col items-center flex-1';
    
//     const valueLabel = document.createElement('div');
//     valueLabel.className = 'text-xs text-gray-600 mb-1';
//     valueLabel.textContent = data[i];
    
//     const bar = document.createElement('div');
//     bar.className = 'w-full bg-blue-500 rounded-t hover:bg-blue-600 transition';
//     bar.style.height = `${height}%`;
//     bar.style.minHeight = '4px';
    
//     const nameLabel = document.createElement('div');
//     nameLabel.className = 'text-xs text-gray-600 mt-1 truncate w-full text-center';
//     nameLabel.textContent = truncateText(label, 10);
//     nameLabel.title = label;
    
//     barContainer.appendChild(valueLabel);
//     barContainer.appendChild(bar);
//     barContainer.appendChild(nameLabel);
//     chartDiv.appendChild(barContainer);
//   });
  
//   container.appendChild(chartDiv);
// }

// Helper function to truncate text
function truncateText(text, maxLength) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}
// Modal Functions
function openDetailsModal(applicationNumber, brandName, ingredient) {
  // Create a modal to show detailed application information
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">${brandName} Details</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-lg font-semibold">${brandName}</h3>
            <p class="text-gray-600">Application: ${applicationNumber}</p>
          </div>
          <div class="flex space-x-2">
            <a href="https://www.accessdata.fda.gov/scripts/cder/daf/index.cfm?event=overview.process&ApplNo=${applicationNumber.replace(/[^0-9]/g, '')}" 
              target="_blank" 
              class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition">
              FDA Database
            </a>
            <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(ingredient)}" 
              target="_blank" 
              class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition">
              DailyMed
            </a>
          </div>
        </div>
        
        <div class="mb-6">
          <div class="bg-gray-50 p-4 rounded-lg flex flex-col space-y-3">
            <div class="text-center">
              <p class="text-sm text-gray-600">Loading application details...</p>
              <div class="mt-2 inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-gray-800"></div>
            </div>
          </div>
        </div>
        
        <div class="flex justify-end">
          <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  showModal(modalContent, async () => {
    // Load application details
    try {
      const response = await fetch(`/api/fda/application/${applicationNumber}`);
      const data = await response.json();
      
      // Update the modal with the fetched data
      // This would be implemented based on your API response structure
    } catch (error) {
      console.error("Error fetching application details:", error);
    }
  });
}

function openLabelModal(labelData) {
  // Construct the modal content
  const brandName = labelData.openfda?.brand_name?.[0] || 'Unknown Brand';
  const genericName = labelData.openfda?.generic_name?.[0] || 'Unknown Generic';
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">${brandName} - Drug Label</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 class="text-lg font-semibold">${brandName}</h3>
            <p class="text-gray-600">${genericName}</p>
            <p class="text-sm text-gray-500">Manufacturer: ${labelData.openfda?.manufacturer_name?.[0] || 'Unknown'}</p>
          </div>
          
          <div>
            <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
              ${labelData.effective_time ? formatDate(labelData.effective_time) : 'Unknown Date'}
            </span>
          </div>
        </div>
        
        <div class="space-y-6">
          <!-- Indications and Usage -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-md font-medium text-gray-800 mb-2">Indications and Usage</h4>
            <div class="text-sm text-gray-600">
              ${labelData.indications_and_usage?.[0] || 'Not provided'}
            </div>
          </div>
          
          <!-- Dosage and Administration -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-md font-medium text-gray-800 mb-2">Dosage and Administration</h4>
            <div class="text-sm text-gray-600">
              ${labelData.dosage_and_administration?.[0] || 'Not provided'}
            </div>
          </div>
          
          <!-- Warnings -->
          ${labelData.boxed_warning ? `
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
              <h4 class="text-md font-medium text-red-800 mb-2">Boxed Warning</h4>
              <div class="text-sm text-red-700">
                ${labelData.boxed_warning[0] || 'Not provided'}
              </div>
            </div>
          ` : ''}
          
          <div class="bg-yellow-50 p-4 rounded-lg">
            <h4 class="text-md font-medium text-yellow-800 mb-2">Warnings and Precautions</h4>
            <div class="text-sm text-yellow-700">
              ${labelData.warnings?.[0] || labelData.warnings_and_precautions?.[0] || 'Not provided'}
            </div>
          </div>
          
          <!-- Adverse Reactions -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-md font-medium text-gray-800 mb-2">Adverse Reactions</h4>
            <div class="text-sm text-gray-600">
              ${labelData.adverse_reactions?.[0] || 'Not provided'}
            </div>
          </div>
          
          <!-- More sections can be added as needed -->
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition mr-2">
          Close
        </button>
        ${labelData.openfda?.spl_id ? `
          <a href="https://dailymed.nlm.nih.gov/dailymed/lookup.cfm?setid=${labelData.openfda.spl_id[0]}" 
            target="_blank" 
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            View on DailyMed
          </a>
        ` : ''}
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

function openNdcModal(ndcData) {
  const productName = ndcData.brand_name || ndcData.generic_name || 'Unknown Product';
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">NDC Product Details</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-lg font-semibold">${productName}</h3>
            <p class="text-gray-600">NDC: ${ndcData.product_ndc || 'Unknown'}</p>
          </div>
          <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
            ${ndcData.product_type || 'Unknown Type'}
          </span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Product Details</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p class="text-sm"><span class="font-medium">Generic Name:</span> ${ndcData.generic_name || 'N/A'}</p>
              <p class="text-sm"><span class="font-medium">Dosage Form:</span> ${ndcData.dosage_form || 'N/A'}</p>
              <p class="text-sm"><span class="font-medium">Route:</span> ${ndcData.route?.join(', ') || 'N/A'}</p>
              <p class="text-sm"><span class="font-medium">Labeler:</span> ${ndcData.labeler_name || 'N/A'}</p>
            </div>
          </div>
          
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Packaging</h4>
            <div class="bg-gray-50 p-3 rounded max-h-40 overflow-y-auto">
              ${ndcData.packaging ? ndcData.packaging.map(pkg => `
                <div class="mb-2 pb-2 border-b border-gray-200 last:border-b-0 last:mb-0 last:pb-0">
                  <p class="text-sm"><span class="font-medium">Package NDC:</span> ${pkg.package_ndc || 'N/A'}</p>
                  <p class="text-sm"><span class="font-medium">Description:</span> ${pkg.description || 'N/A'}</p>
                </div>
              `).join('') : '<p class="text-sm text-gray-500">No packaging information available</p>'}
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h4 class="text-sm font-medium text-gray-700 mb-1">Active Ingredients</h4>
          <div class="bg-gray-50 p-3 rounded">
            ${ndcData.active_ingredients ? ndcData.active_ingredients.map(ing => `
              <div class="mb-2 last:mb-0">
                <p class="text-sm"><span class="font-medium">Name:</span> ${ing.name || 'N/A'}</p>
                <p class="text-sm"><span class="font-medium">Strength:</span> ${ing.strength || 'N/A'}</p>
              </div>
            `).join('') : '<p class="text-sm text-gray-500">No active ingredient information available</p>'}
          </div>
        </div>
        
        <div class="flex justify-end">
          <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition mr-2">
            Close
          </button>
          <a href="https://www.accessdata.fda.gov/scripts/cder/ndc/dsp_searchresult.cfm" 
            target="_blank" 
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            FDA NDC Directory
          </a>
        </div>
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

function openAdverseEventModal(eventData) {
  // Find the drug info
  const drugReports = eventData.patient?.drug || [];
  const drugInfo = drugReports[0] || {};
  const drugName = drugInfo.medicinalproduct || drugInfo.openfda?.brand_name?.[0] || 'Unknown Drug';
  
  // Get reactions
  const reactions = eventData.patient?.reaction || [];
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">Adverse Event Report</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 class="text-lg font-semibold">${drugName}</h3>
            <p class="text-sm text-gray-500">
              Report Date: ${formatDate(eventData.receiptdate)}
              <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${eventData.serious ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                ${eventData.serious ? 'Serious' : 'Non-serious'}
              </span>
            </p>
          </div>
          <div>
            <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
              Report #${eventData.safetyreportid || 'Unknown'}
            </span>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <h4 class="text-md font-medium text-gray-800 mb-2">Reactions</h4>
            <div class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto">
              ${reactions.length > 0 ? `
                <ul class="list-disc pl-5 space-y-2">
                  ${reactions.map(reaction => `
                    <li class="text-sm">
                      <span class="font-medium">${reaction.reactionmeddrapt || 'Unknown reaction'}</span>
                      ${reaction.reactionoutcome ? `<span class="text-xs text-gray-500 ml-1">(Outcome: ${reaction.reactionoutcome})</span>` : ''}
                    </li>
                  `).join('')}
                </ul>
              ` : '<p class="text-sm text-gray-500">No reactions reported</p>'}
            </div>
          </div>
          
          <div>
            <h4 class="text-md font-medium text-gray-800 mb-2">Patient Information</h4>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm mb-2"><span class="font-medium">Age:</span> ${eventData.patient?.patientonsetage ? `${eventData.patient.patientonsetage} ${eventData.patient.patientonsetageunit || 'years'}` : 'Not reported'}</p>
              <p class="text-sm mb-2"><span class="font-medium">Sex:</span> ${eventData.patient?.patientsex === 1 ? 'Male' : eventData.patient?.patientsex === 2 ? 'Female' : 'Not reported'}</p>
              <p class="text-sm mb-2"><span class="font-medium">Weight:</span> ${eventData.patient?.patientweight ? `${eventData.patient.patientweight} kg` : 'Not reported'}</p>
              <p class="text-sm"><span class="font-medium">Country:</span> ${eventData.primarysource?.reportercountry || 'Not reported'}</p>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h4 class="text-md font-medium text-gray-800 mb-2">Drug Information</h4>
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                  <tr>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Drug</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Dosage</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Route</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Indication</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${drugReports.map(drug => `
                    <tr>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.medicinalproduct || drug.openfda?.brand_name?.[0] || 'Unknown'}</td>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.drugcharacterization === 1 ? 'Suspect' : drug.drugcharacterization === 2 ? 'Concomitant' : 'Unknown'}</td>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.drugdosagetext || 'Not reported'}</td>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.drugadministrationroute || 'Not reported'}</td>
                      <td class="px-3 py-2 text-sm text-gray-500">${drug.drugindication || 'Not reported'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="flex justify-end">
          <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

function openEnforcementModal(reportData) {
  const productDescription = reportData.product_description || 'Unknown Product';
  const reason = reportData.reason_for_recall || 'Not specified';
  
  // Determine the severity badge color based on classification
  let classificationColor = 'bg-gray-100 text-gray-800';
  const classification = reportData.classification || 'Unknown Classification';
  
  if (classification.includes('Class I')) {
    classificationColor = 'bg-red-100 text-red-800';
  } else if (classification.includes('Class II')) {
    classificationColor = 'bg-yellow-100 text-yellow-800';
  } else if (classification.includes('Class III')) {
    classificationColor = 'bg-green-100 text-green-800';
  }
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">Enforcement Report</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6">
        <div class="mb-4">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold">${productDescription}</h3>
              <p class="text-sm text-gray-600">Recall #${reportData.recall_number || 'Unknown'}</p>
            </div>
            <div>
              <span class="px-3 py-1 text-sm rounded-full ${classificationColor}">
                ${classification}
              </span>
            </div>
          </div>
          <p class="mt-2 text-sm text-gray-500">Report Date: ${formatDate(reportData.recall_initiation_date)}</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Recall Details</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p class="text-sm mb-2"><span class="font-medium">Status:</span> ${reportData.status || 'Unknown'}</p>
              <p class="text-sm mb-2"><span class="font-medium">Distribution:</span> ${reportData.distribution_pattern || 'Unknown'}</p>
              <p class="text-sm mb-2"><span class="font-medium">Quantity:</span> ${reportData.product_quantity || 'Unknown'}</p>
              <p class="text-sm"><span class="font-medium">Recalling Firm:</span> ${reportData.recalling_firm || 'Unknown'}</p>
            </div>
          </div>
          
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-1">Product Information</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p class="text-sm mb-2"><span class="font-medium">Code Info:</span> ${reportData.code_info || 'None provided'}</p>
              <p class="text-sm"><span class="font-medium">Product Type:</span> ${reportData.product_type || 'Unknown'}</p>
            </div>
          </div>
        </div>
        
        <div class="mb-6">
          <h4 class="text-sm font-medium text-gray-700 mb-1">Reason for Recall</h4>
          <div class="bg-gray-50 p-3 rounded">
            <p class="text-sm">${reason}</p>
          </div>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <span class="text-xs text-gray-500">
              Event ID: ${reportData.event_id || 'Unknown'}
            </span>
          </div>
          <div>
            <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition mr-2">
              Close
            </button>
            <a href="https://www.fda.gov/safety/recalls-market-withdrawals-safety-alerts" 
              target="_blank" 
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
              FDA Recalls
            </a>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

// "View All" modal functions
// "View All" modal functions
function openAllApplicationsModal(categorizedData, drugName) {
  // Collect all products into a flat array
  let allProducts = [];
  Object.entries(categorizedData).forEach(([brandName, strengths]) => {
    Object.entries(strengths).forEach(([strength, products]) => {
      products.forEach(product => {
        allProducts.push({
          ...product,
          strength
        });
      });
    });
  });
  
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">All Drug Applications for ${drugName}</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="mb-4">
          <input type="text" id="application-search" placeholder="Search applications..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="applications-table">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brand Name</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manufacturer</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${allProducts.map(product => `
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.brandName}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.applicationNumber}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.strength}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.manufacturerName || product.sponsorName}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.approvalDate}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.dosageForm}</td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${product.marketingStatus === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                      ${product.marketingStatus || 'Unknown'}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
          Close
        </button>
      </div>
    </div>
  `;
  
  showModal(modalContent, () => {
    // Add search functionality
    const searchInput = document.getElementById('application-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#applications-table tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  });
}

function openAllLabelsModal(labelData) {
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">All Drug Labels</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="mb-4">
          <input type="text" id="label-search" placeholder="Search labels..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="grid grid-cols-1 gap-6" id="labels-container">
          ${labelData.map((label, index) => {
            const brandName = label.openfda?.brand_name?.[0] || 'Unknown Brand';
            const genericName = label.openfda?.generic_name?.[0] || 'Unknown Generic';
            const manufacturerName = label.openfda?.manufacturer_name?.[0] || 'Unknown Manufacturer';
            
            return `
              <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden label-card">
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                  <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">${brandName}</h3>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                      ${genericName}
                    </span>
                  </div>
                  <p class="mt-1 text-sm text-gray-600">Manufacturer: ${manufacturerName}</p>
                </div>
                
                <div class="p-4">
                  <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-1">Indications and Usage:</h4>
                    <div class="text-sm text-gray-600 max-h-20 overflow-y-auto p-2 bg-gray-50 rounded truncate">
                      ${label.indications_and_usage?.[0] || 'Not provided'}
                    </div>
                  </div>
                  
                  <button 
                    class="mt-2 px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded text-sm hover:bg-blue-100 transition view-label-btn" 
                    data-index="${index}">
                    View Full Label Details
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
          Close
        </button>
      </div>
    </div>
  `;
  
  showModal(modalContent, () => {
    // Add search functionality
    const searchInput = document.getElementById('label-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const cards = document.querySelectorAll('#labels-container .label-card');
      
      cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
    
    // Add event listeners to view label details buttons
    document.querySelectorAll('.view-label-btn').forEach(button => {
      button.addEventListener('click', function() {
        const index = parseInt(this.getAttribute('data-index'));
        if (labelData[index]) {
          // Close the current modal
          closeCurrentModal();
          // Open the label detail modal
          setTimeout(() => {
            openLabelModal(labelData[index]);
          }, 300);
        }
      });
    });
  });
}

function openAllEventsModal(eventData, drugName) {
  const modalContent = `
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full">
      <div class="flex justify-between items-center p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">All Adverse Events for ${drugName}</h2>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="mb-4">
          <input type="text" id="event-search" placeholder="Search events..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="events-table">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reactions</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${eventData.map((event, index) => {
                const reportDate = event.receiptdate || 'Unknown Date';
                const isSerious = event.serious ? true : false;
                
                // Find the relevant drug in the report
                const drugReports = event.patient?.drug || [];
                const drugInfo = drugReports.find(drug => 
                  drug.openfda?.brand_name?.[0]?.toLowerCase().includes(drugName.toLowerCase()) ||
                  drug.openfda?.generic_name?.[0]?.toLowerCase().includes(drugName.toLowerCase()) ||
                  (drug.medicinalproduct || '').toLowerCase().includes(drugName.toLowerCase())
                ) || drugReports[0] || {};
                
                // Get reactions
                const reactions = event.patient?.reaction || [];
                const reactionsList = reactions.map(r => r.reactionmeddrapt || 'Unknown').slice(0, 3).join(', ');
                
                // Patient info
                const patientAge = event.patient?.patientonsetage ? 
                  `${event.patient.patientonsetage} ${event.patient.patientonsetageunit || 'years'}` : 'Unknown';
                const patientSex = event.patient?.patientsex === 1 ? 'Male' : 
                  event.patient?.patientsex === 2 ? 'Female' : 'Unknown';
                
                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(reportDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      ${drugInfo.medicinalproduct || drugInfo.openfda?.brand_name?.[0] || 'Unknown'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${isSerious ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                        ${isSerious ? 'Serious' : 'Non-serious'}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                      <div class="max-w-xs truncate" title="${reactions.map(r => r.reactionmeddrapt || 'Unknown').join(', ')}">
                        ${reactionsList}${reactions.length > 3 ? '...' : ''}
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      ${patientAge}, ${patientSex}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <button class="text-blue-600 hover:text-blue-900 view-event-btn" data-index="${index}">Details</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-200 flex justify-end">
        <button class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
          Close
        </button>
      </div>
    </div>
  `;
  
  showModal(modalContent, () => {
    // Add search functionality
    const searchInput = document.getElementById('event-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#events-table tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
    
    // Add event listeners to view event details buttons
    document.querySelectorAll('.view-event-btn').forEach(button => {
      button.addEventListener('click', function() {
        const index = parseInt(this.getAttribute('data-index'));
        if (eventData[index]) {
          // Close the current modal
          closeCurrentModal();
          // Open the event detail modal
          setTimeout(() => {
            openAdverseEventModal(eventData[index]);
          }, 300);
        }
      });
    });
  });
}

// Helper functions
function formatDate(dateString) {
  if (!dateString) return 'Unknown Date';
  
  // Check if the date is in a valid format
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return dateString;
  
  // Format the date
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

function truncateText(text, maxLength) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

// Modal handling
let currentModal = null;

function showModal(content, callback) {
  // Create modal backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  backdrop.id = 'modal-backdrop';
  
  // Insert the content
  backdrop.innerHTML = content;
  
  // Add to the document
  document.body.appendChild(backdrop);
  
  // Save reference to current modal
  currentModal = backdrop;
  
  // Add event listeners to close buttons
  document.querySelectorAll('.close-modal').forEach(button => {
    button.addEventListener('click', closeCurrentModal);
  });
  
  // Close on backdrop click
  backdrop.addEventListener('click', function(event) {
    if (event.target === backdrop) {
      closeCurrentModal();
    }
  });
  
  // Prevent scrolling of the body
  document.body.style.overflow = 'hidden';
  
  // Execute callback if provided
  if (typeof callback === 'function') {
    callback();
  }
}

function closeCurrentModal() {
  if (currentModal) {
    document.body.removeChild(currentModal);
    currentModal = null;
    document.body.style.overflow = '';
  }
}

// Add helper CSS for modals
document.addEventListener('DOMContentLoaded', function() {
  const style = document.createElement('style');
  style.textContent = `
    .modal-backdrop {
      z-index: 50;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    #modal-backdrop {
      animation: fadeIn 0.3s ease-out;
    }
    
    #modal-backdrop > div {
      animation: slideIn 0.3s ease-out;
    }
  `;
  document.head.appendChild(style);
});

// function displayOrangeBookData(data) {
//     console.log(data)
//   // Count total entries
//   const totalProducts = data.total.products || 0;
  
//   // Update counter
//   elements.orangeBookCount.textContent = `${totalProducts} entries`;
  
//   if (totalProducts === 0) {
//     elements.orangeBookData.innerHTML = `
//       <div class="text-center p-4 rounded bg-gray-50">
//         <p class="text-sm text-gray-700">No Orange Book entries found</p>
//       </div>
//     `;
//     return;
//   }
  
//   // Create HTML for the products
//   let html = `
//     <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
//       <div class="flex justify-end p-2 bg-gray-50">
//         <button id="expandAllBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
//           Expand All
//         </button>
//       </div>
//       <div class="divide-y divide-gray-200">
//   `;
  
//   // Add product cards (limit to 20 for performance)
//   const productsToShow = Math.min(data.results.products.length, 20);
  
//   for (let i = 0; i < productsToShow; i++) {
//     const product = data.results.products[i];
//     const hasPatents = product.related_patents && product.related_patents.length > 0;
//     const hasExclusivity = product.related_exclusivity && product.related_exclusivity.length > 0;
    
//     html += `
//       <div class="product-card bg-white overflow-hidden" data-product-id="${product.Appl_No}-${product.Product_No}">
//         <!-- Product Header -->
//         <div class="flex justify-between items-center p-4 cursor-pointer product-header" 
//              onclick="toggleProductDetails('${product.Appl_No}-${product.Product_No}')">
//           <div>
//             <h3 class="text-lg font-medium text-gray-900">${product.Trade_Name || 'Unnamed Product'}</h3>
//             <div class="text-sm text-gray-500">
//               ${product.Ingredient || 'N/A'} | ${product.Strength || 'N/A'} | ${product.DF_Route || product["DF;Route"] || 'N/A'}
//             </div>
//           </div>
//           <div class="flex items-center">
//             <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">
//               ${product.Appl_Type || ''}-${product.Appl_No || ''}
//             </span>
//             <svg class="toggle-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
//             </svg>
//           </div>
//         </div>
        
//         <!-- Product Details (hidden by default) -->
//         <div class="product-details hidden p-4 border-t border-gray-200 bg-gray-50" id="details-${product.Appl_No}-${product.Product_No}">
//           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
//             <!-- Product Information -->
//             <div class="bg-white p-3 rounded shadow-sm">
//               <h4 class="font-medium text-gray-700 mb-2">Product Information</h4>
//               <table class="w-full text-sm">
//                 <tbody>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Applicant</td>
//                     <td class="py-1">${product.Applicant_Full_Name || product.Applicant || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Approval Date</td>
//                     <td class="py-1">${product.Approval_Date || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Type</td>
//                     <td class="py-1">${product.Type || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">RLD/RS</td>
//                     <td class="py-1">
//                       ${product.RLD === 'Yes' ? '<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">RLD</span>' : ''}
//                       ${product.RS === 'Yes' ? '<span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded text-xs ml-1">RS</span>' : ''}
//                     </td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">TE Code</td>
//                     <td class="py-1">${product.TE_Code || 'N/A'}</td>
//                   </tr>
//                 </tbody>
//               </table>
//             </div>
            
//             <!-- Links & Resources -->
//             <div class="bg-white p-3 rounded shadow-sm">
//               <h4 class="font-medium text-gray-700 mb-2">Links & Resources</h4>
//               <div class="space-y-2">
//                 <a href="https://www.accessdata.fda.gov/scripts/cder/ob/results_product.cfm?Appl_Type=${product.Appl_Type}&Appl_No=${product.Appl_No}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   View on FDA Orange Book
//                 </a>
//                 <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(product.Ingredient)}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   Search on DailyMed
//                 </a>
//                 <a href="https://www.drugs.com/search.php?searchterm=${encodeURIComponent(product.Trade_Name || product.Ingredient)}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   Search on Drugs.com
//                 </a>
//               </div>
//             </div>
//           </div>
          
//           <!-- Related Patents Section -->
//           ${hasPatents ? `
//             <div class="mt-4">
//               <h4 class="font-medium text-gray-700 mb-2">Patents (${product.related_patents.length})</h4>
//               <div class="overflow-x-auto bg-white rounded shadow-sm">
//                 <table class="min-w-full divide-y divide-gray-200">
//                   <thead class="bg-gray-50">
//                     <tr>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Patent No</th>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Expiration</th>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Drug Sub/Prod</th>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Use Code</th>
//                     </tr>
//                   </thead>
//                   <tbody class="divide-y divide-gray-200">
//                     ${product.related_patents.map(patent => `
//                       <tr class="hover:bg-gray-50">
//                         <td class="px-3 py-2 text-sm">
//                           <a href="https://patents.google.com/patent/US${patent.Patent_No}" 
//                              target="_blank" 
//                              class="text-blue-600 hover:underline">${patent.Patent_No}</a>
//                         </td>
//                         <td class="px-3 py-2 text-sm">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
//                         <td class="px-3 py-2 text-sm">
//                           ${patent.Drug_Substance_Flag === 'Y' ? '<span class="bg-blue-100 text-blue-800 px-1 rounded text-xs">DS</span>' : ''}
//                           ${patent.Drug_Product_Flag === 'Y' ? '<span class="bg-green-100 text-green-800 px-1 rounded text-xs ml-1">DP</span>' : ''}
//                         </td>
//                         <td class="px-3 py-2 text-sm">${patent.Patent_Use_Code || 'N/A'}</td>
//                       </tr>
//                     `).join('')}
//                   </tbody>
//                 </table>
//               </div>
//             </div>
//           ` : ''}
          
//           <!-- Related Exclusivity Section -->
//           ${hasExclusivity ? `
//             <div class="mt-4">
//               <h4 class="font-medium text-gray-700 mb-2">Exclusivity (${product.related_exclusivity.length})</h4>
//               <div class="overflow-x-auto bg-white rounded shadow-sm">
//                 <table class="min-w-full divide-y divide-gray-200">
//                   <thead class="bg-gray-50">
//                     <tr>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
//                       <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
//                     </tr>
//                   </thead>
//                   <tbody class="divide-y divide-gray-200">
//                     ${product.related_exclusivity.map(exclusivity => `
//                       <tr class="hover:bg-gray-50">
//                         <td class="px-3 py-2 text-sm font-medium">
//                           <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">
//                             ${exclusivity.Exclusivity_Code || 'N/A'}
//                           </span>
//                         </td>
//                         <td class="px-3 py-2 text-sm">${exclusivity.Exclusivity_Date || 'N/A'}</td>
//                       </tr>
//                     `).join('')}
//                   </tbody>
//                 </table>
//               </div>
//             </div>
//           ` : ''}
//         </div>
//       </div>
//     `;
//   }
  
//   html += `
//       </div>
//     </div>
//   `;
  
//   // If there are more results than shown, add a note
//   if (data.results.products.length > 20) {
//     html += `
//       <div class="text-xs text-gray-500 mt-2 text-right">
//         Showing 20 of ${data.results.products.length} entries
//       </div>
//     `;
//   }
  
//   elements.orangeBookData.innerHTML = html;
  
//   // Add event listener for the Expand All button
//   document.getElementById('expandAllBtn').addEventListener('click', function() {
//     const allDetails = document.querySelectorAll('.product-details');
//     const isAnyHidden = Array.from(allDetails).some(el => el.classList.contains('hidden'));
    
//     if (isAnyHidden) {
//       // Expand all
//       allDetails.forEach(el => el.classList.remove('hidden'));
//       this.textContent = 'Collapse All';
      
//       // Rotate all toggle icons
//       document.querySelectorAll('.toggle-icon').forEach(icon => {
//         icon.style.transform = 'rotate(180deg)';
//       });
//     } else {
//       // Collapse all
//       allDetails.forEach(el => el.classList.add('hidden'));
//       this.textContent = 'Expand All';
      
//       // Reset all toggle icons
//       document.querySelectorAll('.toggle-icon').forEach(icon => {
//         icon.style.transform = 'rotate(0deg)';
//       });
//     }
//   });
// }

// // Function to toggle product details
// function toggleProductDetails(productId) {
//   const detailsElement = document.getElementById(`details-${productId}`);
//   const headerElement = detailsElement.previousElementSibling;
//   const iconElement = headerElement.querySelector('.toggle-icon');
  
//   if (detailsElement.classList.contains('hidden')) {
//     detailsElement.classList.remove('hidden');
//     iconElement.style.transform = 'rotate(180deg)';
//   } else {
//     detailsElement.classList.add('hidden');
//     iconElement.style.transform = 'rotate(0deg)';
//   }
// }

// // Add this function to your code to handle searching
// function searchOrangeBook(query) {
//   if (!query.trim()) {
//     elements.orangeBookData.innerHTML = `
//       <div class="text-center p-4">
//         <p class="text-sm text-gray-700">Please enter a search term</p>
//       </div>
//     `;
//     elements.orangeBookCount.textContent = '0 entries';
//     return;
//   }
  
//   // Show loading state
//   elements.orangeBookData.innerHTML = `
//     <div class="text-center p-4">
//       <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800"></div>
//       <p class="mt-2 text-sm text-gray-700">Searching...</p>
//     </div>
//   `;
  
//   // Make the API request
//   fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(query)}`)
//     .then(response => {
//       if (!response.ok) throw new Error('Network response was not ok');
//       return response.json();
//     })
//     .then(data => {
//       displayOrangeBookData(data);
//     })
//     .catch(error => {
//       console.error('Error fetching Orange Book data:', error);
//       elements.orangeBookData.innerHTML = `
//         <div class="text-center p-4">
//           <p class="text-sm text-red-600">Error: ${error.message}</p>
//         </div>
//       `;
//       elements.orangeBookCount.textContent = '0 entries';
//     });
// }

















// Function to display DailyMed data

// function displayOrangeBookData(data) {
//   // Count total entries across all categories
//   const totalProducts = data.total.products || 0;
//   const totalPatents = data.total.patents || 0;
//   const totalExclusivity = data.total.exclusivity || 0;
  
//   // Update counter to show all categories
//   elements.orangeBookCount.textContent = `${totalProducts} Products | ${totalPatents} Patents | ${totalExclusivity} Exclusivity Records`;
  
//   if (totalProducts === 0 && totalPatents === 0 && totalExclusivity === 0) {
//     elements.orangeBookData.innerHTML = `
//       <div class="text-center p-4 rounded bg-gray-50">
//         <p class="text-sm text-gray-700">No Orange Book entries found</p>
//       </div>
//     `;
//     return;
//   }
  
//   // Create tab navigation 
//   let html = `
//     <div class="mb-4 border-b border-gray-200">
//         <style>
//             /* Orange Book Specific Styles */

// /* Tab Navigation */
// .tab-button {
//   transition: all 0.2s ease-in-out;
// }

// .tab-button:focus {
//   outline: none;
//   box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
// }

// .tab-pane {
//   display: none;
// }

// .tab-pane.active {
//   display: block;
//   animation: fadeIn 0.3s ease-in-out;
// }

// /* Product Card Styles */
// .product-card {
//   transition: box-shadow 0.2s ease-in-out;
// }

// .product-card:hover {
//   box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
// }

// .product-header {
//   transition: background-color 0.2s ease-in-out;
// }

// .product-header:hover {
//   background-color: #f9fafb;
// }

// .product-details {
//   transition: max-height 0.3s ease-out, opacity 0.2s ease-in-out;
// }

// /* Toggle Icon Animation */
// .toggle-icon {
//   transition: transform 0.3s ease;
// }

// /* Related Tabs Within Product */
// .related-tab {
//   transition: all 0.2s ease-in-out;
// }

// .related-tab:focus {
//   outline: none;
// }

// .related-pane {
//   display: none;
// }

// .related-pane.active {
//   display: block;
//   animation: fadeIn 0.3s ease-in-out;
// }

// /* Badge styling */
// .badge {
//   display: inline-block;
//   padding: 0.125rem 0.5rem;
//   border-radius: 9999px;
//   font-size: 0.75rem;
//   font-weight: 500;
//   text-align: center;
// }

// .badge-blue {
//   background-color: #e0f2fe;
//   color: #0369a1;
// }

// .badge-green {
//   background-color: #dcfce7;
//   color: #166534;
// }

// .badge-purple {
//   background-color: #f3e8ff;
//   color: #7e22ce;
// }

// .badge-yellow {
//   background-color: #fef9c3;
//   color: #854d0e;
// }

// .badge-red {
//   background-color: #fee2e2;
//   color: #b91c1c;
// }

// /* Animation for loading spinners */
// @keyframes spin {
//   from {
//     transform: rotate(0deg);
//   }
//   to {
//     transform: rotate(360deg);
//   }
// }

// .animate-spin {
//   animation: spin 1s linear infinite;
// }

// /* Fade in animation */
// @keyframes fadeIn {
//   from {
//     opacity: 0;
//   }
//   to {
//     opacity: 1;
//   }
// }

// /* Table hover effects */
// tr.hover\:bg-gray-50:hover {
//   background-color: #f9fafb;
// }

// /* Link styles */
// a.text-blue-600 {
//   text-decoration: none;
// }

// a.text-blue-600:hover {
//   text-decoration: underline;
// }

// /* Custom scrollbar for tables */
// .overflow-x-auto::-webkit-scrollbar {
//   height: 8px;
// }

// .overflow-x-auto::-webkit-scrollbar-track {
//   background: #f1f1f1;
//   border-radius: 4px;
// }

// .overflow-x-auto::-webkit-scrollbar-thumb {
//   background: #d1d5db;
//   border-radius: 4px;
// }

// .overflow-x-auto::-webkit-scrollbar-thumb:hover {
//   background: #9ca3af;
// }

// /* Modal styles */
// .modal-container {
//   animation: fadeIn 0.2s ease-in-out;
// }

// .modal-content {
//   max-height: 80vh;
//   overflow-y: auto;
// }

// /* Print styles */
// @media print {
//   .no-print {
//     display: none !important;
//   }
  
//   .overflow-x-auto {
//     overflow: visible !important;
//   }
  
//   .tab-content {
//     display: block !important;
//   }
  
//   .tab-pane {
//     display: block !important;
//     page-break-after: always;
//   }
  
//   .product-details {
//     display: block !important;
//   }
// }
//   </style>
//       <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
//         <li class="mr-2" role="presentation">
//           <button class="tab-button inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
//                   id="products-tab" 
//                   data-tab="products-content"
//                   aria-selected="true">
//             Products (${totalProducts})
//           </button>
//         </li>
//         <li class="mr-2" role="presentation">
//           <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                   id="patents-tab" 
//                   data-tab="patents-content"
//                   aria-selected="false">
//             Patents (${totalPatents})
//           </button>
//         </li>
//         <li role="presentation">
//           <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                   id="exclusivity-tab" 
//                   data-tab="exclusivity-content"
//                   aria-selected="false">
//             Exclusivity (${totalExclusivity})
//           </button>
//         </li>
//       </ul>
//     </div>
    
//     <div class="tab-content">
//       <!-- Products Tab Content -->
//       <div id="products-content" class="tab-pane active">
//         <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
//           <div class="flex justify-between p-2 bg-gray-50">
//             <div class="flex items-center">
//               <span class="text-xs text-gray-500">Toggle view:</span>
//               <button id="cardsViewBtn" class="ml-2 text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
//                 Cards
//               </button>
//               <button id="tableViewBtn" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">
//                 Table
//               </button>
//             </div>
//             <button id="expandAllBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
//               Expand All
//             </button>
//           </div>
          
//           <!-- Card View (default) -->
//           <div id="cards-view" class="divide-y divide-gray-200">



            
//   `;
  
//   // Add product cards (limit to 20 for performance)
//   const productsToShow = Math.min(data.results.products.length, 20);
  
//   for (let i = 0; i < productsToShow; i++) {
//     const product = data.results.products[i];
//     const hasPatents = product.related_patents && product.related_patents.length > 0;
//     const hasExclusivity = product.related_exclusivity && product.related_exclusivity.length > 0;
    
//     html += `
//       <div class="product-card bg-white overflow-hidden" data-product-id="${product.Appl_No}-${product.Product_No}">
//         <!-- Product Header -->
//         <div class="flex justify-between items-center p-4 cursor-pointer product-header" 
//              onclick="toggleProductDetails('${product.Appl_No}-${product.Product_No}')">
//           <div>
//             <h3 class="text-lg font-medium text-gray-900">${product.Trade_Name || 'Unnamed Product'}</h3>
//             <div class="text-sm text-gray-500">
//               ${product.Ingredient || 'N/A'} | ${product.Strength || 'N/A'} | ${product.DF_Route || product["DF;Route"] || 'N/A'}
//             </div>
//           </div>
//           <div class="flex items-center">
//             <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">
//               ${product.Appl_Type || ''}-${product.Appl_No || ''}
//             </span>
//             <svg class="toggle-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
//               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
//             </svg>
//           </div>
//         </div>
        
//         <!-- Product Details (hidden by default) -->
//         <div class="product-details hidden p-4 border-t border-gray-200 bg-gray-50" id="details-${product.Appl_No}-${product.Product_No}">
//           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
//             <!-- Product Information -->
//             <div class="bg-white p-3 rounded shadow-sm">
//               <h4 class="font-medium text-gray-700 mb-2">Product Information</h4>
//               <table class="w-full text-sm">
//                 <tbody>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Applicant</td>
//                     <td class="py-1">${product.Applicant_Full_Name || product.Applicant || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Approval Date</td>
//                     <td class="py-1">${product.Approval_Date || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">Type</td>
//                     <td class="py-1">${product.Type || 'N/A'}</td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">RLD/RS</td>
//                     <td class="py-1">
//                       ${product.RLD === 'Yes' ? '<span class="badge badge-green">RLD</span>' : ''}
//                       ${product.RS === 'Yes' ? '<span class="badge badge-purple ml-1">RS</span>' : ''}
//                     </td>
//                   </tr>
//                   <tr>
//                     <td class="py-1 pr-2 text-gray-500">TE Code</td>
//                     <td class="py-1">${product.TE_Code || 'N/A'}</td>
//                   </tr>
//                 </tbody>
//               </table>
//             </div>
            
//             <!-- Links & Resources -->
//             <div class="bg-white p-3 rounded shadow-sm">
//               <h4 class="font-medium text-gray-700 mb-2">Links & Resources</h4>
//               <div class="space-y-2">
//                 <a href="https://www.accessdata.fda.gov/scripts/cder/ob/results_product.cfm?Appl_Type=${product.Appl_Type}&Appl_No=${product.Appl_No}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   View on FDA Orange Book
//                 </a>
//                 <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(product.Ingredient)}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   Search on DailyMed
//                 </a>
//                 <a href="https://www.drugs.com/search.php?searchterm=${encodeURIComponent(product.Trade_Name || product.Ingredient)}" 
//                    target="_blank" 
//                    class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
//                   Search on Drugs.com
//                 </a>
//               </div>
//             </div>
//           </div>
          
//           <!-- Related Data Tabs -->
//           <div class="mt-4">
//             <div class="border-b border-gray-200">
//               <ul class="flex flex-wrap -mb-px text-xs font-medium text-center">
//                 <li class="mr-2">
//                   <button class="related-tab inline-block p-2 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
//                           onclick="switchRelatedTab(this, 'related-info-${product.Appl_No}-${product.Product_No}')">
//                     Product Info
//                   </button>
//                 </li>
//                 <li class="mr-2">
//                   <button class="related-tab inline-block p-2 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                           onclick="switchRelatedTab(this, 'related-patents-${product.Appl_No}-${product.Product_No}')">
//                     Patents ${hasPatents ? `(${product.related_patents.length})` : '(0)'}
//                   </button>
//                 </li>
//                 <li>
//                   <button class="related-tab inline-block p-2 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
//                           onclick="switchRelatedTab(this, 'related-exclusivity-${product.Appl_No}-${product.Product_No}')">
//                     Exclusivity ${hasExclusivity ? `(${product.related_exclusivity.length})` : '(0)'}
//                   </button>
//                 </li>
//               </ul>
//             </div>
            
//             <!-- Related Content -->
//             <div class="related-content">
//               <!-- Product Info Tab (active by default, we keep it empty as it's already shown above) -->
//               <div id="related-info-${product.Appl_No}-${product.Product_No}" class="related-pane active mt-3">
//                 <!-- Already shown above, keep this empty or add additional info -->
//               </div>
              
//               <!-- Patents Tab -->
//               <div id="related-patents-${product.Appl_No}-${product.Product_No}" class="related-pane hidden mt-3">
//                 ${hasPatents ? `
//                   <div class="overflow-x-auto bg-white rounded shadow-sm">
//                     <table class="min-w-full divide-y divide-gray-200">
//                       <thead class="bg-gray-50">
//                         <tr>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Patent No</th>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Expiration</th>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Drug Sub/Prod</th>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Use Code</th>
//                         </tr>
//                       </thead>
//                       <tbody class="divide-y divide-gray-200">
//                         ${product.related_patents.map(patent => `
//                           <tr class="hover:bg-gray-50">
//                             <td class="px-3 py-2 text-sm">
//                               <a href="https://patents.google.com/patent/US${patent.Patent_No}" 
//                                  target="_blank" 
//                                  class="text-blue-600 hover:underline">${patent.Patent_No}</a>
//                             </td>
//                             <td class="px-3 py-2 text-sm">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
//                             <td class="px-3 py-2 text-sm">
//                               ${patent.Drug_Substance_Flag === 'Y' ? '<span class="badge badge-blue">DS</span>' : ''}
//                               ${patent.Drug_Product_Flag === 'Y' ? '<span class="badge badge-green ml-1">DP</span>' : ''}
//                             </td>
//                             <td class="px-3 py-2 text-sm">${patent.Patent_Use_Code || 'N/A'}</td>
//                           </tr>
//                         `).join('')}
//                       </tbody>
//                     </table>
//                   </div>
//                 ` : '<p class="text-sm text-gray-500">No patents found for this product.</p>'}
//               </div>
              
//               <!-- Exclusivity Tab -->
//               <div id="related-exclusivity-${product.Appl_No}-${product.Product_No}" class="related-pane hidden mt-3">
//                 ${hasExclusivity ? `
//                   <div class="overflow-x-auto bg-white rounded shadow-sm">
//                     <table class="min-w-full divide-y divide-gray-200">
//                       <thead class="bg-gray-50">
//                         <tr>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
//                           <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
//                         </tr>
//                       </thead>
//                       <tbody class="divide-y divide-gray-200">
//                         ${product.related_exclusivity.map(exclusivity => `
//                           <tr class="hover:bg-gray-50">
//                             <td class="px-3 py-2 text-sm font-medium">
//                               <span class="badge badge-yellow">
//                                 ${exclusivity.Exclusivity_Code || 'N/A'}
//                               </span>
//                             </td>
//                             <td class="px-3 py-2 text-sm">${exclusivity.Exclusivity_Date || 'N/A'}</td>
//                           </tr>
//                         `).join('')}
//                       </tbody>
//                     </table>
//                   </div>
//                 ` : '<p class="text-sm text-gray-500">No exclusivity records found for this product.</p>'}
//               </div>
//             </div>
//           </div>
//         </div>
//       </div>
//     `;
//   }
  
//   html += `
//           </div>
          
//           <!-- Table View (hidden by default) -->
//           <div id="table-view" class="hidden">
//             <table class="min-w-full divide-y divide-gray-200">
//               <thead class="bg-gray-50">
//                 <tr>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade Name</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingredient</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval Date</th>
//                   <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relations</th>
//                 </tr>
//               </thead>
//               <tbody class="bg-white divide-y divide-gray-200">
//                 ${data.results.products.slice(0, 20).map(product => `
//                   <tr class="hover:bg-gray-50">
//                     <td class="px-6 py-4 text-sm font-medium text-gray-900">${product.Trade_Name || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${product.Ingredient || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${product.Strength || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${product.Appl_Type || ''}-${product.Appl_No || ''}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${product.Approval_Date || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">
//                       ${product.related_patents && product.related_patents.length ? 
//                         `<span class="badge badge-blue mr-1">Patents: ${product.related_patents.length}</span>` : ''}
//                       ${product.related_exclusivity && product.related_exclusivity.length ? 
//                         `<span class="badge badge-yellow">Exclusivity: ${product.related_exclusivity.length}</span>` : ''}
//                     </td>
//                   </tr>
//                 `).join('')}
//               </tbody>
//             </table>
//           </div>
//         </div>
//       </div>
      
//       <!-- Patents Tab Content -->
//       <div id="patents-content" class="tab-pane hidden">
//         <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
//           <table class="min-w-full divide-y divide-gray-200">
//             <thead class="bg-gray-50">
//               <tr>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patent No</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiration</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug Sub/Prod</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Use Code</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Related Product</th>
//               </tr>
//             </thead>
//             <tbody class="bg-white divide-y divide-gray-200">
//               ${data.results.patents.slice(0, 20).map(patent => {
//                 // Find related product information if available
//                 const relatedProduct = data.results.products.find(p => 
//                   p.Appl_Type === patent.Appl_Type && 
//                   p.Appl_No === patent.Appl_No && 
//                   p.Product_No === patent.Product_No
//                 );
                
//                 return `
//                   <tr class="hover:bg-gray-50">
//                     <td class="px-6 py-4 text-sm font-medium text-blue-600 hover:underline">
//                       <a href="https://patents.google.com/patent/US${patent.Patent_No}" target="_blank">${patent.Patent_No}</a>
//                     </td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${patent.Appl_Type || ''}-${patent.Appl_No || ''}-${patent.Product_No || ''}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">
//                       ${patent.Drug_Substance_Flag === 'Y' ? '<span class="badge badge-blue">DS</span>' : ''}
//                       ${patent.Drug_Product_Flag === 'Y' ? '<span class="badge badge-green ml-1">DP</span>' : ''}
//                     </td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${patent.Patent_Use_Code || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">
//                       ${relatedProduct ? 
//                         `<span class="font-medium">${relatedProduct.Trade_Name || 'Unnamed Product'}</span><br>
//                          <span class="text-xs">${relatedProduct.Ingredient || 'N/A'}</span>` : 
//                         'No related product found'}
//                     </td>
//                   </tr>
//                 `;
//               }).join('')}
//             </tbody>
//           </table>
//         </div>
//         ${data.results.patents.length > 20 ? `
//           <div class="text-xs text-gray-500 mt-2 text-right">
//             Showing 20 of ${data.results.patents.length} entries
//           </div>
//         ` : ''}
//       </div>
      
//       <!-- Exclusivity Tab Content -->
//       <div id="exclusivity-content" class="tab-pane hidden">
//         <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
//           <table class="min-w-full divide-y divide-gray-200">
//             <thead class="bg-gray-50">
//               <tr>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
//                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Related Product</th>
//               </tr>
//             </thead>
//             <tbody class="bg-white divide-y divide-gray-200">
//               ${data.results.exclusivity.slice(0, 20).map(exclusivity => {
//                 // Find related product information if available
//                 const relatedProduct = data.results.products.find(p => 
//                   p.Appl_Type === exclusivity.Appl_Type && 
//                   p.Appl_No === exclusivity.Appl_No && 
//                   p.Product_No === exclusivity.Product_No
//                 );
                
//                 return `
//                   <tr class="hover:bg-gray-50">
//                     <td class="px-6 py-4 text-sm font-medium">
//                       <span class="badge badge-yellow">${exclusivity.Exclusivity_Code || 'N/A'}</span>
//                     </td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${exclusivity.Appl_Type || ''}-${exclusivity.Appl_No || ''}-${exclusivity.Product_No || ''}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">${exclusivity.Exclusivity_Date || 'N/A'}</td>
//                     <td class="px-6 py-4 text-sm text-gray-500">
//                       ${relatedProduct ? 
//                         `<span class="font-medium">${relatedProduct.Trade_Name || 'Unnamed Product'}</span><br>
//                          <span class="text-xs">${relatedProduct.Ingredient || 'N/A'}</span>` : 
//                         'No related product found'}
//                     </td>
//                   </tr>
//                 `;
//               }).join('')}
//             </tbody>
//           </table>
//         </div>
//         ${data.results.exclusivity.length > 20 ? `
//           <div class="text-xs text-gray-500 mt-2 text-right">
//             Showing 20 of ${data.results.exclusivity.length} entries
//           </div>
//         ` : ''}
//       </div>
//     </div>
//   `;
  
//   elements.orangeBookData.innerHTML = html;
  
//   // Add event listeners to tabs
//   document.querySelectorAll('.tab-button').forEach(button => {
//     button.addEventListener('click', function() {
//       const tabId = this.getAttribute('data-tab');
      
//       // Hide all tab panes
//       document.querySelectorAll('.tab-pane').forEach(pane => {
//         pane.classList.add('hidden');
//         pane.classList.remove('active');
//       });
      
//       // Deactivate all tab buttons
//       document.querySelectorAll('.tab-button').forEach(btn => {
//         btn.classList.remove('border-blue-500', 'text-blue-600');
//         btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
//         btn.setAttribute('aria-selected', 'false');
//       });
      
//       // Activate the clicked tab
//       document.getElementById(tabId).classList.remove('hidden');
//       document.getElementById(tabId).classList.add('active');
      
//       // Activate the clicked tab button
//       this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
//       this.classList.add('border-blue-500', 'text-blue-600');
//       this.setAttribute('aria-selected', 'true');
//     });
//   });
  
//   // Add event listeners for view toggling in Products tab
//   document.getElementById('cardsViewBtn')?.addEventListener('click', function() {
//     document.getElementById('cards-view').classList.remove('hidden');
//     document.getElementById('table-view').classList.add('hidden');
//     this.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
//     this.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
//     document.getElementById('tableViewBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
//     document.getElementById('tableViewBtn').classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
//   });
  
//   document.getElementById('tableViewBtn')?.addEventListener('click', function() {
//     document.getElementById('table-view').classList.remove('hidden');
//     document.getElementById('cards-view').classList.add('hidden');
//     this.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
//     this.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
//     document.getElementById('cardsViewBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
//     document.getElementById('cardsViewBtn').classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
//   });
  
//   // Add event listener for expand all button
//   document.getElementById('expandAllBtn')?.addEventListener('click', function() {
//     const allDetails = document.querySelectorAll('.product-details');
//     const isAnyHidden = Array.from(allDetails).some(el => el.classList.contains('hidden'));
    
//     if (isAnyHidden) {
//       // Expand all
//       allDetails.forEach(el => el.classList.remove('hidden'));
//       this.textContent = 'Collapse All';
      
//       // Rotate all toggle icons
//       document.querySelectorAll('.toggle-icon').forEach(icon => {
//         icon.style.transform = 'rotate(180deg)';
//       });
//     } else {
//       // Collapse all
//       allDetails.forEach(el => el.classList.add('hidden'));
//       this.textContent = 'Expand All';
      
//       // Reset all toggle icons
//       document.querySelectorAll('.toggle-icon').forEach(icon => {
//         icon.style.transform = 'rotate(0deg)';
//       });
//     }
//   });
// }


function displayOrangeBookData(data) {
  // Count total entries across all categories
  const totalProducts = data.total.products || 0;
  const totalPatents = data.total.patents || 0;
  const totalExclusivity = data.total.exclusivity || 0;
  
  // Group products by trade name
  const groups = groupProductsByName(data.results.products);
  
  // Set initial grouping state
  let groupedView = true;
  
  // Update counter to show all categories
  elements.orangeBookCount.textContent = `${totalProducts} Products | ${totalPatents} Patents | ${totalExclusivity} Exclusivity Records`;
  
  if (totalProducts === 0 && totalPatents === 0 && totalExclusivity === 0) {
    elements.orangeBookData.innerHTML = `
      <div class="text-center p-4 rounded bg-gray-50">
        <p class="text-sm text-gray-700">No Orange Book entries found</p>
      </div>
    `;
    return;
  }
  
  // Create tab navigation 
  let html = `
    <div class="mb-4 border-b border-gray-200">
        <style>
            /* Orange Book Specific Styles */

/* Tab Navigation */
.tab-button {
  transition: all 0.2s ease-in-out;
}

.tab-button:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.tab-pane {
  display: none;
}

.tab-pane.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

/* Group Styles */
.group-parent-row {
  transition: background-color 0.2s ease-in-out;
}

.group-parent-row:hover {
  background-color: #f0f4f8;
}

.group-child-row {
  transition: background-color 0.2s ease-in-out;
  background-color: #fefefe;
}

.group-child-row:hover {
  background-color: #f9fafb;
}

.group-toggle {
  transition: transform 0.3s ease;
}

.highlight-card {
  animation: highlightPulse 2s ease-in-out;
}

@keyframes highlightPulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
  }
  50% {
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
  }
}

/* Product Card Styles */
.product-card {
  transition: box-shadow 0.2s ease-in-out;
}

.product-card:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.product-header {
  transition: background-color 0.2s ease-in-out;
}

.product-header:hover {
  background-color: #f9fafb;
}

.product-details {
  transition: max-height 0.3s ease-out, opacity 0.2s ease-in-out;
}

/* Toggle Icon Animation */
.toggle-icon {
  transition: transform 0.3s ease;
}

/* Related Tabs Within Product */
.related-tab {
  transition: all 0.2s ease-in-out;
}

.related-tab:focus {
  outline: none;
}

.related-pane {
  display: none;
}

.related-pane.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
}

/* Badge styling */
.badge {
  display: inline-block;
  padding: 0.125rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  text-align: center;
}

.badge-blue {
  background-color: #e0f2fe;
  color: #0369a1;
}

.badge-green {
  background-color: #dcfce7;
  color: #166534;
}

.badge-purple {
  background-color: #f3e8ff;
  color: #7e22ce;
}

.badge-yellow {
  background-color: #fef9c3;
  color: #854d0e;
}

.badge-red {
  background-color: #fee2e2;
  color: #b91c1c;
}

/* Animation for loading spinners */
@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Fade in animation */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Table hover effects */
tr.hover\:bg-gray-50:hover {
  background-color: #f9fafb;
}

/* Link styles */
a.text-blue-600 {
  text-decoration: none;
}

a.text-blue-600:hover {
  text-decoration: underline;
}

/* Custom scrollbar for tables */
.overflow-x-auto::-webkit-scrollbar {
  height: 8px;
}

.overflow-x-auto::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.overflow-x-auto::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 4px;
}

.overflow-x-auto::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

/* Modal styles */
.modal-container {
  animation: fadeIn 0.2s ease-in-out;
}

.modal-content {
  max-height: 80vh;
  overflow-y: auto;
}

/* Print styles */
@media print {
  .no-print {
    display: none !important;
  }
  
  .overflow-x-auto {
    overflow: visible !important;
  }
  
  .tab-content {
    display: block !important;
  }
  
  .tab-pane {
    display: block !important;
    page-break-after: always;
  }
  
  .product-details {
    display: block !important;
  }
}
  </style>
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" role="tablist">
        <li class="mr-2" role="presentation">
          <button class="tab-button inline-block p-4 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
                  id="products-tab" 
                  data-tab="products-content"
                  aria-selected="true">
            Products (${totalProducts})
          </button>
        </li>
        <li class="mr-2" role="presentation">
          <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="patents-tab" 
                  data-tab="patents-content"
                  aria-selected="false">
            Patents (${totalPatents})
          </button>
        </li>
        <li role="presentation">
          <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                  id="exclusivity-tab" 
                  data-tab="exclusivity-content"
                  aria-selected="false">
            Exclusivity (${totalExclusivity})
          </button>
        </li>
      </ul>
    </div>
    
    <div class="tab-content">
      <!-- Products Tab Content -->
      <div id="products-content" class="tab-pane active">
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <div class="flex justify-between p-2 bg-gray-50">
            <div class="flex items-center">
              <span class="text-xs text-gray-500">Toggle view:</span>
              <button id="cardsViewBtn" class="ml-2 text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                Cards
              </button>
              <button id="tableViewBtn" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">
                Table
              </button>
            </div>
            <button id="expandAllBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
              Expand All
            </button>
          </div>
          
          <!-- Card View (default) -->
          <div id="cards-view" class="divide-y divide-gray-200">
  `;
  
  // Add product cards (limit to 20 for performance)
  const productsToShow = Math.min(data.results.products.length, 20);
  
  for (let i = 0; i < productsToShow; i++) {
    const product = data.results.products[i];
    const hasPatents = product.related_patents && product.related_patents.length > 0;
    const hasExclusivity = product.related_exclusivity && product.related_exclusivity.length > 0;
    
    html += `
      <div class="product-card bg-white overflow-hidden" data-product-id="${product.Appl_No}-${product.Product_No}">
        <!-- Product Header -->
        <div class="flex justify-between items-center p-4 cursor-pointer product-header" 
             onclick="toggleProductDetails('${product.Appl_No}-${product.Product_No}')">
          <div>
            <h3 class="text-lg font-medium text-gray-900">${product.Trade_Name || 'Unnamed Product'}</h3>
            <div class="text-sm text-gray-500">
              ${product.Ingredient || 'N/A'} | ${product.Strength || 'N/A'} | ${product.DF_Route || product["DF;Route"] || 'N/A'}
            </div>
          </div>
          <div class="flex items-center">
            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">
              ${product.Appl_Type || ''}-${product.Appl_No || ''}
            </span>
            <svg class="toggle-icon w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>
        
        <!-- Product Details (hidden by default) -->
        <div class="product-details hidden p-4 border-t border-gray-200 bg-gray-50" id="details-${product.Appl_No}-${product.Product_No}">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Product Information -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h4 class="font-medium text-gray-700 mb-2">Product Information</h4>
              <table class="w-full text-sm">
                <tbody>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">Applicant</td>
                    <td class="py-1">${product.Applicant_Full_Name || product.Applicant || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">Approval Date</td>
                    <td class="py-1">${product.Approval_Date || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">Type</td>
                    <td class="py-1">${product.Type || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">RLD/RS</td>
                    <td class="py-1">
                      ${product.RLD === 'Yes' ? '<span class="badge badge-green">RLD</span>' : ''}
                      ${product.RS === 'Yes' ? '<span class="badge badge-purple ml-1">RS</span>' : ''}
                    </td>
                  </tr>
                  <tr>
                    <td class="py-1 pr-2 text-gray-500">TE Code</td>
                    <td class="py-1">${product.TE_Code || 'N/A'}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Links & Resources -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h4 class="font-medium text-gray-700 mb-2">Links & Resources</h4>
              <div class="space-y-2">
                <a href="https://www.accessdata.fda.gov/scripts/cder/ob/results_product.cfm?Appl_Type=${product.Appl_Type}&Appl_No=${product.Appl_No}" 
                   target="_blank" 
                   class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
                  View on FDA Orange Book
                </a>
                <a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${encodeURIComponent(product.Ingredient)}" 
                   target="_blank" 
                   class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
                  Search on DailyMed
                </a>
                <a href="https://www.drugs.com/search.php?searchterm=${encodeURIComponent(product.Trade_Name || product.Ingredient)}" 
                   target="_blank" 
                   class="block w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded text-sm transition">
                  Search on Drugs.com
                </a>
              </div>
            </div>
          </div>
          
          <!-- Related Data Tabs -->
          <div class="mt-4">
            <div class="border-b border-gray-200">
              <ul class="flex flex-wrap -mb-px text-xs font-medium text-center">
                <li class="mr-2">
                  <button class="related-tab inline-block p-2 border-b-2 border-blue-500 rounded-t-lg active text-blue-600" 
                          onclick="switchRelatedTab(this, 'related-info-${product.Appl_No}-${product.Product_No}')">
                    Product Info
                  </button>
                </li>
                <li class="mr-2">
                  <button class="related-tab inline-block p-2 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                          onclick="switchRelatedTab(this, 'related-patents-${product.Appl_No}-${product.Product_No}')">
                    Patents ${hasPatents ? `(${product.related_patents.length})` : '(0)'}
                  </button>
                </li>
                <li>
                  <button class="related-tab inline-block p-2 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" 
                          onclick="switchRelatedTab(this, 'related-exclusivity-${product.Appl_No}-${product.Product_No}')">
                    Exclusivity ${hasExclusivity ? `(${product.related_exclusivity.length})` : '(0)'}
                  </button>
                </li>
              </ul>
            </div>
            
            <!-- Related Content -->
            <div class="related-content">
              <!-- Product Info Tab (active by default, we keep it empty as it's already shown above) -->
              <div id="related-info-${product.Appl_No}-${product.Product_No}" class="related-pane active mt-3">
                <!-- Already shown above, keep this empty or add additional info -->
              </div>
              
              <!-- Patents Tab -->
              <div id="related-patents-${product.Appl_No}-${product.Product_No}" class="related-pane hidden mt-3">
                ${hasPatents ? `
                  <div class="overflow-x-auto bg-white rounded shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Patent No</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Expiration</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Drug Sub/Prod</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Use Code</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        ${product.related_patents.map(patent => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm">
                              <a href="https://patents.google.com/patent/US${patent.Patent_No}" 
                                 target="_blank" 
                                 class="text-blue-600 hover:underline">${patent.Patent_No}</a>
                            </td>
                            <td class="px-3 py-2 text-sm">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
                            <td class="px-3 py-2 text-sm">
                              ${patent.Drug_Substance_Flag === 'Y' ? '<span class="badge badge-blue">DS</span>' : ''}
                              ${patent.Drug_Product_Flag === 'Y' ? '<span class="badge badge-green ml-1">DP</span>' : ''}
                            </td>
                            <td class="px-3 py-2 text-sm">${patent.Patent_Use_Code || 'N/A'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                ` : '<p class="text-sm text-gray-500">No patents found for this product.</p>'}
              </div>
              
              <!-- Exclusivity Tab -->
              <div id="related-exclusivity-${product.Appl_No}-${product.Product_No}" class="related-pane hidden mt-3">
                ${hasExclusivity ? `
                  <div class="overflow-x-auto bg-white rounded shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        ${product.related_exclusivity.map(exclusivity => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 text-sm font-medium">
                              <span class="badge badge-yellow">
                                ${exclusivity.Exclusivity_Code || 'N/A'}
                              </span>
                            </td>
                            <td class="px-3 py-2 text-sm">${exclusivity.Exclusivity_Date || 'N/A'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                ` : '<p class="text-sm text-gray-500">No exclusivity records found for this product.</p>'}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  html += `
          </div>
          
          <!-- Table View (hidden by default) -->
          <div id="table-view" class="hidden">
            <div class="mb-2 flex justify-between">
              <div>
                <button id="expandAllGroupsBtn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded mr-2">
                  Expand All Groups
                </button>
                <button id="collapseAllGroupsBtn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">
                  Collapse All Groups
                </button>
              </div>
              <div>
                <button id="toggleGroupingBtn" class="text-xs bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded">
                  ${groupedView ? 'Disable Grouping' : 'Enable Grouping'}
                </button>
              </div>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  ${groupedView ? `
                    <th colspan="6" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Grouped by Trade Name (${groups.length} unique products)
                    </th>
                  ` : `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingredient</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relations</th>
                  `}
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="productsTableBody">
                ${groupedView ? 
                  createGroupedTableRows(groups) : 
                  data.results.products.slice(0, 50).map(product => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 text-sm font-medium text-gray-900">${product.Trade_Name || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.Ingredient || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.Strength || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.DF_Route || product["DF;Route"] || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.Appl_Type || ''}-${product.Appl_No || ''}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${product.Approval_Date || 'N/A'}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">
                        <div class="flex space-x-1">
                          ${product.related_patents && product.related_patents.length ? 
                            `<span class="badge badge-blue">Patents: ${product.related_patents.length}</span>` : ''}
                          ${product.related_exclusivity && product.related_exclusivity.length ? 
                            `<span class="badge badge-yellow">Exclusivity: ${product.related_exclusivity.length}</span>` : ''}
                        </div>
                        <button class="mt-1 text-xs text-blue-600 hover:underline" 
                                onclick="showProductDetails('${product.Appl_Type}', '${product.Appl_No}', '${product.Product_No}')">
                          View details
                        </button>
                      </td>
                    </tr>
                  `).join('')
                }
              </tbody>
            </table>
            ${data.results.products.length > 50 ? `
              <div class="text-xs text-gray-500 mt-2 text-right">
                Showing ${groupedView ? groups.length : '50'} of ${groupedView ? groups.length : data.results.products.length} entries
              </div>
            ` : ''}
          </div>
        </div>
      </div>
      
      <!-- Patents Tab Content -->
      <div id="patents-content" class="tab-pane hidden">
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patent No</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiration</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug Sub/Prod</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Use Code</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Related Product</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${data.results.patents.slice(0, 20).map(patent => {
                // Find related product information if available
                const relatedProduct = data.results.products.find(p => 
                  p.Appl_Type === patent.Appl_Type && 
                  p.Appl_No === patent.Appl_No && 
                  p.Product_No === patent.Product_No
                );
                
                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-blue-600 hover:underline">
                      <a href="https://patents.google.com/patent/US${patent.Patent_No}" target="_blank">${patent.Patent_No}</a>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${patent.Appl_Type || ''}-${patent.Appl_No || ''}-${patent.Product_No || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${patent.Patent_Expire_Date_Text || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                      ${patent.Drug_Substance_Flag === 'Y' ? '<span class="badge badge-blue">DS</span>' : ''}
                      ${patent.Drug_Product_Flag === 'Y' ? '<span class="badge badge-green ml-1">DP</span>' : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${patent.Patent_Use_Code || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                      ${relatedProduct ? 
                        `<span class="font-medium">${relatedProduct.Trade_Name || 'Unnamed Product'}</span><br>
                         <span class="text-xs">${relatedProduct.Ingredient || 'N/A'}</span>` : 
                        'No related product found'}
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
        ${data.results.patents.length > 20 ? `
          <div class="text-xs text-gray-500 mt-2 text-right">
            Showing 20 of ${data.results.patents.length} entries
          </div>
        ` : ''}
      </div>
      
      <!-- Exclusivity Tab Content -->
      <div id="exclusivity-content" class="tab-pane hidden">
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Related Product</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${data.results.exclusivity.slice(0, 20).map(exclusivity => {
                // Find related product information if available
                const relatedProduct = data.results.products.find(p => 
                  p.Appl_Type === exclusivity.Appl_Type && 
                  p.Appl_No === exclusivity.Appl_No && 
                  p.Product_No === exclusivity.Product_No
                );
                
                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium">
                      <span class="badge badge-yellow">${exclusivity.Exclusivity_Code || 'N/A'}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${exclusivity.Appl_Type || ''}-${exclusivity.Appl_No || ''}-${exclusivity.Product_No || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${exclusivity.Exclusivity_Date || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                      ${relatedProduct ? 
                        `<span class="font-medium">${relatedProduct.Trade_Name || 'Unnamed Product'}</span><br>
                         <span class="text-xs">${relatedProduct.Ingredient || 'N/A'}</span>` : 
                        'No related product found'}
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
        ${data.results.exclusivity.length > 20 ? `
          <div class="text-xs text-gray-500 mt-2 text-right">
            Showing 20 of ${data.results.exclusivity.length} entries
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  elements.orangeBookData.innerHTML = html;
  
  // Add event listeners to tabs
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Hide all tab panes
      document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.add('hidden');
        pane.classList.remove('active');
      });
      
      // Deactivate all tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        btn.setAttribute('aria-selected', 'false');
      });
      
      // Activate the clicked tab
      document.getElementById(tabId).classList.remove('hidden');
      document.getElementById(tabId).classList.add('active');
      
      // Activate the clicked tab button
      this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
      this.classList.add('border-blue-500', 'text-blue-600');
      this.setAttribute('aria-selected', 'true');
    });
  });
  
  // Add event listeners for view toggling in Products tab
  document.getElementById('cardsViewBtn')?.addEventListener('click', function() {
    document.getElementById('cards-view').classList.remove('hidden');
    document.getElementById('table-view').classList.add('hidden');
    this.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
    this.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
    document.getElementById('tableViewBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
    document.getElementById('tableViewBtn').classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
  });
  
  document.getElementById('tableViewBtn')?.addEventListener('click', function() {
    document.getElementById('table-view').classList.remove('hidden');
    document.getElementById('cards-view').classList.add('hidden');
    this.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
    this.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
    document.getElementById('cardsViewBtn').classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
    document.getElementById('cardsViewBtn').classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
  });
  
  // Add event listener for expand all button
  document.getElementById('expandAllBtn')?.addEventListener('click', function() {
    const allDetails = document.querySelectorAll('.product-details');
    const isAnyHidden = Array.from(allDetails).some(el => el.classList.contains('hidden'));
    
    if (isAnyHidden) {
      // Expand all
      allDetails.forEach(el => el.classList.remove('hidden'));
      this.textContent = 'Collapse All';
      
      // Rotate all toggle icons
      document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.style.transform = 'rotate(180deg)';
      });
    } else {
      // Collapse all
      allDetails.forEach(el => el.classList.add('hidden'));
      this.textContent = 'Expand All';
      
      // Reset all toggle icons
      document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.style.transform = 'rotate(0deg)';
      });
    }
  });
  
  // Add event listeners for grouping controls
  document.getElementById('expandAllGroupsBtn')?.addEventListener('click', function() {
    expandAllGroups();
  });
  
  document.getElementById('collapseAllGroupsBtn')?.addEventListener('click', function() {
    collapseAllGroups();
  });
  
  document.getElementById('toggleGroupingBtn')?.addEventListener('click', function() {
    // Toggle grouping state
    groupedView = !groupedView;
    
    // Update button text
    this.textContent = groupedView ? 'Disable Grouping' : 'Enable Grouping';
    
    // Rebuild the table with the new grouping setting
    const tableBody = document.getElementById('productsTableBody');
    const headerRow = tableBody.previousElementSibling.querySelector('tr');
    
    if (groupedView) {
      // Update header for grouped view
      headerRow.innerHTML = `
        <th colspan="6" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Grouped by Trade Name (${groups.length} unique products)
        </th>
      `;
      
      // Update content for grouped view
      tableBody.innerHTML = createGroupedTableRows(groups);
    } else {
      // Update header for ungrouped view
      headerRow.innerHTML = `
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade Name</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingredient</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval Date</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relations</th>
      `;
      
      // Update content for ungrouped view
      tableBody.innerHTML = data.results.products.slice(0, 50).map(product => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-sm font-medium text-gray-900">${product.Trade_Name || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Ingredient || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Strength || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.DF_Route || product["DF;Route"] || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Appl_Type || ''}-${product.Appl_No || ''}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Approval_Date || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">
            <div class="flex space-x-1">
              ${product.related_patents && product.related_patents.length ? 
                `<span class="badge badge-blue">Patents: ${product.related_patents.length}</span>` : ''}
              ${product.related_exclusivity && product.related_exclusivity.length ? 
                `<span class="badge badge-yellow">Exclusivity: ${product.related_exclusivity.length}</span>` : ''}
            </div>
            <button class="mt-1 text-xs text-blue-600 hover:underline" 
                    onclick="showProductDetails('${product.Appl_Type}', '${product.Appl_No}', '${product.Product_No}')">
              View details
            </button>
          </td>
        </tr>
      `).join('');
    }
  });
}



// Function to toggle product details
function toggleProductDetails(productId) {
  const detailsElement = document.getElementById(`details-${productId}`);
  const headerElement = detailsElement.previousElementSibling;
  const iconElement = headerElement.querySelector('.toggle-icon');
  
  if (detailsElement.classList.contains('hidden')) {
    detailsElement.classList.remove('hidden');
    iconElement.style.transform = 'rotate(180deg)';
  } else {
    detailsElement.classList.add('hidden');
    iconElement.style.transform = 'rotate(0deg)';
  }
}

// Function to group products by trade name
function groupProductsByName(products) {
  const groupedProducts = {};
  
  // Group products by their trade name (case insensitive)
  products.forEach(product => {
    const tradeName = (product.Trade_Name || 'Unnamed Product').toUpperCase();
    
    if (!groupedProducts[tradeName]) {
      groupedProducts[tradeName] = [];
    }
    
    groupedProducts[tradeName].push(product);
  });
  
  // Sort groups by trade name
  return Object.keys(groupedProducts)
    .sort()
    .map(tradeName => ({
      tradeName: tradeName,
      displayName: groupedProducts[tradeName][0].Trade_Name || 'Unnamed Product',
      products: groupedProducts[tradeName],
      count: groupedProducts[tradeName].length
    }));
}

// Function to create table rows for grouped products
function createGroupedTableRows(groups) {
  let html = '';
  
  groups.forEach(group => {
    // Create parent row for the group
    html += `
      <tr class="bg-gray-50 group-parent-row" data-group="${group.tradeName.replace(/\s/g, '_')}">
        <td colspan="6" class="px-4 py-3">
          <div class="flex justify-between items-center">
            <div class="flex items-center">
              <button class="group-toggle mr-2 focus:outline-none" onclick="toggleGroupVisibility('${group.tradeName.replace(/\s/g, '_')}')">
                <svg class="w-5 h-5 text-gray-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <span class="font-medium">${group.displayName}</span>
            </div>
            <span class="badge badge-blue">${group.count} variations</span>
          </div>
        </td>
      </tr>
    `;
    
    // Create child rows for each product in the group (hidden by default)
    group.products.forEach(product => {
      html += `
        <tr class="group-child-row hidden" data-parent="${group.tradeName.replace(/\s/g, '_')}">
          <td class="px-6 py-4 pl-10 text-sm text-gray-900">${product.Ingredient || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Strength || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.DF_Route || product["DF;Route"] || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Appl_Type || ''}-${product.Appl_No || ''}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${product.Approval_Date || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-500">
            <div class="flex space-x-1">
              ${product.related_patents && product.related_patents.length ? 
                `<span class="badge badge-blue">Patents: ${product.related_patents.length}</span>` : ''}
              ${product.related_exclusivity && product.related_exclusivity.length ? 
                `<span class="badge badge-yellow">Exclusivity: ${product.related_exclusivity.length}</span>` : ''}
            </div>
            <button class="mt-1 text-xs text-blue-600 hover:underline" 
                    onclick="showProductDetails('${product.Appl_Type}', '${product.Appl_No}', '${product.Product_No}')">
              View details
            </button>
          </td>
        </tr>
      `;
    });
  });
  
  return html;
}

// Function to toggle visibility of group children
function toggleGroupVisibility(groupId) {
  const parentRow = document.querySelector(`tr[data-group="${groupId}"]`);
  const childRows = document.querySelectorAll(`tr[data-parent="${groupId}"]`);
  const toggleIcon = parentRow.querySelector('.group-toggle svg');
  
  // Check if children are currently visible
  const isVisible = !childRows[0].classList.contains('hidden');
  
  // Toggle visibility
  childRows.forEach(row => {
    if (isVisible) {
      row.classList.add('hidden');
      toggleIcon.style.transform = 'rotate(0deg)';
    } else {
      row.classList.remove('hidden');
      toggleIcon.style.transform = 'rotate(180deg)';
    }
  });
}

// Function to expand all groups
function expandAllGroups() {
  const allGroupParents = document.querySelectorAll('.group-parent-row');
  
  allGroupParents.forEach(parent => {
    const groupId = parent.getAttribute('data-group');
    const childRows = document.querySelectorAll(`tr[data-parent="${groupId}"]`);
    const toggleIcon = parent.querySelector('.group-toggle svg');
    
    // Make all children visible
    childRows.forEach(row => row.classList.remove('hidden'));
    toggleIcon.style.transform = 'rotate(180deg)';
  });
}

// Function to collapse all groups
function collapseAllGroups() {
  const allGroupParents = document.querySelectorAll('.group-parent-row');
  
  allGroupParents.forEach(parent => {
    const groupId = parent.getAttribute('data-group');
    const childRows = document.querySelectorAll(`tr[data-parent="${groupId}"]`);
    const toggleIcon = parent.querySelector('.group-toggle svg');
    
    // Hide all children
    childRows.forEach(row => row.classList.add('hidden'));
    toggleIcon.style.transform = 'rotate(0deg)';
  });
}

// Function to show detailed product view
function showProductDetails(applType, applNo, productNo) {
  // First switch to the "Products" tab
  document.getElementById('products-tab').click();
  
  // Then switch to card view
  document.getElementById('cardsViewBtn').click();
  
  // Find the product card and expand it
  const productId = `${applNo}-${productNo}`;
  const productCard = document.querySelector(`[data-product-id="${productId}"]`);
  
  if (productCard) {
    // Scroll to the product card
    productCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Highlight the card temporarily
    productCard.classList.add('highlight-card');
    setTimeout(() => {
      productCard.classList.remove('highlight-card');
    }, 2000);
    
    // Expand the card if it's collapsed
    const detailsElement = document.getElementById(`details-${productId}`);
    if (detailsElement && detailsElement.classList.contains('hidden')) {
      toggleProductDetails(productId);
    }
  }
}

// Function to switch related tabs within a product card
function switchRelatedTab(tabButton, contentId) {
  // Get parent container for scoping
  const productCard = tabButton.closest('.product-card');
  
  // Deactivate all tabs in this product card
  productCard.querySelectorAll('.related-tab').forEach(btn => {
    btn.classList.remove('border-blue-500', 'text-blue-600');
    btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
  });
  
  // Activate the clicked tab
  tabButton.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
  tabButton.classList.add('border-blue-500', 'text-blue-600');
  
// Hide all related content panes in this product card
productCard.querySelectorAll('.related-pane').forEach(pane => {
    pane.classList.add('hidden');
    pane.classList.remove('active');
  });
  
  // Show the target content
  const contentElement = document.getElementById(contentId);
  contentElement.classList.remove('hidden');
  contentElement.classList.add('active');
}

// Function to handle Orange Book searching
function searchOrangeBook(query) {
  if (!query.trim()) {
    elements.orangeBookData.innerHTML = `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">Please enter a search term</p>
      </div>
    `;
    elements.orangeBookCount.textContent = '0 entries';
    return;
  }
  
  // Show loading state
  elements.orangeBookData.innerHTML = `
    <div class="text-center p-4">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800"></div>
      <p class="mt-2 text-sm text-gray-700">Searching...</p>
    </div>
  `;
  
  // Make the API request
  fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(query)}`)
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(data => {
      displayOrangeBookData(data);
    })
    .catch(error => {
      console.error('Error fetching Orange Book data:', error);
      elements.orangeBookData.innerHTML = `
        <div class="text-center p-4">
          <p class="text-sm text-red-600">Error: ${error.message}</p>
        </div>
      `;
      elements.orangeBookCount.textContent = '0 entries';
    });
}

// Export code reference tables (useful for understanding exclusivity/patent codes)
function exportCodeReference() {
  // Create reference data for exclusivity codes
  const exclusivityCodes = {
    "ODE": "Orphan Drug Exclusivity",
    "NCE": "New Chemical Entity Exclusivity",
    "NDF": "New Dosage Form Exclusivity",
    "NPE": "New Patient Population Exclusivity",
    "POA": "Pediatric Exclusivity",
    "PED": "Pediatric Exclusivity",
    "CSP": "Competitive Generic Therapy Exclusivity",
    "CRP": "GAIN Exclusivity",
    "EBE": "Biologics Exclusivity",
    "RTO": "Reference Product Exclusivity",
    "D-183": "3-Year Exclusivity",
    "D-193": "3-Year Exclusivity (Extended)",
    "BLA": "Biologics License Application Exclusivity"
  };
  
  // Create reference data for patent use codes
  const patentUseCodes = {
    "U-141": "Method of treating disease",
    "U-233": "Drug delivery mechanism",
    "U-510": "Method of use",
    "U-986": "Pharmaceutical composition",
    "U-1490": "Process of manufacturing",
    "U-1574": "Treatment regimen"
  };
  
  let referenceHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Exclusivity Codes -->
      <div class="bg-white rounded shadow-sm p-4">
        <h3 class="font-medium text-gray-800 mb-3">Exclusivity Codes</h3>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${Object.entries(exclusivityCodes).map(([code, desc]) => `
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 text-sm font-medium">
                  <span class="badge badge-yellow">${code}</span>
                </td>
                <td class="px-3 py-2 text-sm">${desc}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      
      <!-- Patent Use Codes -->
      <div class="bg-white rounded shadow-sm p-4">
        <h3 class="font-medium text-gray-800 mb-3">Patent Use Codes</h3>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            ${Object.entries(patentUseCodes).map(([code, desc]) => `
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 text-sm font-medium">
                  <span class="badge badge-blue">${code}</span>
                </td>
                <td class="px-3 py-2 text-sm">${desc}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  // Create and show modal with the reference data
  const modalContainer = document.createElement('div');
  modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modalContainer.id = 'referenceModal';
  
  modalContainer.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Orange Book Reference Codes</h2>
        <button id="closeReferenceModal" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      ${referenceHTML}
    </div>
  `;
  
  document.body.appendChild(modalContainer);
  
  // Add event listener to close the modal
  document.getElementById('closeReferenceModal').addEventListener('click', function() {
    document.body.removeChild(modalContainer);
  });
  
  // Close modal when clicking outside
  modalContainer.addEventListener('click', function(event) {
    if (event.target === modalContainer) {
      document.body.removeChild(modalContainer);
    }
  });
}

// Function to show details for a specific application
function showApplicationDetails(applType, applNo, productNo) {
  // Construct the query to find the exact match
  const query = `${applType}-${applNo}-${productNo}`;
  
  // Show loading state
  elements.orangeBookData.innerHTML = `
    <div class="text-center p-4">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800"></div>
      <p class="mt-2 text-sm text-gray-700">Fetching application details...</p>
    </div>
  `;
  
  // Search using the specific application identifier
  searchOrangeBook(query);
}

// Initialize event listeners when document is ready
document.addEventListener('DOMContentLoaded', function() {
  // Add event listener for the search form if it exists
  const searchForm = document.getElementById('orangeBookSearchForm');
  if (searchForm) {
    searchForm.addEventListener('submit', function(event) {
      event.preventDefault();
      const query = document.getElementById('orangeBookSearchInput').value;
      searchOrangeBook(query);
    });
  }
  
  // Add listener for reference code button if it exists
  const referenceButton = document.getElementById('showReferenceCodesBtn');
  if (referenceButton) {
    referenceButton.addEventListener('click', exportCodeReference);
  }
});


function displayDailyMedData(data) {
  const labelInfo = data.label_info || [];
  
  // Update counter
  elements.dailyMedCount.textContent = `${labelInfo.length} entries`;
  
  if (labelInfo.length === 0) {
    elements.dailyMedData.innerHTML = `
      <div class="text-center p-4">
        <p class="text-sm text-gray-700">No DailyMed information found</p>
      </div>
    `;
    return;
  }
  
  // Create cards for each DailyMed entry
  let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
  
  for (const label of labelInfo) {
    html += `
      <div class="bg-white border border-gray-200 rounded p-3">
        <h4 class="font-medium text-sm">${label.title}</h4>
        <p class="text-xs text-gray-500 mt-1">Published: ${label.published}</p>
        ${label.manufacturer ? `<p class="text-xs mt-1">Manufacturer: ${label.manufacturer}</p>` : ''}
        ${label.dosageForm ? `<p class="text-xs mt-1">Dosage Form: ${label.dosageForm}</p>` : ''}
        <div class="mt-2">
          <a href="${label.labelUrl}" target="_blank" class="text-xs text-blue-600 hover:underline">
            View on DailyMed
          </a>
        </div>
      </div>
    `;
  }
  
  html += `</div>`;
  elements.dailyMedData.innerHTML = html;
}

// Function to create and open the details modal
function openDetailsModal(applicationNumber, brandName, ingredient) {
  // Create modal if it doesn't exist
  if (!document.getElementById('detailsModal')) {
    const modalHTML = `
      <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-auto">
          <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold" id="modalTitle">Application Details</h3>
            <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div class="p-6" id="modalContent">
            <div class="animate-pulse">
              <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
              <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
              <div class="h-4 bg-gray-200 rounded w-5/6 mb-4"></div>
            </div>
          </div>
          
          <div class="border-t p-4 flex justify-end">
            <button id="scrapeDocsBtn" class="px-4 py-2 bg-blue-600 text-white rounded mr-2 hover:bg-blue-700 transition-colors">
              Get Documents
            </button>
            <button id="aiSummaryBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors" disabled>
              AI Summary
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Append modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add event listeners for modal
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    
    // Close modal when clicking outside
    document.getElementById('detailsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  }
  
  // Update modal title
  document.getElementById('modalTitle').textContent = `${brandName} (${applicationNumber})`;
  
  // Show modal
  document.getElementById('detailsModal').classList.remove('hidden');
  
  // Store application number for document scraping
  document.getElementById('scrapeDocsBtn').setAttribute('data-application', applicationNumber);
  
  // Load details into modal
  loadModalDetails(applicationNumber, brandName, ingredient);
  
  // Add event listener for scraping
  document.getElementById('scrapeDocsBtn').addEventListener('click', function() {
    const appNo = this.getAttribute('data-application');
    scrapeDocuments(appNo);
  });
  
  // Add event listener for AI summary
  document.getElementById('aiSummaryBtn').addEventListener('click', function() {
    generateAISummary();
  });
}

// Function to close the modal
function closeModal() {
  document.getElementById('detailsModal').classList.add('hidden');
}

// Function to load details into the modal
async function loadModalDetails(applicationNumber, brandName, ingredient) {
  const modalContent = document.getElementById('modalContent');
  
  modalContent.innerHTML = `
    <div class="animate-pulse">
      <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
      <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
      <div class="h-4 bg-gray-200 rounded w-5/6 mb-4"></div>
    </div>
  `;
  
  try {
    // Fetch Orange Book data for this application
    const orangeBookResponse = await fetch(`/api/fda/orangebook/search?q=${encodeURIComponent(applicationNumber)}`);
    const orangeBookData = await orangeBookResponse.json();
    
    // Fetch DailyMed data for this ingredient
    const dailyMedResponse = await fetch(`/api/fda/dailymed/${encodeURIComponent(ingredient)}`);
    const dailyMedData = await dailyMedResponse.json();
    
    // Build content for modal
    let html = `
      <div class="mb-6">
        <h4 class="text-md font-semibold border-b pb-2 mb-2">Application Information</h4>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>
            <p><span class="font-medium">Application Number:</span> ${applicationNumber}</p>
            <p><span class="font-medium">Brand Name:</span> ${brandName}</p>
            <p><span class="font-medium">Active Ingredient:</span> ${ingredient}</p>
          </div>
          <div class="text-right">
            <a href="https://www.accessdata.fda.gov/scripts/cder/daf/index.cfm?event=overview.process&ApplNo=${applicationNumber.replace(/[^0-9]/g, '')}" 
               target="_blank" 
               class="text-blue-600 hover:underline">
              View on FDA Website
            </a>
          </div>
        </div>
      </div>
      

      
    <!--  <div class="mb-6">
        <h4 class="text-md font-semibold border-b pb-2 mb-2">DailyMed Information</h4>
        ${renderDailyMedDetails(dailyMedData)}
      </div> -->
      
      <div id="documentSection" class="mb-6">
        <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
        <p class="text-sm text-gray-600">Click "Get Documents" button below to retrieve FDA documents for this application.</p>
      </div>
    `;
    
    modalContent.innerHTML = html;
    
  } catch (error) {
    console.error("Error loading modal details:", error);
    modalContent.innerHTML = `
      <div class="text-center text-red-500 p-4">
        <p>Error loading details. Please try again.</p>
      </div>
    `;
  }
}

// Function to render Orange Book details
function renderOrangeBookDetails(data) {
  if (!data.results || data.results.products.length === 0) {
    return `<p class="text-sm text-gray-600">No Orange Book entries found for this application.</p>`;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-blue-600 text-white">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Trade Name</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Approval</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Strength</th>
      </tr>
    </thead>
        <tbody class="bg-white divide-y divide-gray-200">
  `;
  
  // Limit to 5 products for performance
  const productsToShow = Math.min(data.results.products.length, 5);
  for (let i = 0; i < productsToShow; i++) {
    const product = data.results.products[i];
    console.log(product)
    html += `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-sm font-medium text-gray-700">${product.Trade_Name || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${product.Approval_Date
            || 'N/A'}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${product.Strength || 'N/A'}</td>
        </tr>
    `;
  }
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  return html;
}

// Function to render DailyMed details
function renderDailyMedDetails(data) {
  const labelInfo = data.label_info || [];
  
  if (labelInfo.length === 0) {
    return `<p class="text-sm text-gray-600">No DailyMed information found for this product.</p>`;
  }
  
  let html = `<div class="grid grid-cols-1 gap-3">`;
  
  // Display up to 3 entries
  const entriesToShow = Math.min(labelInfo.length, 3);
  for (let i = 0; i < entriesToShow; i++) {
    const label = labelInfo[i];
    html += `
      <div class="bg-gray-50 rounded p-3">
        <h5 class="font-medium text-sm">${label.title}</h5>
        <p class="text-xs text-gray-500 mt-1">Published: ${label.published}</p>
        ${label.manufacturer ? `<p class="text-xs mt-1">Manufacturer: ${label.manufacturer}</p>` : ''}
        <div class="mt-2">
          <a href="${label.labelUrl}" target="_blank" class="text-xs text-blue-600 hover:underline">
            View on DailyMed
          </a>
        </div>
      </div>
    `;
  }
  
  html += `</div>`;
  
  // If there are more entries than shown
  if (labelInfo.length > 3) {
    html += `
      <div class="text-xs text-gray-500 mt-2">
        Showing 3 of ${labelInfo.length} entries
      </div>
    `;
  }
  
  return html;
}

// Function to scrape FDA documents
// Function to scrape FDA documents
// async function scrapeDocuments(applicationNumber) {
//     console.log(applicationNumber)
//   const documentSection = document.getElementById('documentSection');
//   const aiSummaryBtn = document.getElementById('aiSummaryBtn');
  
//   // Show loading state
//   documentSection.innerHTML = `
//     <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
//     <div class="flex justify-center items-center py-4">
//       <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//       </svg>
//       <span class="ml-2 text-gray-600">Retrieving documents...</span>
//     </div>
//   `;
  
//   try {
//     // Use the new endpoint to fetch document links
//     const appNo = applicationNumber.replace(/[^0-9]/g, ''); // Clean the application number
//     const response = await fetch(`/api/fda-pdfs/${appNo}`);
    
// if (!response.ok) {
//   const contentType = response.headers.get("content-type");
//   if (contentType && contentType.indexOf("application/json") === -1) {
//     // Not JSON - probably HTML error page
//     throw new Error(`Received non-JSON response (${response.status})`);
//   }
//   throw new Error(`HTTP error ${response.status}`);
// }
    
//     if (!response.ok) {
//       throw new Error(`HTTP error ${response.status}`);
//     }
    
//     const data = await response.json();
//     const documentLinks = data.results || [];
    
//     // Update the document section with links
//     let html = `
//       <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
//       <div class="mt-3">
//     `;
    
//     if (documentLinks.length === 0) {
//       html += `<p class="text-sm text-gray-600">No documents found for this application.</p>`;
//     } else {
//       // Group documents by type
//       const groupedDocs = {};
//       documentLinks.forEach(link => {
//         if (!groupedDocs[link.type]) {
//           groupedDocs[link.type] = [];
//         }
//         groupedDocs[link.type].push(link);
//       });
      
//       // Display documents by type
//       for (const [type, links] of Object.entries(groupedDocs)) {
//         html += `
//           <div class="mb-3">
//             <h5 class="text-sm font-medium mb-2">${type} Documents (${links.length})</h5>
//             <ul class="list-disc pl-5 text-sm">
//         `;
        
//         for (const link of links) {
//           html += `
//             <li class="mb-1">
//               <a href="${link.url}" target="_blank" class="text-blue-600 hover:underline">
//                 ${link.name}
//               </a>
//             </li>
//           `;
//         }
        
//         html += `
//             </ul>
//           </div>
//         `;
//       }
      
//       // Add note about documents
//       html += `
//         <p class="text-xs text-gray-500 mt-3">
//           Found ${documentLinks.length} documents. Some links may require FDA authentication.
//         </p>
//       `;
//     }
    
//     html += `</div>`;
    
//     // Update the document section
//     documentSection.innerHTML = html;
    
//     // Store document data for AI summary
//     document.getElementById('aiSummaryBtn').setAttribute('data-documents', JSON.stringify(documentLinks));
    
//     // Enable AI summary button if we have documents
//     if (documentLinks.length > 0) {
//       aiSummaryBtn.disabled = false;
//     }
    
//   } catch (error) {
//     console.error("Error retrieving documents:", error);
//     documentSection.innerHTML = `
//       <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
//       <div class="text-center text-red-500 p-4">
//         <p>Error retrieving documents: ${error.message}</p>
//         <button id="retryFetchBtn" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
//           Retry
//         </button>
//       </div>
//     `;
    
//     // Add retry button functionality
//     document.getElementById('retryFetchBtn').addEventListener('click', () => {
//       scrapeDocuments(applicationNumber);
//     });
//   }
// }

async function scrapeDocuments(applicationNumber) {
    console.log(applicationNumber)
  const documentSection = document.getElementById('documentSection');
  const aiSummaryBtn = document.getElementById('aiSummaryBtn');
  
  // Show loading state
  documentSection.innerHTML = `
    <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
    <div class="flex justify-center items-center py-4">
      <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-2 text-gray-600">Retrieving documents...</span>
    </div>
  `;
  
  try {
    // Use the new endpoint to fetch document links
    const appNo = applicationNumber.replace(/[^0-9]/g, ''); // Clean the application number
    const response = await fetch(`/api/fda-pdfs/${appNo}`);
    
    if (!response.ok) {
      const contentType = response.headers.get("content-type");
      if (contentType && contentType.indexOf("application/json") === -1) {
        // Not JSON - probably HTML error page
        throw new Error(`No documents found`);
      }
      throw new Error(`No documents found`);
    }
    
    const data = await response.json();
    const documentLinks = data.results || [];
    
    // Update the document section with links
    let html = `
      <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
      <div class="mt-3">
    `;
    
    if (documentLinks.length === 0) {
      html += `<p class="text-sm text-gray-600">No documents found for this application.</p>`;
    } else {
      // Group documents by type
      const groupedDocs = {};
      documentLinks.forEach(link => {
        if (!groupedDocs[link.type]) {
          groupedDocs[link.type] = [];
        }
        groupedDocs[link.type].push(link);
      });
      
      // Display documents by type
      for (const [type, links] of Object.entries(groupedDocs)) {
        html += `
          <div class="mb-3">
            <h5 class="text-sm font-medium mb-2">${type} Documents (${links.length})</h5>
            <ul class="list-disc pl-5 text-sm">
        `;
        
        for (const link of links) {
          html += `
            <li class="mb-1">
              <a href="${link.url}" target="_blank" class="text-blue-600 hover:underline">
                ${link.name}
              </a>
            </li>
          `;
        }
        
        html += `
            </ul>
          </div>
        `;
      }
      
      // Add note about documents
      html += `
        <p class="text-xs text-gray-500 mt-3">
          Found ${documentLinks.length} documents. Some links may require FDA authentication.
        </p>
      `;
    }
    
    html += `</div>`;
    
    // Update the document section
    documentSection.innerHTML = html;
    
    // Store document data for AI summary
    document.getElementById('aiSummaryBtn').setAttribute('data-documents', JSON.stringify(documentLinks));
    
    // Enable AI summary button if we have documents
    if (documentLinks.length > 0) {
      aiSummaryBtn.disabled = false;
    }
    
  } catch (error) {
    console.error("Error retrieving documents:", error);
    documentSection.innerHTML = `
      <h4 class="text-md font-semibold border-b pb-2 mb-2">FDA Documents</h4>
      <div class="text-center text-gray-600 p-4">
        <p>No documents found</p>
        <button id="retryFetchBtn" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
          Retry
        </button>
      </div>
    `;
    
    // Add retry button functionality
    document.getElementById('retryFetchBtn').addEventListener('click', () => {
      scrapeDocuments(applicationNumber);
    });
  }
}

// Function to generate AI summary of documents
// Function to generate AI summary of documents
// Modified function to generate AI summary of documents
// async function generateAISummary() {
//   const modalContent = document.getElementById('modalContent');
//   const aiSummaryBtn = document.getElementById('aiSummaryBtn');
//   const currentContent = modalContent.innerHTML;
  
//   // Get document data stored in the button's data attribute
//   let documentLinks = [];
//   try {
//     documentLinks = JSON.parse(aiSummaryBtn.getAttribute('data-documents') || '[]');
//   } catch (error) {
//     console.error("Error parsing document data:", error);
//   }
  
//   // Count document types
//   const docTypeCounts = {};
//   documentLinks.forEach(doc => {
//     docTypeCounts[doc.type] = (docTypeCounts[doc.type] || 0) + 1;
//   });
  
//   const docTypeSummary = Object.entries(docTypeCounts)
//     .map(([type, count]) => `${count} ${type}${count > 1 ? 's' : ''}`)
//     .join(', ');
  
//   // Append AI summary section with loading state
//   modalContent.innerHTML = currentContent + `
//     <div id="aiSummarySection" class="mt-6 border-t pt-4">
//       <h4 class="text-md font-semibold border-b pb-2 mb-2">AI Document Summary</h4>
//       <div class="bg-purple-50 p-4 rounded">
//         <div class="flex items-center mb-3">
//           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
//           </svg>
//           <span class="font-medium text-purple-700">AI Analysis</span>
//         </div>
        
//         <div id="aiSummaryContent">
//           <div class="flex justify-center items-center py-4">
//             <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//               <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//             </svg>
//             <span class="ml-2 text-gray-600">Analyzing documents...</span>
//           </div>
//         </div>
//       </div>
//     </div>
//   `;
  
//   // Find PDF document links (with priority order)
//   const pdfLinks = documentLinks.filter(doc => doc.url.toLowerCase().endsWith('.pdf'));
  
//   // Priority order: Label > Review > Letter > Other
//   const labelDocs = pdfLinks.filter(doc => doc.type === 'Label');
//   const reviewDocs = pdfLinks.filter(doc => doc.type === 'Review');
//   const letterDocs = pdfLinks.filter(doc => doc.type === 'Letter');
  
//   // Choose documents to analyze based on priority
//   let docsToAnalyze = [];
//   if (labelDocs.length > 0) {
//     docsToAnalyze = labelDocs;
//   } else if (reviewDocs.length > 0) {
//     docsToAnalyze = reviewDocs;
//   } else if (letterDocs.length > 0) {
//     docsToAnalyze = letterDocs;
//   } else {
//     docsToAnalyze = pdfLinks;
//   }
  
//   if (docsToAnalyze.length === 0) {
//     // No PDF documents found
//     document.getElementById('aiSummaryContent').innerHTML = `
//       <div class="text-center text-gray-600 p-4">
//         <p>No PDF documents found to analyze. AI summary unavailable.</p>
//       </div>
//     `;
//     return;
//   }
  
//   try {
//     // Choose the first document for analysis
//     const docToAnalyze = docsToAnalyze[0];
    
//     // Update status message
//     document.getElementById('aiSummaryContent').innerHTML = `
//       <div class="flex flex-col items-center py-4">
//         <div class="flex items-center">
//           <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
//             <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
//             <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
//           </svg>
//           <span class="ml-2 text-gray-600">Analyzing document...</span>
//         </div>
//         <div class="mt-2 text-xs text-gray-500">
//           Processing: ${docToAnalyze.name} (${docToAnalyze.type})
//         </div>
//       </div>
//     `;
    
//     // Call backend to analyze the document
//     const response = await fetch('/api/analyze-fda-doc', {
//       method: 'POST',
//       headers: {
//         'Content-Type': 'application/json'
//       },
//       body: JSON.stringify({
//         pdfUrl: docToAnalyze.url
//       })
//     });
    
//     if (!response.ok) {
//       const errorText = await response.text();
//       throw new Error(`API request failed (${response.status}): ${errorText}`);
//     }
    
//     const result = await response.json();
    
//     if (result.error) {
//       throw new Error(result.error);
//     }
    
//     // Display the summary with enhanced formatting
//     document.getElementById('aiSummaryContent').innerHTML = `
//       <div class="mt-1 text-sm bg-white p-4 rounded border border-purple-100 prose">
//         ${result.summary}
//       </div>
      
//       <div class="mt-3 flex justify-between items-center text-xs text-gray-500">
//         <span>Document: ${docToAnalyze.type} - ${docToAnalyze.name.length > 40 ? docToAnalyze.name.substring(0, 40) + '...' : docToAnalyze.name}</span>
//         ${result.imageCount > 0 ? `<span>Images analyzed: ${result.imageCount}</span>` : ''}
//       </div>
//     `;
    
//   } catch (error) {
//     console.error("Error generating AI summary:", error);
//     document.getElementById('aiSummaryContent').innerHTML = `
//       <div class="text-center text-red-500 p-4">
//         <p>Error generating AI summary: ${error.message}</p>
//         <button id="retryAnalysisBtn" class="mt-2 px-3 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600">
//           Retry Analysis
//         </button>
//       </div>
//     `;
    
//     // Add retry button functionality
//     document.getElementById('retryAnalysisBtn').addEventListener('click', () => {
//       generateAISummary();
//     });
//   }
// }
function formatAISummary(rawSummary) {
  // Split the raw summary into lines
  const lines = rawSummary.trim().split('\n');
  let html = '<div class="ai-summary-content">';
  let currentSection = '';
  let inList = false;

  lines.forEach((line, index) => {
    line = line.trim();

    // Handle section headings (e.g., ### 1. Drug Name and Active Ingredients)
    if (line.startsWith('###')) {
      if (currentSection) {
        if (inList) {
          currentSection += '</ul>';
          inList = false;
        }
        html += currentSection + '</div>';
      }
      const sectionTitle = line.replace('###', '').trim();
      currentSection = `
        <div class="section mt-4">
          <h5 class="font-semibold text-purple-800 mb-2">${sectionTitle}</h5>
      `;
    }
    // Handle bold items (e.g., **Drug Name:**)
    else if (line.includes('**')) {
      if (inList) {
        currentSection += '</ul>';
        inList = false;
      }
      const parts = line.split('**');
      let formattedLine = '';
      for (let i = 0; i < parts.length; i++) {
        if (i % 2 === 1) {
          // Bold and purple text
          formattedLine += `<strong class="text-purple-700">${parts[i]}</strong>`;
        } else {
          formattedLine += parts[i];
        }
      }
      currentSection += `<p>${formattedLine}</p>`;
    }
    // Handle list items (e.g., - Item)
    else if (line.startsWith('-')) {
      if (!inList) {
        currentSection += '<ul class="list-disc ml-5 mb-2">';
        inList = true;
      }
      const listItem = line.replace('-', '').trim();
      if (listItem.includes('**')) {
        const parts = listItem.split('**');
        let formattedItem = '';
        for (let i = 0; i < parts.length; i++) {
          if (i % 2 === 1) {
            formattedItem += `<strong class="text-purple-700">${parts[i]}</strong>`;
          } else {
            formattedItem += parts[i];
          }
        }
        currentSection += `<li>${formattedItem}</li>`;
      } else {
        currentSection += `<li>${listItem}</li>`;
      }
    }
    // Handle plain text
    else if (line.length > 0) {
      if (inList) {
        currentSection += '</ul>';
        inList = false;
      }
      currentSection += `<p>${line}</p>`;
    }
  });

  // Close the last section
  if (currentSection) {
    if (inList) {
      currentSection += '</ul>';
    }
    html += currentSection + '</div>';
  }

  html += '</div>';
  return html;
}

async function generateAISummary() {
  const modalContent = document.getElementById('modalContent');
  const aiSummaryBtn = document.getElementById('aiSummaryBtn');
  const currentContent = modalContent.innerHTML;

  // Get document data stored in the button's data attribute
  let documentLinks = [];
  try {
    documentLinks = JSON.parse(aiSummaryBtn.getAttribute('data-documents') || '[]');
  } catch (error) {
    console.error("Error parsing document data:", error);
  }

  // Count document types
  const docTypeCounts = {};
  documentLinks.forEach(doc => {
    docTypeCounts[doc.type] = (docTypeCounts[doc.type] || 0) + 1;
  });

  const docTypeSummary = Object.entries(docTypeCounts)
    .map(([type, count]) => `${count} ${type}${count > 1 ? 's' : ''}`)
    .join(', ');

  // Append AI summary section with loading state and improved styling
  modalContent.innerHTML = currentContent + `
    <div id="aiSummarySection" class="mt-6 border-t pt-4">
      <h4 class="text-lg font-semibold text-purple-900 border-b pb-2 mb-4">AI Document Summary</h4>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-purple-100">
        <div class="flex items-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          <span class="font-medium text-purple-700 text-lg">AI Analysis</span>
        </div>
        <div id="aiSummaryContent">
          <div class="flex justify-center items-center py-4">
            <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-2 text-gray-600">Analyzing documents...</span>
          </div>
        </div>
      </div>
    </div>
  `;

  // Find PDF document links (with priority order)
  const pdfLinks = documentLinks.filter(doc => doc.url.toLowerCase().endsWith('.pdf'));
  const labelDocs = pdfLinks.filter(doc => doc.type === 'Label');
  const reviewDocs = pdfLinks.filter(doc => doc.type === 'Review');
  const letterDocs = pdfLinks.filter(doc => doc.type === 'Letter');

  let docsToAnalyze = [];
  if (labelDocs.length > 0) {
    docsToAnalyze = labelDocs;
  } else if (reviewDocs.length > 0) {
    docsToAnalyze = reviewDocs;
  } else if (letterDocs.length > 0) {
    docsToAnalyze = letterDocs;
  } else {
    docsToAnalyze = pdfLinks;
  }

  if (docsToAnalyze.length === 0) {
    document.getElementById('aiSummaryContent').innerHTML = `
      <div class="text-center text-gray-600 p-4">
        <p>No PDF documents found to analyze. AI summary unavailable.</p>
      </div>
    `;
    return;
  }

  try {
    const docToAnalyze = docsToAnalyze[0];
    
    document.getElementById('aiSummaryContent').innerHTML = `
      <div class="flex flex-col items-center py-4">
        <div class="flex items-center">
          <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="ml-2 text-gray-600">Analyzing document...</span>
        </div>
        <div class="mt-2 text-xs text-gray-500">
          Processing: ${docToAnalyze.name} (${docToAnalyze.type})
        </div>
      </div>
    `;

    // Simulated API response (replace with actual fetch call)
    // const response = {
    //   ok: true,
    //   json: async () => ({
    //     summary: `
    //       <div class="ai-summary-content">
    //         <div class="section">
    //           <h5 class="font-semibold text-purple-800 mb-2">1. Drug Name and Active Ingredients</h5>
    //           <p><strong class="text-purple-700">Drug Name:</strong> ADDERALL XR</p>
    //           <p><strong class="text-purple-700">Active Ingredients:</strong></p>
    //           <ul class="list-disc ml-5 mb-2">
    //             <li>Dextroamphetamine Saccharate</li>
    //             <li>Amphetamine Aspartate Monohydrate</li>
    //             <li>Dextroamphetamine Sulfate USP</li>
    //             <li>Amphetamine Sulfate USP</li>
    //           </ul>
    //           <p>Each capsule contains a combination of these salts, with total amphetamine base equivalence of 6.3 mg, 12.5 mg, or 18.8 mg for the 10 mg, 20 mg, and 30 mg capsules, respectively.</p>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">2. Approved Indications</h5>
    //           <p><strong class="text-purple-700">Indications:</strong> ADDERALL XR is indicated for the treatment of Attention Deficit Hyperactivity Disorder (ADHD) in patients who meet DSM-IV criteria for ADHD, including the combined type or the hyperactive-impulsive type.</p>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">3. Important Safety Information</h5>
    //           <ul class="list-disc ml-5 mb-2">
    //             <li><strong class="text-purple-700">High Potential for Abuse:</strong> Amphetamines have a high potential for abuse and prolonged use may lead to drug dependence.</li>
    //             <li><strong class="text-purple-700">Non-Therapeutic Use:</strong> There is a risk of subjects obtaining amphetamines for non-therapeutic use or distribution to others. The drug should be prescribed or dispensed sparingly.</li>
    //             <li><strong class="text-purple-700">Clinical Trials:</strong> Efficacy was demonstrated in controlled trials in children aged 6 to 12, showing significant improvements in behavior and performance compared to placebo.</li>
    //           </ul>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">4. Dosage Recommendations</h5>
    //           <ul class="list-disc ml-5 mb-2">
    //             <li><strong class="text-purple-700">Dosage Forms:</strong> Available in 10 mg, 20 mg, and 30 mg capsules.</li>
    //             <li><strong class="text-purple-700">Administration:</strong> Once daily in the morning. The capsule can be opened and sprinkled on applesauce if needed, with comparable absorption to the intact capsule.</li>
    //             <li><strong class="text-purple-700">Dose Range:</strong> The effective dose range in clinical trials was 10 mg to 30 mg once daily.</li>
    //             <li><strong class="text-purple-700">Pharmacokinetics:</strong> The time to reach maximum plasma concentration (Tmax) is about 7 hours, and the drug demonstrates linear pharmacokinetics over the dose range of 10 to 30 mg.</li>
    //           </ul>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">5. Contraindications</h5>
    //           <p>The document does not explicitly list contraindications, but it emphasizes the high potential for abuse and the need for careful prescribing practices.</p>
    //         </div>

    //         <div class="section mt-4">
    //           <h5 class="font-semibold text-purple-800 mb-2">6. Special Populations and Warnings</h5>
    //           <ul class="list-disc ml-5 mb-2">
    //             <li><strong class="text-purple-700">Pediatric Patients:</strong> Children aged 6 to 12 years eliminate amphetamine faster than adults, with a shorter elimination half-life. However, they have higher systemic exposure due to higher doses on a mg/kg basis.</li>
    //             <li><strong class="text-purple-700">Gender:</strong> Women have 20-30% higher systemic exposure to amphetamine than men, attributed to higher doses on a mg/kg basis.</li>
    //             <li><strong class="text-purple-700">Race:</strong> Pharmacokinetics appear comparable among Caucasians, Blacks, and Hispanics.</li>
    //             <li><strong class="text-purple-700">Food Effects:</strong> Food does not affect the extent of absorption but prolongs Tmax by 2.5 hours.</li>
    //           </ul>
    //           <p class="mt-2"><strong class="text-purple-700">Warnings:</strong></p>
    //           <ul class="list-disc ml-5">
    //             <li><strong class="text-purple-700">Abuse and Dependence:</strong> The document repeatedly warns about the potential for abuse and dependence with prolonged use of amphetamines.</li>
    //             <li><strong class="text-purple-700">Prescribing Practices:</strong> Emphasis on prescribing or dispensing the drug sparingly due to the risk of non-therapeutic use or distribution.</li>
    //           </ul>
    //         </div>
    //       </div>
    //     `,
    //     imageCount: 0
    //   })
    // };

    // Uncomment this for actual API call
    
    const response = await fetch('/api/analyze-fda-doc', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        pdfUrl: docToAnalyze.url
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API request failed (${response.status}): ${errorText}`);
    }

    const result = await response.json();
    
    if (result.error) {
      throw new Error(result.error);
    }
    

    // const result = await response.json();
const html = formatAISummary(result.summary)
    // Display the summary with enhanced formatting
    document.getElementById('aiSummaryContent').innerHTML = `
      <div class="text-sm text-gray-700">
        ${html}
      </div>
      <div class="mt-4 flex justify-between items-center text-xs text-gray-500 border-t pt-2">
        <span>Document: ${docToAnalyze.type} - ${
          docToAnalyze.name.length > 40 
            ? docToAnalyze.name.substring(0, 40) + '...' 
            : docToAnalyze.name
        }</span>
        ${result.imageCount > 0 ? `<span>Images analyzed: ${result.imageCount}</span>` : ''}
      </div>
    `;

  } catch (error) {
    console.error("Error generating AI summary:", error);
    document.getElementById('aiSummaryContent').innerHTML = `
      <div class="text-center text-red-500 p-4">
        <p>Error generating AI summary: ${error.message}</p>
        <button id="retryAnalysisBtn" class="mt-2 px-4 py-1 bg-purple-500 text-white text-sm rounded hover:bg-purple-600">
          Retry Analysis
        </button>
      </div>
    `;
    
    document.getElementById('retryAnalysisBtn').addEventListener('click', () => {
      generateAISummary();
    });
  }
}

function createStatisticalSummaryTable(outcomes) {
    const table = elements.statisticalSummaryTable;
    if (!table) {
        console.warn("Statistical summary table element not found");
        return;
    }
    
    table.innerHTML = '';
    
    // Filter only outcomes with effect sizes
    const validOutcomes = outcomes.filter(o => o.effectSize !== null);
    
    if (validOutcomes.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">No statistical data available for the selected metric.</td></tr>';
        return;
    }
    
    // Group outcomes by study first
    const studyOutcomes = {};
    
    validOutcomes.forEach(o => {
        const nctId = o.nctId;
        if (!studyOutcomes[nctId]) {
            studyOutcomes[nctId] = [];
        }
        studyOutcomes[nctId].push(o);
    });
    
    // Calculate average effect size for each study to avoid over-counting 
    // studies with multiple outcomes
    const studyEffects = Object.entries(studyOutcomes).map(([nctId, outcomes]) => {
        const effectSizes = outcomes.map(o => o.effectSize);
        const meanEffect = calculateMean(effectSizes);
        const phase = outcomes[0].phase || 'N/A';
        
        return {
            nctId,
            phase,
            effectSize: meanEffect,
            experimentalValue: outcomes[0].experimentalValue,
            controlValue: outcomes[0].controlValue,
            experimentalSampleSize: outcomes[0].experimentalSampleSize,
            controlSampleSize: outcomes[0].controlSampleSize
        };
    });
    
    // Now group by phase
    const phaseGroups = {};
    const phaseOrder = { 
        "PRE_PHASE": 0, 
        "PHASE1": 1, 
        "PHASE1_PHASE2": 1.5,
        "PHASE2": 2, 
        "PHASE3": 3, 
        "PHASE4": 4,
        "N/A": 5
    };
    
    studyEffects.forEach(effect => {
        const phase = effect.phase;
        if (!phaseGroups[phase]) {
            phaseGroups[phase] = {
                effectSizes: [],
                experimentalValues: [],
                controlValues: [],
                experimentalSampleSizes: [],
                controlSampleSizes: []
            };
        }
        
        phaseGroups[phase].effectSizes.push(effect.effectSize);
        
        if (effect.experimentalValue !== null) {
            phaseGroups[phase].experimentalValues.push(effect.experimentalValue);
            phaseGroups[phase].experimentalSampleSizes.push(effect.experimentalSampleSize || 0);
        }
        
        if (effect.controlValue !== null) {
            phaseGroups[phase].controlValues.push(effect.controlValue);
            phaseGroups[phase].controlSampleSizes.push(effect.controlSampleSize || 0);
        }
    });
    
    // Add an "All Phases" row at the top
    let allEffectSizes = studyEffects.map(e => e.effectSize);
    let allExperimentalValues = studyEffects.filter(e => e.experimentalValue !== null).map(e => e.experimentalValue);
    let allControlValues = studyEffects.filter(e => e.controlValue !== null).map(e => e.controlValue);
    let allExperimentalSampleSizes = studyEffects.filter(e => e.experimentalSampleSize > 0).map(e => e.experimentalSampleSize);
    let allControlSampleSizes = studyEffects.filter(e => e.controlSampleSize > 0).map(e => e.controlSampleSize);
    
    // Calculate overall statistics
    const overallMean = calculateMean(allEffectSizes);
    const overallStdDev = calculateStandardDeviation(allEffectSizes, overallMean);
    const overallN = studyEffects.length; // Count unique studies
    const overallCi = calculateConfidenceInterval(overallMean, overallStdDev, overallN);
    
    const totalExperimentalN = allExperimentalSampleSizes.reduce((sum, n) => sum + n, 0);
    const totalControlN = allControlSampleSizes.reduce((sum, n) => sum + n, 0);
    
    // Add overall row
    const row = document.createElement('tr');
    row.className = 'bg-gray-50 font-medium';
    row.innerHTML = `
        <td class="py-2 px-4 border-b">All Phases</td>
        <td class="py-2 px-4 border-b">${overallN}</td>
        <td class="py-2 px-4 border-b">${overallMean.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">${overallStdDev.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">${overallCi.lower.toFixed(2)} to ${overallCi.upper.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">${calculatePValue(
            calculateMean(allExperimentalValues),
            calculateMean(allControlValues),
            calculateStandardDeviation(allExperimentalValues),
            calculateStandardDeviation(allControlValues),
            totalExperimentalN,
            totalControlN
        )}</td>
    `;
    table.appendChild(row);
    
    // Add phase-specific rows
    Object.keys(phaseGroups)
        .sort((a, b) => phaseOrder[a] - phaseOrder[b])
        .forEach(phase => {
            const data = phaseGroups[phase];
            
            // Calculate statistics for this phase
            const mean = calculateMean(data.effectSizes);
            const stdDev = calculateStandardDeviation(data.effectSizes, mean);
            const n = data.effectSizes.length;
            const ci = calculateConfidenceInterval(mean, stdDev, n);
            
            const expMean = calculateMean(data.experimentalValues);
            const ctrlMean = calculateMean(data.controlValues);
            const expStdDev = calculateStandardDeviation(data.experimentalValues);
            const ctrlStdDev = calculateStandardDeviation(data.controlValues);
            
            const totalExpN = data.experimentalSampleSizes.reduce((sum, n) => sum + n, 0);
            const totalCtrlN = data.controlSampleSizes.reduce((sum, n) => sum + n, 0);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-2 px-4 border-b">${formatPhase(phase)}</td>
                <td class="py-2 px-4 border-b">${n}</td>
                <td class="py-2 px-4 border-b">${mean.toFixed(2)}</td>
                <td class="py-2 px-4 border-b">${stdDev.toFixed(2)}</td>
                <td class="py-2 px-4 border-b">${ci.lower.toFixed(2)} to ${ci.upper.toFixed(2)}</td>
                <td class="py-2 px-4 border-b">${calculatePValue(expMean, ctrlMean, expStdDev, ctrlStdDev, totalExpN, totalCtrlN)}</td>
            `;
            table.appendChild(row);
        });
}
        // Filter functions
        function filterStudiesByPhase(phase) {
            if (phase === 'all') {
                return appState.studies;
            } else {
                return appState.studies.filter(study => 
                    study.protocolSection?.designModule?.phases?.[0] === phase
                );
            }
        }

        // Utility functions
        function getRandomColor(index, alpha = 1) {
            const colors = [
                `rgba(59, 130, 246, ${alpha})`, // blue-500
                `rgba(16, 185, 129, ${alpha})`, // emerald-500
                `rgba(139, 92, 246, ${alpha})`, // violet-500
                `rgba(249, 115, 22, ${alpha})`, // orange-500
                `rgba(236, 72, 153, ${alpha})`, // pink-500
                `rgba(14, 165, 233, ${alpha})`, // sky-500
                `rgba(168, 85, 247, ${alpha})`, // purple-500
                `rgba(234, 88, 12, ${alpha})`, // amber-600
                `rgba(22, 163, 74, ${alpha})`, // green-600
                `rgba(79, 70, 229, ${alpha})` // indigo-600
            ];
            
            return colors[index % colors.length];
        }

        function hexToRgba(hex, alpha = 1) {
            // Handle color names that aren't hex
            if (!hex.startsWith('#')) {
                // Simple mapping of common colors
                const colorMap = {
                    'red': 'rgba(255, 0, 0, ' + alpha + ')',
                    'green': 'rgba(0, 255, 0, ' + alpha + ')',
                    'blue': 'rgba(0, 0, 255, ' + alpha + ')',
                    'black': 'rgba(0, 0, 0, ' + alpha + ')',
                    'white': 'rgba(255, 255, 255, ' + alpha + ')',
                    'gray': 'rgba(128, 128, 128, ' + alpha + ')',
                    'yellow': 'rgba(255, 255, 0, ' + alpha + ')',
                    'orange': 'rgba(255, 165, 0, ' + alpha + ')',
                    'purple': 'rgba(128, 0, 128, ' + alpha + ')'
                };
                if (colorMap[hex.toLowerCase()]) {
                    return colorMap[hex.toLowerCase()];
                }
                
                // For unknown colors, return a safe default
                return `rgba(128, 128, 128, ${alpha})`;
            }
            
            // Regular hex color handling
            let r = 0, g = 0, b = 0;
            
            // 3 digits
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } 
            // 6 digits
            else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            // Handle other cases with a default
            else {
                return `rgba(128, 128, 128, ${alpha})`;
            }
            
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Event handlers
        function handlePhaseFilter(event) {
            if (!event.target.classList.contains('phase-filter')) return;
            
            const phase = event.target.dataset.phase;
            
            // Update state
            appState.currentPhaseFilter = phase;
            
            // Update filter button styles
            document.querySelectorAll('.phase-filter').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
            });
            event.target.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            event.target.classList.add('bg-primary', 'text-white');
            
            // Filter studies
            const filteredStudies = filterStudiesByPhase(phase);
            
            // Update studies display
            displayStudies(filteredStudies);
        }

// async function handleSearch() {
//     const drug = elements.drugSearch.value.trim();
//     const condition = elements.conditionSearch.value.trim();
//     const hasResultsOnly = elements.hasResultsOnly.checked;
//     const trdFocusOnly = elements.trdFocusOnly.checked;
    
//     if (!drug) {
//         alert('Please enter a drug name to search.');
//         return;
//     }
    
//     // Update state
//     appState.hasResultsOnly = hasResultsOnly;
//     appState.trdFocusOnly = trdFocusOnly;
//     appState.currentPhaseFilter = 'all';
//     appState.studies = [];
//     appState.studyDetails = {};
//     appState.allOutcomeMeasures = [];
//     appState.collatedOutcomes = [];
//     appState.failedStudyIds.clear(); // Reset failed study IDs
    
//     // Reset FDA data
//     appState.fdaData = {
//         documents: [],
//         orangeBook: [],
//         dailyMed: [],
//         warningLetters: []
//     };
    
//     // Reset phase filter buttons
//     document.querySelectorAll('.phase-filter').forEach(btn => {
//         btn.classList.remove('bg-primary', 'text-white');
//         btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
//     });
//     document.querySelector('.phase-filter[data-phase="all"]').classList.remove('bg-gray-200', 'hover:bg-gray-300');
//     document.querySelector('.phase-filter[data-phase="all"]').classList.add('bg-primary', 'text-white');
    
//     // Hide sections and show loading
//     showSection(elements.resultsOverview, false);
//     showSection(elements.studiesSection, false);
//     // showSection(elements.aggregateOutcomesSection, false);
//     // showSection(elements.collatedOutcomesSection, false);
//     showSection(elements.studyDetailSection, false);
//     showSection(elements.fdaDataSection, false);
//     // showSection(elements.drugSuccessSection, false); // Hide drug success section
//     displayLoading(true);
    
//     try {
//         console.log(`Searching for studies - Drug: ${drug}, Condition: ${condition}, Results Only: ${hasResultsOnly}, TRD Focus: ${trdFocusOnly}`);
        
//         // Fetch studies
//         const studies = await fetchStudies(drug, condition, hasResultsOnly);
//         console.log(`Retrieved ${studies.length} studies`);
        
//         // Filter for TRD-specific studies if requested
//         let filteredStudies = studies;
//         if (trdFocusOnly) {
//             filteredStudies = filterTRDSpecificStudies(studies);
//             console.log(`Filtered to ${filteredStudies.length} TRD-specific studies`);
//         }
        
//         appState.studies = filteredStudies;
        
//         if (filteredStudies.length === 0) {
//             elements.placeholderMessage.innerHTML = `
//                 <div class="text-center">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                     </svg>
//                     <p class="text-lg">No ${trdFocusOnly ? 'TRD-specific ' : ''}studies found for "${drug}".</p>
//                     <p class="mt-2 text-sm">Try another drug name${trdFocusOnly ? ' or disable the TRD-specific filter' : ''}.</p>
//                 </div>
//             `;
//             // Still show FDA data even if no studies are found
//             displayFdaData(drug);
//             displayLoading(false);
//             return;
//         }

//         // 
        
//         // Display results summary
//         displayResultsSummary(filteredStudies);
//         // showSection(elements.resultsOverview, true);
        
//         // Display studies list
//         displayStudies(filteredStudies);
//         showSection(elements.studiesSection, true);
        
//         // Display FDA data section
//         displayFdaData(drug);
        
//         // Fetch study details for studies with results
//         appState.studyDetails = {};
//         const studiesWithResults = filteredStudies.filter(study => study.hasResults);
//         console.log(`Fetching details for ${studiesWithResults.length} studies with results`);
        
//          // Ensure chart canvases are created
//         //  ensureChartCanvasesExist();
//         //  ensureDrugSuccessChartCanvasesExist();
//         // Use a semaphore to limit concurrent API calls
//         const MAX_CONCURRENT_REQUESTS = 5;
//         let activeRequests = 0;
//         let requestQueue = [...studiesWithResults];
//         let completedRequests = 0;
        
//         const processQueue = async () => {
//             if (requestQueue.length === 0) return;
            
//             while (activeRequests < MAX_CONCURRENT_REQUESTS && requestQueue.length > 0) {
//                 activeRequests++;
//                 const study = requestQueue.shift();
//                 const nctId = study.protocolSection.identificationModule.nctId;
                
//                 fetchStudyDetails(nctId).then(details => {
//                     if (details) {
//                         appState.studyDetails[nctId] = details;
//                     }
                    
//                     activeRequests--;
//                     completedRequests++;
                    
//                     // Update progress if we have a lot of studies
//                     if (studiesWithResults.length > 10 && completedRequests % 5 === 0) {
//                         const progressPercent = Math.round((completedRequests / studiesWithResults.length) * 100);
//                         console.log(`Study details progress: ${progressPercent}% (${completedRequests}/${studiesWithResults.length})`);
//                     }
                    
//                     // Process more from queue
//                     processQueue();
                    
//                     // If all requests are complete, process the outcomes
//                     if (activeRequests === 0 && requestQueue.length === 0) {
//                         console.log('All study details fetched, processing outcomes');
//                         // Process and display aggregate outcomes
//                         processAggregateOutcomes(filteredStudies);
//                         displayLoading(false);
//                     }
//                 });
//             }
//         };
        
//         // Start processing the queue
//         await processQueue();
        
//         // If no studies with results, hide loading
//         if (studiesWithResults.length === 0) {
//             displayLoading(false);
//         }
        
//     } catch (error) {
//         console.error('Error during search:', error);
//         elements.placeholderMessage.innerHTML = `
//             <div class="text-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                 </svg>
//                 <p class="text-lg">Error searching for studies</p>
//                 <p class="mt-2 text-sm">Please try again later.</p>
//                 <p class="mt-2 text-xs text-gray-500">${error.message}</p>
//             </div>
//         `;
//         displayLoading(false);
//     }
// }



  



// async function handleSearch() {
//     elements.placeholderMessage.innerHTML = `
//                 <div class="text-center">
//         <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
//             </svg>
//             <p class="text-lg">Enter a drug name and click "Search" to analyze clinical trials</p>
//             <p class="mt-2 text-sm">Example searches: Ketamine, Psilocybin, Esketamine, PCN-101, COMP360</p>
// </div>`
//     const drug = elements.drugSearch.value.trim();
//     const condition = elements.conditionSearch.value.trim();
//     const hasResultsOnly = elements.hasResultsOnly.checked;
//     const trdFocusOnly = elements.trdFocusOnly.checked;
    

    
//     // Update state
//     appState.hasResultsOnly = hasResultsOnly;
//     appState.trdFocusOnly = trdFocusOnly;
//     appState.currentPhaseFilter = 'all';
//     appState.studies = [];
//     appState.studyDetails = {};
//     appState.failedStudyIds.clear(); // Reset failed study IDs
    
//     // Reset FDA data
//     appState.fdaData = {
//         documents: [],
//         orangeBook: [],
//         dailyMed: [],
//         warningLetters: []
//     };
    
//     // Reset phase filter buttons
//     document.querySelectorAll('.phase-filter').forEach(btn => {
//         btn.classList.remove('bg-primary', 'text-white');
//         btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
//     });
//     document.querySelector('.phase-filter[data-phase="all"]').classList.remove('bg-gray-200', 'hover:bg-gray-300');
//     document.querySelector('.phase-filter[data-phase="all"]').classList.add('bg-primary', 'text-white');
    
//     // Hide sections and show loading
//     showSection(elements.resultsOverview, false);
//     showSection(elements.studiesSection, false);
//     showSection(elements.studyDetailSection, false);
//     showSection(elements.fdaDataSection, false);
//     displayLoading(true);
    
//     try {
//         console.log(`Searching for studies - Drug: ${drug}, Condition: ${condition}, Results Only: ${hasResultsOnly}, TRD Focus: ${trdFocusOnly}`);
        
//         // Fetch studies
//         const studies = await fetchStudies(drug, condition, hasResultsOnly);
//         console.log(`Retrieved ${studies.length} studies`);
        
//         // Filter for TRD-specific studies if requested
//         let filteredStudies = studies;
                
//       let pubmedSearchTerm = drug;
//         // if (trdFocusOnly) {
//         //     filteredStudies = filterTRDSpecificStudies(studies);
//         //     console.log(`Filtered to ${filteredStudies.length} TRD-specific studies`);
//         // }
        
//         appState.studies = filteredStudies;
//         collectAllTrialOutcomes()

//         if (filteredStudies.length === 0) {
//             elements.placeholderMessage.innerHTML = `
//                 <div class="text-center">
//                     <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
//                     </svg>
//                     <p class="text-lg">No ${trdFocusOnly ? 'TRD-specific ' : ''}studies found for "${drug}".</p>
//                     <p class="mt-2 text-sm">Try another drug name${trdFocusOnly ? ' or disable the TRD-specific filter' : ''}.</p>
//                 </div>
//             `;
//             // Still show FDA data even if no studies are found
           
            
//             if (!drug) {
//         // alert('Please enter a drug name to search.');
//         displayFdaClinicalData(condition);
//         if (condition) {
//     pubmedSearchTerm = drug ? `${drug} ${condition}` : condition;
//   }
  
//   if (pubmedSearchTerm) {
//     PubMedModule.searchPubMed(pubmedSearchTerm);
//   }
//         // EmaClinicalDataModule.init();
//         // EmaClinicalDataModule.searchCondition(condition);
//         displayLoading(false);
//     } 
//       console.log("disalying data ")
//       displayFdaData(drug);
//       EmaDataModule.init();
//       EmaDataModule.searchDrug(drug);
//       displayLoading(false);
    

//             return;
//         }
        
//         // Display results summary
//         displayResultsSummary(filteredStudies);
//         showSection(elements.resultsOverview, true);
        
//         // Display studies list
//         displayStudies(filteredStudies, drug, condition);
//         showSection(elements.studiesSection, true);
        
//         // Display FDA data section
//         // displayFdaData(drug, condition);
//         if (!drug) {
//         // alert('Please enter a drug name to search.');
//         displayFdaClinicalData(condition);
//         // EmaClinicalDataModule.init();
//         // EmaClinicalDataModule.searchCondition(condition);
//         displayLoading(false);
//     } 
//       console.log("disalying data ")
//       displayFdaData(drug);
//       EmaDataModule.init();
//       EmaDataModule.searchDrug(drug);
//       displayLoading(false);

  
//   if (condition) {
//     pubmedSearchTerm = drug ? `${drug} ${condition}` : condition;
//   }
  
//   if (pubmedSearchTerm) {
//     PubMedModule.searchPubMed(pubmedSearchTerm);
//   }
        
//         // Fetch study details for studies with results
//         appState.studyDetails = {};
//         const studiesWithResults = filteredStudies.filter(study => study.hasResults);
//         console.log(`Fetching details for ${studiesWithResults.length} studies with results`);
        
//         // Use a semaphore to limit concurrent API calls
//         const MAX_CONCURRENT_REQUESTS = 5;
//         let activeRequests = 0;
//         let requestQueue = [...studiesWithResults];
//         let completedRequests = 0;
        
//         const processQueue = async () => {
//             if (requestQueue.length === 0) return;
            
//             while (activeRequests < MAX_CONCURRENT_REQUESTS && requestQueue.length > 0) {
//                 activeRequests++;
//                 const study = requestQueue.shift();
//                 const nctId = study.protocolSection.identificationModule.nctId;
                
//                 fetchStudyDetails(nctId).then(details => {
//                     if (details) {
//                         appState.studyDetails[nctId] = details;
//                     }
                    
//                     activeRequests--;
//                     completedRequests++;
                    
//                     // Update progress if we have a lot of studies
//                     if (studiesWithResults.length > 10 && completedRequests % 5 === 0) {
//                         const progressPercent = Math.round((completedRequests / studiesWithResults.length) * 100);
//                         console.log(`Study details progress: ${progressPercent}% (${completedRequests}/${studiesWithResults.length})`);
//                     }
                    
//                     // Process more from queue
//                     processQueue();
                    
//                     // If all requests are complete
//                     if (activeRequests === 0 && requestQueue.length === 0) {
//                         console.log('All study details fetched');
//                         collectAllTrialOutcomes()
//                         displayLoading(false);
//                     }
//                 });
//             }
//         };
        
//         // Start processing the queue
//         await processQueue();
        
//         // If no studies with results, hide loading
//         if (studiesWithResults.length === 0) {
//             displayLoading(false);
//         }
        
//     } catch (error) {
//         console.error('Error during search:', error);
//         elements.placeholderMessage.innerHTML = `
//             <div class="text-center">
//                 <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
//                 </svg>
//                 <p class="text-lg">Error searching for studies</p>
//                 <p class="mt-2 text-sm">Please try again later.</p>
//                 <p class="mt-2 text-xs text-gray-500">${error.message}</p>
//             </div>
//         `;
//         displayLoading(false);
//     }
// }


async function handleSearch() {
    // Get search parameters
    const drug = elements.drugSearch.value.trim();
    const condition = elements.conditionSearch.value.trim();
    const hasResultsOnly = elements.hasResultsOnly.checked;
    const trdFocusOnly = elements.trdFocusOnly.checked;
    
    // Update state
    appState.hasResultsOnly = hasResultsOnly;
    appState.trdFocusOnly = trdFocusOnly;
    appState.currentPhaseFilter = 'all';
    appState.studies = [];
    appState.studyDetails = {};
    appState.failedStudyIds.clear(); // Reset failed study IDs
    
    // Reset FDA data
    appState.fdaData = {
        documents: [],
        orangeBook: [],
        dailyMed: [],
        warningLetters: []
    };
    
    // Reset phase filter buttons
    document.querySelectorAll('.phase-filter').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
    });
    document.querySelector('.phase-filter[data-phase="all"]').classList.remove('bg-gray-200', 'hover:bg-gray-300');
    document.querySelector('.phase-filter[data-phase="all"]').classList.add('bg-primary', 'text-white');
    
    // 1. HIDE ABSOLUTELY EVERYTHING FIRST
    showSection(elements.resultsOverview, false);
    showSection(elements.studiesSection, false);
    showSection(elements.studyDetailSection, false);
    showSection(elements.fdaDataSection, false);
    showSection(elements.placeholderMessage, false);
    // Hide any other sections that might be visible
    document.querySelectorAll('.results-section').forEach(section => {
        section.style.display = 'none';
    });
    displayLoading(true);
    
    // Now show the placeholder for user feedback
    showSection(elements.placeholderMessage, true);
    
    // Set placeholder message
    elements.placeholderMessage.innerHTML = `
        <div class="text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <p class="text-lg">Searching for data...</p>
        </div>`;
    
    try {
        console.log(`Searching - Drug: ${drug}, Condition: ${condition}, Results Only: ${hasResultsOnly}, TRD Focus: ${trdFocusOnly}`);
        
        // 2. DETERMINE SEARCH TERMS FOR PUBMED
        let pubmedSearchTerm = drug;
        if (condition) {
            pubmedSearchTerm = drug ? `${drug} ${condition}` : condition;
        }
        
        // 3. HANDLE CLINICAL TRIALS SEARCH IF DRUG IS PROVIDED
        let filteredStudies = [];
        
        if (drug) {
            // Fetch studies
            const studies = await fetchStudies(drug, condition, hasResultsOnly);
            console.log(`Retrieved ${studies.length} studies`);
            
            // Filter for TRD-specific studies if requested
            filteredStudies = studies;
            if (trdFocusOnly) {
                filteredStudies = filterTRDSpecificStudies(studies);
                console.log(`Filtered to ${filteredStudies.length} TRD-specific studies`);
            }
            
            appState.studies = filteredStudies;
            collectAllTrialOutcomes();
            
            // Display study-related sections if studies are found
            if (filteredStudies.length > 0) {
                // Display results summary
                displayResultsSummary(filteredStudies);
                showSection(elements.resultsOverview, true);
                
                // Display studies list
                displayStudies(filteredStudies, drug, condition);
                showSection(elements.studiesSection, true);
                
                // Fetch study details for studies with results
                await fetchAllStudyDetails(filteredStudies);
            } else {
                // No studies found - show message
                elements.placeholderMessage.innerHTML = `
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        <p class="text-lg">No ${trdFocusOnly ? 'TRD-specific ' : ''}studies found for "${drug}".</p>
                        <p class="mt-2 text-sm">Other data is displayed below.</p>
                    </div>`;
            }
            
            // 4. ALWAYS DISPLAY ALL DATA FOR DRUG SEARCHES
            
            // FDA Data
            displayFdaData(drug);
            showSection(elements.fdaDataSection, true);
            
            // EMA Data
            EmaDataModule.init();
            EmaDataModule.searchDrug(drug);
            
            // If we also have a condition, get condition-specific data too
            if (condition) {
                console.log(`Getting additional condition data for: ${condition}`);
                displayFdaClinicalData(condition);
                EmaDataModule.searchCondition(condition);
            }
        } else if (condition) {
            // 5. HANDLE CONDITION-ONLY SEARCH
            
            // Fetch studies for condition
            try {
                const studies = await fetchStudies("", condition, hasResultsOnly);
                console.log(`Retrieved ${studies.length} studies for condition: ${condition}`);
                
                // Filter for TRD-specific studies if requested
                filteredStudies = studies;
                if (trdFocusOnly) {
                    filteredStudies = filterTRDSpecificStudies(studies);
                    console.log(`Filtered to ${filteredStudies.length} TRD-specific studies`);
                }
                
                appState.studies = filteredStudies;
                collectAllTrialOutcomes();
                
                // Display study-related sections if studies are found
                if (filteredStudies.length > 0) {
                    // Display results summary
                    displayResultsSummary(filteredStudies);
                    showSection(elements.resultsOverview, true);
                    
                    // Display studies list
                    displayStudies(filteredStudies, "", condition);
                    showSection(elements.studiesSection, true);
                    
                    // Fetch study details for studies with results
                    await fetchAllStudyDetails(filteredStudies);
                } else {
                    // No studies found - show message
                    elements.placeholderMessage.innerHTML = `
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            <p class="text-lg">No ${trdFocusOnly ? 'TRD-specific ' : ''}studies found for condition: "${condition}".</p>
                            <p class="mt-2 text-sm">Other condition data is displayed below.</p>
                        </div>`;
                }
            } catch (error) {
                console.error(`Error fetching studies for condition ${condition}:`, error);
                elements.placeholderMessage.innerHTML = `
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-lg">Error searching for condition studies</p>
                        <p class="mt-2 text-sm">Displaying other condition data below.</p>
                    </div>`;
            }
            
            // Always display condition data regardless of study results
            displayFdaClinicalData(condition);
            
            // Make sure all appropriate sections are shown for condition-only searches
            EmaClinicalDataModule.init();
            EmaClinicalDataModule.searchCondition(condition);
            
            // Show FDA data section for condition
            showSection(elements.fdaDataSection, true);
        }
        
        // 6. ALWAYS SEARCH PUBMED IF TERMS ARE AVAILABLE
        if (pubmedSearchTerm) {
            PubMedModule.searchPubMed(pubmedSearchTerm);
        }
        
        // 7. ENSURE ALL APPROPRIATE SECTIONS ARE VISIBLE AND FINISH LOADING
        if (drug || condition) {
            // Always show FDA section if we have any search criteria
            showSection(elements.fdaDataSection, true);
        }
        
        displayLoading(false);
        
    } catch (error) {
        console.error('Error during search:', error);
        elements.placeholderMessage.innerHTML = `
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-lg">Error searching for studies</p>
                <p class="mt-2 text-sm">Please try again later.</p>
                <p class="mt-2 text-xs text-gray-500">${error.message}</p>
            </div>`;
        displayLoading(false);
    }
}

// Helper function to fetch all study details with a semaphore to limit concurrent requests
async function fetchAllStudyDetails(studies) {
    appState.studyDetails = {};
    const studiesWithResults = studies.filter(study => study.hasResults);
    console.log(`Fetching details for ${studiesWithResults.length} studies with results`);
    
    if (studiesWithResults.length === 0) return;
    
    // Use a semaphore to limit concurrent API calls
    const MAX_CONCURRENT_REQUESTS = 5;
    let activeRequests = 0;
    let requestQueue = [...studiesWithResults];
    let completedRequests = 0;
    
    const processQueue = async () => {
        if (requestQueue.length === 0) return;
        
        while (activeRequests < MAX_CONCURRENT_REQUESTS && requestQueue.length > 0) {
            activeRequests++;
            const study = requestQueue.shift();
            const nctId = study.protocolSection.identificationModule.nctId;
            
            fetchStudyDetails(nctId).then(details => {
                if (details) {
                    appState.studyDetails[nctId] = details;
                }
                
                activeRequests--;
                completedRequests++;
                
                // Update progress if we have a lot of studies
                if (studiesWithResults.length > 10 && completedRequests % 5 === 0) {
                    const progressPercent = Math.round((completedRequests / studiesWithResults.length) * 100);
                    console.log(`Study details progress: ${progressPercent}% (${completedRequests}/${studiesWithResults.length})`);
                }
                
                // Process more from queue
                processQueue();
                
                // If all requests are complete
                if (activeRequests === 0 && requestQueue.length === 0) {
                    console.log('All study details fetched');
                    collectAllTrialOutcomes();
                }
            });
        }
    };
    
    // Start processing the queue
    return processQueue();
}



function extractCommonDepressionMeasures() {
    if (appState.allTrialOutcomes.length === 0) return [];
    
    // Collect all depression-related outcome measures
    const depressionMeasures = new Map();
    
    appState.allTrialOutcomes.forEach(study => {
        study.outcomes.forEach(outcome => {
            const title = outcome.title;
            const titleLower = title.toLowerCase();
            
            // Check if this is a depression scale
            if (titleLower.includes('depression') || 
                titleLower.includes('madrs') || 
                titleLower.includes('ham-d') || 
                titleLower.includes('hamd') || 
                titleLower.includes('qids') || 
                titleLower.includes('beck') || 
                titleLower.includes('phq')) {
                
                if (!depressionMeasures.has(title)) {
                    depressionMeasures.set(title, {
                        title,
                        count: 0,
                        studies: new Set(),
                        experimentalValues: [],
                        controlValues: [],
                        effectSizes: []
                    });
                }
                
                const measureData = depressionMeasures.get(title);
                measureData.count++;
                measureData.studies.add(study.nctId);
                
                if (outcome.experimentalValue !== null) {
                    measureData.experimentalValues.push(outcome.experimentalValue);
                }
                
                if (outcome.controlValue !== null) {
                    measureData.controlValues.push(outcome.controlValue);
                }
                
                if (outcome.effectSize !== null) {
                    measureData.effectSizes.push(outcome.effectSize);
                }
            }
        });
    });
    
    // Convert to array and add statistics
    const result = Array.from(depressionMeasures.values()).map(measure => {
        return {
            title: measure.title,
            count: measure.count,
            studyCount: measure.studies.size,
            avgExperimental: measure.experimentalValues.length > 0 ? 
                calculateMean(measure.experimentalValues) : null,
            avgControl: measure.controlValues.length > 0 ? 
                calculateMean(measure.controlValues) : null,
            avgEffectSize: measure.effectSizes.length > 0 ? 
                calculateMean(measure.effectSizes) : null
        };
    });
    
    // Sort by frequency
    result.sort((a, b) => b.count - a.count);
    
    return result;
}

// Function to create a combined view of treatment efficacy across all depression measures
function createCombinedMeasuresChart() {
    const measures = extractCommonDepressionMeasures();
    if (measures.length === 0) return;
    
    // Get the most common measure to use for comparison
    const commonMeasure = measures[0];
    
    console.log(`Most common depression measure: ${commonMeasure.title} (used in ${commonMeasure.studyCount} studies)`);
    
    // Create a section for this visualization if it doesn't exist
    let measuresSection = document.getElementById('combinedMeasuresSection');
    if (!measuresSection) {
        try {
            const drugSuccessSection = document.getElementById('drugSuccessSection');
            if (!drugSuccessSection) {
                console.error("Drug success section not found, cannot add combined measures section");
                return;
            }
            
            // Create section after the drug success section
            measuresSection = document.createElement('section');
            measuresSection.id = 'combinedMeasuresSection';
            measuresSection.className = 'hidden mb-6'; // Start hidden
            measuresSection.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Treatment Efficacy Across Depression Measures</h2>
                    <p class="text-sm text-gray-600 mb-4">Combined analysis of all trials using standardized depression measures.</p>
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3">Depression Rating Scale Comparison</h3>
                        <div class="h-72">
                            <canvas id="combinedMeasuresChart"></canvas>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3">Most Common Depression Measures</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">Measure</th>
                                        <th class="py-2 px-4 border-b text-left">Studies</th>
                                        <th class="py-2 px-4 border-b text-left">Data Points</th>
                                        <th class="py-2 px-4 border-b text-left">Avg. Effect Size</th>
                                    </tr>
                                </thead>
                                <tbody id="measuresSummaryTable">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            drugSuccessSection.parentNode.insertBefore(measuresSection, drugSuccessSection.nextSibling);
            
            // Add references to the elements object
            elements.combinedMeasuresSection = measuresSection;
            elements.measuresSummaryTable = document.getElementById('measuresSummaryTable');
            
            // Show the section
            showSection(measuresSection, true);
        } catch (error) {
            console.error("Error creating combined measures section:", error);
            return;
        }
    } else {
        // Show the section if it exists
        showSection(measuresSection, true);
    }
    
    try {
        // Create the chart
        const canvas = document.getElementById('combinedMeasuresChart');
        if (!canvas) {
            console.error("Combined measures chart canvas not found");
            return;
        }
        
        // Clear any previous chart
        if (charts.combinedMeasures) {
            charts.combinedMeasures.destroy();
        }
        
        // Filter to measures with effect sizes
        const measuresWithEffects = measures.filter(m => m.avgEffectSize !== null);
        
        if (measuresWithEffects.length === 0) {
            canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No effect size data available for comparison.</p>';
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        // Create the chart
        charts.combinedMeasures = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: measuresWithEffects.map(m => m.title),
                datasets: [{
                    label: 'Average Effect Size',
                    data: measuresWithEffects.map(m => m.avgEffectSize),
                    backgroundColor: measuresWithEffects.map((_, i) => getColorByIndex(i, 0.7)),
                    borderColor: measuresWithEffects.map((_, i) => getColorByIndex(i)),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Effect Size'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Depression Measure'
                        },
                        ticks: {
                            callback: function(value) {
                                // Truncate long labels
                                const label = this.getLabelForValue(value);
                                if (label.length > 25) {
                                    return label.substring(0, 22) + '...';
                                }
                                return label;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return measuresWithEffects[context[0].dataIndex].title;
                            },
                            label: function(context) {
                                const measure = measuresWithEffects[context.dataIndex];
                                return [
                                    `Effect Size: ${measure.avgEffectSize.toFixed(2)}`,
                                    `Studies: ${measure.studyCount}`,
                                    `Data Points: ${measure.count}`
                                ];
                            }
                        }
                    }
                }
            }
        });
        
        // Fill the measures summary table
        const table = elements.measuresSummaryTable;
        if (table) {
            table.innerHTML = '';
            
            measures.forEach(measure => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${measure.title}</td>
                    <td class="py-2 px-4 border-b">${measure.studyCount}</td>
                    <td class="py-2 px-4 border-b">${measure.count}</td>
                    <td class="py-2 px-4 border-b">${measure.avgEffectSize !== null ? measure.avgEffectSize.toFixed(2) : 'N/A'}</td>
                `;
                table.appendChild(row);
            });
        }
    } catch (error) {
        console.error("Error rendering combined measures chart:", error);
        
        // Add error message to section
        measuresSection.querySelector('.bg-white').innerHTML += `
            <div class="bg-red-50 text-red-700 p-4 rounded-lg mt-4">
                <p>Error creating depression measures chart: ${error.message}</p>
                <p class="text-sm mt-2">This is likely due to insufficient data in the available studies.</p>
            </div>
        `;
    }
}
// New function to create a treatment outcome curve showing probability of response
function createTreatmentOutcomeCurve() {
    // Get data points from all studies
    if (appState.allTrialOutcomes.length === 0) return;
    
    // Find response rate outcomes across all studies
    const responseData = [];
    
    appState.allTrialOutcomes.forEach(study => {
        study.outcomes.forEach(outcome => {
            const titleLower = outcome.title.toLowerCase();
            const isResponseOutcome = titleLower.includes(">= 50% improvement") || 
                                    titleLower.includes("responders") || 
                                    titleLower.includes("response rate");
            
            if (isResponseOutcome && outcome.measurements && outcome.measurements.length > 0) {
                // Extract drug name
                const drugName = extractDrugName(study.title, outcome.measurements);
                
                // Get experimental and control measurements
                const experimentalMeasurements = outcome.measurements.filter(m => !m.isControlGroup);
                const controlMeasurements = outcome.measurements.filter(m => m.isControlGroup);
                
                if (experimentalMeasurements.length > 0) {
                    // For response outcomes, measurements are usually percentages
                    experimentalMeasurements.forEach(measurement => {
                        responseData.push({
                            drug: drugName,
                            studyId: study.nctId,
                            phase: study.phase,
                            isControl: false,
                            responseRate: measurement.value
                        });
                    });
                }
                
                if (controlMeasurements.length > 0) {
                    controlMeasurements.forEach(measurement => {
                        responseData.push({
                            drug: "Placebo",
                            studyId: study.nctId,
                            phase: study.phase,
                            isControl: true,
                            responseRate: measurement.value
                        });
                    });
                }
            }
        });
    });
    
    if (responseData.length === 0) return;
    
    console.log(`Found ${responseData.length} response rate data points across all studies`);
    
    // Create a section for this visualization
    let outcomeCurveSection = document.getElementById('outcomeCurveSection');
    if (!outcomeCurveSection) {
        const drugSuccessSection = document.getElementById('drugSuccessSection');
        if (!drugSuccessSection) return;
        
        // Create section before the drug success section
        outcomeCurveSection = document.createElement('section');
        outcomeCurveSection.id = 'outcomeCurveSection';
        outcomeCurveSection.className = 'hidden mb-6';  // Start hidden until we add content
        outcomeCurveSection.innerHTML = `
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Treatment Outcome Curve</h2>
                <p class="text-sm text-gray-600 mb-4">Combined visualization of treatment response rates across all trials.</p>
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-3">Response Rate Distribution</h3>
                    <div class="h-72">
                        <canvas id="treatmentOutcomeCurveChart"></canvas>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-medium mb-3">Treatment vs Placebo Response</h3>
                    <div class="h-72">
                        <canvas id="treatmentVsPlaceboChart"></canvas>
                    </div>
                </div>
            </div>
        `;
        
        drugSuccessSection.parentNode.insertBefore(outcomeCurveSection, drugSuccessSection);
        
        // Add references to the elements object
        elements.outcomeCurveSection = outcomeCurveSection;
    }
    
    // Show the section
    showSection(elements.outcomeCurveSection, true);
    
    try {
        // Create the charts
        createTreatmentOutcomeCurveChart(responseData);
        createTreatmentVsPlaceboChart(responseData);
    } catch (error) {
        console.error("Error creating treatment outcome charts:", error);
        
        // Add error message to section
        outcomeCurveSection.querySelector('.bg-white').innerHTML += `
            <div class="bg-red-50 text-red-700 p-4 rounded-lg mt-4">
                <p>Error creating treatment outcome charts: ${error.message}</p>
                <p class="text-sm mt-2">This is likely due to insufficient response rate data in the available studies.</p>
            </div>
        `;
    }
}
function createTreatmentOutcomeCurveChart(responseData) {
    const canvas = document.getElementById('treatmentOutcomeCurveChart');
    if (!canvas) return;
    
    // Clear any previous chart
    if (charts.treatmentOutcomeCurve) {
        charts.treatmentOutcomeCurve.destroy();
    }
    
    // Group data by drug
    const drugGroups = {};
    responseData.forEach(item => {
        if (!drugGroups[item.drug]) {
            drugGroups[item.drug] = [];
        }
        drugGroups[item.drug].push(item.responseRate);
    });
    
    // Generate curves for each drug
    const datasets = [];
    Object.entries(drugGroups).forEach(([drug, rates], index) => {
        if (rates.length < 2) return; // Need at least 2 data points
        
        // Calculate mean and standard deviation
        const mean = calculateMean(rates);
        const stdDev = calculateStandardDeviation(rates, mean);
        
        // Generate curve data
        const curveData = [];
        for (let x = 0; x <= 100; x += 1) { // 0-100% response rate
            const density = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                          Math.exp(-Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2)));
            curveData.push({x, y: density});
        }
        
        // Add dataset
        datasets.push({
            label: drug,
            data: curveData,
            borderColor: getColorByIndex(index),
            backgroundColor: getColorByIndex(index, 0.1),
            fill: true,
            tension: 0.4,
            pointRadius: 0
        });
    });
    
    const ctx = canvas.getContext('2d');
    
    // Create the chart
    charts.treatmentOutcomeCurve = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Response Rate (%)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Probability Density'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `${context[0].dataset.label}`;
                        },
                        label: function(context) {
                            return `Response Rate: ${context.parsed.x.toFixed(1)}%`;
                        }
                    }
                }
            }
        }
    });
}

function createTreatmentVsPlaceboChart(responseData) {
    const canvas = document.getElementById('treatmentVsPlaceboChart');
    if (!canvas) return;
    
    // Clear any previous chart
    if (charts.treatmentVsPlacebo) {
        charts.treatmentVsPlacebo.destroy();
    }
    
    // Separate treatment and placebo data
    const treatmentData = responseData.filter(item => !item.isControl);
    const placeboData = responseData.filter(item => item.isControl);
    
    if (treatmentData.length === 0 || placeboData.length === 0) {
        canvas.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">Insufficient data for treatment vs placebo comparison.</p>';
        return;
    }
    
    // Calculate statistics
    const treatmentRates = treatmentData.map(item => item.responseRate);
    const placeboRates = placeboData.map(item => item.responseRate);
    
    const treatmentMean = calculateMean(treatmentRates);
    const placeboMean = calculateMean(placeboRates);
    
    const treatmentStdDev = calculateStandardDeviation(treatmentRates, treatmentMean);
    const placeboStdDev = calculateStandardDeviation(placeboRates, placeboMean);
    
    const treatmentCI = calculateConfidenceInterval(treatmentMean, treatmentStdDev, treatmentRates.length);
    const placeboCI = calculateConfidenceInterval(placeboMean, placeboStdDev, placeboRates.length);
    
    const ctx = canvas.getContext('2d');
    
    // Create the chart
    charts.treatmentVsPlacebo = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['All Treatments', 'Placebo'],
            datasets: [{
                label: 'Average Response Rate',
                data: [treatmentMean, placeboMean],
                backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(156, 163, 175, 0.7)'],
                borderColor: ['rgb(59, 130, 246)', 'rgb(156, 163, 175)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Response Rate (%)'
                    },
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const index = context.dataIndex;
                            const label = context.dataset.label;
                            if (index === 0) { // Treatment
                                return [
                                    `${label}: ${treatmentMean.toFixed(1)}%`,
                                    `95% CI: [${treatmentCI.lower.toFixed(1)}, ${treatmentCI.upper.toFixed(1)}]`,
                                    `N = ${treatmentRates.length} data points`
                                ];
                            } else { // Placebo
                                return [
                                    `${label}: ${placeboMean.toFixed(1)}%`,
                                    `95% CI: [${placeboCI.lower.toFixed(1)}, ${placeboCI.upper.toFixed(1)}]`,
                                    `N = ${placeboRates.length} data points`
                                ];
                            }
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'errorBars',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    
                    if (!meta.hidden) {
                        meta.data.forEach((element, index) => {
                            // Error bars data
                            let plus, minus;
                            if (index === 0) { // Treatment
                                plus = treatmentCI.upper - treatmentMean;
                                minus = treatmentMean - treatmentCI.lower;
                            } else { // Placebo
                                plus = placeboCI.upper - placeboMean;
                                minus = placeboMean - placeboCI.lower;
                            }
                            
                            const x = element.x;
                            const y = element.y;
                            const barWidth = 5;
                            
                            // Save state
                            ctx.save();
                            
                            // Line style
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = dataset.borderColor[index];
                            
                            // Draw the line
                            ctx.beginPath();
                            ctx.moveTo(x, y - plus);
                            ctx.lineTo(x, y + minus);
                            ctx.stroke();
                            
                            // Draw the top cap
                            ctx.beginPath();
                            ctx.moveTo(x - barWidth, y - plus);
                            ctx.lineTo(x + barWidth, y - plus);
                            ctx.stroke();
                            
                            // Draw the bottom cap
                            ctx.beginPath();
                            ctx.moveTo(x - barWidth, y + minus);
                            ctx.lineTo(x + barWidth, y + minus);
                            ctx.stroke();
                            
                            // Restore state
                            ctx.restore();
                        });
                    }
                });
            }
        }]
    });
}

function ensureChartCanvasesExist() {
    // Make sure the collated outcomes section is visible
    const collatedSection = document.getElementById('collatedOutcomesSection');
    if (!collatedSection) {
        console.error('Collated outcomes section not found');
        return;
    }
    
    // Find containers for charts or create them
    const chartContainers = collatedSection.querySelectorAll('.h-72');
    
    if (chartContainers.length < 3) {
        console.warn('Chart containers not found, attempting to create them');
        
        // Find the main content div
        const contentDiv = collatedSection.querySelector('.bg-white');
        if (!contentDiv) {
            console.error('Content div not found in collated outcomes section');
            return;
        }
        
        // Create containers if needed
        if (chartContainers.length === 0) {
            console.log('Creating all chart containers');
            // Create first section - Overall Treatment Effect
            const section1 = document.createElement('div');
            section1.className = 'mb-6';
            section1.innerHTML = `
                <h3 class="text-lg font-medium mb-3">Overall Treatment Effect Distribution</h3>
                <div class="flex justify-between mb-4">
                    <div>
                        <select id="outcomeMetricSelector" class="p-2 border border-gray-300 rounded-lg">
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <select id="outcomeTypeSelector" class="p-2 border border-gray-300 rounded-lg">
                            <option value="all">All Outcomes</option>
                            <option value="primary" selected>Primary Outcomes</option>
                            <option value="secondary">Secondary Outcomes</option>
                        </select>
                    </div>
                </div>
                <div class="h-72">
                    <canvas id="overallTreatmentEffectChart"></canvas>
                </div>
            `;
            contentDiv.appendChild(section1);
            
            // Create second section - Phase Comparison
            const section2 = document.createElement('div');
            section2.className = 'mb-6';
            section2.innerHTML = `
                <h3 class="text-lg font-medium mb-3">Phase Comparison</h3>
                <p class="text-sm text-gray-600 mb-4">Compare effect sizes across different clinical trial phases. Higher values indicate better outcomes.</p>
                <div class="h-72">
                    <canvas id="phaseComparisonChart"></canvas>
                </div>
            `;
            contentDiv.appendChild(section2);
            
            // Create third section - Comparative Phase Performance
            const section3 = document.createElement('div');
            section3.className = 'mb-6';
            section3.innerHTML = `
                <h3 class="text-lg font-medium mb-3">Comparative Phase Performance</h3>
                <p class="text-sm text-gray-600 mb-4">Direct comparison of phase-specific effect sizes with confidence intervals.</p>
                <div class="h-72">
                    <canvas id="phasePerformanceChart"></canvas>
                </div>
            `;
            contentDiv.appendChild(section3);
            
            // Update element references
            elements.outcomeMetricSelector = document.getElementById('outcomeMetricSelector');
            elements.outcomeTypeSelector = document.getElementById('outcomeTypeSelector');
            
            // Re-add event listeners
            if (elements.outcomeMetricSelector) {
                elements.outcomeMetricSelector.addEventListener('change', () => {
                    appState.currentOutcomeMetric = elements.outcomeMetricSelector.value;
                    displayCollatedOutcomes();
                });
            }
            
            if (elements.outcomeTypeSelector) {
                elements.outcomeTypeSelector.addEventListener('change', () => {
                    appState.currentOutcomeType = elements.outcomeTypeSelector.value;
                    displayCollatedOutcomes();
                });
            }
        } else {
            // Add missing containers as needed
            const lastContainer = chartContainers[chartContainers.length - 1];
            const parentElement = lastContainer.parentElement;
            
            if (chartContainers.length === 1) {
                // Need to add phase comparison and performance sections
                const section2 = document.createElement('div');
                section2.className = 'mb-6';
                section2.innerHTML = `
                    <h3 class="text-lg font-medium mb-3">Phase Comparison</h3>
                    <p class="text-sm text-gray-600 mb-4">Compare effect sizes across different clinical trial phases. Higher values indicate better outcomes.</p>
                    <div class="h-72">
                        <canvas id="phaseComparisonChart"></canvas>
                    </div>
                `;
                parentElement.parentElement.insertBefore(section2, parentElement.nextSibling);
                
                const section3 = document.createElement('div');
                section3.className = 'mb-6';
                section3.innerHTML = `
                    <h3 class="text-lg font-medium mb-3">Comparative Phase Performance</h3>
                    <p class="text-sm text-gray-600 mb-4">Direct comparison of phase-specific effect sizes with confidence intervals.</p>
                    <div class="h-72">
                        <canvas id="phasePerformanceChart"></canvas>
                    </div>
                `;
                parentElement.parentElement.insertBefore(section3, section2.nextSibling);
            } else if (chartContainers.length === 2) {
                // Need to add phase performance section
                const section3 = document.createElement('div');
                section3.className = 'mb-6';
                section3.innerHTML = `
                    <h3 class="text-lg font-medium mb-3">Comparative Phase Performance</h3>
                    <p class="text-sm text-gray-600 mb-4">Direct comparison of phase-specific effect sizes with confidence intervals.</p>
                    <div class="h-72">
                        <canvas id="phasePerformanceChart"></canvas>
                    </div>
                `;
                parentElement.parentElement.insertBefore(section3, parentElement.nextSibling);
            }
        }
    }
    
    // Ensure chart canvases exist within containers
    const chartCanvases = [
        { id: 'overallTreatmentEffectChart', containerIndex: 0 },
        { id: 'phaseComparisonChart', containerIndex: 1 },
        { id: 'phasePerformanceChart', containerIndex: 2 }
    ];
    
    const updatedContainers = collatedSection.querySelectorAll('.h-72');
    chartCanvases.forEach(({ id, containerIndex }) => {
        if (containerIndex < updatedContainers.length) {
            const container = updatedContainers[containerIndex];
            if (!document.getElementById(id)) {
                console.log(`Creating canvas: ${id}`);
                container.innerHTML = `<canvas id="${id}"></canvas>`;
            }
        }
    });
}
function copyTrialDataToClipboard(nctId) {
const studyDetail = appState.studyDetails[nctId];

if (!studyDetail) {
    alert('Study details not available for copying.');
    return;
}

// Format study data as JSON
const studyData = JSON.stringify(studyDetail, null, 2);

// Create a temporary textarea to facilitate copying
const textarea = document.createElement('textarea');
textarea.value = studyData;
textarea.setAttribute('readonly', '');
textarea.style.position = 'absolute';
textarea.style.left = '-9999px';
document.body.appendChild(textarea);

// Copy the text
textarea.select();
document.execCommand('copy');

// Clean up
document.body.removeChild(textarea);

// Notify user
alert('Study data copied to clipboard.');
}

// Function to copy data from trial to clipboard 
// function copyTrialDataToClipboard(nctId) {
//     const study = appState.studies.find(s => s.protocolSection?.identificationModule?.nctId === nctId);
//     if (!study) return;
    
//     const studyDetail = appState.studyDetails[nctId];
    
//     const identification = study.protocolSection?.identificationModule || {};
//     const design = study.protocolSection?.designModule || {};
    
//     // Create a text summary of the study
//     let summary = `CLINICAL TRIAL SUMMARY\n`;
//     summary += `===================\n\n`;
//     summary += `TITLE: ${identification.briefTitle || 'N/A'}\n`;
//     summary += `NCT ID: ${nctId}\n`;
//     summary += `PHASE: ${formatPhase(design.phases?.[0] || 'N/A')}\n`;
//     summary += `STATUS: ${study.protocolSection?.statusModule?.overallStatus || 'N/A'}\n`;
//     summary += `SPONSOR: ${identification.organization?.fullName || 'N/A'}\n\n`;
    
//     // Add outcome data if available
//     if (studyDetail && studyDetail.resultsSection?.outcomeMeasuresModule?.outcomeMeasures) {
//         const outcomes = studyDetail.resultsSection.outcomeMeasuresModule.outcomeMeasures;
        
//         summary += `OUTCOMES:\n`;
//         outcomes.forEach((outcome, idx) => {
//             summary += `${idx + 1}. ${outcome.title} (${outcome.type})\n`;
//             summary += `   Time Frame: ${outcome.timeFrame || 'Not specified'}\n`;
            
//             if (outcome.classes && outcome.classes[0]?.categories) {
//                 outcome.classes.forEach(cls => {
//                     cls.categories.forEach(cat => {
//                         summary += `   - ${cat.title}:\n`;
                        
//                         cat.measurements.forEach(measurement => {
//                             const group = outcome.groups.find(g => g.id === measurement.groupId);
//                             if (group) {
//                                 summary += `     * ${group.title}: ${measurement.value}`;
//                                 if (measurement.dispersion) {
//                                     summary += `  ${measurement.dispersion} (${measurement.dispersionType || 'dispersion'})`;
//                                 }
//                                 summary += `\n`;
//                             }
//                         });
//                     });
//                 });
//             }
//             summary += `\n`;
//         });
//     }
    
//     // Add URL to the full study
//     summary += `View full study: https://clinicaltrials.gov/study/${nctId}\n`;
    
//     // Create a temporary textarea element to copy the text
//     const textarea = document.createElement('textarea');
//     textarea.value = summary;
//     document.body.appendChild(textarea);
//     textarea.select();
    
//     try {
//         const successful = document.execCommand('copy');
//         const msg = successful ? 'successful' : 'unsuccessful';
//         console.log('Copy trial data was ' + msg);
//         alert('Study details copied to clipboard');
//     } catch (err) {
//         console.error('Error copying trial data: ', err);
//         alert('Failed to copy study details');
//     }
    
//     document.body.removeChild(textarea);
// }
        function initEventListeners() {
            elements.searchButton.addEventListener('click', handleSearch);
            elements.phaseFilter.addEventListener('click', handlePhaseFilter);
            elements.closeStudyDetail.addEventListener('click', () => {
                showSection(elements.studyDetailSection, false);
            });
            
            // Add enter key support for search
            elements.drugSearch.addEventListener('keyup', event => {
                if (event.key === 'Enter') {
                    handleSearch();
                }
            });
            elements.conditionSearch.addEventListener('keyup', event => {
                if (event.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // Add outcome metric selector event
            elements.outcomeMetricSelector.addEventListener('change', () => {
                appState.currentOutcomeMetric = elements.outcomeMetricSelector.value;
                displayCollatedOutcomes();
            });
            
            // Add outcome type selector event
            elements.outcomeTypeSelector.addEventListener('change', () => {
                appState.currentOutcomeType = elements.outcomeTypeSelector.value;
                displayCollatedOutcomes();
            });

            const navbar = document.createElement('div');
    navbar.className = 'fixed bottom-4 left-0 right-0 flex justify-center';
    navbar.innerHTML = `
           <div class="bg-white rounded-full shadow-lg px-4 py-2 flex space-x-4"  style="display: none;">
                <button id="nav-studies" class="text-primary hover:text-blue-700 text-sm font-medium">Studies</button>
                <button id="nav-outcomes" class="text-primary hover:text-blue-700 text-sm font-medium">Outcomes</button>
                <button id="nav-aggregate" class="text-primary hover:text-blue-700 text-sm font-medium">Aggregate</button>
                <button id="nav-drug-success" class="text-primary hover:text-blue-700 text-sm font-medium">Success Rates</button>
                <button id="nav-fda" class="text-primary hover:text-blue-700 text-sm font-medium">FDA Data</button>
            </div>
    `;
    document.body.appendChild(navbar);
    
    // Add event listeners for navigation
    document.getElementById('nav-studies').addEventListener('click', () => {
        elements.studiesSection.scrollIntoView({ behavior: 'smooth' });
    });
    document.getElementById('nav-outcomes').addEventListener('click', () => {
        elements.collatedOutcomesSection.scrollIntoView({ behavior: 'smooth' });
    });
    document.getElementById('nav-aggregate').addEventListener('click', () => {
        elements.aggregateOutcomesSection.scrollIntoView({ behavior: 'smooth' });
    });
    document.getElementById('nav-fda').addEventListener('click', () => {
        elements.fdaDataSection.scrollIntoView({ behavior: 'smooth' });
    });
    document.getElementById('nav-drug-success')?.addEventListener('click', () => {
        elements.drugSuccessSection.scrollIntoView({ behavior: 'smooth' });
    });
    

            
            // Handle window resize to redraw charts
            window.addEventListener('resize', debounce(() => {
                // Only redraw visible charts to improve performance
                const redrawCharts = () => {
                    Object.values(charts).forEach(chart => {
                        if (chart && typeof chart.update === 'function') {
                            try {
                                chart.resize();
                                chart.update();
                            } catch (e) {
                                console.warn('Error updating chart:', e);
                            }
                        }
                    });
                };
                
                redrawCharts();
            }, 250));
        }
        
        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize application
        function init() {
    // Check if all required elements are available
    const missingElements = Object.entries(elements).filter(([key, value]) => !value);
    if (missingElements.length > 0) {
        console.error('Missing required elements:', missingElements.map(([key]) => key));
        
        // Try to get elements again after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            Object.keys(elements).forEach(key => {
                if (!elements[key]) {
                    elements[key] = document.getElementById(key);
                }
            });
            
            initEventListeners();
        });
    } else {
        initEventListeners();
    }
    
    // Set default condition
    if (elements.conditionSearch) {
        elements.conditionSearch.value = "Treatment Resistant Depression";
    }

    
    console.log('Enhanced TRD Clinical Trials Research Tool initialized');
}



// Clinical Trial Dashboard Module
// Robust Clinical Trial Dashboard Module
const TrialDashboard = (function() {
    let chartInstances = {};
    let allTrialsData = null;
    let dashboardInitialized = false;
    
    const COLORS = {
        control: { primary: 'rgba(59, 130, 246, 0.8)', secondary: 'rgba(59, 130, 246, 0.2)' },
        experimental: { primary: 'rgba(16, 185, 129, 0.8)', secondary: 'rgba(16, 185, 129, 0.2)' },
        effect: ['#ebf8ff', '#bee3f8', '#90cdf4', '#63b3ed', '#4299e1', '#3182ce', '#2b6cb0'],
        success: ['#c6f6d5', '#9ae6b4', '#68d391', '#48bb78', '#38a169'],
        status: {
            'COMPLETED': '#10b981',
            'TERMINATED': '#ef4444',
            'ACTIVE': '#f59e0b',
            'RECRUITING': '#6366f1',
            'NOT_YET_RECRUITING': '#8b5cf6',
            'SUSPENDED': '#f43f5e',
            'WITHDRAWN': '#64748b',
            'UNKNOWN': '#9ca3af'
        }
    };

    function init(containerId = 'trial-dashboard') {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container with ID "${containerId}" not found.`);
        return null;
    }
    
    // Set container to full width
    container.classList.add('w-full', 'max-w-full');
    container.innerHTML = '';
    container.style.display = 'none';
    
    // Add custom stylesheet
    addCustomStyles();
    
    dashboardInitialized = true;
    
    // Add export button after dashboard is created
    setTimeout(addExportButton, 500);
    
    return container;
}
    
    function addCustomStyles() {
        const styleId = 'trial-dashboard-styles';
        if (!document.getElementById(styleId)) {
            const style = document.createElement('style');
            style.id = styleId;
            style.textContent = `
                .trial-card {
                    transition: all 0.2s ease-in-out;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
                }
                .trial-card:hover {
                    box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
                }
                .dashboard-header {
                    background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%);
                }
                .status-badge {
                    display: inline-block;
                    padding: 0.25rem 0.5rem;
                    border-radius: 9999px;
                    font-size: 0.75rem;
                    font-weight: 600;
                    text-transform: uppercase;
                    color: white;
                }
                .score-pill {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    width: 3rem;
                    height: 1.5rem;
                    border-radius: 9999px;
                    font-weight: 600;
                    font-size: 0.875rem;
                }
                .tooltip {
                    position: relative;
                    display: inline-block;
                }
                .tooltip .tooltip-text {
                    visibility: hidden;
                    width: 200px;
                    background-color: #333;
                    color: #fff;
                    text-align: center;
                    border-radius: 6px;
                    padding: 5px;
                    position: absolute;
                    z-index: 1;
                    bottom: 125%;
                    left: 50%;
                    margin-left: -100px;
                    opacity: 0;
                    transition: opacity 0.3s;
                }
                .tooltip:hover .tooltip-text {
                    visibility: visible;
                    opacity: 1;
                }
                .toggle-details {
                    cursor: pointer;
                    user-select: none;
                }
                .trial-details {
                    max-height: 0;
                    overflow: hidden;
                    transition: max-height 0.3s ease-out;
                }
                .trial-details.open {
                    max-height: 500px;
                }
            `;
            document.head.appendChild(style);
        }
    }

    function createDashboardStructure(containerId = 'trial-dashboard') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
        <!-- Dashboard header and summary metrics -->
        <div class="dashboard-header w-full p-6 mb-6 rounded-lg">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Clinical Trials Dashboard</h1>
                    <p class="text-gray-600">Comprehensive analysis of trial outcomes and metrics</p>
                </div>
                <div class="flex items-center mt-4 md:mt-0">
                    <div class="bg-white rounded-full shadow-sm px-4 py-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span class="font-medium text-gray-700" id="trials-count">Analyzing trials...</span>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="summary-metrics">
                <!-- Summary metrics will be inserted here -->
            </div>
        </div>
        
        <!-- Success score charts (binomial and distribution) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Success Scores Distribution</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Binomial distribution of success scores across trials</span>
                    </div>
                </div>
                <div class="h-72"><canvas id="successScoresChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Success Score Normal Distribution</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Probability distribution of success scores with mean and standard deviation</span>
                    </div>
                </div>
                <div class="h-72"><canvas id="successDistributionChart"></canvas></div>
            </div>
        </div>
        
        <!-- Phase and status charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Trial Phase Distribution</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Distribution of trials by clinical phase</span>
                    </div>
                </div>
                <div class="h-72"><canvas id="phaseDistributionChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Trial Status Overview</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Current status of all trials in the dataset</span>
                    </div>
                </div>
                <div class="h-72"><canvas id="statusDistributionChart"></canvas></div>
            </div>
        </div>
        
        <!-- Effect size and response/remission -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Effect Size Analysis</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Cohen's d effect sizes across trials with available data</span>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-3" id="effect-size-desc">Analyzing effect sizes across trials...</p>
                <div class="h-64"><canvas id="effectSizeChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow trial-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Response & Remission Rates</h2>
                    <div class="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="tooltip-text">Average difference in response and remission rates between treatment and control groups</span>
                    </div>
                </div>
                <div class="h-64" id="response-remission-chart-container">
                    <canvas id="responseRemissionChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Conclusions section -->
        <div class="bg-white p-5 rounded-lg shadow trial-card mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Key Insights & Conclusions</h2>
                <div class="tooltip">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="tooltip-text">Summary of findings from all analyzed trials</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
                <div>
                    <ul class="space-y-3" id="conclusions-list">
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>Analyzing trial data...</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Trials table -->
        <div class="bg-white p-5 rounded-lg shadow trial-card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Trial Details</h2>
                <div class="flex items-center">
                    <input type="text" id="trial-search" placeholder="Search trials..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <div class="overflow-x-auto" id="trials-table-container">
                <table class="min-w-full divide-y divide-gray-200">
                   <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trial</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phase</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sponsor</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Effect Size</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="trial-summary-body">
                            <!-- Trial data rows will go here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Add search functionality
    const searchInput = document.getElementById('trial-search');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#trial-summary-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
}

// Helper function to get distribution curve data for a given mean and standard deviation
function getNormalDistributionPoints(mean, stdDev, min, max, step) {
    const points = [];
    for (let x = min; x <= max; x += step) {
        // Normal distribution formula
        const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                  Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
        points.push({x, y});
    }
    return points;
}

// Helper function to compare different trial groups by success score
function compareTrialGroups(trialSummaries) {
    // Group trials by phase
    const phaseGroups = {};
    trialSummaries.forEach(summary => {
        const phase = summary.phase || 'UNKNOWN';
        if (!phaseGroups[phase]) {
            phaseGroups[phase] = [];
        }
        phaseGroups[phase].push(summary.successScore);
    });
    
    // Calculate mean and std dev for each phase
    const phaseStats = {};
    Object.keys(phaseGroups).forEach(phase => {
        const scores = phaseGroups[phase];
        const mean = scores.reduce((sum, score) => sum + score, 0) / scores.length;
        const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
        const stdDev = Math.sqrt(variance);
        phaseStats[phase] = { mean, stdDev, count: scores.length };
    });
    
    return phaseStats;
}

// Function to export the dashboard data to CSV
function exportDashboardData() {
    if (!window.globalSuccessData) {
        console.error('No data available to export');
        return;
    }
    
    const data = window.globalSuccessData.trials;
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Add headers
    csvContent += "Trial ID,Title,Phase,Status,Success Score,Effect Size\n";
    
    // Add rows
    data.forEach(trial => {
        csvContent += `${trial.id},"${trial.title.replace(/"/g, '""')}",${trial.phase || 'N/A'},${trial.status || 'N/A'},${trial.score},${trial.effectSize || 'N/A'}\n`;
    });
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "clinical_trials_dashboard_data.csv");
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    document.body.removeChild(link);
}

// Add export button to dashboard
function addExportButton() {
    const header = document.querySelector('.dashboard-header > div');
    if (!header) return;
    
    const exportButton = document.createElement('button');
    exportButton.className = 'ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50';
    exportButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Export Data
    `;
    exportButton.addEventListener('click', exportDashboardData);
    
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'ml-auto';
    buttonContainer.appendChild(exportButton);
    
    header.appendChild(buttonContainer);
}




function loadData(data) {
    const container = document.getElementById('trial-dashboard');
    if (!container) {
        console.error('Container "trial-dashboard" not found');
        return false;
    }

    if (!data || (Array.isArray(data) && data.length === 0)) {
        console.error('No data provided or empty array');
        container.style.display = 'none';
        return false;
    }

    if (!dashboardInitialized) {
        init('trial-dashboard');
    }

    try {
        // Store the data globally
        allTrialsData = data;
        
        // Display the container
        container.style.display = 'block';
        
        // Create dashboard structure
        createDashboardStructure('trial-dashboard');

        // Process all trials and calculate success metrics
        const trialSummaries = processAllTrials(data);
        
        // Store success scores in global variable for external access
        window.globalSuccessData = {
            scores: trialSummaries.map(summary => summary.successScore),
            mean: trialSummaries.reduce((sum, summary) => sum + summary.successScore, 0) / trialSummaries.length,
            trials: trialSummaries.map(summary => ({ 
                id: summary.nctId,
                title: summary.title, 
                score: summary.successScore,
                phase: summary.phase,
                status: summary.status,
                effectSize: summary.effectSize
            }))
        };
        
        // Update trials count
        document.getElementById('trials-count').textContent = `${trialSummaries.length} Trials Analyzed`;
        
        // Populate summary metrics
        populateSummaryMetrics(trialSummaries);
        
        // Populate trials table
        populateSummaryTable(trialSummaries);
        
        // Generate charts
        generateSummaryCharts(trialSummaries);
        
        // Generate conclusions
        generateSummaryConclusions(trialSummaries);

        return true;
    } catch (error) {
        console.error('Error processing data:', error);
        container.style.display = 'none';
        showError('Error processing data: ' + error.message);
        return false;
    }
}
    function showError(message) {
        const container = document.getElementById('trial-dashboard');
        if (!container) return;
        if (!dashboardInitialized) {
            console.error(message);
            return;
        }
        container.innerHTML = `
            <div class="w-full p-8 text-center bg-white rounded-lg shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h1 class="text-2xl font-bold text-red-600 mb-2">Error Loading Data</h1>
                <p class="text-gray-600 mb-4">${message}</p>
                <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" onclick="location.reload()">
                    Try Again
                </button>
            </div>
        `;
        container.style.display = 'block';
    }

    function processAllTrials(data) {
        const trialSummaries = [];
        let totalEffectSize = 0;
        let effectSizeCount = 0;
        let totalResponseDiff = 0;
        let responseCount = 0;
        let totalRemissionDiff = 0;
        let remissionCount = 0;

        data.forEach((trial, index) => {
            const summary = {
                nctId: trial.nctId,
                title: trial.title,
                phase: trial.phase,
                status: trial.status,
                sponsor: trial.sponsor,
                successScore: 0,
                effectSize: null,
                responseDiff: null,
                remissionDiff: null,
                details: [],
                hasOutcomes: trial.outcomes && trial.outcomes.length > 0
            };

            if (!summary.hasOutcomes) {
                // Estimate success based on status and phase
                summary.successScore = calculateFallbackSuccessScore(trial);
                summary.details.push('No outcome data available.');
                trialSummaries.push(summary);
                return;
            }

            // Process outcomes
            const primaryOutcomes = trial.outcomes.filter(outcome => outcome.type.toLowerCase() === 'primary');
            const responderOutcomes = trial.outcomes.filter(outcome => 
                outcome.title.toLowerCase().includes('improvement') || 
                outcome.title.toLowerCase().includes('response') ||
                outcome.title.toLowerCase().includes('>=') // e.g., ">= 50% Improvement"
            );
            const remitterOutcomes = trial.outcomes.filter(outcome => 
                outcome.title.toLowerCase().includes('<=') || // e.g., "<= 10"
                outcome.title.toLowerCase().includes('remission')
            );

            // Calculate effect size
            if (primaryOutcomes.length > 0) {
                const effectSizeResult = calculateEffectSizeForTrial(primaryOutcomes);
                summary.effectSize = effectSizeResult.effectSize;
                summary.details.push(effectSizeResult.detail);
                if (summary.effectSize !== null) {
                    totalEffectSize += summary.effectSize;
                    effectSizeCount++;
                }
            }

            // Calculate response and remission rates
            const successRates = calculateSuccessRatesForTrial(responderOutcomes, remitterOutcomes);
            summary.responseDiff = successRates.responseDiff;
            summary.remissionDiff = successRates.remissionDiff;
            summary.details.push(...successRates.details);
            if (summary.responseDiff !== null) {
                totalResponseDiff += summary.responseDiff;
                responseCount++;
            }
            if (summary.remissionDiff !== null) {
                totalRemissionDiff += summary.remissionDiff;
                remissionCount++;
            }

            // Calculate success score
            summary.successScore = calculateSuccessScore(summary);
            trialSummaries.push(summary);
        });

        // Store averages for charts
        trialSummaries.avgEffectSize = effectSizeCount > 0 ? totalEffectSize / effectSizeCount : null;
        trialSummaries.avgResponseDiff = responseCount > 0 ? totalResponseDiff / responseCount : null;
        trialSummaries.avgRemissionDiff = remissionCount > 0 ? totalRemissionDiff / remissionCount : null;
        
        // Store counts for summary metrics
        trialSummaries.totalTrials = trialSummaries.length;
        trialSummaries.trialsWithOutcomes = trialSummaries.filter(summary => summary.hasOutcomes).length;
        trialSummaries.completedTrials = trialSummaries.filter(summary => summary.status === 'COMPLETED').length;
        trialSummaries.highSuccessTrials = trialSummaries.filter(summary => summary.successScore >= 70).length;

        return trialSummaries;
    }

    function populateSummaryMetrics(trialSummaries) {
        const container = document.getElementById('summary-metrics');
        if (!container) return;
        
        const metrics = [
            {
                label: 'Total Trials',
                value: trialSummaries.totalTrials,
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />',
                color: 'blue'
            },
            {
                label: 'Completed Trials',
                value: trialSummaries.completedTrials,
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />',
                color: 'green'
            },
            {
                label: 'With Outcomes',
                value: trialSummaries.trialsWithOutcomes,
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />',
                color: 'purple'
            },
            {
                label: 'High Success',
                value: trialSummaries.highSuccessTrials,
                icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />',
                color: 'yellow'
            }
        ];
        
        container.innerHTML = '';
        
        metrics.forEach(metric => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow trial-card';
            card.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 p-3 rounded-full bg-${metric.color}-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-${metric.color}-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            ${metric.icon}
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">${metric.label}</p>
                        <p class="text-2xl font-semibold text-gray-900">${metric.value}</p>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function calculateFallbackSuccessScore(trial) {
        let score = 0;
        if (trial.status === 'COMPLETED') score += 50;
        else if (trial.status === 'TERMINATED') score += 20;
        if (trial.phase === 'PHASE4') score += 30;
        else if (trial.phase === 'PHASE3') score += 20;
        else if (trial.phase === 'PHASE2') score += 10;
        return score;
    }

    function calculateEffectSizeForTrial(primaryOutcomes) {
        if (!primaryOutcomes || primaryOutcomes.length === 0) {
            return { effectSize: null, detail: 'No primary outcomes available.' };
        }

        const outcome = primaryOutcomes[0];
        if (!outcome.measurements || outcome.measurements.length < 2) {
            return { effectSize: null, detail: 'Insufficient measurements for effect size.' };
        }

        const controlMeasurements = outcome.measurements.filter(m => m.isControlGroup);
        const expMeasurements = outcome.measurements.filter(m => !m.isControlGroup);

        if (controlMeasurements.length === 0 || expMeasurements.length === 0) {
            return { effectSize: null, detail: 'Missing control or experimental data.' };
        }

        const controlMean = controlMeasurements.reduce((sum, m) => sum + (m.value || 0), 0) / controlMeasurements.length;
        const expMean = expMeasurements.reduce((sum, m) => sum + (m.value || 0), 0) / expMeasurements.length;
        const controlSE = controlMeasurements[0].standardError;
        const expSE = expMeasurements[0].standardError;
        const estimatedSD = controlSE || expSE || (outcome.title.toLowerCase().includes('connectivity') ? 0.1 : 8.5);
        const cohensD = Math.abs(expMean - controlMean) / estimatedSD;

        return {
            effectSize: cohensD,
            detail: `Effect size: d = ${cohensD.toFixed(2)} (${getEffectSizeDescription(cohensD)})`
        };
    }

    function calculateSuccessRatesForTrial(responderOutcomes, remitterOutcomes) {
        const result = {
            responseDiff: null,
            remissionDiff: null,
            details: []
        };

        if (responderOutcomes.length > 0) {
            const outcome = responderOutcomes[responderOutcomes.length - 1];
            if (outcome.measurements && outcome.measurements.length > 0) {
                const controlValues = outcome.measurements.filter(m => m.isControlGroup).map(m => m.value).filter(v => v !== null);
                const expValues = outcome.measurements.filter(m => !m.isControlGroup).map(m => m.value).filter(v => v !== null);

                const controlRate = controlValues.length > 0 ? controlValues.reduce((sum, v) => sum + v, 0) / controlValues.length : 0;
                const expRate = expValues.length > 0 ? expValues.reduce((sum, v) => sum + v, 0) / expValues.length : 0;
                result.responseDiff = expRate - controlRate;
                result.details.push(`Response rate difference: ${result.responseDiff >= 0 ? '+' : ''}${result.responseDiff.toFixed(1)}%`);
            } else {
                result.details.push('No measurements for response rate.');
            }
        } else {
            result.details.push('No response rate data available.');
        }

        if (remitterOutcomes.length > 0) {
            const outcome = remitterOutcomes[remitterOutcomes.length - 1];
            if (outcome.measurements && outcome.measurements.length > 0) {
                const controlValues = outcome.measurements.filter(m => m.isControlGroup).map(m => m.value).filter(v => v !== null);
                const expValues = outcome.measurements.filter(m => !m.isControlGroup).map(m => m.value).filter(v => v !== null);

                const controlRate = controlValues.length > 0 ? controlValues.reduce((sum, v) => sum + v, 0) / controlValues.length : 0;
                const expRate = expValues.length > 0 ? expValues.reduce((sum, v) => sum + v, 0) / expValues.length : 0;
                result.remissionDiff = expRate - controlRate;
                result.details.push(`Remission rate difference: ${result.remissionDiff >= 0 ? '+' : ''}${result.remissionDiff.toFixed(1)}%`);
            } else {
                result.details.push('No measurements for remission rate.');
            }
        } else {
            result.details.push('No remission rate data available.');
        }

        return result;
    }

    function calculateSuccessScore(summary) {
        let score = 0;
        if (summary.hasOutcomes) {
            if (summary.effectSize !== null) {
                // Scale effect size to contribute up to 50 points
                if (summary.effectSize >= 2.0) score += 50;
                else if (summary.effectSize >= 1.2) score += 40;
                else if (summary.effectSize >= 0.8) score += 30;
                else if (summary.effectSize >= 0.5) score += 20;
                else if (summary.effectSize >= 0.2) score += 10;
            }
            if (summary.responseDiff !== null) {
                // Scale response difference to contribute up to 25 points
                if (summary.responseDiff >= 20) score += 25;
                else if (summary.responseDiff >= 10) score += 15;
                else if (summary.responseDiff > 0) score += 5;
            }
            if (summary.remissionDiff !== null) {
                // Scale remission difference to contribute up to 25 points
                if (summary.remissionDiff >= 20) score += 25;
                else if (summary.remissionDiff >= 10) score += 15;
                else if (summary.remissionDiff > 0) score += 5;
            }
        } else {
            // Use fallback score for trials without outcomes
            score = summary.successScore;
        }
        return Math.min(score, 100); // Cap at 100
    }

    function getEffectSizeDescription(cohensD) {
        if (cohensD < 0.2) return 'Negligible clinical effect';
        if (cohensD < 0.5) return 'Small clinical effect';
        if (cohensD < 0.8) return 'Medium clinical effect';
        if (cohensD < 1.2) return 'Large clinical effect';
        if (cohensD < 2.0) return 'Very large clinical effect';
        return 'Huge clinical effect';
    }

    function getScoreColor(score) {
        if (score >= 70) return 'bg-green-500';
        if (score >= 50) return 'bg-blue-500';
        if (score >= 30) return 'bg-yellow-500';
        return 'bg-gray-500';
    }

    function getStatusBadgeColor(status) {
        return COLORS.status[status] || '#9ca3af';
    }

    function populateSummaryTable(trialSummaries) {
        const tbody = document.getElementById('trial-summary-body');
        if (!tbody) return;
        
        tbody.innerHTML = '';

        trialSummaries.forEach((summary, index) => {
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
            
            const detailsId = `trial-details-${index}`;
            const toggleId = `toggle-details-${index}`;
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col">
                        <div class="text-sm font-medium text-gray-900">${summary.nctId}</div>
                        <div class="text-sm text-gray-500">${summary.title.length > 50 ? summary.title.substring(0, 47) + '...' : summary.title}</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                        ${summary.phase || 'N/A'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge" style="background-color: ${getStatusBadgeColor(summary.status)}">
                        ${summary.status || 'Unknown'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${summary.sponsor || 'Not specified'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="score-pill text-white ${getScoreColor(summary.successScore)}">
                        ${summary.successScore.toFixed(0)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${summary.effectSize !== null ? `<span class="font-medium">${summary.effectSize.toFixed(2)}</span> <span class="text-xs">(${getEffectSizeDescription(summary.effectSize)})</span>` : 'N/A'}
                </td>
            `;
            
            tbody.appendChild(row);
            
            // No toggle functionality needed anymore
        });
    }

    // Helper function to calculate percentage of values in normal distribution between two points
function calculatePercentageInRange(mean, stdDev, start, end) {
    // Calculate the probability using cumulative distribution function (CDF)
    function normCDF(x) {
        const t = 1 / (1 + 0.2316419 * Math.abs(x));
        const d = 0.3989423 * Math.exp(-x * x / 2);
        const prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
        return x > 0 ? 1 - prob : prob;
    }
    
    const zStart = (start - mean) / stdDev;
    const zEnd = (end - mean) / stdDev;
    
    return (normCDF(zEnd) - normCDF(zStart)) * 100;
}

    function generateSummaryCharts(trialSummaries) {
    // Store success scores in a global variable
    window.globalSuccessScores = trialSummaries.map(summary => summary.successScore);
    
    // Group success scores for binomial chart
    const bins = [
        {min: 0, max: 10, label: '0-10'},
        {min: 11, max: 20, label: '11-20'},
        {min: 21, max: 30, label: '21-30'},
        {min: 31, max: 40, label: '31-40'},
        {min: 41, max: 50, label: '41-50'},
        {min: 51, max: 60, label: '51-60'},
        {min: 61, max: 70, label: '61-70'},
        {min: 71, max: 80, label: '71-80'},
        {min: 81, max: 90, label: '81-90'},
        {min: 91, max: 100, label: '91-100'}
    ];
    
    // Count trials in each bin
    const binCounts = bins.map(bin => {
        return {
            ...bin,
            count: trialSummaries.filter(summary => 
                summary.successScore >= bin.min && 
                summary.successScore <= bin.max
            ).length
        };
    });
    
    // 1. Success Scores Binomial Distribution Chart
    const successScoresData = {
        labels: binCounts.map(bin => bin.label),
        datasets: [{
            label: 'Number of Trials',
            data: binCounts.map(bin => bin.count),
            backgroundColor: binCounts.map(bin => {
                const midpoint = (bin.min + bin.max) / 2;
                if (midpoint >= 70) return 'rgba(16, 185, 129, 0.8)'; 
                if (midpoint >= 50) return 'rgba(59, 130, 246, 0.8)'; 
                if (midpoint >= 30) return 'rgba(245, 158, 11, 0.8)'; 
                return 'rgba(239, 68, 68, 0.8)';
            }),
            borderColor: 'rgba(255, 255, 255, 0.5)',
            borderWidth: 1,
            borderRadius: 4,
            maxBarThickness: 50
        }]
    };
    
    const successScoresConfig = {
        type: 'bar',
        data: successScoresData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    beginAtZero: true,
                    title: { 
                        display: true, 
                        text: 'Number of Trials',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Success Score Range',
                        font: { weight: 'bold' }
                    }
                }
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            return `Success Score: ${tooltipItems[0].label}`;
                        },
                        label: function(context) {
                            return `${context.raw} trials (${((context.raw / trialSummaries.length) * 100).toFixed(1)}%)`;
                        }
                    }
                }
            }
        }
    };
    createOrUpdateChart('successScoresChart', 'bar', successScoresConfig);

    // 2. Success Score Distribution Curve (Normal Distribution)
    // Calculate mean and standard deviation for success scores
    const scores = trialSummaries.map(summary => summary.successScore);
    const mean = scores.reduce((sum, score) => sum + score, 0) / scores.length;
    const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
    const stdDev = Math.sqrt(variance);
    
    // Create normal distribution data points
    const normalDistPoints = [];
    const step = 1;
    for (let x = 0; x <= 100; x += step) {
        const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                  Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
        normalDistPoints.push({x, y});
    }
    
    // Calculate high, medium, low success bounds for shading
    const highSuccessBound = 70;
    const mediumSuccessBound = 50;
    const lowSuccessBound = 30;
    
    // Get points for different regions
    const highSuccessPoints = normalDistPoints.filter(p => p.x >= highSuccessBound);
    const mediumSuccessPoints = normalDistPoints.filter(p => p.x >= mediumSuccessBound && p.x < highSuccessBound);
    const lowSuccessPoints = normalDistPoints.filter(p => p.x >= lowSuccessBound && p.x < mediumSuccessBound);
    const veryLowSuccessPoints = normalDistPoints.filter(p => p.x < lowSuccessBound);
    
    // Define colors for different sections
    const highColor = 'rgba(16, 185, 129, 0.3)'; // Green
    const mediumColor = 'rgba(59, 130, 246, 0.3)'; // Blue
    const lowColor = 'rgba(245, 158, 11, 0.3)'; // Orange
    const veryLowColor = 'rgba(239, 68, 68, 0.3)'; // Red
    
    // Create chart config
    const distributionConfig = {
        type: 'line',
        data: {
            datasets: [
                // Main curve
                {
                    label: `All Trials (=${mean.toFixed(1)}, =${stdDev.toFixed(1)})`,
                    data: normalDistPoints,
                    borderColor: 'rgba(75, 85, 99, 1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.4
                },
                // Shaded regions
                {
                    label: 'High Success (70-100)',
                    data: highSuccessPoints,
                    borderColor: 'rgba(16, 185, 129, 0.8)',
                    backgroundColor: highColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Medium Success (50-69)',
                    data: mediumSuccessPoints,
                    borderColor: 'rgba(59, 130, 246, 0.8)',
                    backgroundColor: mediumColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Low Success (30-49)',
                    data: lowSuccessPoints,
                    borderColor: 'rgba(245, 158, 11, 0.8)',
                    backgroundColor: lowColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Very Low Success (0-29)',
                    data: veryLowSuccessPoints,
                    borderColor: 'rgba(239, 68, 68, 0.8)',
                    backgroundColor: veryLowColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                // Vertical lines for mean
                {
                    label: 'Mean',
                    data: [
                        {x: mean, y: 0},
                        {x: mean, y: (1 / (stdDev * Math.sqrt(2 * Math.PI)))}
                    ],
                    borderColor: 'rgba(0, 0, 0, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'Success Score',
                        font: { weight: 'bold' }
                    },
                    min: 0,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Probability Density',
                        font: { weight: 'bold' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const datasetLabel = context.dataset.label || '';
                            const x = context.parsed.x;
                            const y = context.parsed.y;
                            if (datasetLabel === 'Mean') {
                                return `Mean score: ${x.toFixed(1)}`;
                            }
                            const percentage = calculatePercentageInRange(
                                mean, stdDev, Math.floor(x), Math.ceil(x)
                            );
                            return `Score ${x.toFixed(0)}: ${(y * 100).toFixed(3)}% density (${percentage.toFixed(1)}% of trials)`;
                        }
                    }
                }
            }
        }
    };
    createOrUpdateChart('successDistributionChart', 'line', distributionConfig);
    
    // 3. Phase Distribution Chart
    const phaseCounts = {};
    trialSummaries.forEach(summary => {
        const phase = summary.phase || 'Not Specified';
        phaseCounts[phase] = (phaseCounts[phase] || 0) + 1;
    });
    const phaseData = {
        labels: Object.keys(phaseCounts),
        datasets: [{
            label: 'Number of Trials',
            data: Object.values(phaseCounts),
            backgroundColor: COLORS.effect.slice(0, Object.keys(phaseCounts).length),
            borderWidth: 1,
            borderColor: '#fff'
        }]
    };
    const phaseConfig = {
        type: 'doughnut',
        data: phaseData,
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    };
    createOrUpdateChart('phaseDistributionChart', 'doughnut', phaseConfig);

    // 4. Status Distribution Chart
    const statusCounts = {};
    trialSummaries.forEach(summary => {
        const status = summary.status || 'UNKNOWN';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
    });
    const statusColors = Object.keys(statusCounts).map(status => getStatusBadgeColor(status));
    const statusData = {
        labels: Object.keys(statusCounts),
        datasets: [{
            label: 'Number of Trials',
            data: Object.values(statusCounts),
            backgroundColor: statusColors,
            borderWidth: 1,
            borderColor: '#fff'
        }]
    };
    const statusConfig = {
        type: 'doughnut',
        data: statusData,
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    };
    createOrUpdateChart('statusDistributionChart', 'doughnut', statusConfig);

    // 5. Effect Size Chart
    const effectSizes = trialSummaries.filter(summary => summary.effectSize !== null);
    effectSizes.sort((a, b) => b.effectSize - a.effectSize);
    const topEffectSizes = effectSizes.slice(0, 10); // Show top 10 for better readability
    
    const effectSizeData = {
        labels: topEffectSizes.map(summary => summary.nctId),
        datasets: [{
            label: 'Effect Size (Cohen\'s d)',
            data: topEffectSizes.map(summary => summary.effectSize),
            backgroundColor: function(context) {
                const value = context.raw;
                if (value >= 0.8) return 'rgba(16, 185, 129, 0.8)'; // Large effect
                if (value >= 0.5) return 'rgba(59, 130, 246, 0.8)'; // Medium effect
                return 'rgba(249, 115, 22, 0.8)'; // Small effect
            },
            borderColor: 'rgba(255, 255, 255, 0.5)',
            borderWidth: 1,
            borderRadius: 4,
            maxBarThickness: 35
        }]
    };
    const effectSizeConfig = {
        type: 'bar',
        data: effectSizeData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: { 
                x: { 
                    beginAtZero: true, 
                    title: { 
                        display: true, 
                        text: 'Effect Size (Cohen\'s d)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const index = tooltipItems[0].dataIndex;
                            return topEffectSizes[index].title;
                        },
                        label: function(context) {
                            const value = context.raw;
                            return `Effect Size: ${value.toFixed(2)} (${getEffectSizeDescription(value)})`;
                        }
                    }
                }
            }
        }
    };
    createOrUpdateChart('effectSizeChart', 'bar', effectSizeConfig);

    document.getElementById('effect-size-desc').textContent = effectSizes.length > 0 
        ? `Average effect size: ${trialSummaries.avgEffectSize.toFixed(2)} (${getEffectSizeDescription(trialSummaries.avgEffectSize)})`
        : 'No effect size data available.';
        
    // 6. Response & Remission Chart
    const responseData = {
        labels: ['Response Rate', 'Remission Rate'],
        datasets: [{
            label: 'Average Difference (%)',
            data: [
                trialSummaries.avgResponseDiff !== null ? trialSummaries.avgResponseDiff : 0,
                trialSummaries.avgRemissionDiff !== null ? trialSummaries.avgRemissionDiff : 0
            ],
            backgroundColor: [COLORS.experimental.primary, COLORS.control.primary],
            borderColor: 'rgba(255, 255, 255, 0.5)',
            borderWidth: 1,
            borderRadius: 4
        }]
    };
    const responseConfig = {
        type: 'bar',
        data: responseData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    title: { 
                        display: true, 
                        text: 'Average Difference (%)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            },
            plugins: { 
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Treatment vs Control Difference',
                    font: { weight: 'bold' }
                }
            }
        }
    };
    createOrUpdateChart('responseRemissionChart', 'bar', responseConfig);
}
    function generateSummaryConclusions(trialSummaries) {
        const conclusionsList = document.getElementById('conclusions-list');
        if (!conclusionsList) return;
        
        conclusionsList.innerHTML = '';

        const conclusions = [];
        
        // Add conclusion items with icons
        const addConclusion = (text, icon, color = 'blue') => {
            const li = document.createElement('li');
            li.className = 'flex items-start mb-3';
            li.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-${color}-500 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    ${icon}
                </svg>
                <span>${text}</span>
            `;
            conclusionsList.appendChild(li);
        };

        // Analysis summary
        addConclusion(
            `Analyzed ${trialSummaries.length} trials with ${trialSummaries.trialsWithOutcomes} providing detailed outcome data.`,
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />'
        );

        // Trial status
        const completedTrials = trialSummaries.filter(summary => summary.status === 'COMPLETED').length;
        const completionRate = ((completedTrials / trialSummaries.length) * 100).toFixed(1);
        addConclusion(
            `${completedTrials} trials were completed (${completionRate}%), ${trialSummaries.length - completedTrials} were terminated or in other states.`,
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />',
            completionRate >= 70 ? 'green' : completionRate >= 50 ? 'yellow' : 'red'
        );

        // Success score
        const avgSuccessScore = trialSummaries.reduce((sum, summary) => sum + summary.successScore, 0) / trialSummaries.length;
        const highSuccessTrials = trialSummaries.filter(summary => summary.successScore >= 70).length;
        const highSuccessRate = ((highSuccessTrials / trialSummaries.length) * 100).toFixed(1);
        addConclusion(
            `Average success score: ${avgSuccessScore.toFixed(1)}. ${highSuccessTrials} trials (${highSuccessRate}%) showed high success (score  70).`,
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />',
            avgSuccessScore >= 70 ? 'green' : avgSuccessScore >= 50 ? 'yellow' : 'gray'
        );

        // Effect size
        if (trialSummaries.avgEffectSize !== null) {
            const effectDescription = getEffectSizeDescription(trialSummaries.avgEffectSize);
            const effectColor = trialSummaries.avgEffectSize >= 0.8 ? 'green' : trialSummaries.avgEffectSize >= 0.5 ? 'blue' : 'yellow';
            addConclusion(
                `Average effect size (Cohen's d): ${trialSummaries.avgEffectSize.toFixed(2)} (${effectDescription}).`,
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />',
                effectColor
            );
        } else {
            addConclusion(
                'No effect size data available across trials.',
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />',
                'gray'
            );
        }

        // Response rate
        if (trialSummaries.avgResponseDiff !== null) {
            const responseColor = trialSummaries.avgResponseDiff >= 15 ? 'green' : trialSummaries.avgResponseDiff >= 5 ? 'blue' : 'yellow';
            addConclusion(
                `Average response rate improvement: ${trialSummaries.avgResponseDiff > 0 ? '+' : ''}${trialSummaries.avgResponseDiff.toFixed(1)}% vs. control.`,
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />',
                responseColor
            );
        }

        // Remission rate
        if (trialSummaries.avgRemissionDiff !== null) {
            const remissionColor = trialSummaries.avgRemissionDiff >= 15 ? 'green' : trialSummaries.avgRemissionDiff >= 5 ? 'blue' : 'yellow';
            addConclusion(
                `Average remission rate improvement: ${trialSummaries.avgRemissionDiff > 0 ? '+' : ''}${trialSummaries.avgRemissionDiff.toFixed(1)}% vs. control.`,
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />',
                remissionColor
            );
        }

        // Disclaimer
        const disclaimer = document.createElement('li');
        disclaimer.className = 'flex items-start mt-4';
        disclaimer.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm text-gray-500 italic">Note: Success scores are estimates and should be reviewed by clinical experts. All analyses are based on available data and may not reflect the complete clinical picture.</span>
        `;
        conclusionsList.appendChild(disclaimer);
    }

    function createOrUpdateChart(canvasId, type, config) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error(`Canvas with ID "${canvasId}" not found`);
            return null;
        }
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        chartInstances[canvasId] = new Chart(canvas, config);
        return chartInstances[canvasId];
    }

    return {
        init: init,
        loadData: loadData
    };
})(); 


















// Usage with your full dataset
document.addEventListener('DOMContentLoaded', function() {
    TrialDashboard.init('trial-dashboard');

    // Your dataset with added mock outcomes for demonstration
    const trialData = [
        {
            nctId: "NCT02196259",
            outcomes: [
                {
                    category: "",
                    controlSampleSize: 0,
                    controlValue: null,
                    effectSize: null,
                    experimentalSampleSize: 0,
                    experimentalValue: null,
                    measurements: [
                        { dispersion: null, dispersionType: null, groupId: "OG000", groupTitle: "Initial MRI", isControlGroup: false, sampleSize: 0, standardError: null, value: 0.3114 },
                        { dispersion: null, dispersionType: null, groupId: "OG001", groupTitle: "Depression", isControlGroup: false, sampleSize: 0, standardError: null, value: 0.3459 }
                    ],
                    timeFrame: "8 minutes scans, acquired between 1 day and 3 days (see above)",
                    title: "Functional Connectivity",
                    type: "primary"
                }
            ],
            phase: "NA",
            sponsor: "University of Michigan",
            status: "TERMINATED",
            title: "Anesthesia and Functional Connectivity: An Analysis of fMRI Changes"
        },
        {
            nctId: "NCT01179009",
            title: "Treatment Resistant Depression (Pilot)",
            phase: "NA",
            sponsor: "Washington University School of Medicine",
            status: "COMPLETED",
            outcomes: [] // No outcomes
        },
        {
            nctId: "NCT01627782",
            title: "A Study of Ketamine in Patients With Treatment-resistant Depression",
            phase: "PHASE2",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: [
                {
                    title: "MADRS Score Reduction",
                    type: "primary",
                    timeFrame: "4 weeks",
                    measurements: [
                        { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 15.2 },
                        { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 5.0 }
                    ]
                },
                {
                    title: "Response Rate (>= 50% Improvement)",
                    type: "secondary",
                    timeFrame: "4 weeks",
                    measurements: [
                        { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 45 },
                        { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 20 }
                    ]
                },
                {
                    title: "Remission Rate (MADRS <= 10)",
                    type: "secondary",
                    timeFrame: "4 weeks",
                    measurements: [
                        { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 30 },
                        { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 10 }
                    ]
                }
            ]
        },
        {
            nctId: "NCT05414422",
            title: "A Randomized, Placebo-Controlled, Double-Blind Study to Assess Safety and Efficacy of PCN-101 in TRD",
            phase: "PHASE2",
            sponsor: "Perception Neuroscience",
            status: "COMPLETED",
            outcomes: [
                {
                    title: "MADRS Score Reduction",
                    type: "primary",
                    timeFrame: "24 hours",
                    measurements: [
                        { groupId: "OG000", groupTitle: "PCN-101", isControlGroup: false, sampleSize: 0, value: 12.5 },
                        { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 4.0 }
                    ]
                }
            ]
        },
        // Add mock outcomes for a few more trials for demonstration
        {
            nctId: "NCT00768430",
            title: "Optimization of IV Ketamine for Treatment Resistant Depression",
            phase: "PHASE2",
            sponsor: "Baylor College of Medicine",
            status: "COMPLETED",
            outcomes: [
                {
                    title: "MADRS Score Reduction",
                    type: "primary",
                    timeFrame: "1 week",
                    measurements: [
                        { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 18.0 },
                        { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 6.0 }
                    ]
                },
                {
                    title: "Response Rate (>= 50% Improvement)",
                    type: "secondary",
                    timeFrame: "1 week",
                    measurements: [
                        { groupId: "OG000", groupTitle: "Ketamine", isControlGroup: false, sampleSize: 0, value: 50 },
                        { groupId: "OG001", groupTitle: "Placebo", isControlGroup: true, sampleSize: 0, value: 15 }
                    ]
                }
            ]
        },
        // Remaining trials without outcomes
        {
            nctId: "NCT02360280",
            title: "Efficacy of Repeated Ketamine Infusions for Treatment-resistant Depression",
            phase: "PHASE2",
            sponsor: "VA Office of Research and Development",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT03756129",
            title: "Proof of Concept Study Evaluating the Efficacy and1 in Patients With Treatment-resistant Depression",
            phase: "PHASE2",
            sponsor: "Novartis",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT01998958",
            title: "A Study to Evaluate the Safety and Efficacy of Intasal Esketamine in Treatment-resistant Depression",
            phase: "PHASE2",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT03113968",
            title: "ELEKT-D: Electroconvulsive Therapy (ECT) vs. Ketamatients With Treatment Resistant Depression (TRD)",
            phase: "PHASE2",
            sponsor: "The Cleveland Clinic",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02935595",
            title: "Low Dose Intravenous Ketamine in Treatment Resistant Depression Patients",
            phase: "PHASE2",
            sponsor: "The University of Texas Health Science Center, Houston",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02078817",
            title: "Ketamine in Adolescents With Treatment-Resistant Depression",
            phase: "PHASE2",
            sponsor: "University of Minnesota",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02918318",
            title: "A Study to Evaluate the Efficacy, Safety and Toler Participants With Treatment Resistant Depression",
            phase: "PHASE2",
            sponsor: "Janssen Pharmaceutical K.K.",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT01920555",
            title: "Double-Blind, Placebo-Controlled Trial of Ketamine Therapy in Treatment-Resistant Depression (TRD)",
            phase: "PHASE2",
            sponsor: "Massachusetts General Hospital",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02422186",
            title: "A Study to Evaluate the Efficacy, Safety, and Tole Participants With Treatment-resistant Depression",
            phase: "PHASE3",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02493868",
            title: "A Study of Intranasal Esketamine Plus an Oral Anti Participants With Treatment-resistant Depression",
            phase: "PHASE3",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02782104",
            title: "A Long-term Safety Study of Esketamine Nasal Spray in Treatment-resistant Depression",
            phase: "PHASE3",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT03434041",
            title: "A Study to Evaluate the Efficacy, Pharmacokinetics Participants With Treatment-resistant Depression",
            phase: "PHASE3",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02556606",
            title: "Ketamine for Treatment Resistant Late-Life Depression",
            phase: "PHASE3",
            sponsor: "VA Office of Research and Development",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT04338321",
            title: "A Long-term Comparison of Esketamine Nasal Spray Vith Treatment Resistant Major Depressive Disorder",
            phase: "PHASE3",
            sponsor: "Janssen-Cilag International NV",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02417064",
            title: "A Study to Evaluate the Efficacy, Safety, and Tole Participants With Treatment-resistant Depression",
            phase: "PHASE3",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT02418585",
            title: "A Study to Evaluate the Efficacy, Safety, and Tole Participants With Treatment-resistant Depression",
            phase: "PHASE3",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT03149991",
            title: "A Study of Brexpiprazole Plus Ketamine in Treatment-Resistant Depression (TRD)",
            phase: "PHASE4",
            sponsor: "Massachusetts General Hospital",
            status: "COMPLETED",
            outcomes: []
        },
        {
            nctId: "NCT04599855",
            title: "A Study of Esketamine Nasal Spray, Administered as Participants With Treatment-resistant Depression",
            phase: "PHASE4",
            sponsor: "Janssen Research & Development, LLC",
            status: "COMPLETED",
            outcomes: []
        }
    ];

    // TrialDashboard.loadData(trialData);
});

  document.addEventListener('DOMContentLoaded', () => {
    const trialSelect = document.getElementById('trial-selection');
    const visualizeBtn = document.getElementById('visualize-btn');
    const loadingIndicator = document.getElementById('loading-indicator');
    const visualizationContainer = document.getElementById('visualization-container');
    

    
    // Event listener for visualize button
    visualizeBtn.addEventListener('click', async () => {

      // Show loading indicator
      loadingIndicator.style.display = 'block';
      visualizationContainer.innerHTML = '';
      
      try {
        // Call backend to fetch trial data and generate visualization
        const result = await generateTrialVisualization();
        console.log(result)
        
        // Insert the generated HTML into the container
        let htmlContent = result.html;
    
    // Remove the outer quotes if they exist
    if (htmlContent.startsWith('"') && htmlContent.endsWith('"')) {
      htmlContent = htmlContent.slice(1, -1);
    }
    
    // Replace escaped newlines and quotes
    htmlContent = htmlContent.replace(/\\n/g, '\n').replace(/\\"/g, '"');
    
    // Extract script content
    const scriptTagMatch = htmlContent.match(/<script>([\s\S]*?)<\/script>/);
    let scriptContent = '';
    
    if (scriptTagMatch && scriptTagMatch[1]) {
      scriptContent = scriptTagMatch[1];
      // Remove the script tag from the HTML so we can add it properly
      htmlContent = htmlContent.replace(/<script>[\s\S]*?<\/script>/, '');
    }
    
    // Insert the HTML
    visualizationContainer.innerHTML = htmlContent;
    
    // Create and execute the script
    if (scriptContent) {
      const script = document.createElement('script');
      script.textContent = scriptContent;
      document.body.appendChild(script);
    }
    
    // If there's separate JavaScript returned as well, execute it too
    if (result.javascript) {
      const script = document.createElement('script');
      script.textContent = result.javascript;
      document.body.appendChild(script);
    }
    
  } catch (error) {
    console.error('Error generating visualization:', error);
    visualizationContainer.innerHTML = `
      <div class="p-4 bg-red-100 text-red-700 rounded">
        Error generating visualization: ${error.message}
      </div>
    `;
  } finally {
    // Hide loading indicator
    loadingIndicator.style.display = 'none';
  }
})
})

  // Function to call the backend
  async function generateTrialVisualization() {
    console.log( appState.allTrialOutcomes)
    a =  appState.allTrialOutcomes
    
    const response = await fetch('https://sunday-fsfq.onrender.com/api/generate-visualization', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({  
        trialData: a 
    })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Failed to generate visualization');
    }
    
    return await response.json();
  }

// EMA Data Module
const EmaDataModule = (function() {
  // DOM elements
  const elements = {
  section: document.getElementById('emaDataSection'),
  lastUpdated: document.getElementById('emaDataLastUpdated'),
  refreshBtn: document.getElementById('refreshEmaDataBtn'),
  approvalCount: document.getElementById('emaApprovalCount'),
  orphanCount: document.getElementById('emaOrphanCount'),
  safetyCount: document.getElementById('emaSafetyCount'),
  psusaCount: document.getElementById('emaPsusaCount'),
  shortagesCount: document.getElementById('emaShortagesCount'),
  referralsCount: document.getElementById('emaReferralsCount'),
  approvalData: document.getElementById('emaApprovalData'),
  orphanData: document.getElementById('emaOrphanData'),
  safetyData: document.getElementById('emaSafetyData'),
  psusaData: document.getElementById('emaPsusaData'),
  shortagesData: document.getElementById('emaShortagesData'),
  referralsData: document.getElementById('emaReferralsData'),
  uploadStatus: document.getElementById('uploadStatus'),
  // Form elements
  dhpcUploadForm: document.getElementById('dhpcUploadForm'),
  psusaUploadForm: document.getElementById('psusaUploadForm'),
  shortagesUploadForm: document.getElementById('shortagesUploadForm'),
  medicinesUploadForm: document.getElementById('medicinesUploadForm'),
  referralsUploadForm: document.getElementById('referralsUploadForm'),
  // File inputs
  dhpcFileInput: document.getElementById('dhpcFileInput'),
  psusaFileInput: document.getElementById('psusaFileInput'),
  shortagesFileInput: document.getElementById('shortagesFileInput'),
  medicinesFileInput: document.getElementById('medicinesFileInput'),
  referralsFileInput: document.getElementById('referralsFileInput'),
  dataAdmin: document.getElementById('emaDataAdmin')
};

  // Initialize the module
  function init() {
    // Initialize tab navigation
    initTabNavigation();
    
    // Initialize file upload forms
    initFileUploadForms();
    
    // Add refresh button event listener
    if (elements.refreshBtn) {
      elements.refreshBtn.addEventListener('click', refreshEmaData);
    }
    
    // Check data status on initialization
    checkEmaDataStatus();
    
    // Hide admin section by default (can be shown based on user role)
    toggleAdminSection(false);
    
    console.log('EMA Data Module initialized');
  }

  // Initialize tab navigation
  function initTabNavigation() {
    const tabButtons = document.querySelectorAll('.ema-tab-button');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        // Hide all tab panes
        document.querySelectorAll('.ema-tab-pane').forEach(pane => {
          pane.classList.add('hidden');
          pane.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        tabButtons.forEach(btn => {
          btn.classList.remove('border-blue-500', 'text-blue-600');
          btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
          btn.setAttribute('aria-selected', 'false');
        });
        
        // Activate the clicked tab
        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById(tabId).classList.add('active');
        
        // Activate the clicked tab button
        this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        this.classList.add('border-blue-500', 'text-blue-600');
        this.setAttribute('aria-selected', 'true');
      });
    });
  }

  // Initialize file upload forms
  function initFileUploadForms() {
  // DHPC Upload Form
  if (elements.dhpcUploadForm) {
    elements.dhpcUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('dhpc', elements.dhpcFileInput.files[0]);
    });
  }
  
  // PSUSA Upload Form
  if (elements.psusaUploadForm) {
    elements.psusaUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('psusa', elements.psusaFileInput.files[0]);
    });
  }
  
  // Shortages Upload Form
  if (elements.shortagesUploadForm) {
    elements.shortagesUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('shortages', elements.shortagesFileInput.files[0]);
    });
  }
  
  // Medicines Upload Form
  if (elements.medicinesUploadForm) {
    elements.medicinesUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('medicines', elements.medicinesFileInput.files[0]);
    });
  }
  
  // Referrals Upload Form
  if (elements.referralsUploadForm) {
    elements.referralsUploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      uploadFile('referrals', elements.referralsFileInput.files[0]);
    });
  }
}

  // Show the EMA data section
  function showSection(show = true) {
    if (elements.section) {
      elements.section.classList.toggle('hidden', !show);
    }
  }

  // Toggle admin section visibility
  function toggleAdminSection(show = false) {
    if (elements.dataAdmin) {
      elements.dataAdmin.classList.toggle('hidden', !show);
    }
  }

  // Check EMA data status
  async function checkEmaDataStatus() {
    try {
      showLoadingState(elements.lastUpdated, true);
      
      const response = await fetch('/api/ema/status');
      const data = await response.json();
      
      if (response.ok) {
        updateLastUpdated(data.status);
      } else {
        showError('Error checking EMA data status');
        console.error('Error checking EMA data status:', data.error);
      }
      
      showLoadingState(elements.lastUpdated, false);
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error checking EMA data status:', error);
      showLoadingState(elements.lastUpdated, false);
    }
  }

  // Update last updated timestamp
  function updateLastUpdated(statusData) {
    if (!elements.lastUpdated) return;
    
    let lastUpdateDate = null;
    
    // Find the most recent update across all data types
    for (const dataType in statusData) {
      if (statusData[dataType].available && statusData[dataType].lastUpdated) {
        const updateDate = new Date(statusData[dataType].lastUpdated);
        if (!lastUpdateDate || updateDate > lastUpdateDate) {
          lastUpdateDate = updateDate;
        }
      }
    }
    
    if (lastUpdateDate) {
      elements.lastUpdated.textContent = `Last updated: ${formatDate(lastUpdateDate)}`;
    } else {
      elements.lastUpdated.textContent = 'Data not yet available';
    }
  }

  // Refresh EMA data
  async function refreshEmaData() {
    try {
      if (!elements.refreshBtn) return;
      
      // Disable refresh button and show loading state
      elements.refreshBtn.disabled = true;
      elements.refreshBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refreshing...
      `;
      
      const response = await fetch('/api/ema/refresh', { method: 'POST' });
      const data = await response.json();
      
      if (response.ok) {
        updateLastUpdated(data.status);
        showToast('EMA data refreshed successfully', 'success');
      } else {
        showError('Error refreshing EMA data');
        console.error('Error refreshing EMA data:', data.error);
      }
      
      // Re-enable refresh button
      elements.refreshBtn.disabled = false;
      elements.refreshBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refresh
      `;
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error refreshing EMA data:', error);
      
      // Re-enable refresh button
      if (elements.refreshBtn) {
        elements.refreshBtn.disabled = false;
        elements.refreshBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        `;
      }
    }
  }

  // Search EMA data for a specific drug
  async function searchDrug(drugName) {
    if (!drugName) return;
    
    try {
      // Show loading state for all data containers
      showLoadingState(elements.approvalData);
      showLoadingState(elements.orphanData);
      showLoadingState(elements.safetyData);
      showLoadingState(elements.psusaData);
      showLoadingState(elements.shortagesData);
      
      // Show the EMA section
      showSection(true);

      console.log("fetching ema data")
      const response = await fetch(`/api/ema/drug/${encodeURIComponent(drugName)}`);
      const data = await response.json();
      
      if (response.ok) {
        console.log(data)
        displayEmaData(data);
      } else {
        showError('Error searching EMA data');
        console.error('Error searching EMA data:', data.error);
        
        // Show empty state for all data containers
        showEmptyState(elements.approvalData, 'No EMA approval data found for this drug.');
        showEmptyState(elements.orphanData, 'No orphan designation data found for this drug.');
        showEmptyState(elements.safetyData, 'No safety communication data found for this drug.');
        showEmptyState(elements.psusaData, 'No PSUSA data found for this drug.');
        showEmptyState(elements.shortagesData, 'No shortage data found for this drug.');
      }
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error searching EMA data:', error);
      
      // Show empty state for all data containers
      showEmptyState(elements.approvalData, 'Error loading EMA approval data.');
      showEmptyState(elements.orphanData, 'Error loading orphan designation data.');
      showEmptyState(elements.safetyData, 'Error loading safety communication data.');
      showEmptyState(elements.psusaData, 'Error loading PSUSA data.');
      showEmptyState(elements.shortagesData, 'Error loading shortages data.');
    }
  }

  // Display EMA data in the UI
// Update the display functions in the EMA Data Module to handle the raw CSV data structure

// Display approval data
function displayApprovalData(data) {
  if (!elements.approvalData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.approvalData, 'No human medicine approval data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine Name</th>
            <th>Status</th>
            <th>Active Substance</th>
            <th>Therapeutic Area</th>
            <th>Authorization Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Extract relevant fields based on the raw data structure
    const medicineName = item._1 || 'Unknown';
    const status = item._3 || 'Unknown';
    const substance = item._6 || item._7 || 'Not specified';
    const therapeuticArea = item._8 || item._13 || 'Not specified';
    const authDate = item._29 || item._31 || item._36 || 'Unknown';
    const indication = item._15 || '';
    const emaLink = item._38 || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('authorised') || status.toLowerCase().includes('authorized')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('refused')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('withdrawn')) {
      statusClass = 'bg-gray-100 text-gray-800';
    } else if (status.toLowerCase().includes('pending')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicineName}</div>
          ${item._2 ? `<div class="text-xs text-gray-500">Procedure: ${item._2}</div>` : ''}
        </td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${substance}</td>
        <td>${formatTherapeuticArea(therapeuticArea)}</td>
        <td>${formatDate(authDate)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          ${indication ? `<div class="text-xs text-gray-600 mt-1">Indication: ${indication}</div>` : ''}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.approvalData.innerHTML = html;
}

// Display orphan designation data
function displayOrphanData(data) {
  if (!elements.orphanData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.orphanData, 'No orphan designation data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine Name</th>
            <th>Condition</th>
            <th>Status</th>
            <th>Decision Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicineName = item['Orphan designation'] || item._1 || 'Unknown';
    const condition = findFieldInItem(item, ['condition', '_2', '_3']) || 'Not specified';
    const status = findFieldInItem(item, ['status', '_4', '_5']) || 'Unknown';
    const decisionDate = findFieldInItem(item, ['date', '_6', '_7']) || 'Unknown';
    const sponsor = findFieldInItem(item, ['sponsor', '_8', '_9']) || '';
    const emaLink = findFieldInItem(item, ['_20', '_21', '_22']) || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('positive')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('negative')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('withdrawn')) {
      statusClass = 'bg-gray-100 text-gray-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicineName}</div>
          ${sponsor ? `<div class="text-xs text-gray-500">Sponsor: ${sponsor}</div>` : ''}
        </td>
        <td>${condition}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(decisionDate)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.orphanData.innerHTML = html;
}

// Display safety communication data
function displaySafetyData(data) {
  if (!elements.safetyData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.safetyData, 'No safety communication data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Medicine</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const title = item['Direct healthcare professional communication (DHPC)'] || 
                  findFieldInItem(item, ['_1', '_2']) || 'Unknown';
    const medicine = findFieldInItem(item, ['medicine', '_3', '_4']) || 'Not specified';
    const date = findFieldInItem(item, ['date', '_5', '_6']) || 'Unknown';
    const reason = findFieldInItem(item, ['reason', '_7', '_8']) || '';
    const emaLink = findFieldInItem(item, ['_15', '_16', '_17']) || '';
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${title}</div>
        </td>
        <td>${medicine}</td>
        <td>${formatDate(date)}</td>
        <td>
          ${reason ? `<div class="text-xs text-gray-600 mb-1">Reason: ${reason}</div>` : ''}
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.safetyData.innerHTML = html;
}

// Display PSUSA data
function displayPsusaData(data) {
  if (!elements.psusaData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.psusaData, 'No PSUSA data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Substance</th>
            <th>Procedure</th>
            <th>Outcome</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const substance = item['Periodic safety update report single assessments (PSUSA)'] || 
                     item._1 || 
                     item._2 || 'Unknown';
    const procedure = item._4 || 'Not specified';
    const outcome = item._5 || 'Unknown';
    const date = item._6 || 'Unknown';
    const emaLink = item._8 || '';
    
    // Determine outcome badge class
    let outcomeClass = 'bg-gray-100 text-gray-800';
    if (outcome.toLowerCase().includes('variation')) {
      outcomeClass = 'bg-yellow-100 text-yellow-800';
    } else if (outcome.toLowerCase().includes('maintenance')) {
      outcomeClass = 'bg-green-100 text-green-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${substance}</div>
        </td>
        <td>${procedure}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${outcomeClass}">
            ${outcome}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.psusaData.innerHTML = html;
}

// Display Referrals data
function displayReferralsData(data) {
  if (!elements.referralsData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.referralsData, 'No referral data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine</th>
            <th>Substance</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicine = item._1 || 'Unknown';
    const substance = item._2 || 'Not specified';
    const status = item._3 || 'Unknown';
    const procedure = item._9 || '';
    const date = findFieldInItem(item, ['_17', '_18', '_19']) || 'Unknown';
    const emaLink = item._21 || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('final') || status.toLowerCase().includes('concluded')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('ongoing')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicine}</div>
        </td>
        <td>${substance}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${procedure ? `<div class="text-xs text-gray-600 mb-1">Procedure: ${procedure}</div>` : ''}
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.referralsData.innerHTML = html;
}

// Display Shortages data
function displayShortagesData(data) {
  if (!elements.shortagesData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.shortagesData, 'No shortage data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicine = item.Shortage || item._1 || 'Unknown';
    const reason = findFieldInItem(item, ['reason', '_4', '_5']) || 'Not specified';
    const status = findFieldInItem(item, ['status', '_6', '_7']) || 'Unknown';
    const date = findFieldInItem(item, ['date', '_8', '_9']) || 'Unknown';
    const emaLink = findFieldInItem(item, ['_13', '_14', '_15']) || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('ongoing')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('resolved')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('expected')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicine}</div>
        </td>
        <td>${reason}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.shortagesData.innerHTML = html;
}

// Helper function to find field in an item with numeric keys (_0, _1, etc.)
function findFieldInItem(item, possibleKeys) {
  // First try the exact keys
  for (const key of possibleKeys) {
    if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
      return item[key];
    }
  }
  
  // If not found, try all numeric keys
  for (let i = 0; i < 40; i++) {
    const key = `_${i}`;
    if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
      // Try to determine if this is the field we're looking for
      // This is a simplistic approach and might need refinement
      const value = item[key].toString().toLowerCase();
      
      // Check if this might be a date
      if (possibleKeys.includes('date') && (value.includes('/') || value.match(/\d{2}\.\d{2}\.\d{4}/))) {
        return item[key];
      }
      
      // Check if this might be a status
      if (possibleKeys.includes('status') && 
          (value.includes('authorised') || value.includes('withdrawn') || 
           value.includes('ongoing') || value.includes('resolved'))) {
        return item[key];
      }
      
      // Check if this might be a reason
      if (possibleKeys.includes('reason') && 
          value.length > 10 && (value.includes('due to') || value.includes('because'))) {
        return item[key];
      }
    }
  }
  
  return null;
}

// Update display EMA data to include referrals
function displayEmaData(data) {
  const { results, total } = data;
  
  // Filter out veterinary products
  Object.keys(results).forEach(key => {
    if (Array.isArray(results[key])) {
      results[key] = results[key].filter(item => !item._0 || item._0.toLowerCase() !== 'veterinary');
      // Update totals after filtering
      total[key] = results[key].length;
    }
  });
  
  // Update counters
  updateCounter(elements.approvalCount, total.medicines, 'approval', 'approvals');
  updateCounter(elements.orphanCount, total.orphans, 'designation', 'designations');
  updateCounter(elements.safetyCount, total.dhpc, 'communication', 'communications');
  updateCounter(elements.psusaCount, total.psusa, 'report', 'reports');
  updateCounter(elements.shortagesCount, total.shortages, 'shortage', 'shortages');
  updateCounter(elements.referralsCount, total.referrals, 'referral', 'referrals');
  
  // Display approval data
  if (results.medicines && results.medicines.length > 0) {
    displayApprovalData(results.medicines);
  } else {
    showEmptyState(elements.approvalData, 'No EMA approval data found for this drug.');
  }
  
  // Display orphan designation data
  if (results.orphans && results.orphans.length > 0) {
    displayOrphanData(results.orphans);
  } else {
    showEmptyState(elements.orphanData, 'No orphan designation data found for this drug.');
  }
  
  // Display safety communication data
  if (results.dhpc && results.dhpc.length > 0) {
    displaySafetyData(results.dhpc);
  } else {
    showEmptyState(elements.safetyData, 'No safety communication data found for this drug.');
  }
  
  // Display PSUSA data
  if (results.psusa && results.psusa.length > 0) {
    displayPsusaData(results.psusa);
  } else {
    showEmptyState(elements.psusaData, 'No PSUSA data found for this drug.');
  }
  
  // Display Referrals data
  if (results.referrals && results.referrals.length > 0) {
    displayReferralsData(results.referrals);
  } else {
    showEmptyState(elements.referralsData, 'No referral data found for this drug.');
  }
  
  // Display Shortages data
  if (results.shortages && results.shortages.length > 0) {
    displayShortagesData(results.shortages);
  } else {
    showEmptyState(elements.shortagesData, 'No shortage data found for this drug.');
  }
}
  // Display approval data
  function displayApprovalData(data) {
  if (!elements.approvalData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.approvalData, 'No human medicine approval data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine Name</th>
            <th>Status</th>
            <th>Active Substance</th>
            <th>Therapeutic Area</th>
            <th>Authorization Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Extract relevant fields based on the raw data structure
    const medicineName = item._1 || 'Unknown';
    const status = item._3 || 'Unknown';
    const substance = item._6 || item._7 || 'Not specified';
    const therapeuticArea = item._8 || item._13 || 'Not specified';
    const authDate = item._29 || item._31 || item._36 || 'Unknown';
    const indication = item._15 || '';
    const emaLink = item._38 || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('authorised') || status.toLowerCase().includes('authorized')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('refused')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('withdrawn')) {
      statusClass = 'bg-gray-100 text-gray-800';
    } else if (status.toLowerCase().includes('pending')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicineName}</div>
          ${item._2 ? `<div class="text-xs text-gray-500">Procedure: ${item._2}</div>` : ''}
        </td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${substance}</td>
        <td>${formatTherapeuticArea(therapeuticArea)}</td>
        <td>${formatDate(authDate)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          ${indication ? `<div class="text-xs text-gray-600 mt-1">Indication: ${indication}</div>` : ''}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.approvalData.innerHTML = html;
}

function displayOrphanData(data) {
  if (!elements.orphanData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.orphanData, 'No orphan designation data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine Name</th>
            <th>Condition</th>
            <th>Status</th>
            <th>Decision Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicineName = item['Orphan designation'] || item._1 || 'Unknown';
    const condition = findFieldInItem(item, ['condition', '_2', '_3']) || 'Not specified';
    const status = findFieldInItem(item, ['status', '_4', '_5']) || 'Unknown';
    const decisionDate = findFieldInItem(item, ['date', '_6', '_7']) || 'Unknown';
    const sponsor = findFieldInItem(item, ['sponsor', '_8', '_9']) || '';
    const emaLink = findFieldInItem(item, ['_20', '_21', '_22']) || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('positive')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('negative')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('withdrawn')) {
      statusClass = 'bg-gray-100 text-gray-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicineName}</div>
          ${sponsor ? `<div class="text-xs text-gray-500">Sponsor: ${sponsor}</div>` : ''}
        </td>
        <td>${condition}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(decisionDate)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.orphanData.innerHTML = html;
}
  
function displaySafetyData(data) {
  if (!elements.safetyData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.safetyData, 'No safety communication data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Medicine</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const title = item['Direct healthcare professional communication (DHPC)'] || 
                  findFieldInItem(item, ['_1', '_2']) || 'Unknown';
    const medicine = findFieldInItem(item, ['medicine', '_3', '_4']) || 'Not specified';
    const date = findFieldInItem(item, ['date', '_5', '_6']) || 'Unknown';
    const reason = findFieldInItem(item, ['reason', '_7', '_8']) || '';
    const emaLink = findFieldInItem(item, ['_15', '_16', '_17']) || '';
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${title}</div>
        </td>
        <td>${medicine}</td>
        <td>${formatDate(date)}</td>
        <td>
          ${reason ? `<div class="text-xs text-gray-600 mb-1">Reason: ${reason}</div>` : ''}
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.safetyData.innerHTML = html;
}

// Display PSUSA data
function displayPsusaData(data) {
  if (!elements.psusaData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.psusaData, 'No PSUSA data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Substance</th>
            <th>Procedure</th>
            <th>Outcome</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const substance = item['Periodic safety update report single assessments (PSUSA)'] || 
                     item._1 || 
                     item._2 || 'Unknown';
    const procedure = item._4 || 'Not specified';
    const outcome = item._5 || 'Unknown';
    const date = item._6 || 'Unknown';
    const emaLink = item._8 || '';
    
    // Determine outcome badge class
    let outcomeClass = 'bg-gray-100 text-gray-800';
    if (outcome.toLowerCase().includes('variation')) {
      outcomeClass = 'bg-yellow-100 text-yellow-800';
    } else if (outcome.toLowerCase().includes('maintenance')) {
      outcomeClass = 'bg-green-100 text-green-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${substance}</div>
        </td>
        <td>${procedure}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${outcomeClass}">
            ${outcome}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.psusaData.innerHTML = html;
}

// Display Referrals data
function displayReferralsData(data) {
  if (!elements.referralsData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.referralsData, 'No referral data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine</th>
            <th>Substance</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicine = item._1 || 'Unknown';
    const substance = item._2 || 'Not specified';
    const status = item._3 || 'Unknown';
    const procedure = item._9 || '';
    const date = findFieldInItem(item, ['_17', '_18', '_19']) || 'Unknown';
    const emaLink = item._21 || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('final') || status.toLowerCase().includes('concluded')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('ongoing')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicine}</div>
        </td>
        <td>${substance}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${procedure ? `<div class="text-xs text-gray-600 mb-1">Procedure: ${procedure}</div>` : ''}
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.referralsData.innerHTML = html;
}

// Display Shortages data
function displayShortagesData(data) {
  if (!elements.shortagesData) return;
  
  // Filter out veterinary products
  const filteredData = data.filter(item => {
    return !item._0 || item._0.toLowerCase() !== 'veterinary';
  });
  
  if (filteredData.length === 0) {
    showEmptyState(elements.shortagesData, 'No shortage data found for this drug.');
    return;
  }
  
  let html = `
    <div class="overflow-x-auto">
      <table class="ema-data-table">
        <thead>
          <tr>
            <th>Medicine</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  filteredData.forEach(item => {
    // Find fields based on your CSV structure
    const medicine = item.Shortage || item._1 || 'Unknown';
    const reason = findFieldInItem(item, ['reason', '_4', '_5']) || 'Not specified';
    const status = findFieldInItem(item, ['status', '_6', '_7']) || 'Unknown';
    const date = findFieldInItem(item, ['date', '_8', '_9']) || 'Unknown';
    const emaLink = findFieldInItem(item, ['_13', '_14', '_15']) || '';
    
    // Determine status badge class
    let statusClass = 'bg-gray-100 text-gray-800';
    if (status.toLowerCase().includes('ongoing')) {
      statusClass = 'bg-red-100 text-red-800';
    } else if (status.toLowerCase().includes('resolved')) {
      statusClass = 'bg-green-100 text-green-800';
    } else if (status.toLowerCase().includes('expected')) {
      statusClass = 'bg-yellow-100 text-yellow-800';
    }
    
    html += `
      <tr>
        <td>
          <div class="font-medium">${medicine}</div>
        </td>
        <td>${reason}</td>
        <td>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${status}
          </span>
        </td>
        <td>${formatDate(date)}</td>
        <td>
          ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  elements.shortagesData.innerHTML = html;
}

// Helper function to find field in an item with numeric keys (_0, _1, etc.)
function findFieldInItem(item, possibleKeys) {
  // First try the exact keys
  for (const key of possibleKeys) {
    if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
      return item[key];
    }
  }
  
  // If not found, try all numeric keys
  for (let i = 0; i < 40; i++) {
    const key = `_${i}`;
    if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
      // Try to determine if this is the field we're looking for
      // This is a simplistic approach and might need refinement
      const value = item[key].toString().toLowerCase();
      
      // Check if this might be a date
      if (possibleKeys.includes('date') && (value.includes('/') || value.match(/\d{2}\.\d{2}\.\d{4}/))) {
        return item[key];
      }
      
      // Check if this might be a status
      if (possibleKeys.includes('status') && 
          (value.includes('authorised') || value.includes('withdrawn') || 
           value.includes('ongoing') || value.includes('resolved'))) {
        return item[key];
      }
      
      // Check if this might be a reason
      if (possibleKeys.includes('reason') && 
          value.length > 10 && (value.includes('due to') || value.includes('because'))) {
        return item[key];
      }
    }
  }
  
  return null;
}

// Helper function to find a field value in an object using various possible keys
  function findField(obj, possibleKeys) {
    for (const key of possibleKeys) {
      if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') {
        return obj[key];
      }
    }
    
    // Try matching keys by pattern
    for (const objKey in obj) {
      for (const possibleKey of possibleKeys) {
        if (objKey.toLowerCase().includes(possibleKey.toLowerCase()) && 
            obj[objKey] !== undefined && obj[objKey] !== null && obj[objKey] !== '') {
          return obj[objKey];
        }
      }
    }
    
    return null;
  }

  // Upload a file to the server
  async function uploadFile(fileType, file) {
    if (!file) {
      showUploadStatus('Please select a file', 'error');
      return;
    }
    
    try {
      // Create form data
      const formData = new FormData();
      formData.append('file', file);
      
      // Show loading state
      showUploadStatus('Uploading file...', 'loading');
      
      // Send request
      const response = await fetch(`/api/ema/upload/${fileType}`, {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showUploadStatus(`File uploaded successfully. Processed ${data.records} records.`, 'success');
        
        // Clear file input
        if (fileType === 'dhpc' && elements.dhpcFileInput) {
          elements.dhpcFileInput.value = '';
        } else if (fileType === 'psusa' && elements.psusaFileInput) {
          elements.psusaFileInput.value = '';
        } else if (fileType === 'shortages' && elements.shortagesFileInput) {
          elements.shortagesFileInput.value = '';
        }
        
        // Refresh EMA data status
        checkEmaDataStatus();
      } else {
        showUploadStatus(`Error: ${data.error}`, 'error');
        console.error('Error uploading file:', data.error);
      }
    } catch (error) {
      showUploadStatus('Error connecting to server', 'error');
      console.error('Error uploading file:', error);
    }
  }

  // Show upload status message
  function showUploadStatus(message, type = 'info') {
    if (!elements.uploadStatus) return;
    
    let bgColor = 'bg-blue-50';
    let textColor = 'text-blue-800';
    let icon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
    
    if (type === 'success') {
      bgColor = 'bg-green-50';
      textColor = 'text-green-800';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
    } else if (type === 'error') {
      bgColor = 'bg-red-50';
      textColor = 'text-red-800';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    } else if (type === 'loading') {
      bgColor = 'bg-blue-50';
      textColor = 'text-blue-800';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      `;
    }
    
    elements.uploadStatus.innerHTML = `
      <div class="flex items-center p-4 ${bgColor} ${textColor} rounded-lg">
        ${icon}
        <span>${message}</span>
      </div>
    `;
    
    elements.uploadStatus.classList.remove('hidden');
    
    // Hide the status message after 5 seconds if it's a success message
    if (type === 'success') {
      setTimeout(() => {
        elements.uploadStatus.classList.add('hidden');
      }, 5000);
    }
  }

  // Update counter
  function updateCounter(element, count, singular, plural) {
    if (!element) return;
    
    element.textContent = `${count} ${count === 1 ? singular : plural}`;
  }

  // Show loading state
  function showLoadingState(element, isText = false) {
    if (!element) return;
    
    if (isText) {
      element.innerHTML = `
        <span class="animate-pulse">Loading...</span>
      `;
    } else {
      element.innerHTML = `
        <div class="ema-loading-state">
          <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-8 w-8 text-blue-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <p class="text-center text-gray-500">Loading data...</p>
        </div>
      `;
    }
  }

  // Show empty state
  function showEmptyState(element, message) {
    if (!element) return;
    
    element.innerHTML = `
      <div class="ema-empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="text-center text-gray-500">${message}</p>
      </div>
    `;
  }

  // Format date
  function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return dateString; // Return the original string if it's not a valid date
      }
      
      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    } catch (error) {
      return dateString;
    }
  }

  // Format therapeutic area
  function formatTherapeuticArea(area) {
    if (!area) return 'Not specified';
    
    // Split by commas and create badges
    const areas = area.split(',').map(a => a.trim()).filter(a => a);
    
    if (areas.length === 0) return 'Not specified';
    
    return areas.map(a => `
      <span class="inline-block px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded-full mb-1 mr-1">
        ${a}
      </span>
    `).join('');
  }

  // Show error toast
  function showError(message) {
    showToast(message, 'error');
  }

  // Show toast message
  function showToast(message, type = 'info') {
    // Check if toast container exists, if not create it
    let toastContainer = document.getElementById('toast-container');
    
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col space-y-2';
      document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    
    let bgColor = 'bg-blue-500';
    let icon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
    
    if (type === 'success') {
      bgColor = 'bg-green-500';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
    } else if (type === 'error') {
      bgColor = 'bg-red-500';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    } else if (type === 'warning') {
      bgColor = 'bg-yellow-500';
      icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      `;
    }
    
    toast.className = `flex items-center p-3 rounded-lg text-white ${bgColor} shadow-lg transition-opacity duration-500`;
    toast.innerHTML = `
      ${icon}
      <span>${message}</span>
      <button class="ml-4 text-white focus:outline-none hover:text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    `;
    
    // Add click event to close button
    const closeButton = toast.querySelector('button');
    closeButton.addEventListener('click', () => {
      toast.style.opacity = '0';
      setTimeout(() => {
        toastContainer.removeChild(toast);
      }, 500);
    });
    
    // Add toast to container
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode === toastContainer) {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (toast.parentNode === toastContainer) {
            toastContainer.removeChild(toast);
          }
        }, 500);
      }
    }, 5000);
  }

  // Set user role (admin or regular user)
  function setUserRole(role) {
    const isAdmin = role === 'admin';
    toggleAdminSection(isAdmin);
  }

  // Check if user is authenticated and has the correct role
  async function checkUserPermissions() {
    try {
      const response = await fetch('/api/auth/user');
      const data = await response.json();
      
      if (response.ok && data.authenticated) {
        // Check if user has admin role for EMA data
        const hasEmaAdminRole = data.roles && data.roles.includes('ema_admin');
        setUserRole(hasEmaAdminRole ? 'admin' : 'user');
        
        return hasEmaAdminRole;
      } else {
        setUserRole('user');
        return false;
      }
    } catch (error) {
      console.error('Error checking user permissions:', error);
      setUserRole('user');
      return false;
    }
  }

  // Add CSS styles for EMA data tables
  function addTableStyles() {
    const styleId = 'ema-data-table-styles';
    
    // Check if styles already exist
    if (document.getElementById(styleId)) {
      return;
    }
    
    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.textContent = `
      .ema-data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      .ema-data-table th {
        background-color: #f8fafc;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .ema-data-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .ema-data-table tbody tr:hover {
        background-color: #f9fafb;
      }
      
      .ema-empty-state, .ema-loading-state {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
      }
    `;
    
    document.head.appendChild(styleElement);
  }

  // Export functions for external use
  return {
    init,
    searchDrug,
    showSection,
    toggleAdminSection,
    refreshEmaData,
    checkEmaDataStatus,
    checkUserPermissions
  };
})();

const EmaClinicalDataModule = (function() {
  // DOM elements (unchanged from original)
  const elements = {
    section: document.getElementById('emaDataSection'),
    lastUpdated: document.getElementById('emaDataLastUpdated'),
    refreshBtn: document.getElementById('refreshEmaDataBtn'),
    approvalCount: document.getElementById('emaApprovalCount'),
    orphanCount: document.getElementById('emaOrphanCount'),
    safetyCount: document.getElementById('emaSafetyCount'),
    psusaCount: document.getElementById('emaPsusaCount'),
    shortagesCount: document.getElementById('emaShortagesCount'),
    referralsCount: document.getElementById('emaReferralsCount'),
    approvalData: document.getElementById('emaApprovalData'),
    orphanData: document.getElementById('emaOrphanData'),
    safetyData: document.getElementById('emaSafetyData'),
    psusaData: document.getElementById('emaPsusaData'),
    shortagesData: document.getElementById('emaShortagesData'),
    referralsData: document.getElementById('emaReferralsData'),
    uploadStatus: document.getElementById('uploadStatus'),
    dhpcUploadForm: document.getElementById('dhpcUploadForm'),
    psusaUploadForm: document.getElementById('psusaUploadForm'),
    shortagesUploadForm: document.getElementById('shortagesUploadForm'),
    medicinesUploadForm: document.getElementById('medicinesUploadForm'),
    referralsUploadForm: document.getElementById('referralsUploadForm'),
    dhpcFileInput: document.getElementById('dhpcFileInput'),
    psusaFileInput: document.getElementById('psusaFileInput'),
    shortagesFileInput: document.getElementById('shortagesFileInput'),
    medicinesFileInput: document.getElementById('medicinesFileInput'),
    referralsFileInput: document.getElementById('referralsFileInput'),
    dataAdmin: document.getElementById('emaDataAdmin')
  };

  // Initialize the module
  function init() {
    initTabNavigation();
    initFileUploadForms();
    if (elements.refreshBtn) {
      elements.refreshBtn.addEventListener('click', refreshEmaData);
    }
    checkEmaDataStatus();
    toggleAdminSection(false);
    addTableStyles();
    console.log('EMA Clinical Data Module initialized');
  }

  // Tab navigation and file upload forms remain unchanged
  function initTabNavigation() {
    const tabButtons = document.querySelectorAll('.ema-tab-button');
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        document.querySelectorAll('.ema-tab-pane').forEach(pane => {
          pane.classList.add('hidden');
          pane.classList.remove('active');
        });
        tabButtons.forEach(btn => {
          btn.classList.remove('border-blue-500', 'text-blue-600');
          btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
          btn.setAttribute('aria-selected', 'false');
        });
        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById(tabId).classList.add('active');
        this.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
        this.classList.add('border-blue-500', 'text-blue-600');
        this.setAttribute('aria-selected', 'true');
      });
    });
  }

  function initFileUploadForms() {
    if (elements.dhpcUploadForm) {
      elements.dhpcUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('dhpc', elements.dhpcFileInput.files[0]);
      });
    }
    if (elements.psusaUploadForm) {
      elements.psusaUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('psusa', elements.psusaFileInput.files[0]);
      });
    }
    if (elements.shortagesUploadForm) {
      elements.shortagesUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('shortages', elements.shortagesFileInput.files[0]);
      });
    }
    if (elements.medicinesUploadForm) {
      elements.medicinesUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('medicines', elements.medicinesFileInput.files[0]);
      });
    }
    if (elements.referralsUploadForm) {
      elements.referralsUploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('referrals', elements.referralsFileInput.files[0]);
      });
    }
  }

  // New function to search by condition
  async function searchCondition(condition) {
    if (!condition) {
      showError('Please provide a clinical condition to search.');
      return;
    }

    try {
      showLoadingState(elements.approvalData);
      showLoadingState(elements.orphanData);
      showLoadingState(elements.safetyData);
      showLoadingState(elements.psusaData);
      showLoadingState(elements.shortagesData);
      showLoadingState(elements.referralsData);
      showSection(true);

      console.log(`Fetching EMA data for condition: ${condition}`);
      const response = await fetch(`/api/ema/condition/${encodeURIComponent(condition)}`);
      const data = await response.json();

      if (response.ok) {
        console.log(data);
        displayEmaClinicalData(data, condition);
      } else {
        showError(`Error searching EMA data for ${condition}`);
        console.error('Error searching EMA data:', data.error);
        showEmptyState(elements.approvalData, `No EMA approval data found for ${condition}.`);
        showEmptyState(elements.orphanData, `No orphan designation data found for ${condition}.`);
        showEmptyState(elements.safetyData, `No safety communication data found for ${condition}.`);
        showEmptyState(elements.psusaData, `No PSUSA data found for ${condition}.`);
        showEmptyState(elements.shortagesData, `No shortage data found for ${condition}.`);
        showEmptyState(elements.referralsData, `No referral data found for ${condition}.`);
      }
    } catch (error) {
      showError('Error connecting to server');
      console.error(`Error searching EMA data for ${condition}:`, error);
      showEmptyState(elements.approvalData, 'Error loading EMA approval data.');
      showEmptyState(elements.orphanData, 'Error loading orphan designation data.');
      showEmptyState(elements.safetyData, 'Error loading safety communication data.');
      showEmptyState(elements.psusaData, 'Error loading PSUSA data.');
      showEmptyState(elements.shortagesData, 'Error loading shortages data.');
      showEmptyState(elements.referralsData, 'Error loading referrals data.');
    }
  }

  // Updated display function for condition-based data
  function displayEmaClinicalData(data, condition) {
    const { results, total } = data;

    // Filter out veterinary products
    Object.keys(results).forEach(key => {
      if (Array.isArray(results[key])) {
        results[key] = results[key].filter(item => !item._0 || item._0.toLowerCase() !== 'veterinary');
        total[key] = results[key].length;
      }
    });

    // Update counters with total number of records
    updateCounter(elements.approvalCount, total.medicines, 'approval', 'approvals');
    updateCounter(elements.orphanCount, total.orphans, 'designation', 'designations');
    updateCounter(elements.safetyCount, total.dhpc, 'communication', 'communications');
    updateCounter(elements.psusaCount, total.psusa, 'report', 'reports');
    updateCounter(elements.shortagesCount, total.shortages, 'shortage', 'shortages');
    updateCounter(elements.referralsCount, total.referrals, 'referral', 'referrals');

    // Display data for each category
    displayClinicalApprovalData(results.medicines, condition);
    displayClinicalOrphanData(results.orphans, condition);
    displayClinicalSafetyData(results.dhpc, condition);
    displayClinicalPsusaData(results.psusa, condition);
    displayClinicalShortagesData(results.shortages, condition);
    displayClinicalReferralsData(results.referrals, condition);
  }

  // Clinical display functions
  function displayClinicalApprovalData(data, condition) {
    if (!elements.approvalData || !data || data.length === 0) {
      showEmptyState(elements.approvalData, `No EMA approval data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Approved Medicines for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Medicine Name</th>
              <th>Status</th>
              <th>Active Substance</th>
              <th>Therapeutic Area</th>
              <th>Authorization Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const medicineName = item._1 || 'Unknown';
      const status = item._3 || 'Unknown';
      const substance = item._6 || item._7 || 'Not specified';
      const therapeuticArea = item._8 || item._13 || 'Not specified';
      const authDate = item._29 || item._31 || item._36 || 'Unknown';
      const indication = item._15 || '';
      const emaLink = item._38 || '';

      let statusClass = 'bg-gray-100 text-gray-800';
      if (status.toLowerCase().includes('authorised') || status.toLowerCase().includes('authorized')) {
        statusClass = 'bg-green-100 text-green-800';
      } else if (status.toLowerCase().includes('refused')) {
        statusClass = 'bg-red-100 text-red-800';
      } else if (status.toLowerCase().includes('withdrawn')) {
        statusClass = 'bg-gray-100 text-gray-800';
      } else if (status.toLowerCase().includes('pending')) {
        statusClass = 'bg-yellow-100 text-yellow-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${medicineName}</div>
            ${item._2 ? `<div class="text-xs text-gray-500">Procedure: ${item._2}</div>` : ''}
          </td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${status}
            </span>
          </td>
          <td>${substance}</td>
          <td>${formatTherapeuticArea(therapeuticArea)}</td>
          <td>${formatDate(authDate)}</td>
          <td>
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
            ${indication ? `<div class="text-xs text-gray-600 mt-1">Indication: ${indication}</div>` : ''}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.approvalData.innerHTML = html;
  }

  function displayClinicalOrphanData(data, condition) {
    if (!elements.orphanData || !data || data.length === 0) {
      showEmptyState(elements.orphanData, `No orphan designation data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Orphan Designations for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Medicine Name</th>
              <th>Condition</th>
              <th>Status</th>
              <th>Decision Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const medicineName = item['Orphan designation'] || item._1 || 'Unknown';
      const orphanCondition = findFieldInItem(item, ['condition', '_2', '_3']) || 'Not specified';
      const status = findFieldInItem(item, ['status', '_4', '_5']) || 'Unknown';
      const decisionDate = findFieldInItem(item, ['date', '_6', '_7']) || 'Unknown';
      const sponsor = findFieldInItem(item, ['sponsor', '_8', '_9']) || '';
      const emaLink = findFieldInItem(item, ['_20', '_21', '_22']) || '';

      let statusClass = 'bg-gray-100 text-gray-800';
      if (status.toLowerCase().includes('positive')) {
        statusClass = 'bg-green-100 text-green-800';
      } else if (status.toLowerCase().includes('negative')) {
        statusClass = 'bg-red-100 text-red-800';
      } else if (status.toLowerCase().includes('withdrawn')) {
        statusClass = 'bg-gray-100 text-gray-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${medicineName}</div>
            ${sponsor ? `<div class="text-xs text-gray-500">Sponsor: ${sponsor}</div>` : ''}
          </td>
          <td>${orphanCondition}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${status}
            </span>
          </td>
          <td>${formatDate(decisionDate)}</td>
          <td>
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.orphanData.innerHTML = html;
  }

  function displayClinicalSafetyData(data, condition) {
    if (!elements.safetyData || !data || data.length === 0) {
      showEmptyState(elements.safetyData, `No safety communication data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Safety Communications for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Medicine</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const title = item['Direct healthcare professional communication (DHPC)'] || findFieldInItem(item, ['_1', '_2']) || 'Unknown';
      const medicine = findFieldInItem(item, ['medicine', '_3', '_4']) || 'Not specified';
      const date = findFieldInItem(item, ['date', '_5', '_6']) || 'Unknown';
      const reason = findFieldInItem(item, ['reason', '_7', '_8']) || '';
      const emaLink = findFieldInItem(item, ['_15', '_16', '_17']) || '';

      html += `
        <tr>
          <td>
            <div class="font-medium">${title}</div>
          </td>
          <td>${medicine}</td>
          <td>${formatDate(date)}</td>
          <td>
            ${reason ? `<div class="text-xs text-gray-600 mb-1">Reason: ${reason}</div>` : ''}
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.safetyData.innerHTML = html;
  }

  function displayClinicalPsusaData(data, condition) {
    if (!elements.psusaData || !data || data.length === 0) {
      showEmptyState(elements.psusaData, `No PSUSA data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">PSUSA Reports for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Substance</th>
              <th>Procedure</th>
              <th>Outcome</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const substance = item['Periodic safety update report single assessments (PSUSA)'] || item._1 || item._2 || 'Unknown';
      const procedure = item._4 || 'Not specified';
      const outcome = item._5 || 'Unknown';
      const date = item._6 || 'Unknown';
      const emaLink = item._8 || '';

      let outcomeClass = 'bg-gray-100 text-gray-800';
      if (outcome.toLowerCase().includes('variation')) {
        outcomeClass = 'bg-yellow-100 text-yellow-800';
      } else if (outcome.toLowerCase().includes('maintenance')) {
        outcomeClass = 'bg-green-100 text-green-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${substance}</div>
          </td>
          <td>${procedure}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${outcomeClass}">
              ${outcome}
            </span>
          </td>
          <td>${formatDate(date)}</td>
          <td>
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.psusaData.innerHTML = html;
  }

  function displayClinicalShortagesData(data, condition) {
    if (!elements.shortagesData || !data || data.length === 0) {
      showEmptyState(elements.shortagesData, `No shortage data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Shortages for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Medicine</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const medicine = item.Shortage || item._1 || 'Unknown';
      const reason = findFieldInItem(item, ['reason', '_4', '_5']) || 'Not specified';
      const status = findFieldInItem(item, ['status', '_6', '_7']) || 'Unknown';
      const date = findFieldInItem(item, ['date', '_8', '_9']) || 'Unknown';
      const emaLink = findFieldInItem(item, ['_13', '_14', '_15']) || '';

      let statusClass = 'bg-gray-100 text-gray-800';
      if (status.toLowerCase().includes('ongoing')) {
        statusClass = 'bg-red-100 text-red-800';
      } else if (status.toLowerCase().includes('resolved')) {
        statusClass = 'bg-green-100 text-green-800';
      } else if (status.toLowerCase().includes('expected')) {
        statusClass = 'bg-yellow-100 text-yellow-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${medicine}</div>
          </td>
          <td>${reason}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${status}
            </span>
          </td>
          <td>${formatDate(date)}</td>
          <td>
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.shortagesData.innerHTML = html;
  }

  function displayClinicalReferralsData(data, condition) {
    if (!elements.referralsData || !data || data.length === 0) {
      showEmptyState(elements.referralsData, `No referral data found for ${condition}.`);
      return;
    }

    let html = `
      <div class="overflow-x-auto">
        <h2 class="text-lg font-semibold mb-2">Referrals for ${condition}</h2>
        <table class="ema-data-table">
          <thead>
            <tr>
              <th>Medicine</th>
              <th>Substance</th>
              <th>Status</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
    `;

    data.forEach(item => {
      const medicine = item._1 || 'Unknown';
      const substance = item._2 || 'Not specified';
      const status = item._3 || 'Unknown';
      const procedure = item._9 || '';
      const date = findFieldInItem(item, ['_17', '_18', '_19']) || 'Unknown';
      const emaLink = item._21 || '';

      let statusClass = 'bg-gray-100 text-gray-800';
      if (status.toLowerCase().includes('final') || status.toLowerCase().includes('concluded')) {
        statusClass = 'bg-green-100 text-green-800';
      } else if (status.toLowerCase().includes('ongoing')) {
        statusClass = 'bg-yellow-100 text-yellow-800';
      }

      html += `
        <tr>
          <td>
            <div class="font-medium">${medicine}</div>
          </td>
          <td>${substance}</td>
          <td>
            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
              ${status}
            </span>
          </td>
          <td>${formatDate(date)}</td>
          <td>
            ${procedure ? `<div class="text-xs text-gray-600 mb-1">Procedure: ${procedure}</div>` : ''}
            ${emaLink ? `<a href="${emaLink}" target="_blank" class="text-blue-600 hover:underline">EMA Page</a>` : 'N/A'}
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
    elements.referralsData.innerHTML = html;
  }

  // Helper functions (mostly unchanged)
  function showSection(show = true) {
    if (elements.section) {
      elements.section.classList.toggle('hidden', !show);
    }
  }

  function toggleAdminSection(show = false) {
    if (elements.dataAdmin) {
      elements.dataAdmin.classList.toggle('hidden', !show);
    }
  }

  async function checkEmaDataStatus() {
    try {
      showLoadingState(elements.lastUpdated, true);
      const response = await fetch('/api/ema/status');
      const data = await response.json();
      if (response.ok) {
        updateLastUpdated(data.status);
      } else {
        showError('Error checking EMA data status');
        console.error('Error checking EMA data status:', data.error);
      }
      showLoadingState(elements.lastUpdated, false);
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error checking EMA data status:', error);
      showLoadingState(elements.lastUpdated, false);
    }
  }

  function updateLastUpdated(statusData) {
    if (!elements.lastUpdated) return;
    let lastUpdateDate = null;
    for (const dataType in statusData) {
      if (statusData[dataType].available && statusData[dataType].lastUpdated) {
        const updateDate = new Date(statusData[dataType].lastUpdated);
        if (!lastUpdateDate || updateDate > lastUpdateDate) {
          lastUpdateDate = updateDate;
        }
      }
    }
    elements.lastUpdated.textContent = lastUpdateDate 
      ? `Last updated: ${formatDate(lastUpdateDate)}` 
      : 'Data not yet available';
  }

  async function refreshEmaData() {
    try {
      if (!elements.refreshBtn) return;
      elements.refreshBtn.disabled = true;
      elements.refreshBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refreshing...
      `;
      const response = await fetch('/api/ema/refresh', { method: 'POST' });
      const data = await response.json();
      if (response.ok) {
        updateLastUpdated(data.status);
        showToast('EMA data refreshed successfully', 'success');
      } else {
        showError('Error refreshing EMA data');
        console.error('Error refreshing EMA data:', data.error);
      }
      elements.refreshBtn.disabled = false;
      elements.refreshBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refresh
      `;
    } catch (error) {
      showError('Error connecting to server');
      console.error('Error refreshing EMA data:', error);
      if (elements.refreshBtn) {
        elements.refreshBtn.disabled = false;
        elements.refreshBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        `;
      }
    }
  }

  async function uploadFile(fileType, file) {
    if (!file) {
      showUploadStatus('Please select a file', 'error');
      return;
    }
    try {
      const formData = new FormData();
      formData.append('file', file);
      showUploadStatus('Uploading file...', 'loading');
      const response = await fetch(`/api/ema/upload/${fileType}`, {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      if (response.ok) {
        showUploadStatus(`File uploaded successfully. Processed ${data.records} records.`, 'success');
        if (fileType === 'dhpc' && elements.dhpcFileInput) elements.dhpcFileInput.value = '';
        else if (fileType === 'psusa' && elements.psusaFileInput) elements.psusaFileInput.value = '';
        else if (fileType === 'shortages' && elements.shortagesFileInput) elements.shortagesFileInput.value = '';
        else if (fileType === 'medicines' && elements.medicinesFileInput) elements.medicinesFileInput.value = '';
        else if (fileType === 'referrals' && elements.referralsFileInput) elements.referralsFileInput.value = '';
        checkEmaDataStatus();
      } else {
        showUploadStatus(`Error: ${data.error}`, 'error');
        console.error('Error uploading file:', data.error);
      }
    } catch (error) {
      showUploadStatus('Error connecting to server', 'error');
      console.error('Error uploading file:', error);
    }
  }

  function showUploadStatus(message, type = 'info') {
    if (!elements.uploadStatus) return;
    let bgColor = 'bg-blue-50', textColor = 'text-blue-800', icon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
    if (type === 'success') {
      bgColor = 'bg-green-50'; textColor = 'text-green-800'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
    } else if (type === 'error') {
      bgColor = 'bg-red-50'; textColor = 'text-red-800'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    } else if (type === 'loading') {
      bgColor = 'bg-blue-50'; textColor = 'text-blue-800'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      `;
    }
    elements.uploadStatus.innerHTML = `
      <div class="flex items-center p-4 ${bgColor} ${textColor} rounded-lg">
        ${icon}
        <span>${message}</span>
      </div>
    `;
    elements.uploadStatus.classList.remove('hidden');
    if (type === 'success') setTimeout(() => elements.uploadStatus.classList.add('hidden'), 5000);
  }

  function updateCounter(element, count, singular, plural) {
    if (!element) return;
    element.textContent = `${count} ${count === 1 ? singular : plural}`;
  }

  function showLoadingState(element, isText = false) {
    if (!element) return;
    if (isText) {
      element.innerHTML = `<span class="animate-pulse">Loading...</span>`;
    } else {
      element.innerHTML = `
        <div class="ema-loading-state">
          <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-8 w-8 text-blue-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <p class="text-center text-gray-500">Loading data...</p>
        </div>
      `;
    }
  }

  function showEmptyState(element, message) {
    if (!element) return;
    element.innerHTML = `
      <div class="ema-empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="text-center text-gray-500">${message}</p>
      </div>
    `;
  }

  function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    } catch (error) {
      return dateString;
    }
  }

  function formatTherapeuticArea(area) {
    if (!area) return 'Not specified';
    const areas = area.split(',').map(a => a.trim()).filter(a => a);
    if (areas.length === 0) return 'Not specified';
    return areas.map(a => `
      <span class="inline-block px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded-full mb-1 mr-1">
        ${a}
      </span>
    `).join('');
  }

  function findFieldInItem(item, possibleKeys) {
    for (const key of possibleKeys) {
      if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
        return item[key];
      }
    }
    for (let i = 0; i < 40; i++) {
      const key = `_${i}`;
      if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
        const value = item[key].toString().toLowerCase();
        if (possibleKeys.includes('date') && (value.includes('/') || value.match(/\d{2}\.\d{2}\.\d{4}/))) {
          return item[key];
        }
        if (possibleKeys.includes('status') && 
            (value.includes('authorised') || value.includes('withdrawn') || 
             value.includes('ongoing') || value.includes('resolved'))) {
          return item[key];
        }
        if (possibleKeys.includes('reason') && 
            value.length > 10 && (value.includes('due to') || value.includes('because'))) {
          return item[key];
        }
      }
    }
    return null;
  }

  function showError(message) {
    showToast(message, 'error');
  }

  function showToast(message, type = 'info') {
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col space-y-2';
      document.body.appendChild(toastContainer);
    }
    const toast = document.createElement('div');
    let bgColor = 'bg-blue-500', icon = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    `;
    if (type === 'success') {
      bgColor = 'bg-green-500'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      `;
    } else if (type === 'error') {
      bgColor = 'bg-red-500'; icon = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      `;
    }
    toast.className = `flex items-center p-3 rounded-lg text-white ${bgColor} shadow-lg transition-opacity duration-500`;
    toast.innerHTML = `
      ${icon}
      <span>${message}</span>
      <button class="ml-4 text-white focus:outline-none hover:text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    `;
    const closeButton = toast.querySelector('button');
    closeButton.addEventListener('click', () => {
      toast.style.opacity = '0';
      setTimeout(() => toastContainer.removeChild(toast), 500);
    });
    toastContainer.appendChild(toast);
    setTimeout(() => {
      if (toast.parentNode === toastContainer) {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (toast.parentNode === toastContainer) toastContainer.removeChild(toast);
        }, 500);
      }
    }, 5000);
  }

  function addTableStyles() {
    const styleId = 'ema-data-table-styles';
    if (document.getElementById(styleId)) return;
    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.textContent = `
      .ema-data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      .ema-data-table th {
        background-color: #f8fafc;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
      }
      .ema-data-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .ema-data-table tbody tr:hover {
        background-color: #f9fafb;
      }
      .ema-empty-state, .ema-loading-state {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
      }
    `;
    document.head.appendChild(styleElement);
  }

  // Export functions
  return {
    init,
    searchCondition, // New function for condition-based search
    showSection,
    toggleAdminSection,
    refreshEmaData,
    checkEmaDataStatus
    // Note: Removed searchDrug since this is now condition-focused
  };
})();

// Example usage




function addExtendedTableStyles() {
  const styleId = 'ema-extended-table-styles';
  
  // Check if styles already exist
  if (document.getElementById(styleId)) {
    return;
  }
  
  const styleElement = document.createElement('style');
  styleElement.id = styleId;
  styleElement.textContent = `
    .ema-data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .ema-data-table th {
      background-color: #f8fafc;
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .ema-data-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }
    
    .ema-data-table tbody tr:hover {
      background-color: #f9fafb;
    }
    
    .ema-empty-state, .ema-loading-state {
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }
    
    .ema-data-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
    }
    
    /* Adjust the detail sections */
    .text-xs.text-gray-600 {
      max-width: 300px;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    
    /* Make the headers sticky */
    .ema-data-container {
      position: relative;
    }
  `;
  
  document.head.appendChild(styleElement);
}
// Initialize the module when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  // Add table styles
 
  EmaDataModule.addTableStyles = function() {
    const styleId = 'ema-data-table-styles';
    
    // Check if styles already exist
    if (document.getElementById(styleId)) {
      return;
    }
    
    const styleElement = document.createElement('style');
    styleElement.id = styleId;
    styleElement.textContent = `
      .ema-data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      .ema-data-table th {
        background-color: #f8fafc;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .ema-data-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .ema-data-table tbody tr:hover {
        background-color: #f9fafb;
      }
      
      .ema-empty-state, .ema-loading-state {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
      }
    `;
    
    document.head.appendChild(styleElement);
  };
  
  // Add table styles
  EmaDataModule.addTableStyles();
  addExtendedTableStyles()
  // Initialize the module

  
  // Show admin panel for development (remove in production)
  EmaDataModule.toggleAdminSection(false);
  
});

// PubMed Module
const PubMedModule = (function() {
  const elements = {
    pubmedSection: document.getElementById('pubmedSection'),
    pubmedLoading: document.getElementById('pubmedLoading'),
    pubmedError: document.getElementById('pubmedError'),
    pubmedErrorMessage: document.getElementById('pubmedErrorMessage'),
    pubmedEmpty: document.getElementById('pubmedEmpty'),
    pubmedArticles: document.getElementById('pubmedArticles'),
    pubmedArticlesList: document.getElementById('pubmedArticlesList'),
    pubmedResultCount: document.getElementById('pubmedResultCount'),
    pubmedSort: document.getElementById('pubmedSort'),
    pubmedFullTextOnly: document.getElementById('pubmedFullTextOnly'),
    pubmedLoadMore: document.getElementById('pubmedLoadMore'),
    pubmedPagination: document.getElementById('pubmedPagination'),
  pubmedSummary: document.getElementById('pubmedSummary'),
  pubmedSummaryLoading: document.getElementById('pubmedSummaryLoading'),
  pubmedSummaryContent: document.getElementById('pubmedSummaryContent'),
  pubmedKeyAreas: document.getElementById('pubmedKeyAreas'),
  pubmedTimeline: document.getElementById('pubmedTimeline'),
  pubmedTopics: document.getElementById('pubmedTopics'),
  pubmedTopicsCloud: document.getElementById('pubmedTopicsCloud'),
  pubmedJournals: document.getElementById('pubmedJournals')
  };

  let state = {
    term: '',
    articles: [],
    currentPage: 1,
    totalResults: 0,
    isLoading: false,
    sortBy: 'relevance',
    fullTextOnly: false
  };
  
  function showComponent(component, isVisible) {
    if (isVisible) {
      component.classList.remove('hidden');
    } else {
      component.classList.add('hidden');
    }
  }
  
  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  
  function createArticleElement(article) {
    const articleElement = document.createElement('div');
    articleElement.className = 'bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition duration-150 ease-in-out';
    
    const hasDOI = article.doi && article.doi.trim() !== '';
    const hasFullText = article.fullTextUrl && article.fullTextUrl.trim() !== '';
    
    articleElement.innerHTML = `
      <h3 class="text-lg font-semibold text-gray-800 mb-2">${article.title}</h3>
      <div class="text-sm text-gray-600 mb-2">
        ${article.authors.slice(0, 3).join(', ')}${article.authors.length > 3 ? ', et al.' : ''}
      </div>
      <div class="text-sm text-gray-500 mb-3">
        <span class="font-medium">${article.journal || 'Journal not specified'}</span>  
        ${formatDate(article.pubDate)}  
        ${article.citationCount !== undefined ? `<span class="text-primary">${article.citationCount} citations</span>  ` : ''}
        PMID: ${article.pmid}
      </div>
      <p class="text-gray-700 text-sm mb-3">${article.abstract.substring(0, 200)}${article.abstract.length > 200 ? '...' : ''}</p>
      <div class="flex flex-wrap gap-2 mb-3">
        ${article.keywords.map(keyword => 
          `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">${keyword}</span>`
        ).join('')}
      </div>
      <div class="flex flex-wrap gap-2">
        <a href="https://pubmed.ncbi.nlm.nih.gov/${article.pmid}" target="_blank" class="text-primary hover:text-primary-dark text-sm underline">View on PubMed</a>
        ${hasDOI ? 
          `<a href="https://doi.org/${article.doi}" target="_blank" class="text-primary hover:text-primary-dark text-sm underline">DOI</a>` : ''}
        ${hasFullText ? 
          `<a href="${article.fullTextUrl}" target="_blank" class="text-primary hover:text-primary-dark text-sm underline">Full Text</a>` : ''}
      </div>
    `;
    
    return articleElement;
  }
  
  function renderArticles() {
    elements.pubmedArticlesList.innerHTML = '';
    
    state.articles.forEach(article => {
      const articleElement = createArticleElement(article);
      elements.pubmedArticlesList.appendChild(articleElement);
    });
    
    elements.pubmedResultCount.textContent = `${state.totalResults} articles found`;
    
    // Show/hide load more button based on whether there are more results
    const hasMoreResults = state.articles.length < state.totalResults;
    showComponent(elements.pubmedPagination, hasMoreResults);
  }
  

  // Add to the PubMedModule

function generateSummary(articles) {
  // Show loading state
  showComponent(elements.pubmedSummary, true);
  showComponent(elements.pubmedSummaryLoading, true);
  showComponent(elements.pubmedSummaryContent, false);
  
  // Process in setTimeout to not block UI
  setTimeout(() => {
    try {
      // Extract publication years
    //   const years = {};
    //   articles.forEach(article => {
    //     const date = new Date(article.pubDate);
    //     const year = date.getFullYear();
    //     if (!isNaN(year)) {
    //       years[year] = (years[year] || 0) + 1;
    //     }
    //   });
      
    //   // Sort years and format for display
    //   const sortedYears = Object.entries(years)
    //     .sort(([yearA], [yearB]) => parseInt(yearA) - parseInt(yearB));
      
    //   let timelineHtml = '';
    //   if (sortedYears.length > 0) {
    //     timelineHtml = `
    //       <div class="flex items-end h-20 space-x-1 mb-1">
    //         ${sortedYears.map(([year, count]) => {
    //           const height = Math.max(20, Math.min(80, count * 10));
    //           return `
    //             <div class="group relative">
    //               <div class="bg-primary h-[${height}%] w-5" title="${count} articles in ${year}"></div>
    //               <div class="absolute bottom-0 left-0 transform -rotate-45 origin-bottom-left text-xs text-gray-500 mt-1">${year}</div>
    //             </div>
    //           `;
    //         }).join('')}
    //       </div>
    //       <p class="text-xs text-gray-500 mt-3">Publications by year (${sortedYears.length} years represented)</p>
    //     `;
    //   } else {
    //     timelineHtml = '<p>Timeline data not available</p>';
    //   }
      


      // Update the timeline generation in the generateSummary function
// Replace the existing timeline code with this:

// Extract publication years
const years = {};
articles.forEach(article => {
  const date = new Date(article.pubDate);
  const year = date.getFullYear();
  if (!isNaN(year)) {
    years[year] = (years[year] || 0) + 1;
  }
});

// Sort years and format for display
const sortedYears = Object.entries(years)
  .sort(([yearA], [yearB]) => parseInt(yearA) - parseInt(yearB));

let timelineHtml = '';
if (sortedYears.length > 0) {
  // Find max count for scaling
  const maxCount = Math.max(...sortedYears.map(([, count]) => count));
  
  timelineHtml = `
    <table class="w-full">
      <tbody>
        ${sortedYears.map(([year, count]) => {
          // Calculate width percentage (minimum 10%, maximum 100%)
          const widthPercent = Math.max(10, Math.min(100, (count / maxCount) * 100));
          
          return `
            <tr class="border-b border-gray-100">
              <td class="py-1 pr-2 text-right font-medium">${year}</td>
              <td class="py-1 w-full">
                <div class="flex items-center">
                  <div class="bg-primary h-5 rounded-sm" style="width: ${widthPercent}%"></div>
                  <span class="ml-2">${count}</span>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
    <p class="text-xs text-gray-500 mt-2">Publications by year</p>
  `;
} else {
  timelineHtml = '<p>Timeline data not available</p>';
}

elements.pubmedTimeline.innerHTML = timelineHtml;


      // Extract journals
      const journals = {};
      articles.forEach(article => {
        if (article.journal) {
          journals[article.journal] = (journals[article.journal] || 0) + 1;
        }
      });
      
      // Get top journals
      const topJournals = Object.entries(journals)
        .sort(([,countA], [,countB]) => countB - countA)
        .slice(0, 5);
      
      let journalsHtml = '';
      if (topJournals.length > 0) {
        journalsHtml = `
          <ul class="list-disc list-inside">
            ${topJournals.map(([journal, count]) => 
              `<li>${journal} <span class="text-gray-500">(${count} article${count !== 1 ? 's' : ''})</span></li>`
            ).join('')}
          </ul>
        `;
      } else {
        journalsHtml = '<p>Journal data not available</p>';
      }
      
      // Extract keywords/topics
      const topics = {};
      articles.forEach(article => {
        article.keywords.forEach(keyword => {
          if (keyword && keyword.length > 3) {
            topics[keyword] = (topics[keyword] || 0) + 1;
          }
        });
      });
      
      // Get top topics
      const topTopics = Object.entries(topics)
        .sort(([,countA], [,countB]) => countB - countA)
        .slice(0, 15);
      
      let topicsHtml = '';
      if (topTopics.length > 0) {
        topicsHtml = topTopics.map(([topic, count]) => {
          const fontSize = Math.max(0.7, Math.min(1.5, 0.8 + (count / 5) * 0.5));
          return `<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs" 
                      style="font-size: ${fontSize}rem">${topic}</span>`;
        }).join(' ');
      } else {
        topicsHtml = '<p>No common topics identified</p>';
      }
      
      // Determine key research areas by analyzing abstracts
      // This is a simplified approach - in a real app, you might use NLP
      const researchAreas = new Set();
      const commonPhrases = [
        'clinical trial', 'meta-analysis', 'systematic review', 'case study', 
        'randomized controlled', 'double-blind', 'placebo-controlled',
        'efficacy', 'safety', 'mechanism', 'pathophysiology', 'treatment outcome',
        'adverse effects', 'drug therapy', 'dosage', 'comparative study'
      ];
      
      articles.forEach(article => {
        const text = (article.title + ' ' + article.abstract).toLowerCase();
        commonPhrases.forEach(phrase => {
          if (text.includes(phrase)) {
            researchAreas.add(phrase);
          }
        });
      });
      
      let areasHtml = '';
      if (researchAreas.size > 0) {
        areasHtml = `
          <ul class="list-disc list-inside">
            ${Array.from(researchAreas).slice(0, 6).map(area => 
              `<li class="capitalize">${area}</li>`
            ).join('')}
          </ul>
        `;
      } else {
        areasHtml = '<p>Research focus areas could not be determined</p>';
      }
      
      // Update the DOM
    //   elements.pubmedTimeline.innerHTML = timelineHtml;
      elements.pubmedJournals.innerHTML = journalsHtml;
      elements.pubmedTopicsCloud.innerHTML = topicsHtml;
      elements.pubmedKeyAreas.innerHTML = areasHtml;
      
      // Hide loading, show content
      showComponent(elements.pubmedSummaryLoading, false);
      showComponent(elements.pubmedSummaryContent, true);
      
    } catch (error) {
      console.error('Error generating summary:', error);
      elements.pubmedSummary.innerHTML = `
        <p class="text-sm text-gray-500">Could not generate research summary: ${error.message}</p>
      `;
    }
  }, 100);
}





// Add pubmedSummary element to the elements object


  async function searchPubMed(term, options = {}) {
    state.isLoading = true;
    state.term = term;
    state.currentPage = options.page || 1;
    state.sortBy = options.sortBy || state.sortBy;
    state.fullTextOnly = options.fullTextOnly !== undefined ? options.fullTextOnly : state.fullTextOnly;
    
    // Show the pubmed section and loading state
    showComponent(elements.pubmedSection, true);
    showComponent(elements.pubmedLoading, true);
    showComponent(elements.pubmedError, false);
    showComponent(elements.pubmedEmpty, false);
    showComponent(elements.pubmedArticles, false);
    
    try {
      const params = new URLSearchParams({
        term: term,
        page: state.currentPage,
        sortBy: state.sortBy,
        fullTextOnly: state.fullTextOnly
      });
      
      const response = await fetch(`/api/pubmed?${params}`);
      
      if (!response.ok) {
        throw new Error(`Server responded with status ${response.status}`);
      }
      
      const data = await response.json();
      
      // Update state with fetched data
      if (state.currentPage === 1) {
        state.articles = data.articles;
      } else {
        state.articles = [...state.articles, ...data.articles];
      }


      state.totalResults = data.totalResults;
      
      // Hide loading state
      showComponent(elements.pubmedLoading, false);
      
      if (state.articles.length === 0) {
      showComponent(elements.pubmedEmpty, true);
      showComponent(elements.pubmedSummary, false);
    } else {
      showComponent(elements.pubmedArticles, true);
      renderArticles();
      
      // Generate and show summary for first page results
      if (state.currentPage === 1) {
        generateSummary(state.articles);
      }
    }
    
      
    } catch (error) {
      console.error('Error fetching PubMed data:', error);
      showComponent(elements.pubmedLoading, false);
      showComponent(elements.pubmedError, true);
      elements.pubmedErrorMessage.textContent = error.message || 'Failed to fetch articles. Please try again later.';
      showComponent(elements.pubmedSummary, false);
    }
    
    state.isLoading = false;
  }
  
  function initEventListeners() {
    elements.pubmedSort.addEventListener('change', () => {
      searchPubMed(state.term, { 
        page: 1, 
        sortBy: elements.pubmedSort.value,
        fullTextOnly: elements.pubmedFullTextOnly.checked 
      });
    });
    
    elements.pubmedFullTextOnly.addEventListener('change', () => {
      searchPubMed(state.term, { 
        page: 1, 
        sortBy: elements.pubmedSort.value,
        fullTextOnly: elements.pubmedFullTextOnly.checked 
      });
    });
    
    elements.pubmedLoadMore.addEventListener('click', () => {
      if (!state.isLoading) {
        searchPubMed(state.term, { 
          page: state.currentPage + 1,
          sortBy: elements.pubmedSort.value,
          fullTextOnly: elements.pubmedFullTextOnly.checked
        });
      }
    });
  }
  
  function init() {
    initEventListeners();
  }
  
  return {
    init,
    searchPubMed
  };
})();






// Initialize the PubMed module
document.addEventListener('DOMContentLoaded', () => {
  PubMedModule.init();
});

// Initialize the module when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  init()
});

// Add the EMA data module to window for debugging
window.EmaDataModule = EmaDataModule;



    </script>
</body>
</html>