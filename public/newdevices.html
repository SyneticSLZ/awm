<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDA Device Intelligence Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fda-blue': '#1e40af',
                        'fda-light': '#eff6ff',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444',
                        'gray-850': '#1f2937'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'bounce-subtle': 'bounceSubtle 1s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseSoft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes bounceSubtle {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .section-expanded {
            transform: rotate(180deg);
        }
        .status-online { background: linear-gradient(45deg, #10b981, #34d399); }
        .status-warning { background: linear-gradient(45deg, #f59e0b, #fbbf24); }
        .status-error { background: linear-gradient(45deg, #ef4444, #f87171); }
        .metric-card {
            background: linear-gradient(135deg, var(--tw-gradient-from), var(--tw-gradient-to));
        }
        .search-input-focus:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        .modal-backdrop {
            backdrop-filter: blur(8px);
        }
        .toggle-active {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            transform: translateX(100%);
        }
        .toggle-inactive {
            background: #D1D5DB;
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-white bg-opacity-20 rounded-xl p-3 mr-4 backdrop-blur-sm">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">FDA Device Intelligence Pro</h1>
                        <p class="text-sm opacity-90 mt-1">AI-Powered Regulatory Intelligence Platform</p>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <div class="glass-effect rounded-xl p-3 text-gray-800">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full status-online mr-2"></div>
                            <div>
                                <p class="text-xs font-medium">API Status</p>
                                <p class="text-xs opacity-70">All systems operational</p>
                            </div>
                        </div>
                    </div>
                    <button id="settings-btn" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl p-2 transition-all duration-200">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-6">
        <!-- Search Interface -->
        <div class="bg-white rounded-3xl card-shadow card-hover p-8 mb-8 animate-fade-in">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Intelligent Search Engine</h2>
                
                <!-- Search Mode Toggle -->
                <div class="bg-gray-100 rounded-2xl p-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Search Mode</h3>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-8">
                            <!-- Device Toggle -->
                            <div class="flex items-center">
                                <div class="relative">
                                    <input type="radio" id="device-mode" name="search-mode" value="device" class="sr-only" checked>
                                    <label for="device-mode" class="flex items-center cursor-pointer">
                                        <div class="w-6 h-6 border-2 border-blue-500 rounded-full mr-3 flex items-center justify-center bg-blue-500">
                                            <div class="w-2 h-2 bg-white rounded-full"></div>
                                        </div>
                                        <div>
                                            <span class="font-semibold text-blue-800">Device Search</span>
                                            <p class="text-xs text-blue-600">Search for specific medical devices, or device types</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Company Toggle -->
                            <div class="flex items-center">
                                <div class="relative">
                                    <input type="radio" id="company-mode" name="search-mode" value="company" class="sr-only">
                                    <label for="company-mode" class="flex items-center cursor-pointer">
                                        <div class="w-6 h-6 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                                            <div class="w-2 h-2 bg-transparent rounded-full"></div>
                                        </div>
                                        <div>
                                            <span class="font-semibold text-gray-700">Company Search</span>
                                            <p class="text-xs text-gray-500">Search for company portfolios, manufacturers, and regulatory history</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Auto-detect indicator -->
                        <div id="auto-detect-indicator" class="bg-purple-100 text-purple-800 px-3 py-2 rounded-xl text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                            Auto-detect active
                        </div>
                    </div>
                </div>

                <!-- Search Examples -->
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div id="device-examples" class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-4 border border-blue-200">
                        <div class="flex items-center mb-3">
                            <div class="bg-blue-500 rounded-lg p-2 mr-3">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-blue-800 text-sm">Device Search Examples</h3>
                        </div>
                        <p class="text-xs text-blue-700 mb-2">Search for specific devices and get regulatory pathways</p>
                        <p class="text-xs text-blue-600">"pacemaker", "glucose monitor", "insulin pump"</p>
                    </div>
                    <div id="company-examples" class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-4 border border-purple-200 hidden">
                        <div class="flex items-center mb-3">
                            <div class="bg-purple-500 rounded-lg p-2 mr-3">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-purple-800 text-sm">Company Search Examples</h3>
                        </div>
                        <p class="text-xs text-purple-700 mb-2">Analyze company portfolios and regulatory footprint</p>
                        <p class="text-xs text-purple-600">"Medtronic", "Abbott", "Boston Scientific", "Johnson & Johnson"</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-4 mb-6">
                <div class="flex-1">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Enter search term..."
                            class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl search-input-focus focus:outline-none text-lg transition-all duration-200"
                        >
                        <div id="search-suggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-2xl mt-1 shadow-xl z-10 hidden"></div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button 
                        id="smart-search-btn" 
                        class="bg-fda-blue text-white px-6 py-4 rounded-2xl hover:bg-blue-700 transition-all font-semibold flex items-center shadow-lg hover:shadow-xl"
                    >
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        Smart Search
                    </button>
                    <button 
                        id="part-search-btn" 
                        class="bg-green-600 text-white px-6 py-4 rounded-2xl hover:bg-green-700 transition-all font-semibold flex items-center shadow-lg hover:shadow-xl"
                    >
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        CFR Explorer
                    </button>
                </div>
            </div>

            <!-- Quick CFR Access -->
            <div class="bg-gray-50 rounded-2xl p-6">
                <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                    Quick CFR Part Access
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2">
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="862">
                        <div class="font-semibold">862</div>
                        <div class="text-xs text-gray-600">Chemistry</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="864">
                        <div class="font-semibold">864</div>
                        <div class="text-xs text-gray-600">Hematology</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="866">
                        <div class="font-semibold">866</div>
                        <div class="text-xs text-gray-600">Immunology</div>
                    </button>
<button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="868">
                        <div class="font-semibold">868</div>
                        <div class="text-xs text-gray-600">Anesthesia</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="870">
                        <div class="font-semibold">870</div>
                        <div class="text-xs text-gray-600">Cardiovascular</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="872">
                        <div class="font-semibold">872</div>
                        <div class="text-xs text-gray-600">Dental</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="874">
                        <div class="font-semibold">874</div>
                        <div class="text-xs text-gray-600">ENT</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="876">
                        <div class="font-semibold">876</div>
                        <div class="text-xs text-gray-600">Gastro-Uro</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="878">
                        <div class="font-semibold">878</div>
                        <div class="text-xs text-gray-600">Surgery</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="880">
                        <div class="font-semibold">880</div>
                        <div class="text-xs text-gray-600">Hospital</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="882">
                        <div class="font-semibold">882</div>
                        <div class="text-xs text-gray-600">Neurological</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="884">
                        <div class="font-semibold">884</div>
                        <div class="text-xs text-gray-600">OB/GYN</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="886">
                        <div class="font-semibold">886</div>
                        <div class="text-xs text-gray-600">Ophthalmic</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="888">
                        <div class="font-semibold">888</div>
                        <div class="text-xs text-gray-600">Orthopedic</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="890">
                        <div class="font-semibold">890</div>
                        <div class="text-xs text-gray-600">Physical Med</div>
                    </button>
                    <button class="part-btn bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-300 rounded-xl px-3 py-3 text-sm transition-all card-hover" data-part="892">
                        <div class="font-semibold">892</div>
                        <div class="text-xs text-gray-600">Radiology</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden bg-white rounded-3xl card-shadow p-12 mb-8 animate-fade-in">
            <div class="flex flex-col items-center">
                <div class="flex space-x-2 mb-6">
                    <div class="w-4 h-4 bg-fda-blue rounded-full animate-pulse-soft"></div>
                    <div class="w-4 h-4 bg-fda-blue rounded-full animate-pulse-soft" style="animation-delay: 0.2s;"></div>
                    <div class="w-4 h-4 bg-fda-blue rounded-full animate-pulse-soft" style="animation-delay: 0.4s;"></div>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Analyzing FDA Data</h3>
                <p class="text-gray-600 text-center mb-6">Searching across multiple databases and applying AI intelligence...</p>
                <div class="w-full max-w-md bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="loading-status" class="mt-4 text-sm text-gray-500">Initializing search...</div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="error-display" class="hidden bg-red-50 border-2 border-red-200 rounded-3xl p-8 mb-8 animate-fade-in">
            <div class="flex items-start">
                <div class="bg-red-100 rounded-full p-3 mr-4">
                    <svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Search Error</h3>
                    <div id="error-content" class="text-red-700"></div>
                    <button id="retry-btn" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 transition-colors">
                        Try Again
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results-container" class="hidden animate-fade-in">
            <!-- AI Insights Panel -->
            <div id="ai-insights" class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-3xl p-8 mb-8">
                <div class="flex items-center mb-6">
                    <div class="bg-purple-600 rounded-xl p-3 mr-4">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">AI-Powered Insights</h2>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-2xl p-6 border border-purple-200 card-shadow">
                        <h3 class="font-semibold text-purple-800 mb-3">Regulatory Summary</h3>
                        <div id="ai-regulatory-summary" class="text-gray-700">
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 border border-purple-200 card-shadow">
                        <h3 class="font-semibold text-purple-800 mb-3">Risk Assessment</h3>
                        <div id="ai-risk-assessment" class="text-gray-700">
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-6 border border-purple-200 card-shadow">
                    <h3 class="font-semibold text-purple-800 mb-3">Strategic Recommendations</h3>
                    <div id="ai-recommendations" class="text-gray-700">
                        <div class="animate-pulse space-y-2">
                            <div class="h-4 bg-gray-200 rounded w-full"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                            <div class="h-4 bg-gray-200 rounded w-4/5"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Overview -->
            <div id="profile-overview" class="bg-white rounded-3xl card-shadow p-8 mb-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2" id="profile-title"></h2>
                        <p class="text-gray-600" id="profile-timestamp"></p>
                        <div id="search-mode-indicator" class="mt-2"></div>
                    </div>
                    <button id="export-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        Export Report
                    </button>
                </div>

                <!-- Metrics Cards -->
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card from-blue-500 to-blue-600 text-white rounded-2xl p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium opacity-90">Regulatory Complexity</h3>
                            <svg class="w-5 h-5 opacity-75" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <p class="text-2xl font-bold mb-1" id="complexity-level">-</p>
                        <p class="text-sm opacity-75" id="complexity-desc">-</p>
                    </div>
                    <div class="metric-card from-green-500 to-green-600 text-white rounded-2xl p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium opacity-90" id="classification-title">Classification</h3>
                            <svg class="w-5 h-5 opacity-75" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="text-2xl font-bold mb-1" id="classification-value">-</p>
                        <p class="text-sm opacity-75" id="classification-desc">-</p>
                    </div>
                    <div class="metric-card from-purple-500 to-purple-600 text-white rounded-2xl p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium opacity-90">Market Status</h3>
                            <svg class="w-5 h-5 opacity-75" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                        </div>
                        <p class="text-2xl font-bold mb-1" id="market-status">-</p>
                        <p class="text-sm opacity-75" id="market-desc">-</p>
                    </div>
                    <div class="metric-card from-orange-500 to-orange-600 text-white rounded-2xl p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium opacity-90">Safety Profile</h3>
                            <svg class="w-5 h-5 opacity-75" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="text-2xl font-bold mb-1" id="safety-level">-</p>
                        <p class="text-sm opacity-75" id="safety-desc">-</p>
                    </div>
                </div>

                <!-- Company Information (shown for company searches) -->
                <div id="company-info" class="bg-gray-50 rounded-2xl p-6 mb-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"/>
                        </svg>
                        Company Portfolio
                    </h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2">Key Facilities</h4>
                            <div id="facilities-list" class="space-y-2"></div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2">Applicants/Subsidiaries</h4>
                            <div id="applicant-list" class="space-y-2"></div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2">Device Portfolio</h4>
                            <div id="device-portfolio" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Applicable Parts (shown for device searches) -->
                <div id="applicable-parts-container" class="bg-gray-50 rounded-2xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        Applicable CFR Parts
                    </h3>
                    <div id="applicable-parts" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- Strategic Recommendations -->
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-200 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        Strategic Recommendations
                    </h3>
                    <div id="recommendations-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- Data Insights Tabs with Interactive Charts -->
            <div class="bg-white rounded-3xl card-shadow overflow-hidden mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex" id="data-tabs">
                        <button class="tab-btn active px-6 py-4 text-sm font-medium border-b-2 border-fda-blue text-fda-blue bg-blue-50" data-tab="overview">
                            Overview & Charts
                        </button>
                        <button class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="fda-data">
                            FDA Database Results
                        </button>
                        <button class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="regulatory">
                            Regulatory Analysis
                        </button>
                        <button class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="compliance">
                            Compliance Check
                        </button>
                    </nav>
                </div>

                <div class="p-8">
                    <!-- Overview Tab with Interactive Charts -->
                    <div id="tab-overview" class="tab-content">
                        <div class="grid md:grid-cols-2 gap-8 mb-8">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Source Distribution</h3>
                                <div class="bg-gray-50 rounded-2xl p-6 h-80">
                                    <canvas id="sourceDistributionChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Activity Timeline</h3>
                                <div class="bg-gray-50 rounded-2xl p-6 h-80">
                                    <canvas id="timelineChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-8 mb-8">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Device Class Distribution</h3>
                                <div class="bg-gray-50 rounded-2xl p-6 h-80">
                                    <canvas id="classDistributionChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Safety Events Timeline</h3>
                                <div class="bg-gray-50 rounded-2xl p-6 h-80">
                                    <canvas id="safetyTimelineChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="bg-blue-50 rounded-2xl p-6">
                                <h4 class="font-semibold text-blue-800 mb-2">Total Records Found</h4>
                                <p class="text-3xl font-bold text-blue-600" id="total-records">0</p>
                                <p class="text-sm text-blue-600 mt-1">Across all FDA databases</p>
                            </div>
                            <div class="bg-green-50 rounded-2xl p-6">
                                <h4 class="font-semibold text-green-800 mb-2">Active Clearances</h4>
                                <p class="text-3xl font-bold text-green-600" id="active-clearances">0</p>
                                <p class="text-sm text-green-600 mt-1">510(k) + PMA approvals</p>
                            </div>
                            <div class="bg-orange-50 rounded-2xl p-6">
                                <h4 class="font-semibold text-orange-800 mb-2">Safety Events</h4>
                                <p class="text-3xl font-bold text-orange-600" id="safety-events">0</p>
                                <p class="text-sm text-orange-600 mt-1">Recalls + adverse events</p>
                            </div>
                        </div>
                    </div>

                    <!-- FDA Data Tab -->
                    <div id="tab-fda-data" class="tab-content hidden">
                        <div id="fda-data-container" class="space-y-6"></div>
                    </div>

                    <!-- Regulatory Tab -->
                    <div id="tab-regulatory" class="tab-content hidden">
                        <div id="regulatory-container" class="space-y-6"></div>
                    </div>

                    <!-- Compliance Tab -->
                    <div id="tab-compliance" class="tab-content hidden">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div class="bg-gray-50 rounded-2xl p-6">
                                <h3 class="font-semibold text-gray-800 mb-4">Compliance Checklist</h3>
                                <div id="compliance-checklist" class="space-y-3">
                                    <div class="flex items-center p-3 bg-white rounded border">
                                        <div class="w-5 h-5 bg-gray-300 rounded mr-3"></div>
                                        <span class="text-gray-600">Loading compliance requirements...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-2xl p-6">
                                <h3 class="font-semibold text-gray-800 mb-4">Required Documentation</h3>
                                <div id="required-docs" class="space-y-3">
                                    <div class="flex items-center p-3 bg-white rounded border">
                                        <div class="w-5 h-5 bg-gray-300 rounded mr-3"></div>
                                        <span class="text-gray-600">Loading documentation requirements...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Modal Container -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-6xl max-h-[90vh] overflow-hidden animate-scale-in w-full shadow-2xl">
          <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                <div class="flex items-center space-x-2">
                    <button id="modal-maximize" class="text-gray-500 hover:text-gray-700 transition-colors p-2 rounded-lg hover:bg-white">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 01-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <button id="modal-close" class="text-gray-500 hover:text-gray-700 transition-colors p-2 rounded-lg hover:bg-white">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-2xl w-full animate-scale-in shadow-2xl">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">Dashboard Settings</h3>
                <button id="settings-close" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Endpoint</label>
                    <input type="text" id="api-endpoint" value="/api/fda" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-fda-blue focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Results per endpoint</label>
                    <select id="results-limit" class="w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-fda-blue focus:border-transparent">
                        <option value="100">100 (Fast)</option>
                        <option value="500">500 (Balanced)</option>
                        <option value="1000" selected>1000 (Comprehensive)</option>
                        <option value="2000">2000 (Exhaustive)</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="enable-ai-insights" checked class="mr-2">
                    <label for="enable-ai-insights" class="text-sm text-gray-700">Enable AI-powered insights</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="auto-refresh" class="mr-2">
                    <label for="auto-refresh" class="text-sm text-gray-700">Auto-refresh data every 5 minutes</label>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="settings-cancel" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button>
                    <button id="settings-save" class="px-4 py-2 bg-fda-blue text-white rounded-xl hover:bg-blue-700 transition-colors">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class FDAIntelligenceDashboard {
            constructor() {
                this.baseUrl = '/api/device';
                this.currentData = null;
                this.searchInProgress = false;
                this.searchMode = 'device'; // 'device' or 'company'
                this.charts = {};
                this.settings = {
                    resultsLimit: 1000,
                    enableAI: true,
                    autoRefresh: false
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadSettings();
                this.setupSearchSuggestions();
                this.setupSearchModeToggle();
            }

            setupEventListeners() {
                // Search functionality
                document.getElementById('smart-search-btn').addEventListener('click', () => this.performSmartSearch());
                document.getElementById('part-search-btn').addEventListener('click', () => this.performPartSearch());
                document.getElementById('search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.performSmartSearch();
                });

                // Part buttons
                document.querySelectorAll('.part-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const part = e.target.closest('.part-btn').dataset.part;
                        this.searchSpecificPart(part);
                    });
                });

                // Tab functionality
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });

                // Modal functionality
                document.getElementById('modal-close').addEventListener('click', () => this.closeModal());
                document.getElementById('modal-maximize').addEventListener('click', () => this.toggleModalSize());
                document.getElementById('modal-container').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-container') this.closeModal();
                });

                // Settings
                document.getElementById('settings-btn').addEventListener('click', () => this.openSettings());
                document.getElementById('settings-close').addEventListener('click', () => this.closeSettings());
                document.getElementById('settings-save').addEventListener('click', () => this.saveSettings());
                document.getElementById('settings-cancel').addEventListener('click', () => this.closeSettings());

                // Error retry
                document.getElementById('retry-btn').addEventListener('click', () => {
                    this.hideError();
                    const searchTerm = document.getElementById('search-input').value.trim();
                    if (searchTerm) {
                        this.performSmartSearch();
                    }
                });

                // Export functionality
                document.getElementById('export-btn').addEventListener('click', () => this.exportReport());
            }

            setupSearchModeToggle() {
                const deviceMode = document.getElementById('device-mode');
                const companyMode = document.getElementById('company-mode');
                const deviceExamples = document.getElementById('device-examples');
                const companyExamples = document.getElementById('company-examples');
                const searchInput = document.getElementById('search-input');

                deviceMode.addEventListener('change', () => {
                    if (deviceMode.checked) {
                        this.searchMode = 'device';
                        deviceExamples.classList.remove('hidden');
                        companyExamples.classList.add('hidden');
                        searchInput.placeholder = 'Enter device name, K-number, or device type...';
                        this.updateToggleStyles(deviceMode, companyMode);
                    }
                });

                companyMode.addEventListener('change', () => {
                    if (companyMode.checked) {
                        this.searchMode = 'company';
                        companyExamples.classList.remove('hidden');
                        deviceExamples.classList.add('hidden');
                        searchInput.placeholder = 'Enter company name or manufacturer...';
                        this.updateToggleStyles(companyMode, deviceMode);
                    }
                });
            }

            updateToggleStyles(activeRadio, inactiveRadio) {
                // Update active radio
                const activeContainer = activeRadio.parentElement.querySelector('.w-6');
                activeContainer.classList.remove('border-gray-300');
                activeContainer.classList.add('border-blue-500', 'bg-blue-500');
                activeContainer.querySelector('.w-2').classList.remove('bg-transparent');
                activeContainer.querySelector('.w-2').classList.add('bg-white');
                
                // Update active label
                const activeLabel = activeRadio.parentElement.querySelector('span');
                activeLabel.classList.remove('text-gray-700');
                activeLabel.classList.add('text-blue-800');

                // Update inactive radio
                const inactiveContainer = inactiveRadio.parentElement.querySelector('.w-6');
                inactiveContainer.classList.remove('border-blue-500', 'bg-blue-500');
                inactiveContainer.classList.add('border-gray-300');
                inactiveContainer.querySelector('.w-2').classList.remove('bg-white');
                inactiveContainer.querySelector('.w-2').classList.add('bg-transparent');
                
                // Update inactive label
                const inactiveLabel = inactiveRadio.parentElement.querySelector('span');
                inactiveLabel.classList.remove('text-blue-800');
                inactiveLabel.classList.add('text-gray-700');
            }

            setupSearchSuggestions() {
                const searchInput = document.getElementById('search-input');
                const deviceSuggestions = [
                    'K123456', 'K990123', 'P123456', 'pacemaker', 'defibrillator', 'stent', 
                    'insulin pump', 'MRI scanner', 'surgical robot', 'hearing aid', 
                    'contact lens', 'dental implant', 'wheelchair', 'ventilator', 
                    'ultrasound', 'X-ray machine', 'glucose monitor'
                ];
                
                const companySuggestions = [
                    'Medtronic', 'Abbott', 'Boston Scientific', 'Johnson & Johnson',
                    'Pfizer', 'GE Healthcare', 'Siemens Healthineers', 'Philips Healthcare',
                    'Stryker', 'Zimmer Biomet', 'Edwards Lifesciences', 'Intuitive Surgical'
                ];

                searchInput.addEventListener('input', (e) => {
                    const value = e.target.value.toLowerCase();
                    if (value.length < 2) {
                        this.hideSuggestions();
                        return;
                    }

                    const suggestions = this.searchMode === 'company' ? companySuggestions : deviceSuggestions;
                    const matches = suggestions.filter(s => s.toLowerCase().includes(value));
                    this.showSuggestions(matches.slice(0, 5));
                });

                searchInput.addEventListener('blur', () => {
                    setTimeout(() => this.hideSuggestions(), 150);
                });
            }

            showSuggestions(suggestions) {
                const container = document.getElementById('search-suggestions');
                if (suggestions.length === 0) {
                    this.hideSuggestions();
                    return;
                }

                container.innerHTML = suggestions.map(suggestion => 
                    `<div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" data-suggestion="${suggestion}">${suggestion}</div>`
                ).join('');
                
                container.querySelectorAll('[data-suggestion]').forEach(item => {
                    item.addEventListener('click', () => this.selectSuggestion(item.dataset.suggestion));
                });
                
                container.classList.remove('hidden');
            }

            hideSuggestions() {
                document.getElementById('search-suggestions').classList.add('hidden');
            }

            selectSuggestion(suggestion) {
                document.getElementById('search-input').value = suggestion;
                this.hideSuggestions();
                this.performSmartSearch();
            }

            async performSmartSearch() {
                if (this.searchInProgress) return;
                
                const searchTerm = document.getElementById('search-input').value.trim();
                if (!searchTerm) {
                    this.showError('Please enter a search term');
                    return;
                }

                this.searchInProgress = true;
                this.showLoading(this.searchMode);
                this.hideError();

                try {
                    const response = await fetch(`${this.baseUrl}/device-intelligence?q=${encodeURIComponent(searchTerm)}&mode=${this.searchMode}`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Search failed');
                    }

                    this.currentData = data;
                    this.displayResults(data);
                } catch (error) {
                    this.showError(`Search failed: ${error.message}`);
                } finally {
                    this.hideLoading();
                    this.searchInProgress = false;
                }
            }

            async performPartSearch() {
                const searchTerm = document.getElementById('search-input').value.trim();
                if (!searchTerm) {
                    this.showError('Please enter a part number or search term');
                    return;
                }
                
                let partNumber = this.extractPartNumber(searchTerm);
                
                if (!partNumber) {
                    this.showError('Please specify a valid CFR part number (862-892) or use keywords like "cardiovascular", "dental", etc.');
                    return;
                }

                this.searchSpecificPart(partNumber);
            }

            extractPartNumber(searchTerm) {
                const term = searchTerm.toLowerCase();
                
                // Direct part number match
                const partMatch = term.match(/(\d{3})/);
                if (partMatch) {
                    const num = partMatch[1];
                    if (num >= '862' && num <= '892') return num;
                }

                // Keyword mapping
                const keywordMap = {
                    'chemistry': '862', 'cardiovascular': '870', 'dental': '872', 'ent': '874',
                    'gastro': '876', 'surgery': '878', 'hospital': '880', 'neuro': '882',
                    'obstetric': '884', 'ophthalmic': '886', 'orthopedic': '888', 'radiology': '892'
                };

                for (const [keyword, part] of Object.entries(keywordMap)) {
                    if (term.includes(keyword)) return part;
                }

                return null;
            }

            async searchSpecificPart(partNumber) {
                this.showLoading('part');
                this.hideError();

                try {
                    const response = await fetch(`${this.baseUrl}/ecfr-part/${partNumber}`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Part search failed');
                    }

                    this.currentData = data;
                    this.displayPartResults(data);
                } catch (error) {
                    this.showError(`CFR Part search failed: ${error.message}`);
                } finally {
                    this.hideLoading();
                }
            }

            showLoading(type = 'device') {
                const loadingState = document.getElementById('loading-state');
                const statusElement = document.getElementById('loading-status');
                const progressBar = document.getElementById('progress-bar');
                
                loadingState.classList.remove('hidden');
                document.getElementById('results-container').classList.add('hidden');
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = `${progress}%`;
                    
                    if (progress < 30) {
                        statusElement.textContent = type === 'company' ? 'Analyzing company portfolio...' : 
                                                   type === 'device' ? 'Analyzing device data...' : 'Loading CFR regulations...';
                    } else if (progress < 60) {
                        statusElement.textContent = 'Querying FDA databases...';
                    } else {
                        statusElement.textContent = 'Processing results with AI...';
                    }
                }, 200);

                this.loadingInterval = interval;
            }

            hideLoading() {
                if (this.loadingInterval) {
                    clearInterval(this.loadingInterval);
                    this.loadingInterval = null;
                }
                
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    document.getElementById('loading-state').classList.add('hidden');
                }, 300);
            }

            showError(message, details = null) {
                const errorDisplay = document.getElementById('error-display');
                const errorContent = document.getElementById('error-content');
                
                let errorHtml = `<p class="mb-2">${message}</p>`;
                
                if (details) {
                    errorHtml += `
                        <details class="mt-3">
                            <summary class="cursor-pointer text-sm font-medium hover:text-red-900">Technical Details</summary>
                            <div class="mt-2 p-3 bg-red-100 rounded-xl text-sm">
                                <pre class="whitespace-pre-wrap text-xs">${JSON.stringify(details, null, 2)}</pre>
                            </div>
                        </details>
                    `;
                }
                
                errorContent.innerHTML = errorHtml;
                errorDisplay.classList.remove('hidden');
                document.getElementById('results-container').classList.add('hidden');
                this.hideLoading();
            }

            hideError() {
                document.getElementById('error-display').classList.add('hidden');
            }

            displayResults(data) {
                this.hideError();
                document.getElementById('results-container').classList.remove('hidden');

                // Update profile
                this.updateProfile(data);
                
                // Update AI insights
                this.updateAIInsights(data);
                
                // Create interactive charts
                this.createInteractiveCharts(data.data.charts);
                
                // Update data tabs
                this.updateDataTabs(data);
                
                // Show appropriate sections based on search mode
                if (data.profile.isCompanySearch) {
                    this.showCompanyView(data);
                } else {
                    this.showDeviceView(data);
                }
                
                // Show first tab
                this.switchTab('overview');
            }

            showCompanyView(data) {
                document.getElementById('company-info').classList.remove('hidden');
                document.getElementById('applicable-parts-container').classList.add('hidden');
                
                // Update company-specific UI elements
                document.getElementById('classification-title').textContent = 'Portfolio Range';
                this.displayCompanyInfo(data.profile.companyInfo);
            }

            showDeviceView(data) {
                document.getElementById('company-info').classList.add('hidden');
                document.getElementById('applicable-parts-container').classList.remove('hidden');
                
                // Update device-specific UI elements
                document.getElementById('classification-title').textContent = 'Device Classification';
                this.displayApplicableParts(data.applicableParts);
            }

            updateProfile(data) {
                const profile = data.profile;
                
                // Update header
                const title = profile.isCompanySearch ? 
                    `${data.searchTerm} - Company Intelligence` : 
                    `${data.searchTerm} - Device Intelligence`;
                    
                document.getElementById('profile-title').textContent = title;
                document.getElementById('profile-timestamp').textContent = `Generated: ${new Date(data.timestamp).toLocaleString()}`;
                
                // Add search mode indicator
                const modeIndicator = document.getElementById('search-mode-indicator');
                const modeColors = {
                    'company': 'bg-purple-100 text-purple-800',
                    'device': 'bg-blue-100 text-blue-800',
                    'k-number': 'bg-green-100 text-green-800',
                    'pma-number': 'bg-orange-100 text-orange-800'
                };
                
                modeIndicator.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${modeColors[profile.searchType] || modeColors.device}">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        ${profile.searchType.charAt(0).toUpperCase() + profile.searchType.slice(1).replace('-', ' ')} Search
                    </span>
                `;

                // Update metrics cards
                document.getElementById('complexity-level').textContent = profile.overview.regulatoryComplexity || 'Unknown';
                document.getElementById('classification-value').textContent = profile.overview.primaryClassification || 'Unknown';
                document.getElementById('market-status').textContent = profile.overview.marketStatus || 'Unknown';
                document.getElementById('safety-level').textContent = profile.safety.riskLevel || 'Unknown';

                const complexityDesc = profile.isCompanySearch ? 
                    `${profile.companyInfo.devicePortfolio?.length || 0} devices in portfolio` :
                    `${profile.regulatory.applicableParts || 0} CFR parts identified`;

                document.getElementById('complexity-desc').textContent = complexityDesc;
                document.getElementById('classification-desc').textContent = profile.regulatory.pathways?.join(', ') || 'Analysis in progress';
                document.getElementById('market-desc').textContent = `${profile.overview.totalFDARecords || 0} FDA records found`;
                document.getElementById('safety-desc').textContent = `${profile.safety.recallCount || 0} recalls, ${profile.safety.adverseEventCount || 0} adverse events`;

                // Update recommendations
                this.displayRecommendations(profile.recommendations);
            }

            displayCompanyInfo(companyInfo) {
                const facilitiesList = document.getElementById('facilities-list');
                const applicantList = document.getElementById('applicant-list');
                const devicePortfolio = document.getElementById('device-portfolio');
                
                // Display facilities
                if (companyInfo.facilities && companyInfo.facilities.length > 0) {
                    facilitiesList.innerHTML = companyInfo.facilities.slice(0, 5).map(facility => `
                        <div class="flex items-center p-2 bg-white rounded border border-gray-200">
                            <svg class="w-4 h-4 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm text-gray-700">${facility}</span>
                        </div>
                    `).join('');
                } else {
                    facilitiesList.innerHTML = '<p class="text-gray-500 text-sm">No facility information available</p>';
                }
                
                // Display applicants
                if (companyInfo.applicants && companyInfo.applicants.length > 0) {
                    applicantList.innerHTML = companyInfo.applicants.slice(0, 5).map(applicant => `
                        <div class="flex items-center p-2 bg-white rounded border border-gray-200">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm text-gray-700">${applicant}</span>
                        </div>
                    `).join('');
                } else {
                    applicantList.innerHTML = '<p class="text-gray-500 text-sm">No applicant information available</p>';
                }

                // Display device portfolio
                if (companyInfo.devicePortfolio && companyInfo.devicePortfolio.length > 0) {
                    devicePortfolio.innerHTML = companyInfo.devicePortfolio.slice(0, 8).map(device => `
                        <div class="flex items-center p-2 bg-white rounded border border-gray-200">
                            <svg class="w-4 h-4 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="text-sm text-gray-700">${device}</span>
                        </div>
                    `).join('');
                } else {
                    devicePortfolio.innerHTML = '<p class="text-gray-500 text-sm">No device portfolio information available</p>';
                }
            }

            updateAIInsights(data) {
                const profile = data.profile;
                
                setTimeout(() => {
                    const complexity = profile.overview.regulatoryComplexity || 'unknown';
                    const classification = profile.overview.primaryClassification || 'unknown';
                    const pathway = profile.regulatory.pathways?.[0] || 'under analysis';
                    
                    const searchTypeText = profile.isCompanySearch ? 'company' : 'device';
                    
                    document.getElementById('ai-regulatory-summary').innerHTML = `
                        <p class="mb-2">Based on FDA data analysis, this ${searchTypeText} shows <strong>${classification.toLowerCase()}</strong> with <strong>${complexity.toLowerCase()}</strong> regulatory complexity.</p>
                        <p>Primary regulatory pathway: <strong>${pathway}</strong></p>
                        ${profile.overview.totalFDARecords > 0 ? 
                            `<p class="mt-2 text-sm text-gray-600">Found ${profile.overview.totalFDARecords} FDA records across multiple databases.</p>` : 
                            '<p class="mt-2 text-sm text-gray-600">Limited FDA records found - may require broader search terms.</p>'
                        }
                    `;

                    const riskLevel = profile.safety.riskLevel || 'unknown';
                    const riskColor = this.getRiskColor(riskLevel);
                    
                    document.getElementById('ai-risk-assessment').innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="w-3 h-3 rounded-full mr-2 ${riskColor}"></div>
                            <span class="font-medium">${riskLevel} Risk Profile</span>
                        </div>
                        <p>Safety analysis shows ${profile.safety.recallCount || 0} recalls and ${profile.safety.adverseEventCount || 0} adverse events in FDA databases.</p>
                        ${profile.safety.recallCount > 0 || profile.safety.adverseEventCount > 0 ? 
                            '<p class="mt-2 text-sm text-orange-600">⚠️ Historical safety issues identified - review recall and adverse event details.</p>' :
                            '<p class="mt-2 text-sm text-green-600">✅ No significant safety issues found in FDA databases.</p>'
                        }
                    `;

                    const recommendations = profile.recommendations || [];
                    if (recommendations.length > 0) {
                        document.getElementById('ai-recommendations').innerHTML = `
                            <ul class="space-y-2">
                                ${recommendations.slice(0, 3).map(rec => ` <li class="flex items-start">
                                        <svg class="w-4 h-4 text-purple-600 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-sm">${rec}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    } else {
                        document.getElementById('ai-recommendations').innerHTML = `
                            <div class="text-center p-4 bg-gray-50 rounded-lg">
                                <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-sm text-gray-600">Analyzing available data to generate recommendations...</p>
                            </div>
                        `;
                    }
                }, 1000);
            }

            getRiskColor(riskLevel) {
                switch(riskLevel.toLowerCase()) {
                    case 'high': return 'bg-red-500';
                    case 'medium': return 'bg-yellow-500';
                    case 'low': return 'bg-green-500';
                    default: return 'bg-gray-500';
                }
            }

            displayApplicableParts(parts) {
                const container = document.getElementById('applicable-parts');
                container.innerHTML = '';

                if (!parts || parts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 col-span-full">No applicable CFR parts identified. This may indicate the device is unregulated or requires manual review.</p>';
                    return;
                }

                parts.forEach(part => {
                    const partCard = document.createElement('div');
                    partCard.className = 'bg-white border-2 border-gray-200 hover:border-blue-300 rounded-2xl p-4 transition-all cursor-pointer card-hover';
                    partCard.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-semibold text-gray-800">21 CFR Part ${part.part}</h4>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${part.matchType}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">${part.description}</p>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                <span class="text-xs text-gray-500">Score: ${part.relevanceScore}/10</span>
                            </div>
                            <button class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                Explore Part →
                            </button>
                        </div>
                    `;
                    partCard.addEventListener('click', () => this.searchSpecificPart(part.part));
                    container.appendChild(partCard);
                });
            }

            displayRecommendations(recommendations) {
                const container = document.getElementById('recommendations-list');
                container.innerHTML = '';

                if (!recommendations || recommendations.length === 0) {
                    container.innerHTML = '<div class="text-center p-4"><div class="text-gray-500">Generating recommendations based on available data...</div></div>';
                    return;
                }

                recommendations.forEach((rec, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-start p-3 bg-white rounded-xl border border-yellow-200';
                    item.innerHTML = `
                        <div class="bg-yellow-100 rounded-full p-1 mr-3 mt-0.5">
                            <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-yellow-800 font-medium text-sm">${rec}</p>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            createInteractiveCharts(chartsData) {
                if (!chartsData) return;

                // Destroy existing charts
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};

                // Source Distribution Chart (Doughnut)
                if (chartsData.sourceDistribution && chartsData.sourceDistribution.length > 0) {
                    const ctx = document.getElementById('sourceDistributionChart');
                    if (ctx) {
                        this.charts.sourceDistribution = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: chartsData.sourceDistribution.map(item => item.name),
                                datasets: [{
                                    data: chartsData.sourceDistribution.map(item => item.value),
                                    backgroundColor: chartsData.sourceDistribution.map(item => item.color),
                                    borderWidth: 2,
                                    borderColor: '#ffffff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            usePointStyle: true,
                                            padding: 15
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return `${label}: ${value} records (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }

                // Timeline Chart (Line)
                if (chartsData.timeline && chartsData.timeline.length > 0) {
                    const ctx = document.getElementById('timelineChart');
                    if (ctx) {
                        this.charts.timeline = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: chartsData.timeline.map(item => item.year),
                                datasets: [
                                    {
                                        label: 'Clearances',
                                        data: chartsData.timeline.map(item => item.clearances),
                                        borderColor: '#3B82F6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    },
                                    {
                                        label: 'Recalls',
                                        data: chartsData.timeline.map(item => item.recalls),
                                        borderColor: '#EF4444',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    }
                                }
                            }
                        });
                    }
                }

                // Class Distribution Chart (Bar)
                if (chartsData.classDistribution && chartsData.classDistribution.length > 0) {
                    const ctx = document.getElementById('classDistributionChart');
                    if (ctx) {
                        this.charts.classDistribution = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: chartsData.classDistribution.map(item => item.name),
                                datasets: [{
                                    label: 'Number of Devices',
                                    data: chartsData.classDistribution.map(item => item.value),
                                    backgroundColor: chartsData.classDistribution.map(item => item.color),
                                    borderRadius: 8,
                                    borderSkipped: false,
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    }
                                }
                            }
                        });
                    }
                }

                // Safety Timeline Chart (Line)
                if (chartsData.safetyTimeline && chartsData.safetyTimeline.length > 0) {
                    const ctx = document.getElementById('safetyTimelineChart');
                    if (ctx) {
                        this.charts.safetyTimeline = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: chartsData.safetyTimeline.map(item => item.month),
                                datasets: [
                                    {
                                        label: 'Recalls',
                                        data: chartsData.safetyTimeline.map(item => item.recalls),
                                        borderColor: '#EF4444',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    },
                                    {
                                        label: 'Adverse Events',
                                        data: chartsData.safetyTimeline.map(item => item.adverseEvents),
                                        borderColor: '#F59E0B',
                                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            maxRotation: 45
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            }

            updateDataTabs(data) {
                // Update overview stats
                const totalRecords = data.profile?.overview?.totalFDARecords || 0;
                
                document.getElementById('total-records').textContent = totalRecords.toLocaleString();
                document.getElementById('active-clearances').textContent = 
                    ((data.profile?.market?.active510k || 0) + (data.profile?.market?.activePMA || 0)).toLocaleString();
                document.getElementById('safety-events').textContent = 
                    ((data.profile?.safety?.recallCount || 0) + (data.profile?.safety?.adverseEventCount || 0)).toLocaleString();

                // Update FDA data tab
                this.updateFDADataTab(data.data?.fda || {});
                
                // Update regulatory tab
                this.updateRegulatoryTab(data.data?.ecfr || {});
                
                // Update compliance tab
                this.updateComplianceTab(data.profile);
            }

            updateFDADataTab(fdaData) {
                const container = document.getElementById('fda-data-container');
                container.innerHTML = '';

                const endpoints = [
                    { key: 'fiveOneOk', name: '510(k) Clearances', color: 'blue', icon: 'check' },
                    { key: 'pma', name: 'PMA Approvals', color: 'green', icon: 'shield' },
                    { key: 'recalls', name: 'Device Recalls', color: 'red', icon: 'exclamation' },
                    { key: 'adverseEvents', name: 'Adverse Events', color: 'orange', icon: 'warning' },
                    { key: 'classification', name: 'Device Classification', color: 'purple', icon: 'tag' },
                    { key: 'registrations', name: 'Registrations', color: 'indigo', icon: 'office' },
                    { key: 'udi', name: 'UDI Database', color: 'pink', icon: 'qrcode' },
                    { key: 'enforcement', name: 'Enforcement', color: 'gray', icon: 'gavel' }
                ];

                endpoints.forEach(endpoint => {
                    const data = fdaData[endpoint.key];
                    const section = this.createFDASection(endpoint, data);
                    container.appendChild(section);
                });
            }

            createFDASection(endpoint, data) {
                const section = document.createElement('div');
                section.className = 'border border-gray-200 rounded-2xl overflow-hidden';

                const hasResults = data?.results?.length > 0;
                const resultCount = data?.results?.length || 0;
                const hasError = !!data?.error;

                section.innerHTML = `
                    <div class="bg-${endpoint.color}-50 border-b border-gray-200 p-4 cursor-pointer hover:bg-${endpoint.color}-100 transition-colors" onclick="dashboard.toggleSection(this)">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <div class="bg-${endpoint.color}-500 rounded-xl p-2 mr-3">
                                    ${this.getIcon(endpoint.icon)}
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">${endpoint.name}</h3>
                            </div>
                            <div class="flex items-center">
                                <span class="text-sm ${hasResults ? 'text-green-600' : hasError ? 'text-red-600' : 'text-gray-500'} mr-4">
                                    ${hasResults ? `${resultCount} records` : hasError ? 'Error' : 'No data'}
                                </span>
                                <svg class="w-5 h-5 text-gray-500 transform transition-transform section-arrow" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="hidden p-4 bg-white section-content">
                        ${this.createFDADataContent(data, endpoint)}
                    </div>
                `;

                return section;
            }

            createFDADataContent(data, endpoint) {
                if (data?.error) {
                    return `
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-4 text-red-700">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-red-500 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <strong>API Error:</strong> ${data.error}
                                    <br><span class="text-sm">This endpoint may be temporarily unavailable or the search term may not match this database.</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (!data?.results?.length) {
                    return `
                        <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 text-gray-600 text-center">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                            <p>No records found for this search term.</p>
                            <p class="text-sm mt-1">Try different keywords or check other databases.</p>
                        </div>
                    `;
                }

                const records = data.results.slice(0, 5);
                return `
                    <div class="space-y-4">
                        ${records.map((record, index) => `
                            <div class="border border-gray-200 rounded-2xl p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="dashboard.showRecordDetails('${endpoint.key}', ${index})">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-medium text-gray-800">${this.getRecordTitle(record, endpoint.key)}</h4>
                                    <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        View Details
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${this.getRecordSummary(record, endpoint.key)}</p>
                                <div class="flex items-center text-xs text-gray-500">
                                    <span class="mr-4">${this.getRecordDate(record, endpoint.key)}</span>
                                    ${this.getRecordStatus(record, endpoint.key)}
                                </div>
                            </div>
                        `).join('')}
                        ${data.results.length > 5 ? `
                            <button class="w-full py-2 text-blue-600 hover:text-blue-800 text-sm font-medium border border-blue-200 rounded-2xl hover:bg-blue-50 transition-colors" onclick="dashboard.showAllRecords('${endpoint.key}')">
                                View all ${data.results.length} records
                            </button>
                        ` : ''}
                    </div>
                `;
            }

            getRecordTitle(record, type) {
                switch(type) {
                    case 'fiveOneOk':
                        return record.device_name || record.k_number || 'Unknown Device';
                    case 'pma':
                        return record.trade_name || record.generic_name || record.pma_number || 'Unknown Device';
                    case 'recalls':
                        return record.product_description || record.res_event_number || 'Recall Notice';
                    case 'adverseEvents':
                        return record.device?.device_name || record.device?.generic_name || 'Adverse Event Report';
                    case 'classification':
                        return record.device_name || record.product_code || 'Device Classification';
                    case 'registrations':
                        return record.proprietary_name || record.establishment_name || 'Registration';
                    case 'udi':
                        return record.device_description || record.brand_name || 'UDI Record';
                    case 'enforcement':
                        return record.product_description || 'Enforcement Action';
                    default:
                        return 'FDA Record';
                }
            }

            getRecordSummary(record, type) {
                switch(type) {
                    case 'fiveOneOk':
                        return `Applicant: ${record.applicant || 'Unknown'} | Decision: ${record.decision_description || 'Unknown'}`;
                    case 'pma':
                        return `Applicant: ${record.applicant || 'Unknown'} | Status: ${record.advisory_committee_description || 'Unknown'}`;
                    case 'recalls':
                        return `Firm: ${record.recalling_firm || 'Unknown'} | Status: ${record.recall_status || 'Unknown'}`;
                    case 'adverseEvents':
                        return `Event Type: ${record.event_type || 'Unknown'} | Manufacturer: ${record.manufacturer_name || 'Unknown'}`;
                    case 'classification':
                        return `Class: ${record.device_class || 'Unknown'} | Specialty: ${record.medical_specialty_description || 'Unknown'}`;
                    case 'registrations':
                        return `Company: ${record.establishment_name || 'Unknown'} | Type: ${record.establishment_type || 'Unknown'}`;
                    case 'udi':
                        return `Company: ${record.company_name || 'Unknown'} | Model: ${record.version_or_model_number || 'Unknown'}`;
                    case 'enforcement':
                        return `Firm: ${record.recalling_firm || 'Unknown'} | Class: ${record.classification || 'Unknown'}`;
                    default:
                        return 'FDA database record';
                }
            }

            getRecordDate(record, type) {
                const dateFields = {
                    'fiveOneOk': 'decision_date',
                    'pma': 'decision_date',
                    'recalls': 'event_date_initiated',
                    'adverseEvents': 'date_received',
                    'classification': 'date_received',
                    'registrations': 'reg_expiry_date_year',
                    'udi': 'publish_date',
                    'enforcement': 'event_date_initiated'
                };
                
                const date = record[dateFields[type]];
                return date ? new Date(date).toLocaleDateString() : 'Date unknown';
            }

            getRecordStatus(record, type) {
                const statusFields = {
                    'fiveOneOk': record.decision_description,
                    'pma': record.advisory_committee_description,
                    'recalls': record.recall_status,
                    'adverseEvents': record.event_type,
                    'classification': record.device_class,
                    'registrations': record.status_code,
                    'udi': record.device_count_in_base_package,
                    'enforcement': record.classification
                };
                
                const status = statusFields[type];
                if (!status) return '';
                
                const statusClass = this.getStatusClass(status);
                return `<span class="px-2 py-1 rounded-full text-xs ${statusClass}">${status}</span>`;
            }

            getStatusClass(status) {
                const lower = status.toLowerCase();
                if (lower.includes('cleared') || lower.includes('approved') || lower.includes('active')) {
                    return 'bg-green-100 text-green-800';
                } else if (lower.includes('recalled') || lower.includes('terminated')) {
                    return 'bg-red-100 text-red-800';
                } else if (lower.includes('pending') || lower.includes('ongoing')) {
                    return 'bg-yellow-100 text-yellow-800';
                } else {
                    return 'bg-gray-100 text-gray-800';
                }
            }

            updateRegulatoryTab(ecfrData) {
                const container = document.getElementById('regulatory-container');
                container.innerHTML = '';

                if (!ecfrData || Object.keys(ecfrData).length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-8">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                            </svg>
                            <p class="text-gray-500">No regulatory data available for this search.</p>
                            <p class="text-sm text-gray-400 mt-2">Try searching for specific device types or use CFR part explorer.</p>
                        </div>
                    `;
                    return;
                }

                Object.entries(ecfrData).forEach(([partNumber, partData]) => {
                    const section = this.createRegulatorySection(partNumber, partData);
                    container.appendChild(section);
                });
            }

            updateComplianceTab(profile) {
                const checklistContainer = document.getElementById('compliance-checklist');
                const docsContainer = document.getElementById('required-docs');

                const complianceItems = this.generateComplianceChecklist(profile);
                const requiredDocs = this.generateRequiredDocs(profile);

                checklistContainer.innerHTML = complianceItems.map(item => `
                    <div class="flex items-center p-3 bg-white rounded border">
                        <div class="w-5 h-5 ${item.completed ? 'bg-green-500' : 'bg-gray-300'} rounded mr-3 flex items-center justify-center">
                            ${item.completed ? '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                        </div>
                        <span class="text-gray-700 ${item.completed ? 'line-through' : ''}">${item.text}</span>
                    </div>
                `).join('');

                docsContainer.innerHTML = requiredDocs.map(doc => `
                    <div class="flex items-center p-3 bg-white rounded border">
                        <div class="w-5 h-5 ${doc.required ? 'bg-red-500' : 'bg-gray-300'} rounded mr-3"></div>
                        <div class="flex-1">
                            <span class="text-gray-700">${doc.name}</span>
                            <p class="text-xs text-gray-500 mt-1">${doc.description}</p>
                        </div>
                    </div>
                `).join('');
            }

            generateComplianceChecklist(profile) {
                const items = [
                    { text: 'Search strategy implemented', completed: true },
                    { text: 'FDA database coverage verified', completed: profile.overview.totalFDARecords > 0 },
                    { text: 'Regulatory complexity assessed', completed: profile.overview.regulatoryComplexity !== 'Unknown' },
                    { text: 'Safety profile evaluated', completed: profile.safety.riskLevel !== 'Unknown' },
                    { text: 'Market status determined', completed: profile.overview.marketStatus !== 'Unknown' }
                ];

              if (profile.isCompanySearch) {
                    items.push({ text: 'Company portfolio analyzed', completed: profile.companyInfo.devicePortfolio?.length > 0 });
                } else {
                    items.push({ text: 'Device classification identified', completed: profile.overview.primaryClassification !== 'Unknown' });
                }

                return items;
            }

            generateRequiredDocs(profile) {
                const docs = [
                    { name: 'Search Report', description: 'Comprehensive search results and analysis', required: true },
                    { name: 'Risk Assessment', description: 'Safety and regulatory risk evaluation', required: true }
                ];

                if (profile.isCompanySearch) {
                    docs.push(
                        { name: 'Company Profile', description: 'Complete company regulatory portfolio', required: true },
                        { name: 'Portfolio Analysis', description: 'Device portfolio regulatory mapping', required: true }
                    );
                } else {
                    docs.push(
                        { name: 'Device Classification', description: 'FDA device class determination', required: true },
                        { name: 'Regulatory Pathway', description: '510(k) or PMA pathway documentation', required: true }
                    );
                }

                return docs;
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active', 'border-fda-blue', 'text-fda-blue', 'bg-blue-50');
                        btn.classList.remove('border-transparent', 'text-gray-500');
                    } else {
                        btn.classList.remove('active', 'border-fda-blue', 'text-fda-blue', 'bg-blue-50');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    }
                });

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    if (content.id === `tab-${tabName}`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            }

            toggleSection(headerElement) {
                const content = headerElement.nextElementSibling;
                const icon = headerElement.querySelector('.section-arrow');
                
                content.classList.toggle('hidden');
                if (content.classList.contains('hidden')) {
                    icon.classList.remove('section-expanded');
                } else {
                    icon.classList.add('section-expanded');
                }
            }

            showRecordDetails(endpoint, index) {
                if (!this.currentData?.data?.fda?.[endpoint]?.results?.[index]) return;
                
                const record = this.currentData.data.fda[endpoint].results[index];
                
                this.openModal(`FDA Record Details - ${endpoint}`, `
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-2xl p-6">
                            <h4 class="font-semibold text-gray-800 mb-4">Record Information</h4>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                ${Object.entries(record).slice(0, 20).map(([key, value]) => `
                                    <div class="border-b border-gray-200 pb-2">
                                        <span class="font-medium text-gray-700 block">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span>
                                        <span class="text-gray-600 mt-1 block">${this.formatValue(value)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-2xl p-6">
                            <h4 class="font-semibold text-blue-800 mb-4">Complete Raw Data</h4>
                            <pre class="text-xs bg-white p-4 rounded-xl border overflow-x-auto max-h-96">${JSON.stringify(record, null, 2)}</pre>
                        </div>
                    </div>
                `);
            }

            showAllRecords(endpoint) {
                if (!this.currentData?.data?.fda?.[endpoint]?.results) return;
                
                const records = this.currentData.data.fda[endpoint].results;
                const recordsHtml = records.map((record, index) => `
                    <div class="border border-gray-200 rounded-2xl p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="dashboard.showRecordDetails('${endpoint}', ${index})">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-800">${this.getRecordTitle(record, endpoint)}</h4>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Details
                            </button>
                        </div>
                        <p class="text-sm text-gray-600">${this.getRecordSummary(record, endpoint)}</p>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-xs text-gray-500">${this.getRecordDate(record, endpoint)}</span>
                            ${this.getRecordStatus(record, endpoint)}
                        </div>
                    </div>
                `).join('');

                this.openModal(`All ${endpoint} Records (${records.length})`, `
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        ${recordsHtml}
                    </div>
                `);
            }

            openModal(title, content) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-content').innerHTML = content;
                document.getElementById('modal-container').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                document.getElementById('modal-container').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            toggleModalSize() {
                const modal = document.querySelector('#modal-container .bg-white');
                if (modal.classList.contains('max-w-6xl')) {
                    modal.classList.remove('max-w-6xl');
                    modal.classList.add('max-w-7xl');
                } else {
                    modal.classList.remove('max-w-7xl');
                    modal.classList.add('max-w-6xl');
                }
            }

            openSettings() {
                document.getElementById('settings-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            closeSettings() {
                document.getElementById('settings-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            saveSettings() {
                this.settings.resultsLimit = parseInt(document.getElementById('results-limit').value);
                this.settings.enableAI = document.getElementById('enable-ai-insights').checked;
                this.settings.autoRefresh = document.getElementById('auto-refresh').checked;
                this.baseUrl = document.getElementById('api-endpoint').value;
                
                localStorage.setItem('fdaDashboardSettings', JSON.stringify(this.settings));
                this.closeSettings();
                
                this.showNotification('Settings saved successfully!', 'success');
            }

            loadSettings() {
                const saved = localStorage.getItem('fdaDashboardSettings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                    document.getElementById('results-limit').value = this.settings.resultsLimit;
                    document.getElementById('enable-ai-insights').checked = this.settings.enableAI;
                    document.getElementById('auto-refresh').checked = this.settings.autoRefresh;
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-2xl shadow-xl animate-slide-up ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            exportReport() {
                if (!this.currentData) {
                    this.showNotification('No data available to export', 'error');
                    return;
                }

                const reportData = {
                    searchTerm: this.currentData.searchTerm,
                    searchMode: this.currentData.searchMode,
                    timestamp: this.currentData.timestamp,
                    profile: this.currentData.profile,
                    summary: {
                        totalRecords: this.currentData.profile?.overview?.totalFDARecords || 0,
                        searchType: this.currentData.profile?.searchType || 'unknown',
                        isCompanySearch: this.currentData.profile?.isCompanySearch || false,
                        safetyEvents: (this.currentData.profile?.safety?.recallCount || 0) + 
                                     (this.currentData.profile?.safety?.adverseEventCount || 0)
                    },
                    sources: this.currentData.sources
                };

                const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fda-intelligence-${this.currentData.searchTerm.replace(/[^a-z0-9]/gi, '_').toLowerCase()}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showNotification('Report exported successfully!', 'success');
            }

            formatValue(value) {
                if (value === null || value === undefined) return 'N/A';
                if (typeof value === 'object') return JSON.stringify(value);
                if (typeof value === 'string' && value.length > 100) return value.substring(0, 100) + '...';
                return String(value);
            }

            truncateText(text, maxLength) {
                if (!text) return '-';
                const str = String(text);
                return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
            }

            escapeHtml(text) {
                if (!text) return '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }

            getIcon(iconName) {
                const icons = {
                    check: '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>',
                    shield: '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>',
                    exclamation: '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
                    warning: '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
                    tag: '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>',
                    office: '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"/></svg>',
                    qrcode: '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2V5h1v1H5zM3 13a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1v-3zm2 2v-1h1v1H5zM13 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1V4zm2 2V5h1v1h-1zM11 4a1 1 0 10-2 0v1a1 1 0 002 0V4zM10 7a1 1 0 011 1v1h2a1 1 0 110 2h-3a1 1 0 01-1-1V8a1 1 0 011-1zM16 12a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1zM12 13a1 1 0 100-2h1a1 1 0 110 2h-1zM13 16a1 1 0 011-1h3a1 1 0 110 2h-3a1 1 0 01-1-1zM13 11a1 1 0 100-2h1a1 1 0 110 2h-1zM19 11a1 1 0 10-2 0v1a1 1 0 002 0v-1z" clip-rule="evenodd"/></svg>',
                    gavel: '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg>'
                };
                return icons[iconName] || icons.check;
            }

            displayPartResults(data) {
                this.hideError();
                document.getElementById('results-container').classList.remove('hidden');

                // Hide AI insights and profile for part-only search
                document.getElementById('ai-insights').classList.add('hidden');
                document.getElementById('profile-overview').classList.add('hidden');

                // Update regulatory container with part data
                this.updatePartResultsTab(data);
                
                // Switch to regulatory tab
                this.switchTab('regulatory');
            }

            updatePartResultsTab(data) {
                const container = document.getElementById('regulatory-container');
                container.innerHTML = `
                    <div class="bg-white rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">21 CFR Part ${data.part}</h3>
                                <p class="text-gray-600 mt-1">${data.description}</p>
                            </div>
                            <a href="${data.url || `https://www.ecfr.gov/current/title-21/chapter-I/subchapter-H/part-${data.part}`}" 
                               target="_blank" 
                               class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition-colors flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                                    <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                                </svg>
                                View on eCFR
                            </a>
                        </div>
                        
                        ${data.data?.summary ? `
                            <div class="bg-gray-50 rounded-2xl p-4 mb-6">
                                <h4 class="font-semibold text-gray-800 mb-3">Part Summary</h4>
                                <div class="grid md:grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <span class="font-medium">Total Sections:</span>
                                        <span class="ml-2">${data.data.summary.totalSections}</span>
                                    </div>
                                    <div>
                                        <span class="font-medium">Device Classes:</span>
                                        <div class="mt-1 text-xs">
                                            Class I: ${data.data.summary.classDistribution?.classI || 0}<br>
                                            Class II: ${data.data.summary.classDistribution?.classII || 0}<br>
                                            Class III: ${data.data.summary.classDistribution?.classIII || 0}
                                        </div>
                                    </div>
                                    <div>
                                        <span class="font-medium">Common Devices:</span>
                                        <div class="mt-1 text-xs">
                                            ${data.data.summary.deviceTypes?.slice(0, 3).join(', ') || 'Various medical devices'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800">Recent Sections</h4>
                            ${data.data?.sections?.slice(0, 10).map(section => `
                                <div class="border border-gray-200 rounded-2xl p-4 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start mb-2">
                                        <h5 class="font-medium text-gray-800">${section.title || section.sectionId}</h5>
                                        ${section.deviceClass ? `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Class ${section.deviceClass}</span>` : ''}
                                    </div>
                                    ${section.identification ? `
                                        <p class="text-sm text-gray-600 mb-2">
                                            <strong>Identification:</strong> ${this.truncateText(section.identification, 150)}
                                        </p>
                                    ` : ''}
                                    ${section.classification ? `
                                        <p class="text-sm text-gray-600">
                                            <strong>Classification:</strong> ${this.truncateText(section.classification, 150)}
                                        </p>
                                    ` : ''}
                                </div>
                            `).join('') || '<p class="text-gray-500">No sections available</p>'}
                        </div>
                    </div>
                `;
            }
        

        createRegulatorySection(partNumber, partData) {
    const section = document.createElement('div');
    section.className = 'border border-gray-200 rounded-2xl overflow-hidden mb-6';

    const searchResults = partData.searchResults || [];
    const totalSections = partData.document?.summary?.totalSections || 0;

    section.innerHTML = `
        <div class="bg-green-50 border-b border-gray-200 p-4 cursor-pointer hover:bg-green-100 transition-colors" onclick="dashboard.toggleSection(this)">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <div class="bg-green-500 rounded-xl p-2 mr-3">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">21 CFR Part ${partNumber}</h3>
                        <p class="text-sm text-gray-600">${partData.partInfo?.description || 'CFR Part ' + partNumber}</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="text-sm text-green-600 mr-4">${searchResults.length} matches / ${totalSections} sections</span>
                    <svg class="w-5 h-5 text-gray-500 transform transition-transform section-arrow" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="hidden p-4 bg-white section-content">
            ${this.createRegulatoryContent(partData)}
        </div>
    `;

    return section;
}

createRegulatoryContent(partData) {
    const sections = partData.searchResults?.slice(0, 10) || [];
    
    if (sections.length === 0) {
        return '<p class="text-gray-500">No relevant sections found for your search term.</p>';
    }

    return `
        <div class="space-y-4">
            ${sections.map(section => `
                <div class="border border-gray-200 rounded-2xl p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="dashboard.showSectionDetails('${section.section}', '${this.escapeHtml(section.title)}', '${this.escapeHtml(section.identification || '')}', '${this.escapeHtml(section.classification || '')}')">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-gray-800">${section.title || section.section}</h4>
                        <div class="flex items-center space-x-2">
                            ${section.deviceClass ? `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Class ${section.deviceClass}</span>` : ''}
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                View Section
                            </button>
                        </div>
                    </div>
                    ${section.identification ? `
                        <div class="mb-2">
                            <span class="text-sm font-medium text-gray-700">Identification:</span>
                            <p class="text-sm text-gray-600 mt-1">${this.truncateText(section.identification, 200)}</p>
                        </div>
                    ` : ''}
                    ${section.classification ? `
                        <div class="mb-2">
                            <span class="text-sm font-medium text-gray-700">Classification:</span>
                            <p class="text-sm text-gray-600 mt-1">${this.truncateText(section.classification, 150)}</p>
                        </div>
                    ` : ''}
                </div>
            `).join('')}
        </div>
    `;
}

showSectionDetails(sectionId, title, identification, classification) {
    this.openModal(`CFR Section Details - ${sectionId}`, `
        <div class="space-y-6">
            <div class="bg-green-50 rounded-2xl p-6">
                <h4 class="font-semibold text-green-800 mb-4">${title || sectionId}</h4>
                ${identification ? `
                    <div class="mb-4">
                        <h5 class="font-medium text-green-700 mb-2">Identification:</h5>
                        <p class="text-green-700 text-sm leading-relaxed">${identification}</p>
                    </div>
                ` : ''}
                ${classification ? `
                    <div class="mb-4">
                        <h5 class="font-medium text-green-700 mb-2">Classification:</h5>
                        <p class="text-green-700 text-sm leading-relaxed">${classification}</p>
                    </div>
                ` : ''}
            </div>
            <div class="bg-yellow-50 rounded-2xl p-6">
                <h4 class="font-semibold text-yellow-800 mb-4">Compliance Requirements</h4>
                <ul class="list-disc list-inside text-yellow-700 space-y-2">
                    <li>Device must meet general controls (21 CFR 820)</li>
                    <li>Special controls may apply based on device class</li>
                    <li>Labeling requirements must be satisfied (21 CFR 801)</li>
                    <li>Quality system regulations apply unless exempt</li>
                    <li>Registration and listing may be required (21 CFR 807)</li>
                </ul>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="window.open('https://www.fda.gov/medical-devices', '_blank')" class="bg-gray-600 text-white px-4 py-2 rounded-xl hover:bg-gray-700 transition-colors">
                    FDA Guidance
                </button>
                <button onclick="window.open('https://www.ecfr.gov/current/title-21/chapter-I/subchapter-H/part-${sectionId.split('.')[0]}/section-${sectionId}', '_blank')" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition-colors">
                    View on eCFR →
                </button>
            </div>
        </div>
    `);
}
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.dashboard = new FDAIntelligenceDashboard();
        });
    </script>
</body>
</html>